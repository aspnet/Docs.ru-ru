---
title: ASP.NET Core Защита данных
author: rick-anderson
description: Узнайте о концепции защиты данных и принципах разработки ASP.NET Core интерфейсах API защиты данных.
ms.author: riande
ms.custom: mvc
ms.date: 10/24/2018
no-loc:
- ':::no-loc(appsettings.json):::'
- ':::no-loc(ASP.NET Core Identity):::'
- ':::no-loc(cookie):::'
- ':::no-loc(Cookie):::'
- ':::no-loc(Blazor):::'
- ':::no-loc(Blazor Server):::'
- ':::no-loc(Blazor WebAssembly):::'
- ':::no-loc(Identity):::'
- ":::no-loc(Let's Encrypt):::"
- ':::no-loc(Razor):::'
- ':::no-loc(SignalR):::'
uid: security/data-protection/introduction
ms.openlocfilehash: 5fd5676b286e758f0648d78bf8cb4171e7a98f60
ms.sourcegitcommit: ca34c1ac578e7d3daa0febf1810ba5fc74f60bbf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2020
ms.locfileid: "93051698"
---
# <a name="aspnet-core-data-protection"></a><span data-ttu-id="69fdb-103">ASP.NET Core Защита данных</span><span class="sxs-lookup"><span data-stu-id="69fdb-103">ASP.NET Core Data Protection</span></span>

<span data-ttu-id="69fdb-104">Веб-приложениям часто требуется хранить конфиденциальные данные.</span><span class="sxs-lookup"><span data-stu-id="69fdb-104">Web applications often need to store security-sensitive data.</span></span> <span data-ttu-id="69fdb-105">Windows предоставляет DPAPI для настольных приложений, но это не подходит для веб-приложений.</span><span class="sxs-lookup"><span data-stu-id="69fdb-105">Windows provides DPAPI for desktop applications but this is unsuitable for web applications.</span></span> <span data-ttu-id="69fdb-106">ASP.NET Coreный стек защиты данных предоставляет простой и простой в использовании криптографический API, который разработчик может использовать для защиты данных, включая управление ключами и вращение.</span><span class="sxs-lookup"><span data-stu-id="69fdb-106">The ASP.NET Core data protection stack provide a simple, easy to use cryptographic API a developer can use to protect data, including key management and rotation.</span></span>

<span data-ttu-id="69fdb-107">ASP.NET Coreный стек защиты данных предназначен для использования в качестве долгосрочной замены &lt; &gt; элемента machineKey в ASP.NET 1. x-4. x.</span><span class="sxs-lookup"><span data-stu-id="69fdb-107">The ASP.NET Core data protection stack is designed to serve as the long-term replacement for the &lt;machineKey&gt; element in ASP.NET 1.x - 4.x.</span></span> <span data-ttu-id="69fdb-108">Она была разработана для устранения многих недостатков старого криптографического стека, предоставляя готовое решение для большинства случаев использования современных приложений.</span><span class="sxs-lookup"><span data-stu-id="69fdb-108">It was designed to address many of the shortcomings of the old cryptographic stack while providing an out-of-the-box solution for the majority of use cases modern applications are likely to encounter.</span></span>

## <a name="problem-statement"></a><span data-ttu-id="69fdb-109">Проблема</span><span class="sxs-lookup"><span data-stu-id="69fdb-109">Problem statement</span></span>

<span data-ttu-id="69fdb-110">Общая проблема может быть кратко сформулирована в одном предложении: мне нужно сохранить надежную информацию для последующего извлечения, но я не доверяю механизму сохраняемости.</span><span class="sxs-lookup"><span data-stu-id="69fdb-110">The overall problem statement can be succinctly stated in a single sentence: I need to persist trusted information for later retrieval, but I don't trust the persistence mechanism.</span></span> <span data-ttu-id="69fdb-111">В веб-терминах это может быть написано следующим образом: "мне требуется надежное состояние приема-передачи с помощью ненадежного клиента".</span><span class="sxs-lookup"><span data-stu-id="69fdb-111">In web terms, this might be written as "I need to round-trip trusted state via an untrusted client."</span></span>

<span data-ttu-id="69fdb-112">Канонический пример — это токен проверки подлинности :::no-loc(cookie)::: или носителя.</span><span class="sxs-lookup"><span data-stu-id="69fdb-112">The canonical example of this is an authentication :::no-loc(cookie)::: or bearer token.</span></span> <span data-ttu-id="69fdb-113">Сервер создает маркер «I Грут и имеет разрешение XYZ» и передает его клиенту.</span><span class="sxs-lookup"><span data-stu-id="69fdb-113">The server generates an "I am Groot and have xyz permissions" token and hands it to the client.</span></span> <span data-ttu-id="69fdb-114">В будущем клиент получит этот маркер обратно на сервер, но сервер должен быть уверен, что клиент не подвели маркер.</span><span class="sxs-lookup"><span data-stu-id="69fdb-114">At some future date the client will present that token back to the server, but the server needs some kind of assurance that the client hasn't forged the token.</span></span> <span data-ttu-id="69fdb-115">Поэтому первое требование: подлинность (</span><span class="sxs-lookup"><span data-stu-id="69fdb-115">Thus the first requirement: authenticity (a.k.a.</span></span> <span data-ttu-id="69fdb-116">целостность, проверка на фальсификацию).</span><span class="sxs-lookup"><span data-stu-id="69fdb-116">integrity, tamper-proofing).</span></span>

<span data-ttu-id="69fdb-117">Так как сохраненное состояние является доверенным для сервера, мы ожидаем, что это состояние может содержать сведения, относящиеся к операционной среде.</span><span class="sxs-lookup"><span data-stu-id="69fdb-117">Since the persisted state is trusted by the server, we anticipate that this state might contain information that's specific to the operating environment.</span></span> <span data-ttu-id="69fdb-118">Это может быть путь к файлу, разрешение, маркер или другая косвенная ссылка или другой элемент данных, относящихся к серверу.</span><span class="sxs-lookup"><span data-stu-id="69fdb-118">This could be in the form of a file path, a permission, a handle or other indirect reference, or some other piece of server-specific data.</span></span> <span data-ttu-id="69fdb-119">Как правило, такие сведения не должны раскрываться с недоверенным клиентом.</span><span class="sxs-lookup"><span data-stu-id="69fdb-119">Such information should generally not be disclosed to an untrusted client.</span></span> <span data-ttu-id="69fdb-120">Поэтому второе требование: конфиденциальность.</span><span class="sxs-lookup"><span data-stu-id="69fdb-120">Thus the second requirement: confidentiality.</span></span>

<span data-ttu-id="69fdb-121">Наконец, поскольку современные приложения являются компонентами, то, что мы видели, некоторые компоненты хотят воспользоваться преимуществами этой системы, не обращаясь к другим компонентам системы.</span><span class="sxs-lookup"><span data-stu-id="69fdb-121">Finally, since modern applications are componentized, what we've seen is that individual components will want to take advantage of this system without regard to other components in the system.</span></span> <span data-ttu-id="69fdb-122">Например, если компонент токена носителя использует этот стек, он должен работать без помех от механизма защиты от CSRF, который также может использовать тот же стек.</span><span class="sxs-lookup"><span data-stu-id="69fdb-122">For instance, if a bearer token component is using this stack, it should operate without interference from an anti-CSRF mechanism that might also be using the same stack.</span></span> <span data-ttu-id="69fdb-123">Таким образом, конечное требование: изоляция.</span><span class="sxs-lookup"><span data-stu-id="69fdb-123">Thus the final requirement: isolation.</span></span>

<span data-ttu-id="69fdb-124">Мы можем предоставить дополнительные ограничения, чтобы сузить область действия наших требований.</span><span class="sxs-lookup"><span data-stu-id="69fdb-124">We can provide further constraints in order to narrow the scope of our requirements.</span></span> <span data-ttu-id="69fdb-125">Предполагается, что все службы, работающие в криптосистемы, являются одинаково надежными и что данные не должны создаваться или потребляться за пределами служб непосредственно в рамках прямого управления.</span><span class="sxs-lookup"><span data-stu-id="69fdb-125">We assume that all services operating within the cryptosystem are equally trusted and that the data doesn't need to be generated or consumed outside of the services under our direct control.</span></span> <span data-ttu-id="69fdb-126">Кроме того, необходимо, чтобы операции были максимально быстрыми, поскольку каждый запрос к веб-службе может пройти через криптосистемы один или несколько раз.</span><span class="sxs-lookup"><span data-stu-id="69fdb-126">Furthermore, we require that operations are as fast as possible since each request to the web service might go through the cryptosystem one or more times.</span></span> <span data-ttu-id="69fdb-127">Это делает симметричное шифрование идеальным для нашего сценария, и мы можем задействовать асимметричную криптографию до такого момента времени, когда это необходимо.</span><span class="sxs-lookup"><span data-stu-id="69fdb-127">This makes symmetric cryptography ideal for our scenario, and we can discount asymmetric cryptography until such a time that it's needed.</span></span>

## <a name="design-philosophy"></a><span data-ttu-id="69fdb-128">Философия проектирования</span><span class="sxs-lookup"><span data-stu-id="69fdb-128">Design philosophy</span></span>

<span data-ttu-id="69fdb-129">Мы начали с определения проблем существующего стека.</span><span class="sxs-lookup"><span data-stu-id="69fdb-129">We started by identifying problems with the existing stack.</span></span> <span data-ttu-id="69fdb-130">После того как мы составили это, мы проделали обзор существующих решений и готовы, что ни одно из существующих решений не обладает достаточной функциональностью.</span><span class="sxs-lookup"><span data-stu-id="69fdb-130">Once we had that, we surveyed the landscape of existing solutions and concluded that no existing solution quite had the capabilities we sought.</span></span> <span data-ttu-id="69fdb-131">Затем мы разработали решение на основе нескольких принципов GUID.</span><span class="sxs-lookup"><span data-stu-id="69fdb-131">We then engineered a solution based on several guiding principles.</span></span>

* <span data-ttu-id="69fdb-132">Система должна предлагать простоту настройки.</span><span class="sxs-lookup"><span data-stu-id="69fdb-132">The system should offer simplicity of configuration.</span></span> <span data-ttu-id="69fdb-133">В идеале система будет иметь нулевую конфигурацию, и разработчики могли попасть на нее.</span><span class="sxs-lookup"><span data-stu-id="69fdb-133">Ideally the system would be zero-configuration and developers could hit the ground running.</span></span> <span data-ttu-id="69fdb-134">В ситуациях, когда разработчикам необходимо настроить определенный аспект (например, репозиторий ключей), следует учесть, что необходимо сделать эти конкретные конфигурации простыми.</span><span class="sxs-lookup"><span data-stu-id="69fdb-134">In situations where developers need to configure a specific aspect (such as the key repository), consideration should be given to making those specific configurations simple.</span></span>

* <span data-ttu-id="69fdb-135">Предлагают простой API, ориентированный на потребителей.</span><span class="sxs-lookup"><span data-stu-id="69fdb-135">Offer a simple consumer-facing API.</span></span> <span data-ttu-id="69fdb-136">API-интерфейсы должны быть простыми в использовании, и их сложно использовать неправильно.</span><span class="sxs-lookup"><span data-stu-id="69fdb-136">The APIs should be easy to use correctly and difficult to use incorrectly.</span></span>

* <span data-ttu-id="69fdb-137">Разработчики не должны изучать принципы управления ключами.</span><span class="sxs-lookup"><span data-stu-id="69fdb-137">Developers shouldn't learn key management principles.</span></span> <span data-ttu-id="69fdb-138">Система должна обрабатывала выбор алгоритма и время существования ключа от имени разработчика.</span><span class="sxs-lookup"><span data-stu-id="69fdb-138">The system should handle algorithm selection and key lifetime on the developer's behalf.</span></span> <span data-ttu-id="69fdb-139">В идеале разработчик не должен даже иметь доступ к необработанному материалу ключа.</span><span class="sxs-lookup"><span data-stu-id="69fdb-139">Ideally the developer should never even have access to the raw key material.</span></span>

* <span data-ttu-id="69fdb-140">Если возможно, ключи должны быть защищены неактивных.</span><span class="sxs-lookup"><span data-stu-id="69fdb-140">Keys should be protected at rest when possible.</span></span> <span data-ttu-id="69fdb-141">Система должна определить подходящий механизм защиты по умолчанию и применить его автоматически.</span><span class="sxs-lookup"><span data-stu-id="69fdb-141">The system should figure out an appropriate default protection mechanism and apply it automatically.</span></span>

<span data-ttu-id="69fdb-142">Учитывая эти принципы, мы разработали простой, простой [в использовании](xref:security/data-protection/using-data-protection) стек защиты данных.</span><span class="sxs-lookup"><span data-stu-id="69fdb-142">With these principles in mind we developed a simple, [easy to use](xref:security/data-protection/using-data-protection) data protection stack.</span></span>

<span data-ttu-id="69fdb-143">ASP.NET Core API-интерфейсы защиты данных в основном не предназначены для неопределенного сохранения конфиденциальных полезных данных.</span><span class="sxs-lookup"><span data-stu-id="69fdb-143">The ASP.NET Core data protection APIs are not primarily intended for indefinite persistence of confidential payloads.</span></span> <span data-ttu-id="69fdb-144">Другие технологии, такие как [Windows CNG DPAPI](/windows/win32/seccng/cng-dpapi) и [Azure Rights Management](/rights-management/) , более подходят для сценария неопределенного хранилища и имеют соответствующие возможности управления ключами.</span><span class="sxs-lookup"><span data-stu-id="69fdb-144">Other technologies like [Windows CNG DPAPI](/windows/win32/seccng/cng-dpapi) and [Azure Rights Management](/rights-management/) are more suited to the scenario of indefinite storage, and they have correspondingly strong key management capabilities.</span></span> <span data-ttu-id="69fdb-145">С другой стороны, разработчик не запрещает использовать ASP.NET Core API-интерфейсы защиты данных для долгосрочной защиты конфиденциальных данных.</span><span class="sxs-lookup"><span data-stu-id="69fdb-145">That said, there's nothing prohibiting a developer from using the ASP.NET Core data protection APIs for long-term protection of confidential data.</span></span>

## <a name="audience"></a><span data-ttu-id="69fdb-146">Аудитория</span><span class="sxs-lookup"><span data-stu-id="69fdb-146">Audience</span></span>

<span data-ttu-id="69fdb-147">Система защиты данных делится на пять основных пакетов.</span><span class="sxs-lookup"><span data-stu-id="69fdb-147">The data protection system is divided into five main packages.</span></span> <span data-ttu-id="69fdb-148">Различные аспекты этих API предназначены для трех основных аудиторий;</span><span class="sxs-lookup"><span data-stu-id="69fdb-148">Various aspects of these APIs target three main audiences;</span></span>

1. <span data-ttu-id="69fdb-149">[Пользовательские API-интерфейсы Обзор](xref:security/data-protection/consumer-apis/overview) предназначены для разработчиков приложений и платформ.</span><span class="sxs-lookup"><span data-stu-id="69fdb-149">The [Consumer APIs Overview](xref:security/data-protection/consumer-apis/overview) target application and framework developers.</span></span>

   <span data-ttu-id="69fdb-150">«Я не хочу изучать, как работает стек или как он настроен.</span><span class="sxs-lookup"><span data-stu-id="69fdb-150">"I don't want to learn about how the stack operates or about how it's configured.</span></span> <span data-ttu-id="69fdb-151">Я просто хочу выполнить какую-либо операцию в качестве простого способа с высокой вероятностью успешного использования API-интерфейсов ".</span><span class="sxs-lookup"><span data-stu-id="69fdb-151">I simply want to perform some operation in as simple a manner as possible with high probability of using the APIs successfully."</span></span>

2. <span data-ttu-id="69fdb-152">[API конфигурации](xref:security/data-protection/configuration/overview) предназначены для разработчиков приложений и системных администраторов.</span><span class="sxs-lookup"><span data-stu-id="69fdb-152">The [configuration APIs](xref:security/data-protection/configuration/overview) target application developers and system administrators.</span></span>

   <span data-ttu-id="69fdb-153">«Мне нужно сообщить системе защиты данных, что моей среде требуются пути или параметры, отличные от используемых по умолчанию».</span><span class="sxs-lookup"><span data-stu-id="69fdb-153">"I need to tell the data protection system that my environment requires non-default paths or settings."</span></span>

3. <span data-ttu-id="69fdb-154">API расширения предназначены для разработчиков, которые отвечают за реализацию настраиваемой политики.</span><span class="sxs-lookup"><span data-stu-id="69fdb-154">The extensibility APIs target developers in charge of implementing custom policy.</span></span> <span data-ttu-id="69fdb-155">Использование этих API будет ограничено редкими ситуациями и опытными разработчиками, осведомленными о безопасности.</span><span class="sxs-lookup"><span data-stu-id="69fdb-155">Usage of these APIs would be limited to rare situations and experienced, security aware developers.</span></span>

   <span data-ttu-id="69fdb-156">«Мне нужно заменить весь компонент в системе, поскольку у меня есть уникальные требования к поведению.</span><span class="sxs-lookup"><span data-stu-id="69fdb-156">"I need to replace an entire component within the system because I have truly unique behavioral requirements.</span></span> <span data-ttu-id="69fdb-157">Я хочу изучать редко используемые части области API, чтобы создать подключаемый модуль, выполняющий мои требования. "</span><span class="sxs-lookup"><span data-stu-id="69fdb-157">I am willing to learn uncommonly-used parts of the API surface in order to build a plugin that fulfills my requirements."</span></span>

## <a name="package-layout"></a><span data-ttu-id="69fdb-158">Макет пакета</span><span class="sxs-lookup"><span data-stu-id="69fdb-158">Package layout</span></span>

<span data-ttu-id="69fdb-159">Стек защиты данных состоит из пяти пакетов.</span><span class="sxs-lookup"><span data-stu-id="69fdb-159">The data protection stack consists of five packages.</span></span>

* <span data-ttu-id="69fdb-160">[Microsoft. AspNetCore. Data Protection. абстракции](https://www.nuget.org/packages/Microsoft.AspNetCore.DataProtection.Abstractions/) содержит <xref:Microsoft.AspNetCore.DataProtection.IDataProtectionProvider> интерфейсы и <xref:Microsoft.AspNetCore.DataProtection.IDataProtector> для создания служб защиты данных.</span><span class="sxs-lookup"><span data-stu-id="69fdb-160">[Microsoft.AspNetCore.DataProtection.Abstractions](https://www.nuget.org/packages/Microsoft.AspNetCore.DataProtection.Abstractions/) contains the <xref:Microsoft.AspNetCore.DataProtection.IDataProtectionProvider> and <xref:Microsoft.AspNetCore.DataProtection.IDataProtector> interfaces to create data protection services.</span></span> <span data-ttu-id="69fdb-161">Он также содержит полезные методы расширения для работы с этими типами (например, [идатапротектор. Protect](xref:Microsoft.AspNetCore.DataProtection.DataProtectionCommonExtensions.Protect*)).</span><span class="sxs-lookup"><span data-stu-id="69fdb-161">It also contains useful extension methods for working with these types (for example, [IDataProtector.Protect](xref:Microsoft.AspNetCore.DataProtection.DataProtectionCommonExtensions.Protect*)).</span></span> <span data-ttu-id="69fdb-162">Если экземпляр системы защиты данных создается в другой части и вы используете API, см `Microsoft.AspNetCore.DataProtection.Abstractions` . ссылку.</span><span class="sxs-lookup"><span data-stu-id="69fdb-162">If the data protection system is instantiated elsewhere and you're consuming the API, reference `Microsoft.AspNetCore.DataProtection.Abstractions`.</span></span>

* <span data-ttu-id="69fdb-163">[Microsoft. AspNetCore. Data Protection](https://www.nuget.org/packages/Microsoft.AspNetCore.DataProtection/) содержит базовую реализацию системы защиты данных, включая основные криптографические операции, управление ключами, конфигурацию и расширяемость.</span><span class="sxs-lookup"><span data-stu-id="69fdb-163">[Microsoft.AspNetCore.DataProtection](https://www.nuget.org/packages/Microsoft.AspNetCore.DataProtection/) contains the core implementation of the data protection system, including core cryptographic operations, key management, configuration, and extensibility.</span></span> <span data-ttu-id="69fdb-164">Создание экземпляра системы защиты данных (например, добавление ее в <xref:Microsoft.Extensions.DependencyInjection.IServiceCollection> ) или изменение или расширение его поведения, ссылки `Microsoft.AspNetCore.DataProtection` .</span><span class="sxs-lookup"><span data-stu-id="69fdb-164">To instantiate the data protection system (for example, adding it to an <xref:Microsoft.Extensions.DependencyInjection.IServiceCollection>) or modifying or extending its behavior, reference `Microsoft.AspNetCore.DataProtection`.</span></span>

* <span data-ttu-id="69fdb-165">[Microsoft. AspNetCore. в отношении защиты. Extensions](https://www.nuget.org/packages/Microsoft.AspNetCore.DataProtection.Extensions/) содержит дополнительные интерфейсы API, которые могут оказаться полезными для разработчиков, но не входят в основной пакет.</span><span class="sxs-lookup"><span data-stu-id="69fdb-165">[Microsoft.AspNetCore.DataProtection.Extensions](https://www.nuget.org/packages/Microsoft.AspNetCore.DataProtection.Extensions/) contains additional APIs which developers might find useful but which don't belong in the core package.</span></span> <span data-ttu-id="69fdb-166">Например, этот пакет содержит заводские методы для создания экземпляра системы защиты данных для хранения ключей в расположении в файловой системе без внедрения зависимостей (см. раздел <xref:Microsoft.AspNetCore.DataProtection.DataProtectionProvider> ).</span><span class="sxs-lookup"><span data-stu-id="69fdb-166">For instance, this package contains factory methods to instantiate the data protection system to store keys at a location on the file system without dependency injection (see <xref:Microsoft.AspNetCore.DataProtection.DataProtectionProvider>).</span></span> <span data-ttu-id="69fdb-167">Он также содержит методы расширения для ограничения времени существования защищенных полезных данных (см <xref:Microsoft.AspNetCore.DataProtection.ITimeLimitedDataProtector> .).</span><span class="sxs-lookup"><span data-stu-id="69fdb-167">It also contains extension methods for limiting the lifetime of protected payloads (see <xref:Microsoft.AspNetCore.DataProtection.ITimeLimitedDataProtector>).</span></span>

* <span data-ttu-id="69fdb-168">[Microsoft.AspNetCore.DataProtection.Sysтемвеб](https://www.nuget.org/packages/Microsoft.AspNetCore.DataProtection.SystemWeb/) можно установить в существующее приложение ASP.NET 4. x, чтобы перенаправить его `<machineKey>` операции для использования нового стека защиты данных ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="69fdb-168">[Microsoft.AspNetCore.DataProtection.SystemWeb](https://www.nuget.org/packages/Microsoft.AspNetCore.DataProtection.SystemWeb/) can be installed into an existing ASP.NET 4.x app to redirect its `<machineKey>` operations to use the new ASP.NET Core data protection stack.</span></span> <span data-ttu-id="69fdb-169">Для получения дополнительной информации см. <xref:security/data-protection/compatibility/replacing-machinekey>.</span><span class="sxs-lookup"><span data-stu-id="69fdb-169">For more information, see <xref:security/data-protection/compatibility/replacing-machinekey>.</span></span>

* <span data-ttu-id="69fdb-170">[Microsoft. AspNetCore. Cryptography. KeyDerivation](https://www.nuget.org/packages/Microsoft.AspNetCore.Cryptography.KeyDerivation/) предоставляет реализацию подпрограммы хэширования паролей PBKDF2 и может использоваться системами, которые должны безопасно обрабатывать пароли пользователей.</span><span class="sxs-lookup"><span data-stu-id="69fdb-170">[Microsoft.AspNetCore.Cryptography.KeyDerivation](https://www.nuget.org/packages/Microsoft.AspNetCore.Cryptography.KeyDerivation/) provides an implementation of the PBKDF2 password hashing routine and can be used by systems that must handle user passwords securely.</span></span> <span data-ttu-id="69fdb-171">Для получения дополнительной информации см. <xref:security/data-protection/consumer-apis/password-hashing>.</span><span class="sxs-lookup"><span data-stu-id="69fdb-171">For more information, see <xref:security/data-protection/consumer-apis/password-hashing>.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="69fdb-172">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="69fdb-172">Additional resources</span></span>

<xref:host-and-deploy/web-farm>
