---
title: Маршрутизация в ASP.NET Core
author: rick-anderson
description: Узнайте, как маршрутизация ASP.NET Core обеспечивает сопоставление HTTP-запросов и их распределение по исполняемым конечным точкам.
monikerRange: '>= aspnetcore-2.1'
ms.author: riande
ms.custom: mvc
ms.date: 4/1/2020
no-loc:
- ASP.NET Core Identity
- cookie
- Cookie
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: fundamentals/routing
ms.openlocfilehash: 46a9fc7776022a29bedf1c88e8230e1fd52d1607
ms.sourcegitcommit: d1a897ebd89daa05170ac448e4831d327f6b21a8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/01/2020
ms.locfileid: "91606761"
---
# <a name="routing-in-aspnet-core"></a><span data-ttu-id="777c4-103">Маршрутизация в ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="777c4-103">Routing in ASP.NET Core</span></span>

<span data-ttu-id="777c4-104">Авторы: [Райан Новак](https://github.com/rynowak) (Ryan Nowak), [Кирк Ларкин](https://twitter.com/serpent5) (Kirk Larkin) и [Рик Андерсон](https://twitter.com/RickAndMSFT) (Rick Anderson)</span><span class="sxs-lookup"><span data-stu-id="777c4-104">By [Ryan Nowak](https://github.com/rynowak), [Kirk Larkin](https://twitter.com/serpent5), and [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

::: moniker range=">= aspnetcore-3.0"

<span data-ttu-id="777c4-105">Маршрутизация обеспечивает сопоставление входящих HTTP-запросов и их распределение по исполняемым конечным точкам приложения.</span><span class="sxs-lookup"><span data-stu-id="777c4-105">Routing is responsible for matching incoming HTTP requests and dispatching those requests to the app's executable endpoints.</span></span> <span data-ttu-id="777c4-106">[Конечные точки](#endpoint) — это блоки исполняемого кода обработки запросов приложения.</span><span class="sxs-lookup"><span data-stu-id="777c4-106">[Endpoints](#endpoint) are the app's units of executable request-handling code.</span></span> <span data-ttu-id="777c4-107">Конечные точки определяются в приложении и настраиваются при его запуске.</span><span class="sxs-lookup"><span data-stu-id="777c4-107">Endpoints are defined in the app and configured when the app starts.</span></span> <span data-ttu-id="777c4-108">Процесс сопоставления конечных точек может извлекать значения из URL-адреса запроса и предоставлять эти значения для обработки запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-108">The endpoint matching process can extract values from the request's URL and provide those values for request processing.</span></span> <span data-ttu-id="777c4-109">С помощью сведений о конечных точках из приложения маршрутизация также может формировать URL-адреса, которые сопоставляются с конечными точками.</span><span class="sxs-lookup"><span data-stu-id="777c4-109">Using endpoint information from the app, routing is also able to generate URLs that map to endpoints.</span></span>

<span data-ttu-id="777c4-110">Приложения могут настраивать маршрутизацию с помощью следующего.</span><span class="sxs-lookup"><span data-stu-id="777c4-110">Apps can configure routing using:</span></span>

- <span data-ttu-id="777c4-111">Контроллеры</span><span class="sxs-lookup"><span data-stu-id="777c4-111">Controllers</span></span>
- <span data-ttu-id="777c4-112">Razor Pages</span><span class="sxs-lookup"><span data-stu-id="777c4-112">Razor Pages</span></span>
- SignalR
- <span data-ttu-id="777c4-113">Службы gRPC</span><span class="sxs-lookup"><span data-stu-id="777c4-113">gRPC Services</span></span>
- <span data-ttu-id="777c4-114">[ПО промежуточного слоя](xref:fundamentals/middleware/index) с поддержкой конечных точек, например [проверки работоспособности](xref:host-and-deploy/health-checks)</span><span class="sxs-lookup"><span data-stu-id="777c4-114">Endpoint-enabled [middleware](xref:fundamentals/middleware/index) such as [Health Checks](xref:host-and-deploy/health-checks).</span></span>
- <span data-ttu-id="777c4-115">Делегаты и лямбда-выражения, зарегистрированные с маршрутизацией</span><span class="sxs-lookup"><span data-stu-id="777c4-115">Delegates and lambdas registered with routing.</span></span>

<span data-ttu-id="777c4-116">В этом документе представлены сведения о низкоуровневой маршрутизации ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="777c4-116">This document covers low-level details of ASP.NET Core routing.</span></span> <span data-ttu-id="777c4-117">Дополнительные сведения о настройке маршрутизации</span><span class="sxs-lookup"><span data-stu-id="777c4-117">For information on configuring routing:</span></span>

* <span data-ttu-id="777c4-118">Для контроллеров — см. раздел <xref:mvc/controllers/routing>.</span><span class="sxs-lookup"><span data-stu-id="777c4-118">For controllers, see <xref:mvc/controllers/routing>.</span></span>
* <span data-ttu-id="777c4-119">Для соглашений Razor Pages — см. раздел <xref:razor-pages/razor-pages-conventions>.</span><span class="sxs-lookup"><span data-stu-id="777c4-119">For Razor Pages conventions, see <xref:razor-pages/razor-pages-conventions>.</span></span>

<span data-ttu-id="777c4-120">Система маршрутизации конечных точек, описанная в этом документе, применима к ASP.NET Core 3.0 и более поздних версий.</span><span class="sxs-lookup"><span data-stu-id="777c4-120">The endpoint routing system described in this document applies to ASP.NET Core 3.0 and later.</span></span> <span data-ttu-id="777c4-121">Чтобы получить сведения о предыдущей системе маршрутизации на основе <xref:Microsoft.AspNetCore.Routing.IRouter>, выберите версию ASP.NET Core 2.1, используя один из следующих методов.</span><span class="sxs-lookup"><span data-stu-id="777c4-121">For information on the previous routing system based on <xref:Microsoft.AspNetCore.Routing.IRouter>, select the ASP.NET Core 2.1 version using one of the following approaches:</span></span>

* <span data-ttu-id="777c4-122">Выбор версии для предыдущей версии.</span><span class="sxs-lookup"><span data-stu-id="777c4-122">The version selector for a previous version.</span></span>
* <span data-ttu-id="777c4-123">Выберите [маршрутизацию ASP.NET Core 2.1](?view=aspnetcore-2.1).</span><span class="sxs-lookup"><span data-stu-id="777c4-123">Select [ASP.NET Core 2.1 routing](?view=aspnetcore-2.1).</span></span>

<span data-ttu-id="777c4-124">[Просмотреть или скачать образец кода](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/fundamentals/routing/samples/3.x) ([как скачивать](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="777c4-124">[View or download sample code](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/fundamentals/routing/samples/3.x) ([how to download](xref:index#how-to-download-a-sample))</span></span>

<span data-ttu-id="777c4-125">Примеры этого документа для загрузки включены в определенном классе `Startup`.</span><span class="sxs-lookup"><span data-stu-id="777c4-125">The download samples for this document are enabled by a specific `Startup` class.</span></span> <span data-ttu-id="777c4-126">Чтобы выполнить конкретный пример, измените *Program.cs* для вызова нужного класса `Startup`.</span><span class="sxs-lookup"><span data-stu-id="777c4-126">To run a specific sample, modify *Program.cs* to call the desired `Startup` class.</span></span>

## <a name="routing-basics"></a><span data-ttu-id="777c4-127">Основы маршрутизации</span><span class="sxs-lookup"><span data-stu-id="777c4-127">Routing basics</span></span>

<span data-ttu-id="777c4-128">Все шаблоны ASP.NET Core включают маршрутизацию в созданном коде.</span><span class="sxs-lookup"><span data-stu-id="777c4-128">All ASP.NET Core templates include routing in the generated code.</span></span> <span data-ttu-id="777c4-129">Маршрутизация регистрируется в конвейере [ПО промежуточного слоя](xref:fundamentals/middleware/index) в `Startup.Configure`.</span><span class="sxs-lookup"><span data-stu-id="777c4-129">Routing is registered in the [middleware](xref:fundamentals/middleware/index) pipeline in `Startup.Configure`.</span></span>

<span data-ttu-id="777c4-130">В следующем коде приведен базовый пример маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-130">The following code shows a basic example of routing:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/Startup.cs?name=snippet&highlight=8,10)]

<span data-ttu-id="777c4-131">Маршрутизация использует пару ПО промежуточного слоя, зарегистрированную <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseRouting*> и <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseEndpoints*>.</span><span class="sxs-lookup"><span data-stu-id="777c4-131">Routing uses a pair of middleware, registered by <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseRouting*> and <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseEndpoints*>:</span></span>

* <span data-ttu-id="777c4-132">`UseRouting` добавляет соответствие маршрута в конвейер ПО промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="777c4-132">`UseRouting` adds route matching to the middleware pipeline.</span></span> <span data-ttu-id="777c4-133">Это ПО промежуточного слоя обращается к набору конечных точек, определенных в приложении, и выбирает [наиболее подходящее](#urlm) на основе запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-133">This middleware looks at the set of endpoints defined in the app, and selects the [best match](#urlm) based on the request.</span></span>
* <span data-ttu-id="777c4-134">`UseEndpoints` добавляет выполнение конечной точки в конвейер ПО промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="777c4-134">`UseEndpoints` adds endpoint execution to the middleware pipeline.</span></span> <span data-ttu-id="777c4-135">Он запускает делегат, связанный с выбранной конечной точкой.</span><span class="sxs-lookup"><span data-stu-id="777c4-135">It runs the delegate associated with the selected endpoint.</span></span>

<span data-ttu-id="777c4-136">В предыдущем примере имеется один *маршрут к конечной точке кода* с помощью метода [MapGet](xref:Microsoft.AspNetCore.Builder.EndpointRouteBuilderExtensions.MapGet*).</span><span class="sxs-lookup"><span data-stu-id="777c4-136">The preceding example includes a single *route to code* endpoint using the [MapGet](xref:Microsoft.AspNetCore.Builder.EndpointRouteBuilderExtensions.MapGet*) method:</span></span>

* <span data-ttu-id="777c4-137">При отправке HTTP-запроса `GET` на корневой URL-адрес `/`:</span><span class="sxs-lookup"><span data-stu-id="777c4-137">When an HTTP `GET` request is sent to the root URL `/`:</span></span>
  * <span data-ttu-id="777c4-138">Выполняется показанный делегат запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-138">The request delegate shown executes.</span></span>
  * <span data-ttu-id="777c4-139">В ответ HTTP записывается `Hello World!`.</span><span class="sxs-lookup"><span data-stu-id="777c4-139">`Hello World!` is written to the HTTP response.</span></span> <span data-ttu-id="777c4-140">Корневой URL-адрес `/` по умолчанию — `https://localhost:5001/`.</span><span class="sxs-lookup"><span data-stu-id="777c4-140">By default, the root URL `/` is `https://localhost:5001/`.</span></span>
* <span data-ttu-id="777c4-141">Если метод запроса не является `GET` или если корневой URL-адрес не `/`, сопоставление маршрута не выполняется и возвращается сообщение об ошибке HTTP 404.</span><span class="sxs-lookup"><span data-stu-id="777c4-141">If the request method is not `GET` or the root URL is not `/`, no route matches and an HTTP 404 is returned.</span></span>

### <a name="endpoint"></a><span data-ttu-id="777c4-142">Конечная точка</span><span class="sxs-lookup"><span data-stu-id="777c4-142">Endpoint</span></span>

<a name="endpoint"></a>

<span data-ttu-id="777c4-143">Для определения **конечной точки** используется метод `MapGet`.</span><span class="sxs-lookup"><span data-stu-id="777c4-143">The `MapGet` method is used to define an **endpoint**.</span></span> <span data-ttu-id="777c4-144">Конечная точка — это то, что можно:</span><span class="sxs-lookup"><span data-stu-id="777c4-144">An endpoint is something that can be:</span></span>

* <span data-ttu-id="777c4-145">выбрать путем сопоставления URL-адреса и метода HTTP;</span><span class="sxs-lookup"><span data-stu-id="777c4-145">Selected, by matching the URL and HTTP method.</span></span>
* <span data-ttu-id="777c4-146">выполнить путем запуска делегата.</span><span class="sxs-lookup"><span data-stu-id="777c4-146">Executed, by running the delegate.</span></span>

<span data-ttu-id="777c4-147">Конечные точки, которые могут быть сопоставлены и выполнены приложением, настраиваются в `UseEndpoints`.</span><span class="sxs-lookup"><span data-stu-id="777c4-147">Endpoints that can be matched and executed by the app are configured in `UseEndpoints`.</span></span> <span data-ttu-id="777c4-148">Например, <xref:Microsoft.AspNetCore.Builder.EndpointRouteBuilderExtensions.MapGet*>, <xref:Microsoft.AspNetCore.Builder.EndpointRouteBuilderExtensions.MapPost*> и [аналогичные методы](xref:Microsoft.AspNetCore.Builder.EndpointRouteBuilderExtensions) подключают делегаты запросов к системе маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-148">For example, <xref:Microsoft.AspNetCore.Builder.EndpointRouteBuilderExtensions.MapGet*>, <xref:Microsoft.AspNetCore.Builder.EndpointRouteBuilderExtensions.MapPost*>, and [similar methods](xref:Microsoft.AspNetCore.Builder.EndpointRouteBuilderExtensions) connect request delegates to the routing system.</span></span>
<span data-ttu-id="777c4-149">Для подключения функций платформы ASP.NET Core к системе маршрутизации можно использовать дополнительные методы.</span><span class="sxs-lookup"><span data-stu-id="777c4-149">Additional methods can be used to connect ASP.NET Core framework features to the routing system:</span></span>
- <span data-ttu-id="777c4-150">[MapRazorPages для Razor Pages](xref:Microsoft.AspNetCore.Builder.RazorPagesEndpointRouteBuilderExtensions.MapRazorPages*)</span><span class="sxs-lookup"><span data-stu-id="777c4-150">[MapRazorPages for Razor Pages](xref:Microsoft.AspNetCore.Builder.RazorPagesEndpointRouteBuilderExtensions.MapRazorPages*)</span></span>
- [<span data-ttu-id="777c4-151">MapControllers для контроллеров</span><span class="sxs-lookup"><span data-stu-id="777c4-151">MapControllers for controllers</span></span>](xref:Microsoft.AspNetCore.Builder.ControllerEndpointRouteBuilderExtensions.MapControllers*)
- <span data-ttu-id="777c4-152">[MapHub\<THub> для SignalR](xref:Microsoft.AspNetCore.SignalR.HubRouteBuilder.MapHub*)</span><span class="sxs-lookup"><span data-stu-id="777c4-152">[MapHub\<THub> for SignalR](xref:Microsoft.AspNetCore.SignalR.HubRouteBuilder.MapHub*)</span></span> 
- [<span data-ttu-id="777c4-153">MapGrpcService\<TService> для gRPC</span><span class="sxs-lookup"><span data-stu-id="777c4-153">MapGrpcService\<TService> for gRPC</span></span>](xref:grpc/aspnetcore)

<span data-ttu-id="777c4-154">Ниже представлен пример маршрутизации с более сложным шаблоном маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-154">The following example shows routing with a more sophisticated route template:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/RouteTemplateStartup.cs?name=snippet)]

<span data-ttu-id="777c4-155">Строка `/hello/{name:alpha}` является **шаблоном маршрута**.</span><span class="sxs-lookup"><span data-stu-id="777c4-155">The string `/hello/{name:alpha}` is a **route template**.</span></span> <span data-ttu-id="777c4-156">Она используется для настройки способа сопоставления конечной точки.</span><span class="sxs-lookup"><span data-stu-id="777c4-156">It is used to configure how the endpoint is matched.</span></span> <span data-ttu-id="777c4-157">В этом случае шаблон соответствует следующим условиям.</span><span class="sxs-lookup"><span data-stu-id="777c4-157">In this case, the template matches:</span></span>

* <span data-ttu-id="777c4-158">URL-адрес, подобный `/hello/Ryan`</span><span class="sxs-lookup"><span data-stu-id="777c4-158">A URL like `/hello/Ryan`</span></span>
* <span data-ttu-id="777c4-159">Любой URL-путь, начинающийся с `/hello/`,после которого следует набор буквенных символов.</span><span class="sxs-lookup"><span data-stu-id="777c4-159">Any URL path that begins with `/hello/` followed by a sequence of alphabetic characters.</span></span>  <span data-ttu-id="777c4-160">`:alpha` применяет ограничение маршрута, которое соответствует только буквенным символам.</span><span class="sxs-lookup"><span data-stu-id="777c4-160">`:alpha` applies a route constraint that matches only alphabetic characters.</span></span> <span data-ttu-id="777c4-161">[Ограничения маршрута](#route-constraint-reference) описаны далее в этом документе.</span><span class="sxs-lookup"><span data-stu-id="777c4-161">[Route constraints](#route-constraint-reference) are explained later in this document.</span></span>

<span data-ttu-id="777c4-162">Второй сегмент URL-пути, `{name:alpha}`:</span><span class="sxs-lookup"><span data-stu-id="777c4-162">The second segment of the URL path, `{name:alpha}`:</span></span>

* <span data-ttu-id="777c4-163">привязан к параметру `name`;</span><span class="sxs-lookup"><span data-stu-id="777c4-163">Is bound to the `name` parameter.</span></span>
* <span data-ttu-id="777c4-164">записывается и сохраняется в [HttpRequest.RouteValues](xref:Microsoft.AspNetCore.Http.HttpRequest.RouteValues*).</span><span class="sxs-lookup"><span data-stu-id="777c4-164">Is captured and stored in [HttpRequest.RouteValues](xref:Microsoft.AspNetCore.Http.HttpRequest.RouteValues*).</span></span>

<span data-ttu-id="777c4-165">Система маршрутизации конечных точек, описанная в этом документе, является новой и применяется, начиная с ASP.NET Core версии 3.0 и более поздней.</span><span class="sxs-lookup"><span data-stu-id="777c4-165">The endpoint routing system described in this document is new as of ASP.NET Core 3.0.</span></span> <span data-ttu-id="777c4-166">Однако все версии ASP.NET Core поддерживают один и тот же набор функций шаблона маршрута и ограничений маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-166">However, all versions of ASP.NET Core support the same set of route template features and route constraints.</span></span>

<span data-ttu-id="777c4-167">В следующем примере показана маршрутизация с [проверками работоспособности](xref:host-and-deploy/health-checks) и авторизацией.</span><span class="sxs-lookup"><span data-stu-id="777c4-167">The following example shows routing with [health checks](xref:host-and-deploy/health-checks) and authorization:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/AuthorizationStartup.cs?name=snippet)]

[!INCLUDE[request localized comments](~/includes/code-comments-loc.md)]

<span data-ttu-id="777c4-168">В предыдущем примере, показано то, как:</span><span class="sxs-lookup"><span data-stu-id="777c4-168">The preceding example demonstrates how:</span></span>

* <span data-ttu-id="777c4-169">ПО промежуточного слоя для авторизации можно использовать с маршрутизацией;</span><span class="sxs-lookup"><span data-stu-id="777c4-169">The authorization middleware can be used with routing.</span></span>
* <span data-ttu-id="777c4-170">можно использовать конечные точки для настройки режима авторизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-170">Endpoints can be used to configure authorization behavior.</span></span>

<span data-ttu-id="777c4-171">При вызове <xref:Microsoft.AspNetCore.Builder.HealthCheckEndpointRouteBuilderExtensions.MapHealthChecks*> добавляется конечная точка проверки работоспособности.</span><span class="sxs-lookup"><span data-stu-id="777c4-171">The <xref:Microsoft.AspNetCore.Builder.HealthCheckEndpointRouteBuilderExtensions.MapHealthChecks*> call adds a health check endpoint.</span></span> <span data-ttu-id="777c4-172">Связывание <xref:Microsoft.AspNetCore.Builder.AuthorizationEndpointConventionBuilderExtensions.RequireAuthorization*> с этим вызовом прикрепляет политику авторизации к конечной точке.</span><span class="sxs-lookup"><span data-stu-id="777c4-172">Chaining <xref:Microsoft.AspNetCore.Builder.AuthorizationEndpointConventionBuilderExtensions.RequireAuthorization*> on to this call attaches an authorization policy to the endpoint.</span></span>

<span data-ttu-id="777c4-173">При вызове <xref:Microsoft.AspNetCore.Builder.AuthAppBuilderExtensions.UseAuthentication*> и <xref:Microsoft.AspNetCore.Builder.AuthorizationAppBuilderExtensions.UseAuthorization*> добавляется ПО промежуточного слоя для проверки подлинности и авторизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-173">Calling <xref:Microsoft.AspNetCore.Builder.AuthAppBuilderExtensions.UseAuthentication*> and <xref:Microsoft.AspNetCore.Builder.AuthorizationAppBuilderExtensions.UseAuthorization*> adds the authentication and authorization middleware.</span></span> <span data-ttu-id="777c4-174">Это ПО промежуточного слоя размещается между методами <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseRouting*> и `UseEndpoints`, чтобы оно могло:</span><span class="sxs-lookup"><span data-stu-id="777c4-174">These middleware are placed between <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseRouting*> and `UseEndpoints` so that they can:</span></span>

* <span data-ttu-id="777c4-175">просматривать, какая конечная точка выбрана методом `UseRouting`;</span><span class="sxs-lookup"><span data-stu-id="777c4-175">See which endpoint was selected by `UseRouting`.</span></span>
* <span data-ttu-id="777c4-176">применять политику авторизации до отправки <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseEndpoints*> на конечную точку.</span><span class="sxs-lookup"><span data-stu-id="777c4-176">Apply an authorization policy before <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseEndpoints*> dispatches to the endpoint.</span></span>

<a name="metadata"></a>

### <a name="endpoint-metadata"></a><span data-ttu-id="777c4-177">Метаданные конечной точки</span><span class="sxs-lookup"><span data-stu-id="777c4-177">Endpoint metadata</span></span>

<span data-ttu-id="777c4-178">В предыдущем примере имеется две конечные точки, политика авторизации прикреплена только к конечной точке проверки работоспособности.</span><span class="sxs-lookup"><span data-stu-id="777c4-178">In the preceding example, there are two endpoints, but only the health check endpoint has an authorization policy attached.</span></span> <span data-ttu-id="777c4-179">Если запрос соответствует конечной точке проверки работоспособности, `/healthz`, выполняется проверка авторизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-179">If the request matches the health check endpoint, `/healthz`, an authorization check is performed.</span></span> <span data-ttu-id="777c4-180">Это служит демонстрацией того, что к конечным точкам можно прикреплять дополнительные данные.</span><span class="sxs-lookup"><span data-stu-id="777c4-180">This demonstrates that endpoints can have extra data attached to them.</span></span> <span data-ttu-id="777c4-181">Эти дополнительные данные называются **метаданными** конечных точек.</span><span class="sxs-lookup"><span data-stu-id="777c4-181">This extra data is called endpoint **metadata**:</span></span>

* <span data-ttu-id="777c4-182">Метаданные могут обрабатываться ПО промежуточного слоя с поддержкой маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-182">The metadata can be processed by routing-aware middleware.</span></span>
* <span data-ttu-id="777c4-183">Метаданные могут быть любого типа .NET.</span><span class="sxs-lookup"><span data-stu-id="777c4-183">The metadata can be of any .NET type.</span></span>

## <a name="routing-concepts"></a><span data-ttu-id="777c4-184">Основные понятия маршрутизации</span><span class="sxs-lookup"><span data-stu-id="777c4-184">Routing concepts</span></span>

<span data-ttu-id="777c4-185">Система маршрутизации формируется поверх конвейера ПО промежуточного слоя путем добавления эффективной системы **конечных точек**.</span><span class="sxs-lookup"><span data-stu-id="777c4-185">The routing system builds on top of the middleware pipeline by adding the powerful **endpoint** concept.</span></span> <span data-ttu-id="777c4-186">Конечные точки представляют собой единицы функциональности приложения, отличающиеся друг от друга в плане маршрутизации, авторизации и количества систем ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="777c4-186">Endpoints represent units of the app's functionality that are distinct from each other in terms of routing, authorization, and any number of ASP.NET Core's systems.</span></span>

<a name="endpoint"></a>

### <a name="aspnet-core-endpoint-definition"></a><span data-ttu-id="777c4-187">Определение конечной точки ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="777c4-187">ASP.NET Core endpoint definition</span></span>

<span data-ttu-id="777c4-188">Конечная точка ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="777c4-188">An ASP.NET Core endpoint is:</span></span>

* <span data-ttu-id="777c4-189">Исполняемая: имеет <xref:Microsoft.AspNetCore.Http.Endpoint.RequestDelegate>.</span><span class="sxs-lookup"><span data-stu-id="777c4-189">Executable: Has a <xref:Microsoft.AspNetCore.Http.Endpoint.RequestDelegate>.</span></span>
* <span data-ttu-id="777c4-190">Расширяемая: включает коллекцию [Metadata](xref:Microsoft.AspNetCore.Http.Endpoint.Metadata*).</span><span class="sxs-lookup"><span data-stu-id="777c4-190">Extensible: Has a [Metadata](xref:Microsoft.AspNetCore.Http.Endpoint.Metadata*) collection.</span></span>
* <span data-ttu-id="777c4-191">Selectable: при необходимости содержит [сведения о маршрутизации](xref:Microsoft.AspNetCore.Routing.RouteEndpoint.RoutePattern*).</span><span class="sxs-lookup"><span data-stu-id="777c4-191">Selectable: Optionally, has [routing information](xref:Microsoft.AspNetCore.Routing.RouteEndpoint.RoutePattern*).</span></span>
* <span data-ttu-id="777c4-192">Перечисляемая: коллекцию конечных точек можно получить путем извлечения <xref:Microsoft.AspNetCore.Routing.EndpointDataSource> из [DI](xref:fundamentals/dependency-injection).</span><span class="sxs-lookup"><span data-stu-id="777c4-192">Enumerable: The collection of endpoints can be listed by retrieving the <xref:Microsoft.AspNetCore.Routing.EndpointDataSource> from [DI](xref:fundamentals/dependency-injection).</span></span>

<span data-ttu-id="777c4-193">В следующем примере кода показано, как получить и проверить конечную точку, соответствующую текущему запросу.</span><span class="sxs-lookup"><span data-stu-id="777c4-193">The following code shows how to retrieve and inspect the endpoint matching the current request:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/EndpointInspectorStartup.cs?name=snippet)]

<span data-ttu-id="777c4-194">Конечную точку, если она выбрана, можно получить из `HttpContext`.</span><span class="sxs-lookup"><span data-stu-id="777c4-194">The endpoint, if selected, can be retrieved from the `HttpContext`.</span></span> <span data-ttu-id="777c4-195">Ее свойства можно проверить.</span><span class="sxs-lookup"><span data-stu-id="777c4-195">Its properties can be inspected.</span></span> <span data-ttu-id="777c4-196">Объекты конечных точек являются неизменяемыми, и их невозможно изменить после создания.</span><span class="sxs-lookup"><span data-stu-id="777c4-196">Endpoint objects are immutable and cannot be modified after creation.</span></span> <span data-ttu-id="777c4-197">Наиболее распространенным типом конечной точки является <xref:Microsoft.AspNetCore.Routing.RouteEndpoint>.</span><span class="sxs-lookup"><span data-stu-id="777c4-197">The most common type of endpoint is a <xref:Microsoft.AspNetCore.Routing.RouteEndpoint>.</span></span> <span data-ttu-id="777c4-198">`RouteEndpoint` содержит сведения, позволяющие системе маршрутизации выбрать эту конечную точку.</span><span class="sxs-lookup"><span data-stu-id="777c4-198">`RouteEndpoint` includes information that allows it to be to selected by the routing system.</span></span>

<span data-ttu-id="777c4-199">В приведенном выше коде [app.Use](xref:Microsoft.AspNetCore.Builder.UseExtensions.Use*) настраивает встроенное [ПО промежуточного слоя](xref:fundamentals/middleware/index).</span><span class="sxs-lookup"><span data-stu-id="777c4-199">In the preceding code, [app.Use](xref:Microsoft.AspNetCore.Builder.UseExtensions.Use*) configures an in-line [middleware](xref:fundamentals/middleware/index).</span></span>

<a name="mt"></a>

<span data-ttu-id="777c4-200">В следующем коде показано, что в зависимости от того, где в конвейере вызывается `app.Use`, может не быть конечной точки.</span><span class="sxs-lookup"><span data-stu-id="777c4-200">The following code shows that, depending on where `app.Use` is called in the pipeline, there may not be an endpoint:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/MiddlewareFlowStartup.cs?name=snippet)]

<span data-ttu-id="777c4-201">В предыдущем примере добавляются инструкции `Console.WriteLine`, которые показывают, выбрана ли конечная точка.</span><span class="sxs-lookup"><span data-stu-id="777c4-201">This preceding sample adds `Console.WriteLine` statements that display whether or not an endpoint has been selected.</span></span> <span data-ttu-id="777c4-202">Для ясности в примере указанной конечной точке `/` назначается отображаемое имя.</span><span class="sxs-lookup"><span data-stu-id="777c4-202">For clarity, the sample assigns a display name to the provided `/` endpoint.</span></span>

<span data-ttu-id="777c4-203">При выполнении этого кода с URL-адресом `/` отображается следующее.</span><span class="sxs-lookup"><span data-stu-id="777c4-203">Running this code with a URL of `/` displays:</span></span>

```txt
1. Endpoint: (null)
2. Endpoint: Hello
3. Endpoint: Hello
```

<span data-ttu-id="777c4-204">При выполнении этого кода с любым другим URL-адресом отображается следующее.</span><span class="sxs-lookup"><span data-stu-id="777c4-204">Running this code with any other URL displays:</span></span>

```txt
1. Endpoint: (null)
2. Endpoint: (null)
4. Endpoint: (null)
```

<span data-ttu-id="777c4-205">В этом выводе показано следующее.</span><span class="sxs-lookup"><span data-stu-id="777c4-205">This output demonstrates that:</span></span>

* <span data-ttu-id="777c4-206">Перед вызовом `UseRouting` конечная точка всегда имеет значение NULL.</span><span class="sxs-lookup"><span data-stu-id="777c4-206">The endpoint is always null before `UseRouting` is called.</span></span>
* <span data-ttu-id="777c4-207">Если найдено совпадение, конечная точка не имеет значение NULL между методами `UseRouting` и <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseEndpoints*>.</span><span class="sxs-lookup"><span data-stu-id="777c4-207">If a match is found, the endpoint is non-null between `UseRouting` and <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseEndpoints*>.</span></span>
* <span data-ttu-id="777c4-208">ПО промежуточного слоя `UseEndpoints` является **терминальным** при обнаружении соответствия.</span><span class="sxs-lookup"><span data-stu-id="777c4-208">The `UseEndpoints` middleware is **terminal** when a match is found.</span></span> <span data-ttu-id="777c4-209">Определение [терминального ПО промежуточного слоя](#tm) приведено далее в этом документе.</span><span class="sxs-lookup"><span data-stu-id="777c4-209">[Terminal middleware](#tm) is defined later in this document.</span></span>
* <span data-ttu-id="777c4-210">ПО промежуточного слоя после метода `UseEndpoints` выполняется, только если совпадения не найдены.</span><span class="sxs-lookup"><span data-stu-id="777c4-210">The middleware after `UseEndpoints` execute only when no match is found.</span></span>

<span data-ttu-id="777c4-211">ПО промежуточного слоя `UseRouting` использует метод [SetEndpoint](xref:Microsoft.AspNetCore.Http.EndpointHttpContextExtensions.SetEndpoint*), чтобы присоединить конечную точку к текущему контексту.</span><span class="sxs-lookup"><span data-stu-id="777c4-211">The `UseRouting` middleware uses the [SetEndpoint](xref:Microsoft.AspNetCore.Http.EndpointHttpContextExtensions.SetEndpoint*) method to attach the endpoint to the current context.</span></span> <span data-ttu-id="777c4-212">ПО промежуточного слоя `UseRouting` можно заменить на настраиваемую логику и по-прежнему использовать конечные точки.</span><span class="sxs-lookup"><span data-stu-id="777c4-212">It's possible to replace the `UseRouting` middleware with custom logic and still get the benefits of using endpoints.</span></span> <span data-ttu-id="777c4-213">Конечные точки — это низкоуровневые примитивы, такие как ПО промежуточного слоя, которые не связаны с реализацией маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-213">Endpoints are a low-level primitive like middleware, and aren't coupled to the routing implementation.</span></span> <span data-ttu-id="777c4-214">В большинстве приложений метод `UseRouting` не требуется заменять настраиваемой логикой.</span><span class="sxs-lookup"><span data-stu-id="777c4-214">Most apps don't need to replace `UseRouting` with custom logic.</span></span>

<span data-ttu-id="777c4-215">ПО промежуточного слоя `UseEndpoints` предназначено для использования совместно с ПО промежуточного слоя `UseRouting`.</span><span class="sxs-lookup"><span data-stu-id="777c4-215">The `UseEndpoints` middleware is designed to be used in tandem with the `UseRouting` middleware.</span></span> <span data-ttu-id="777c4-216">Основная логика для выполнения конечной точки достаточно проста.</span><span class="sxs-lookup"><span data-stu-id="777c4-216">The core logic to execute an endpoint isn't complicated.</span></span> <span data-ttu-id="777c4-217">Чтобы получить конечную точку, используйте <xref:Microsoft.AspNetCore.Http.EndpointHttpContextExtensions.GetEndpoint*>, а затем вызовите ее свойство <xref:Microsoft.AspNetCore.Http.Endpoint.RequestDelegate>.</span><span class="sxs-lookup"><span data-stu-id="777c4-217">Use <xref:Microsoft.AspNetCore.Http.EndpointHttpContextExtensions.GetEndpoint*> to retrieve the endpoint, and then invoke its <xref:Microsoft.AspNetCore.Http.Endpoint.RequestDelegate> property.</span></span>

<span data-ttu-id="777c4-218">В следующем примере кода показано, как ПО промежуточного слоя может влиять на маршрутизацию или реагировать на нее.</span><span class="sxs-lookup"><span data-stu-id="777c4-218">The following code demonstrates how middleware can influence or react to routing:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/IntegratedMiddlewareStartup.cs?name=snippet)]

<span data-ttu-id="777c4-219">В предыдущем примере показаны два важных основных понятия.</span><span class="sxs-lookup"><span data-stu-id="777c4-219">The preceding example demonstrates two important concepts:</span></span>

* <span data-ttu-id="777c4-220">ПО промежуточного слоя может выполняться до `UseRouting` для изменения данных, с которыми взаимодействует маршрутизация.</span><span class="sxs-lookup"><span data-stu-id="777c4-220">Middleware can run before `UseRouting` to modify the data that routing operates upon.</span></span>
    * <span data-ttu-id="777c4-221">Обычно ПО промежуточного слоя, отображаемое перед маршрутизацией, изменяет некоторое свойство запроса, например <xref:Microsoft.AspNetCore.Builder.RewriteBuilderExtensions.UseRewriter*>, <xref:Microsoft.AspNetCore.Builder.HttpMethodOverrideExtensions.UseHttpMethodOverride*> или <xref:Microsoft.AspNetCore.Builder.UsePathBaseExtensions.UsePathBase*>.</span><span class="sxs-lookup"><span data-stu-id="777c4-221">Usually middleware that appears before routing modifies some property of the request, such as <xref:Microsoft.AspNetCore.Builder.RewriteBuilderExtensions.UseRewriter*>, <xref:Microsoft.AspNetCore.Builder.HttpMethodOverrideExtensions.UseHttpMethodOverride*>, or <xref:Microsoft.AspNetCore.Builder.UsePathBaseExtensions.UsePathBase*>.</span></span>
* <span data-ttu-id="777c4-222">ПО промежуточного слоя может выполняться между `UseRouting` и <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseEndpoints*> для обработки результатов маршрутизации до выполнения конечной точки.</span><span class="sxs-lookup"><span data-stu-id="777c4-222">Middleware can run between `UseRouting` and <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseEndpoints*> to process the results of routing before the endpoint is executed.</span></span>
    * <span data-ttu-id="777c4-223">ПО промежуточного слоя, которое выполняется между `UseRouting` и `UseEndpoints`:</span><span class="sxs-lookup"><span data-stu-id="777c4-223">Middleware that runs between `UseRouting` and `UseEndpoints`:</span></span>
      * <span data-ttu-id="777c4-224">Обычно проверяет метаданные для получения представления о конечных точках.</span><span class="sxs-lookup"><span data-stu-id="777c4-224">Usually inspects metadata to understand the endpoints.</span></span>
      * <span data-ttu-id="777c4-225">Зачастую принимает решения по обеспечению безопасности, как это делается методами `UseAuthorization` и `UseCors`.</span><span class="sxs-lookup"><span data-stu-id="777c4-225">Often makes security decisions, as done by `UseAuthorization` and `UseCors`.</span></span>
    * <span data-ttu-id="777c4-226">Сочетание ПО промежуточного слоя и метаданных позволяет настраивать политики для каждой конечной точки.</span><span class="sxs-lookup"><span data-stu-id="777c4-226">The combination of middleware and metadata allows configuring policies per-endpoint.</span></span>

<span data-ttu-id="777c4-227">В приведенном выше коде показан пример настраиваемого ПО промежуточного слоя, поддерживающего политики для каждой конечной точки.</span><span class="sxs-lookup"><span data-stu-id="777c4-227">The preceding code shows an example of a custom middleware that supports per-endpoint policies.</span></span> <span data-ttu-id="777c4-228">ПО промежуточного слоя записывает в консоль *журнал аудита* доступа к конфиденциальным данным.</span><span class="sxs-lookup"><span data-stu-id="777c4-228">The middleware writes an *audit log* of access to sensitive data to the console.</span></span> <span data-ttu-id="777c4-229">ПО промежуточного слоя можно настроить на *аудит* конечной точки с помощью метаданных `AuditPolicyAttribute`.</span><span class="sxs-lookup"><span data-stu-id="777c4-229">The middleware can be configured to *audit* an endpoint with the `AuditPolicyAttribute` metadata.</span></span> <span data-ttu-id="777c4-230">В этом примере демонстрируется *выбор*, когда аудит выполняется только для конечных точек, помеченных как конфиденциальные.</span><span class="sxs-lookup"><span data-stu-id="777c4-230">This sample demonstrates an *opt-in* pattern where only endpoints that are marked as sensitive are audited.</span></span> <span data-ttu-id="777c4-231">Эту логику можно определить в обратном порядке для аудита всего, что не отмечено, например, как надежное.</span><span class="sxs-lookup"><span data-stu-id="777c4-231">It's possible to define this logic in reverse, auditing everything that isn't marked as safe, for example.</span></span> <span data-ttu-id="777c4-232">Система метаданных конечной точки обеспечивает гибкость.</span><span class="sxs-lookup"><span data-stu-id="777c4-232">The endpoint metadata system is flexible.</span></span> <span data-ttu-id="777c4-233">Эту логику можно настроить под любой требуемый вариант использования.</span><span class="sxs-lookup"><span data-stu-id="777c4-233">This logic could be designed in whatever way suits the use case.</span></span>

<span data-ttu-id="777c4-234">Предыдущий пример кода предназначен для демонстрации основных понятий конечных точек.</span><span class="sxs-lookup"><span data-stu-id="777c4-234">The preceding sample code is intended to demonstrate the basic concepts of endpoints.</span></span> <span data-ttu-id="777c4-235">**Он не предназначен для использования в рабочей среде**.</span><span class="sxs-lookup"><span data-stu-id="777c4-235">**The sample is not intended for production use**.</span></span> <span data-ttu-id="777c4-236">Более полная версия ПО промежуточного слоя *журнала аудита*:</span><span class="sxs-lookup"><span data-stu-id="777c4-236">A more complete version of an *audit log* middleware would:</span></span>

* <span data-ttu-id="777c4-237">Регистрирует сведения в файле или базе данных.</span><span class="sxs-lookup"><span data-stu-id="777c4-237">Log to a file or database.</span></span>
* <span data-ttu-id="777c4-238">Включает такие сведения, как информация о пользователе, IP-адресе, имени конфиденциальной конечной точки и многое другое.</span><span class="sxs-lookup"><span data-stu-id="777c4-238">Include details such as the user, IP address, name of the sensitive endpoint, and more.</span></span>

<span data-ttu-id="777c4-239">Метаданные политики аудита `AuditPolicyAttribute` определены как `Attribute`, чтобы их было проще использовать в платформах на основе классов, таких как контроллеры и SignalR.</span><span class="sxs-lookup"><span data-stu-id="777c4-239">The audit policy metadata `AuditPolicyAttribute` is defined as an `Attribute` for easier use with class-based frameworks such as controllers and SignalR.</span></span> <span data-ttu-id="777c4-240">При использовании *маршрута к коду*:</span><span class="sxs-lookup"><span data-stu-id="777c4-240">When using *route to code*:</span></span>

* <span data-ttu-id="777c4-241">Метаданные присоединяются к API-интерфейсу построителя.</span><span class="sxs-lookup"><span data-stu-id="777c4-241">Metadata is attached with a builder API.</span></span>
* <span data-ttu-id="777c4-242">При создании конечных точек платформы на основе классов включают все атрибуты в соответствующем методе и классе.</span><span class="sxs-lookup"><span data-stu-id="777c4-242">Class-based frameworks include all attributes on the corresponding method and class when creating endpoints.</span></span>

<span data-ttu-id="777c4-243">Типы метаданных рекомендуется определить либо как интерфейсы, либо как атрибуты.</span><span class="sxs-lookup"><span data-stu-id="777c4-243">The best practices for metadata types are to define them either as interfaces or attributes.</span></span> <span data-ttu-id="777c4-244">Интерфейсы и атрибуты допускают повторное использование кода.</span><span class="sxs-lookup"><span data-stu-id="777c4-244">Interfaces and attributes allow code reuse.</span></span> <span data-ttu-id="777c4-245">Система метаданных является гибкой и не накладывает никаких ограничений.</span><span class="sxs-lookup"><span data-stu-id="777c4-245">The metadata system is flexible and doesn't impose any limitations.</span></span>

<a name="tm"></a>

### <a name="comparing-a-terminal-middleware-and-routing"></a><span data-ttu-id="777c4-246">Сравнение терминального ПО промежуточного слоя и маршрутизации</span><span class="sxs-lookup"><span data-stu-id="777c4-246">Comparing a terminal middleware and routing</span></span>

<span data-ttu-id="777c4-247">В следующем примере кода использование ПО промежуточного слоя сравнивается с маршрутизацией.</span><span class="sxs-lookup"><span data-stu-id="777c4-247">The following code sample contrasts using middleware with using routing:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/TerminalMiddlewareStartup.cs?name=snippet)]

<span data-ttu-id="777c4-248">Стиль ПО промежуточного слоя, который показан в разделе `Approach 1:`, — **терминальное ПО промежуточного слоя**.</span><span class="sxs-lookup"><span data-stu-id="777c4-248">The style of middleware shown with `Approach 1:` is **terminal middleware**.</span></span> <span data-ttu-id="777c4-249">ПО промежуточного слоя называется терминальным, поскольку выполняет операцию сопоставления.</span><span class="sxs-lookup"><span data-stu-id="777c4-249">It's called terminal middleware because it does a matching operation:</span></span>

* <span data-ttu-id="777c4-250">Операция сопоставления в предыдущем примере — `Path == "/"` для ПО промежуточного слоя и `Path == "/Movie"` для маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-250">The matching operation in the preceding sample is `Path == "/"` for the middleware and `Path == "/Movie"` for routing.</span></span>
* <span data-ttu-id="777c4-251">Если сопоставление выполнено успешно, оно выполняет некоторые функции и возвращает результат, а не вызывает ПО промежуточного слоя `next`.</span><span class="sxs-lookup"><span data-stu-id="777c4-251">When a match is successful, it executes some functionality and returns, rather than invoking the `next` middleware.</span></span>

<span data-ttu-id="777c4-252">Оно называется терминальным, поскольку завершает поиск, выполняет некоторые функции, а затем возвращает результат.</span><span class="sxs-lookup"><span data-stu-id="777c4-252">It's called terminal middleware because it terminates the search, executes some functionality, and then returns.</span></span>

<span data-ttu-id="777c4-253">Сравнение терминального ПО промежуточного слоя и маршрутизации</span><span class="sxs-lookup"><span data-stu-id="777c4-253">Comparing a terminal middleware and routing:</span></span>
* <span data-ttu-id="777c4-254">Оба подхода позволяют завершать конвейер обработки:</span><span class="sxs-lookup"><span data-stu-id="777c4-254">Both approaches allow terminating the processing pipeline:</span></span>
    * <span data-ttu-id="777c4-255">ПО промежуточного слоя завершает конвейер, возвращая вместо вызова `next`.</span><span class="sxs-lookup"><span data-stu-id="777c4-255">Middleware terminates the pipeline by returning rather than invoking `next`.</span></span>
    * <span data-ttu-id="777c4-256">Конечные точки всегда являются терминальными.</span><span class="sxs-lookup"><span data-stu-id="777c4-256">Endpoints are always terminal.</span></span>
* <span data-ttu-id="777c4-257">Терминальное ПО промежуточного слоя позволяет размещать ПО промежуточного слоя в произвольном месте конвейера.</span><span class="sxs-lookup"><span data-stu-id="777c4-257">Terminal middleware allows positioning the middleware at an arbitrary place in the pipeline:</span></span>
    * <span data-ttu-id="777c4-258">Конечные точки выполняются в позиции <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseEndpoints*>.</span><span class="sxs-lookup"><span data-stu-id="777c4-258">Endpoints execute at the position of <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseEndpoints*>.</span></span>
* <span data-ttu-id="777c4-259">Терминальное ПО промежуточного слоя позволяет произвольному коду проверять соответствие ПО промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="777c4-259">Terminal middleware allows arbitrary code to determine when the middleware matches:</span></span>
    * <span data-ttu-id="777c4-260">Настраиваемый код сопоставления маршрутов может быть подробным и сложным для корректной записи.</span><span class="sxs-lookup"><span data-stu-id="777c4-260">Custom route matching code can be verbose and difficult to write correctly.</span></span>
    * <span data-ttu-id="777c4-261">Маршрутизация обеспечивает простые решения для обычных приложений.</span><span class="sxs-lookup"><span data-stu-id="777c4-261">Routing provides straightforward solutions for typical apps.</span></span> <span data-ttu-id="777c4-262">Большинству приложений не требуется настраиваемый код сопоставления маршрутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-262">Most apps don't require custom route matching code.</span></span>
* <span data-ttu-id="777c4-263">Интерфейс конечных точек с ПО промежуточного слоя, например `UseAuthorization` и `UseCors`.</span><span class="sxs-lookup"><span data-stu-id="777c4-263">Endpoints interface with middleware such as `UseAuthorization` and `UseCors`.</span></span>
    * <span data-ttu-id="777c4-264">Использование терминального ПО промежуточного слоя с `UseAuthorization` или `UseCors` требует взаимодействия вручную с системой авторизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-264">Using a terminal middleware with `UseAuthorization` or `UseCors` requires manual interfacing with the authorization system.</span></span>

<span data-ttu-id="777c4-265">[Конечная точка определяет](#endpoint) и то, и другое:</span><span class="sxs-lookup"><span data-stu-id="777c4-265">An [endpoint](#endpoint) defines both:</span></span>

* <span data-ttu-id="777c4-266">делегат для обработки запросов;</span><span class="sxs-lookup"><span data-stu-id="777c4-266">A delegate to process requests.</span></span>
* <span data-ttu-id="777c4-267">коллекцию произвольных метаданных.</span><span class="sxs-lookup"><span data-stu-id="777c4-267">A collection of arbitrary metadata.</span></span> <span data-ttu-id="777c4-268">Метаданные используются для реализации сквозной функциональности на основе политик и конфигурации каждой конечной точки.</span><span class="sxs-lookup"><span data-stu-id="777c4-268">The metadata is used to implement cross-cutting concerns based on policies and configuration attached to each endpoint.</span></span>

<span data-ttu-id="777c4-269">Терминальное ПО промежуточного слоя может быть эффективным средством, однако может потребоваться:</span><span class="sxs-lookup"><span data-stu-id="777c4-269">Terminal middleware can be an effective tool, but can require:</span></span>

* <span data-ttu-id="777c4-270">значительный объем кода и тестирования;</span><span class="sxs-lookup"><span data-stu-id="777c4-270">A significant amount of coding and testing.</span></span>
* <span data-ttu-id="777c4-271">интеграция вручную с другими системами для достижения желаемого уровня гибкости.</span><span class="sxs-lookup"><span data-stu-id="777c4-271">Manual integration with other systems to achieve the desired level of flexibility.</span></span>

<span data-ttu-id="777c4-272">Прежде чем создавать терминальное ПО промежуточного слоя, рассмотрите возможность интеграции с маршрутизацией.</span><span class="sxs-lookup"><span data-stu-id="777c4-272">Consider integrating with routing before writing a terminal middleware.</span></span>

<span data-ttu-id="777c4-273">Существующее терминальное ПО промежуточного слоя, которое интегрируется с [Map](xref:fundamentals/middleware/index#branch-the-middleware-pipeline) или <xref:Microsoft.AspNetCore.Builder.MapWhenExtensions.MapWhen*>, обычно может быть включено в конечную точку с поддержкой маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-273">Existing terminal middleware that integrates with [Map](xref:fundamentals/middleware/index#branch-the-middleware-pipeline) or <xref:Microsoft.AspNetCore.Builder.MapWhenExtensions.MapWhen*> can usually be turned into a routing aware endpoint.</span></span> <span data-ttu-id="777c4-274">[MapHealthChecks](https://github.com/aspnet/AspNetCore/blob/master/src/Middleware/HealthChecks/src/Builder/HealthCheckEndpointRouteBuilderExtensions.cs#L16) демонстрирует шаблон для маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-274">[MapHealthChecks](https://github.com/aspnet/AspNetCore/blob/master/src/Middleware/HealthChecks/src/Builder/HealthCheckEndpointRouteBuilderExtensions.cs#L16) demonstrates the pattern for router-ware:</span></span>
* <span data-ttu-id="777c4-275">Напишите метод расширения в <xref:Microsoft.AspNetCore.Routing.IEndpointRouteBuilder>.</span><span class="sxs-lookup"><span data-stu-id="777c4-275">Write an extension method on <xref:Microsoft.AspNetCore.Routing.IEndpointRouteBuilder>.</span></span>
* <span data-ttu-id="777c4-276">Создайте вложенный конвейер ПО промежуточного слоя с помощью <xref:Microsoft.AspNetCore.Routing.IEndpointRouteBuilder.CreateApplicationBuilder*>.</span><span class="sxs-lookup"><span data-stu-id="777c4-276">Create a nested middleware pipeline using <xref:Microsoft.AspNetCore.Routing.IEndpointRouteBuilder.CreateApplicationBuilder*>.</span></span>
* <span data-ttu-id="777c4-277">Присоедините ПО промежуточного слоя к новому конвейеру.</span><span class="sxs-lookup"><span data-stu-id="777c4-277">Attach the middleware to the new pipeline.</span></span> <span data-ttu-id="777c4-278">В этом случае — <xref:Microsoft.AspNetCore.Builder.HealthCheckApplicationBuilderExtensions.UseHealthChecks*>.</span><span class="sxs-lookup"><span data-stu-id="777c4-278">In this case, <xref:Microsoft.AspNetCore.Builder.HealthCheckApplicationBuilderExtensions.UseHealthChecks*>.</span></span>
* <span data-ttu-id="777c4-279"><xref:Microsoft.AspNetCore.Builder.IApplicationBuilder.Build*> конвейер ПО промежуточного слоя в <xref:Microsoft.AspNetCore.Http.RequestDelegate>.</span><span class="sxs-lookup"><span data-stu-id="777c4-279"><xref:Microsoft.AspNetCore.Builder.IApplicationBuilder.Build*> the middleware pipeline into a <xref:Microsoft.AspNetCore.Http.RequestDelegate>.</span></span>
* <span data-ttu-id="777c4-280">Вызовите `Map` и укажите новый конвейер ПО промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="777c4-280">Call `Map` and provide the new middleware pipeline.</span></span>
* <span data-ttu-id="777c4-281">Верните объект построителя, предоставленного `Map`, из метода расширения.</span><span class="sxs-lookup"><span data-stu-id="777c4-281">Return the builder object provided by `Map` from the extension method.</span></span>

<span data-ttu-id="777c4-282">В следующем коде показано использование [MapHealthChecks](xref:host-and-deploy/health-checks).</span><span class="sxs-lookup"><span data-stu-id="777c4-282">The following code shows use of [MapHealthChecks](xref:host-and-deploy/health-checks):</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/AuthorizationStartup.cs?name=snippet)]

<span data-ttu-id="777c4-283">В предыдущем примере показано, почему возврат объекта построителя имеет большое значение.</span><span class="sxs-lookup"><span data-stu-id="777c4-283">The preceding sample shows why returning the builder object is important.</span></span> <span data-ttu-id="777c4-284">Возврат объекта построителя позволяет разработчику приложения настраивать политики, такие как авторизация для конечной точки.</span><span class="sxs-lookup"><span data-stu-id="777c4-284">Returning the builder object allows the app developer to configure policies such as authorization for the endpoint.</span></span> <span data-ttu-id="777c4-285">В этом примере ПО промежуточного слоя проверки работоспособности не имеет прямой интеграции с системой авторизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-285">In this example, the health checks middleware has no direct integration with the authorization system.</span></span>

<span data-ttu-id="777c4-286">Для решения проблем, обнаруженных авторами расширения при использовании терминального ПО промежуточного слоя, была создана система метаданных.</span><span class="sxs-lookup"><span data-stu-id="777c4-286">The metadata system was created in response to the problems encountered by extensibility authors using terminal middleware.</span></span> <span data-ttu-id="777c4-287">Для каждого ПО промежуточного слоя достаточно проблематично реализовать собственную интеграцию с системой авторизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-287">It's problematic for each middleware to implement its own integration with the authorization system.</span></span>

<a name="urlm"></a>

### <a name="url-matching"></a><span data-ttu-id="777c4-288">Соответствие URL-адресов</span><span class="sxs-lookup"><span data-stu-id="777c4-288">URL matching</span></span>

* <span data-ttu-id="777c4-289">Это процесс, с помощью которого функция маршрутизации сопоставляет входящий запрос в [конечную точку](#endpoint).</span><span class="sxs-lookup"><span data-stu-id="777c4-289">Is the process by which routing matches an incoming request to an [endpoint](#endpoint).</span></span>
* <span data-ttu-id="777c4-290">Он основан на данных в URL-пути и заголовках.</span><span class="sxs-lookup"><span data-stu-id="777c4-290">Is based on data in the URL path and headers.</span></span>
* <span data-ttu-id="777c4-291">Его можно расширить, чтобы учесть любые данные в запросе.</span><span class="sxs-lookup"><span data-stu-id="777c4-291">Can be extended to consider any data in the request.</span></span>

<span data-ttu-id="777c4-292">При выполнении ПО промежуточного слоя маршрутизации оно задает конечную точку (`Endpoint`) и значения маршрута для [функции запроса](xref:fundamentals/request-features) в <xref:Microsoft.AspNetCore.Http.HttpContext> из текущего запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-292">When a routing middleware executes, it sets an `Endpoint` and route values to a [request feature](xref:fundamentals/request-features) on the <xref:Microsoft.AspNetCore.Http.HttpContext> from the current request:</span></span>

* <span data-ttu-id="777c4-293">Вызов [HttpContext.GetEndpoint](<xref:Microsoft.AspNetCore.Http.EndpointHttpContextExtensions.GetEndpoint*>) получает конечную точку.</span><span class="sxs-lookup"><span data-stu-id="777c4-293">Calling [HttpContext.GetEndpoint](<xref:Microsoft.AspNetCore.Http.EndpointHttpContextExtensions.GetEndpoint*>) gets the endpoint.</span></span>
* <span data-ttu-id="777c4-294">`HttpRequest.RouteValues` получает коллекцию значений маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-294">`HttpRequest.RouteValues` gets the collection of route values.</span></span>

<span data-ttu-id="777c4-295">[ПО промежуточного слоя](xref:fundamentals/middleware/index), которое выполняется после ПО промежуточного слоя маршрутизации, может проверить конечную точку и выполнять действия.</span><span class="sxs-lookup"><span data-stu-id="777c4-295">[Middleware](xref:fundamentals/middleware/index) running after the routing middleware can inspect the endpoint and take action.</span></span> <span data-ttu-id="777c4-296">Например, ПО промежуточного слоя авторизации может запросить политику авторизации у коллекции метаданных конечной точки.</span><span class="sxs-lookup"><span data-stu-id="777c4-296">For example, an authorization middleware can interrogate the endpoint's metadata collection for an authorization policy.</span></span> <span data-ttu-id="777c4-297">После выполнения всех экземпляров ПО промежуточного слоя в конвейере обработки запросов вызывается делегат выбранной конечной точки.</span><span class="sxs-lookup"><span data-stu-id="777c4-297">After all of the middleware in the request processing pipeline is executed, the selected endpoint's delegate is invoked.</span></span>

<span data-ttu-id="777c4-298">Система маршрутизации в маршрутизации по конечным точкам принимает все решения об отправке.</span><span class="sxs-lookup"><span data-stu-id="777c4-298">The routing system in endpoint routing is responsible for all dispatching decisions.</span></span> <span data-ttu-id="777c4-299">Поскольку ПО промежуточного слоя применяет политики, основанные на выбранной конечной точке, важно следующее.</span><span class="sxs-lookup"><span data-stu-id="777c4-299">Because the middleware applies policies based on the selected endpoint, it's important that:</span></span>

* <span data-ttu-id="777c4-300">Любые решения, которые могут повлиять на распределение или применение политик безопасности, должны выполняться внутри системы маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-300">Any decision that can affect dispatching or the application of security policies is made inside the routing system.</span></span>

> [!WARNING]
> <span data-ttu-id="777c4-301">Для обеспечения обратной совместимости, когда выполняются контроллер или делегат конечной точки Razor Pages, свойствам [RouteContext.RouteData](xref:Microsoft.AspNetCore.Routing.RouteContext.RouteData) присваиваются значения с учетом уже выполненной на текущий момент обработки.</span><span class="sxs-lookup"><span data-stu-id="777c4-301">For backwards-compatibility, when a Controller or Razor Pages endpoint delegate is executed, the properties of [RouteContext.RouteData](xref:Microsoft.AspNetCore.Routing.RouteContext.RouteData) are set to appropriate values based on the request processing performed thus far.</span></span>
>
> <span data-ttu-id="777c4-302">В следующем выпуске тип `RouteContext` будет помечен как устаревший.</span><span class="sxs-lookup"><span data-stu-id="777c4-302">The `RouteContext` type will be marked obsolete in a future release:</span></span>
>
> * <span data-ttu-id="777c4-303">Перенесите `RouteData.Values` в `HttpRequest.RouteValues`.</span><span class="sxs-lookup"><span data-stu-id="777c4-303">Migrate `RouteData.Values` to `HttpRequest.RouteValues`.</span></span>
> * <span data-ttu-id="777c4-304">Перенесите `RouteData.DataTokens`, чтобы получить [IDataTokensMetadata](xref:Microsoft.AspNetCore.Routing.IDataTokensMetadata) из метаданных конечной точки.</span><span class="sxs-lookup"><span data-stu-id="777c4-304">Migrate `RouteData.DataTokens` to retrieve [IDataTokensMetadata](xref:Microsoft.AspNetCore.Routing.IDataTokensMetadata) from the endpoint metadata.</span></span>

<span data-ttu-id="777c4-305">Работа сопоставления URL-адресов подразделяется на этапы, которые можно настроить.</span><span class="sxs-lookup"><span data-stu-id="777c4-305">URL matching operates in a configurable set of phases.</span></span> <span data-ttu-id="777c4-306">На каждом этапе выходные данные представляют собой набор совпадений.</span><span class="sxs-lookup"><span data-stu-id="777c4-306">In each phase, the output is a set of matches.</span></span> <span data-ttu-id="777c4-307">По мере перехода между этапами набор совпадений можно ограничивать.</span><span class="sxs-lookup"><span data-stu-id="777c4-307">The set of matches can be narrowed down further by the next phase.</span></span> <span data-ttu-id="777c4-308">Реализация маршрутизации не гарантирует порядок обработки для соответствующих конечных точек.</span><span class="sxs-lookup"><span data-stu-id="777c4-308">The routing implementation does not guarantee a processing order for matching endpoints.</span></span> <span data-ttu-id="777c4-309">**Все** возможные совпадения обрабатываются одновременно.</span><span class="sxs-lookup"><span data-stu-id="777c4-309">**All** possible matches are processed at once.</span></span> <span data-ttu-id="777c4-310">Этапы сопоставления URL-адресов выполняются в следующем порядке.</span><span class="sxs-lookup"><span data-stu-id="777c4-310">The URL matching phases occur in the following order.</span></span> <span data-ttu-id="777c4-311">ASP.NET Core:</span><span class="sxs-lookup"><span data-stu-id="777c4-311">ASP.NET Core:</span></span>

1. <span data-ttu-id="777c4-312">URL-путь обрабатывается по набору конечных точек и их шаблонов маршрутов, при этом выполняется сбор **всех** совпадений.</span><span class="sxs-lookup"><span data-stu-id="777c4-312">Processes the URL path against the set of endpoints and their route templates, collecting **all** of the matches.</span></span>
1. <span data-ttu-id="777c4-313">Принимается предыдущий список, и удаляются совпадения, которые не соответствуют примененным ограничениям маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-313">Takes the preceding list and removes matches that fail with route constraints applied.</span></span>
1. <span data-ttu-id="777c4-314">Принимается предыдущий список, и удаляются совпадения, которые не соответствуют набору экземпляров [MatcherPolicy](xref:Microsoft.AspNetCore.Routing.MatcherPolicy).</span><span class="sxs-lookup"><span data-stu-id="777c4-314">Takes the preceding list and removes matches that fail the set of [MatcherPolicy](xref:Microsoft.AspNetCore.Routing.MatcherPolicy) instances.</span></span>
1. <span data-ttu-id="777c4-315">Используется [EndpointSelector](xref:Microsoft.AspNetCore.Routing.Matching.EndpointSelector) для принятия окончательного решения из предыдущего списка.</span><span class="sxs-lookup"><span data-stu-id="777c4-315">Uses the [EndpointSelector](xref:Microsoft.AspNetCore.Routing.Matching.EndpointSelector) to make a final decision from the preceding list.</span></span>

<span data-ttu-id="777c4-316">Список конечных точек определяется по приоритету в соответствии со следующим.</span><span class="sxs-lookup"><span data-stu-id="777c4-316">The list of endpoints is prioritized according to:</span></span>

* <span data-ttu-id="777c4-317">[RouteEndpoint.Order](xref:Microsoft.AspNetCore.Routing.RouteEndpoint.Order*)</span><span class="sxs-lookup"><span data-stu-id="777c4-317">The [RouteEndpoint.Order](xref:Microsoft.AspNetCore.Routing.RouteEndpoint.Order*)</span></span>
* <span data-ttu-id="777c4-318">[Приоритет шаблона маршрута](#rtp)</span><span class="sxs-lookup"><span data-stu-id="777c4-318">The [route template precedence](#rtp)</span></span>

<span data-ttu-id="777c4-319">Все соответствующие конечные точки обрабатываются на каждом этапе до тех пор, пока не будет достигнут <xref:Microsoft.AspNetCore.Routing.Matching.EndpointSelector>.</span><span class="sxs-lookup"><span data-stu-id="777c4-319">All matching endpoints are processed in each phase until the <xref:Microsoft.AspNetCore.Routing.Matching.EndpointSelector> is reached.</span></span> <span data-ttu-id="777c4-320">`EndpointSelector` — это заключительный этап.</span><span class="sxs-lookup"><span data-stu-id="777c4-320">The `EndpointSelector` is the final phase.</span></span> <span data-ttu-id="777c4-321">Он выбирает конечную точку с наивысшим приоритетом из совпадений как наилучшее соответствие.</span><span class="sxs-lookup"><span data-stu-id="777c4-321">It chooses the highest priority endpoint from the matches as the best match.</span></span> <span data-ttu-id="777c4-322">При наличии других совпадений с тем же приоритетом, что и у наилучшего соответствия, создается исключение неоднозначного соответствия.</span><span class="sxs-lookup"><span data-stu-id="777c4-322">If there are other matches with the same priority as the best match, an ambiguous match exception is thrown.</span></span>

<span data-ttu-id="777c4-323">Приоритет маршрута вычисляется на основе **более определенного** шаблона маршрута, которому назначается более высокий приоритет.</span><span class="sxs-lookup"><span data-stu-id="777c4-323">The route precedence is computed based on a **more specific** route template being given a higher priority.</span></span> <span data-ttu-id="777c4-324">Например, рассмотрим шаблоны `/hello` и `/{message}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-324">For example, consider the templates `/hello` and `/{message}`:</span></span>

* <span data-ttu-id="777c4-325">Оба соответствуют URL-пути `/hello`.</span><span class="sxs-lookup"><span data-stu-id="777c4-325">Both match the URL path `/hello`.</span></span>
* <span data-ttu-id="777c4-326">`/hello` является более конкретным, и, следовательно, ему назначается более высокий приоритет.</span><span class="sxs-lookup"><span data-stu-id="777c4-326">`/hello`  is more specific and therefore higher priority.</span></span>

<span data-ttu-id="777c4-327">Как правило, приоритет маршрута помогает выбрать наилучшее соответствие для типов схем URL-адресов, используемых на практике.</span><span class="sxs-lookup"><span data-stu-id="777c4-327">In general, route precedence does a good job of choosing the best match for the kinds of URL schemes used in practice.</span></span> <span data-ttu-id="777c4-328">Используйте <xref:Microsoft.AspNetCore.Routing.RouteEndpoint.Order> только в случае, когда необходимо избежать неоднозначности.</span><span class="sxs-lookup"><span data-stu-id="777c4-328">Use <xref:Microsoft.AspNetCore.Routing.RouteEndpoint.Order> only when necessary to avoid an ambiguity.</span></span>

<span data-ttu-id="777c4-329">Ввиду различных типов расширяемости, предоставляемых службой маршрутизации, система маршрутизации не может заранее вычислить неоднозначные маршруты.</span><span class="sxs-lookup"><span data-stu-id="777c4-329">Due to the kinds of extensibility provided by routing, it isn't possible for the routing system to compute ahead of time the ambiguous routes.</span></span> <span data-ttu-id="777c4-330">Рассмотрим в качестве примера шаблоны маршрутов `/{message:alpha}` и `/{message:int}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-330">Consider an example such as the route templates `/{message:alpha}` and `/{message:int}`:</span></span>

* <span data-ttu-id="777c4-331">Ограничение `alpha` соответствует только буквенным символам.</span><span class="sxs-lookup"><span data-stu-id="777c4-331">The `alpha` constraint matches only alphabetic characters.</span></span>
* <span data-ttu-id="777c4-332">Ограничение `int` соответствует только числам.</span><span class="sxs-lookup"><span data-stu-id="777c4-332">The `int` constraint matches only numbers.</span></span>
* <span data-ttu-id="777c4-333">Эти шаблоны имеют одинаковый приоритет маршрута, однако не существует одного URL-адреса, по которому они совпадают.</span><span class="sxs-lookup"><span data-stu-id="777c4-333">These templates have the same route precedence, but there's no single URL they both match.</span></span>
* <span data-ttu-id="777c4-334">Если система маршрутизации сообщила об ошибке неоднозначности при запуске, это означает, что она заблокировала этот допустимый вариант использования.</span><span class="sxs-lookup"><span data-stu-id="777c4-334">If the routing system reported an ambiguity error at startup, it would block this valid use case.</span></span>

> [!WARNING]
>
> <span data-ttu-id="777c4-335">Порядок операций в <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseEndpoints*> не влияет на поведение маршрутизации, за одним исключением.</span><span class="sxs-lookup"><span data-stu-id="777c4-335">The order of operations inside <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseEndpoints*> doesn't influence the behavior of routing, with one exception.</span></span> <span data-ttu-id="777c4-336"><xref:Microsoft.AspNetCore.Builder.ControllerEndpointRouteBuilderExtensions.MapControllerRoute*> и <xref:Microsoft.AspNetCore.Builder.MvcAreaRouteBuilderExtensions.MapAreaRoute*> автоматически присваивают значение порядка своим конечным точкам в соответствии с порядком их вызова.</span><span class="sxs-lookup"><span data-stu-id="777c4-336"><xref:Microsoft.AspNetCore.Builder.ControllerEndpointRouteBuilderExtensions.MapControllerRoute*> and <xref:Microsoft.AspNetCore.Builder.MvcAreaRouteBuilderExtensions.MapAreaRoute*> automatically assign an order value to their endpoints based on the order they are invoked.</span></span> <span data-ttu-id="777c4-337">Это имитирует поведение контроллеров без системы маршрутизации в долгосрочной перспективе, предоставляя те же гарантии, что и в старых реализациях маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-337">This simulates long-time behavior of controllers without the routing system providing the same guarantees as older routing implementations.</span></span>
>
> <span data-ttu-id="777c4-338">В старой реализации маршрутизации можно реализовать расширяемость маршрутизации, которая зависит от порядка обработки маршрутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-338">In the legacy implementation of routing, it's possible to implement routing extensibility that has a dependency on the order in which routes are processed.</span></span> <span data-ttu-id="777c4-339">Маршрутизация конечных точек в ASP.NET Core 3.0 и более поздних версий</span><span class="sxs-lookup"><span data-stu-id="777c4-339">Endpoint routing in ASP.NET Core 3.0 and later:</span></span>
> 
> * <span data-ttu-id="777c4-340">Не имеет концепции маршрутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-340">Doesn't have a concept of routes.</span></span>
> * <span data-ttu-id="777c4-341">Не гарантирует порядок обработки.</span><span class="sxs-lookup"><span data-stu-id="777c4-341">Doesn't provide ordering guarantees.</span></span> <span data-ttu-id="777c4-342">Все конечные точки обрабатываются одновременно.</span><span class="sxs-lookup"><span data-stu-id="777c4-342">All endpoints are processed at once.</span></span>
>
> <span data-ttu-id="777c4-343">Если вы используете устаревшую систему маршрутизации, [обратитесь за помощью к сообществу GitHub](https://github.com/dotnet/aspnetcore/issues).</span><span class="sxs-lookup"><span data-stu-id="777c4-343">If this means you're stuck using the legacy routing system, [open a GitHub issue for assistance](https://github.com/dotnet/aspnetcore/issues).</span></span>

<a name="rtp"></a>

### <a name="route-template-precedence-and-endpoint-selection-order"></a><span data-ttu-id="777c4-344">Приоритет шаблонов маршрутов и порядок выбора конечных точек</span><span class="sxs-lookup"><span data-stu-id="777c4-344">Route template precedence and endpoint selection order</span></span>

<span data-ttu-id="777c4-345">[Приоритет шаблонов маршрутов](https://github.com/dotnet/aspnetcore/blob/master/src/Http/Routing/src/Template/RoutePrecedence.cs#L16) — это система, которая назначает каждому шаблону маршрута значение в зависимости от того, насколько он является конкретным.</span><span class="sxs-lookup"><span data-stu-id="777c4-345">[Route template precedence](https://github.com/dotnet/aspnetcore/blob/master/src/Http/Routing/src/Template/RoutePrecedence.cs#L16) is a system that assigns each route template a value based on how specific it is.</span></span> <span data-ttu-id="777c4-346">Приоритет шаблона маршрута</span><span class="sxs-lookup"><span data-stu-id="777c4-346">Route template precedence:</span></span>

* <span data-ttu-id="777c4-347">Позволяет избежать необходимости настраивать порядок конечных точек в общих случаях.</span><span class="sxs-lookup"><span data-stu-id="777c4-347">Avoids the need to adjust the order of endpoints in common cases.</span></span>
* <span data-ttu-id="777c4-348">Является попыткой сопоставить стандартные ожидания поведения маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-348">Attempts to match the common-sense expectations of routing behavior.</span></span>

<span data-ttu-id="777c4-349">Например, рассмотрим шаблоны `/Products/List` и `/Products/{id}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-349">For example, consider templates `/Products/List` and `/Products/{id}`.</span></span> <span data-ttu-id="777c4-350">Разумно предположить, что для URL-пути `/Products/List` `/Products/List` является лучшим соответствием, чем `/Products/{id}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-350">It would be reasonable to assume that `/Products/List` is a better match than `/Products/{id}` for the URL path `/Products/List`.</span></span> <span data-ttu-id="777c4-351">Литеральный сегмент `/List` считается более приоритетным, чем сегмент параметров `/{id}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-351">The works because the literal segment `/List` is considered to have better precedence than the parameter segment `/{id}`.</span></span>

<span data-ttu-id="777c4-352">Порядок определения приоритета связан с порядком определения шаблонов маршрутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-352">The details of how precedence works are coupled to how route templates are defined:</span></span>

* <span data-ttu-id="777c4-353">Шаблоны с большим количеством сегментов считаются более конкретными.</span><span class="sxs-lookup"><span data-stu-id="777c4-353">Templates with more segments are considered more specific.</span></span>
* <span data-ttu-id="777c4-354">Сегмент с литеральным текстом считается более конкретным, чем сегмент параметров.</span><span class="sxs-lookup"><span data-stu-id="777c4-354">A segment with literal text is considered more specific than a parameter segment.</span></span>
* <span data-ttu-id="777c4-355">Сегмент параметров с ограничением считается более конкретным, чем сегмент без него.</span><span class="sxs-lookup"><span data-stu-id="777c4-355">A parameter segment with a constraint is considered more specific than one without.</span></span>
* <span data-ttu-id="777c4-356">Сложный сегмент рассматривается как сегмент параметров с ограничением.</span><span class="sxs-lookup"><span data-stu-id="777c4-356">A complex segment is considered as specific as a parameter segment with a constraint.</span></span>
* <span data-ttu-id="777c4-357">Универсальные параметры являются менее конкретными.</span><span class="sxs-lookup"><span data-stu-id="777c4-357">Catch-all parameters are the least specific.</span></span> <span data-ttu-id="777c4-358">Важные сведения об универсальных маршрутах см. в разделе об **универсальных параметрах** в [справочнике по шаблонам маршрута](#rtr).</span><span class="sxs-lookup"><span data-stu-id="777c4-358">See **catch-all** in the [Route template reference](#rtr) for important information on catch-all routes.</span></span>

<span data-ttu-id="777c4-359">Справка по точным значениям приведена в [исходном коде в GitHub](https://github.com/dotnet/aspnetcore/blob/master/src/Http/Routing/src/Template/RoutePrecedence.cs#L189).</span><span class="sxs-lookup"><span data-stu-id="777c4-359">See the [source code on GitHub](https://github.com/dotnet/aspnetcore/blob/master/src/Http/Routing/src/Template/RoutePrecedence.cs#L189) for a reference of exact values.</span></span>

<a name="lg"></a>

### <a name="url-generation-concepts"></a><span data-ttu-id="777c4-360">Основные понятия формирования URL-адресов</span><span class="sxs-lookup"><span data-stu-id="777c4-360">URL generation concepts</span></span>

<span data-ttu-id="777c4-361">Формирование URL-адреса</span><span class="sxs-lookup"><span data-stu-id="777c4-361">URL generation:</span></span>

* <span data-ttu-id="777c4-362">Это процесс создания пути URL-адреса функцией маршрутизации на основе набора значений маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-362">Is the process by which routing can create a URL path based on a set of route values.</span></span>
* <span data-ttu-id="777c4-363">Обеспечивает логическое разделение конечных точек и URL-адресов, по которым к ним осуществляется доступ.</span><span class="sxs-lookup"><span data-stu-id="777c4-363">Allows for a logical separation between endpoints and the URLs that access them.</span></span>

<span data-ttu-id="777c4-364">Маршрутизация конечных точек включает в себя API генератора ссылок (<xref:Microsoft.AspNetCore.Routing.LinkGenerator>).</span><span class="sxs-lookup"><span data-stu-id="777c4-364">Endpoint routing includes the <xref:Microsoft.AspNetCore.Routing.LinkGenerator> API.</span></span> <span data-ttu-id="777c4-365">`LinkGenerator` — это одноэлементная служба, доступная в [DI](xref:fundamentals/dependency-injection).</span><span class="sxs-lookup"><span data-stu-id="777c4-365">`LinkGenerator` is a singleton service available from [DI](xref:fundamentals/dependency-injection).</span></span> <span data-ttu-id="777c4-366">API `LinkGenerator` можно использовать вне контекста выполнения запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-366">The `LinkGenerator` API can be used outside of the context of an executing request.</span></span> <span data-ttu-id="777c4-367">[Mvc.IUrlHelper](xref:Microsoft.AspNetCore.Mvc.IUrlHelper) и сценарии, которые зависят от <xref:Microsoft.AspNetCore.Mvc.IUrlHelper>, такие как [вспомогательные функции тегов](xref:mvc/views/tag-helpers/intro), вспомогательные методы HTML и [результаты действий](xref:mvc/controllers/actions), используют API `LinkGenerator` для предоставления возможностей создания ссылок.</span><span class="sxs-lookup"><span data-stu-id="777c4-367">[Mvc.IUrlHelper](xref:Microsoft.AspNetCore.Mvc.IUrlHelper) and scenarios that rely on <xref:Microsoft.AspNetCore.Mvc.IUrlHelper>, such as [Tag Helpers](xref:mvc/views/tag-helpers/intro), HTML Helpers, and [Action Results](xref:mvc/controllers/actions), use the `LinkGenerator` API internally to provide link generating capabilities.</span></span>

<span data-ttu-id="777c4-368">Генератор ссылок использует концепции **адреса** и **схем адресов**.</span><span class="sxs-lookup"><span data-stu-id="777c4-368">The link generator is backed by the concept of an **address** and **address schemes**.</span></span> <span data-ttu-id="777c4-369">Схема адресов — это способ определения конечных точек, которые должны рассматриваться для создания ссылки.</span><span class="sxs-lookup"><span data-stu-id="777c4-369">An address scheme is a way of determining the endpoints that should be considered for link generation.</span></span> <span data-ttu-id="777c4-370">Например, сценарии с именем маршрута и значениями маршрута, с которыми многие пользователи знакомы по контроллерам и Razor Pages, реализуются как схема адресов.</span><span class="sxs-lookup"><span data-stu-id="777c4-370">For example, the route name and route values scenarios many users are familiar with from controllers and Razor Pages are implemented as an address scheme.</span></span>

<span data-ttu-id="777c4-371">Генератор ссылок может установить связь с контроллерами и Razor Pages с помощью следующих методов расширения.</span><span class="sxs-lookup"><span data-stu-id="777c4-371">The link generator can link to controllers and Razor Pages via the following extension methods:</span></span>

* <xref:Microsoft.AspNetCore.Routing.ControllerLinkGeneratorExtensions.GetPathByAction*>
* <xref:Microsoft.AspNetCore.Routing.ControllerLinkGeneratorExtensions.GetUriByAction*>
* <xref:Microsoft.AspNetCore.Routing.PageLinkGeneratorExtensions.GetPathByPage*>
* <xref:Microsoft.AspNetCore.Routing.PageLinkGeneratorExtensions.GetUriByPage*>

<span data-ttu-id="777c4-372">Перегрузка этих методов принимает аргументы, которые включают `HttpContext`.</span><span class="sxs-lookup"><span data-stu-id="777c4-372">Overloads of these methods accept arguments that include the `HttpContext`.</span></span> <span data-ttu-id="777c4-373">Эти методы являются функциональными эквивалентами [Url.Action](xref:System.Web.Mvc.UrlHelper.Action*) и [Url.Page](xref:Microsoft.AspNetCore.Mvc.UrlHelperExtensions.Page*), но предлагают дополнительную гибкость и параметры.</span><span class="sxs-lookup"><span data-stu-id="777c4-373">These methods are functionally equivalent to [Url.Action](xref:System.Web.Mvc.UrlHelper.Action*) and [Url.Page](xref:Microsoft.AspNetCore.Mvc.UrlHelperExtensions.Page*), but offer additional flexibility and options.</span></span>

<span data-ttu-id="777c4-374">Методы `GetPath*` наиболее схожи с `Url.Action` и `Url.Page` в том, что создают URI, содержащий абсолютный путь.</span><span class="sxs-lookup"><span data-stu-id="777c4-374">The `GetPath*` methods are most similar to `Url.Action` and `Url.Page`, in that they generate a URI containing an absolute path.</span></span> <span data-ttu-id="777c4-375">Методы `GetUri*` всегда создают абсолютный URI, содержащий схему и узел.</span><span class="sxs-lookup"><span data-stu-id="777c4-375">The `GetUri*` methods always generate an absolute URI containing a scheme and host.</span></span> <span data-ttu-id="777c4-376">Методы, которые принимают `HttpContext`, создают URI в контексте выполнения запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-376">The methods that accept an `HttpContext` generate a URI in the context of the executing request.</span></span> <span data-ttu-id="777c4-377">Используются значения [окружения](#ambient) маршрута, базовый URL-адрес, схема и узел из выполняющегося запроса, если не указано иное.</span><span class="sxs-lookup"><span data-stu-id="777c4-377">The [ambient](#ambient) route values, URL base path, scheme, and host from the executing request are used unless overridden.</span></span>

<span data-ttu-id="777c4-378"><xref:Microsoft.AspNetCore.Routing.LinkGenerator> вызывается с адресом.</span><span class="sxs-lookup"><span data-stu-id="777c4-378"><xref:Microsoft.AspNetCore.Routing.LinkGenerator> is called with an address.</span></span> <span data-ttu-id="777c4-379">Создание URI происходит в два этапа:</span><span class="sxs-lookup"><span data-stu-id="777c4-379">Generating a URI occurs in two steps:</span></span>

1. <span data-ttu-id="777c4-380">Адрес привязан к списку конечных точек, соответствующих адресу.</span><span class="sxs-lookup"><span data-stu-id="777c4-380">An address is bound to a list of endpoints that match the address.</span></span>
1. <span data-ttu-id="777c4-381"><xref:Microsoft.AspNetCore.Routing.RouteEndpoint.RoutePattern> конечной точки вычисляется, пока не будет найден шаблон маршрута, который соответствует предоставленным значениям.</span><span class="sxs-lookup"><span data-stu-id="777c4-381">Each endpoint's <xref:Microsoft.AspNetCore.Routing.RouteEndpoint.RoutePattern> is evaluated until a route pattern that matches the supplied values is found.</span></span> <span data-ttu-id="777c4-382">Полученный результат объединяется с другими частями URI, предоставленными генератору ссылок и возвращенными.</span><span class="sxs-lookup"><span data-stu-id="777c4-382">The resulting output is combined with the other URI parts supplied to the link generator and returned.</span></span>

<span data-ttu-id="777c4-383">Методы, предоставляемые <xref:Microsoft.AspNetCore.Routing.LinkGenerator>, поддерживают стандартные возможности создания ссылки для любого типа адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-383">The methods provided by <xref:Microsoft.AspNetCore.Routing.LinkGenerator> support standard link generation capabilities for any type of address.</span></span> <span data-ttu-id="777c4-384">Самый удобный способ использовать генератор ссылки — через методы расширения, которые выполняют операции для определенного типа адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-384">The most convenient way to use the link generator is through extension methods that perform operations for a specific address type:</span></span>

| <span data-ttu-id="777c4-385">Метод расширения</span><span class="sxs-lookup"><span data-stu-id="777c4-385">Extension Method</span></span> | <span data-ttu-id="777c4-386">Описание</span><span class="sxs-lookup"><span data-stu-id="777c4-386">Description</span></span> |
| ---------------- | ----------- |
| <xref:Microsoft.AspNetCore.Routing.LinkGenerator.GetPathByAddress*> | <span data-ttu-id="777c4-387">Создает URI с абсолютным путем на основе предоставленных значений.</span><span class="sxs-lookup"><span data-stu-id="777c4-387">Generates a URI with an absolute path based on the provided values.</span></span> |
| <xref:Microsoft.AspNetCore.Routing.LinkGenerator.GetUriByAddress*> | <span data-ttu-id="777c4-388">Создает абсолютный URI на основе предоставленных значений.</span><span class="sxs-lookup"><span data-stu-id="777c4-388">Generates an absolute URI based on the provided values.</span></span>             |

> [!WARNING]
> <span data-ttu-id="777c4-389">Обратите внимание на следующие последствия вызова методов <xref:Microsoft.AspNetCore.Routing.LinkGenerator>:</span><span class="sxs-lookup"><span data-stu-id="777c4-389">Pay attention to the following implications of calling <xref:Microsoft.AspNetCore.Routing.LinkGenerator> methods:</span></span>
>
> * <span data-ttu-id="777c4-390">Используйте методы расширения `GetUri*` с осторожностью в конфигурации приложения, которая не проверяет заголовок входящих запросов `Host`.</span><span class="sxs-lookup"><span data-stu-id="777c4-390">Use `GetUri*` extension methods with caution in an app configuration that doesn't validate the `Host` header of incoming requests.</span></span> <span data-ttu-id="777c4-391">Если не проверить заголовок входящих запросов `Host`, входные данные в запросе без доверия могут отправляться обратно клиенту в URI в представлении или на странице.</span><span class="sxs-lookup"><span data-stu-id="777c4-391">If the `Host` header of incoming requests isn't validated, untrusted request input can be sent back to the client in URIs in a view or page.</span></span> <span data-ttu-id="777c4-392">Рекомендуется, чтобы все рабочие приложения настраивали свой сервер на проверку заголовка `Host` относительно известных допустимых значений.</span><span class="sxs-lookup"><span data-stu-id="777c4-392">We recommend that all production apps configure their server to validate the `Host` header against known valid values.</span></span>
>
> * <span data-ttu-id="777c4-393">Используйте <xref:Microsoft.AspNetCore.Routing.LinkGenerator> с осторожностью в ПО промежуточного слоя в сочетании с `Map` или `MapWhen`.</span><span class="sxs-lookup"><span data-stu-id="777c4-393">Use <xref:Microsoft.AspNetCore.Routing.LinkGenerator> with caution in middleware in combination with `Map` or `MapWhen`.</span></span> <span data-ttu-id="777c4-394">`Map*` изменяет базовый путь выполняющегося запроса, что влияет на выходные данные создания ссылки.</span><span class="sxs-lookup"><span data-stu-id="777c4-394">`Map*` changes the base path of the executing request, which affects the output of link generation.</span></span> <span data-ttu-id="777c4-395">Все API <xref:Microsoft.AspNetCore.Routing.LinkGenerator> разрешают указание базового пути.</span><span class="sxs-lookup"><span data-stu-id="777c4-395">All of the <xref:Microsoft.AspNetCore.Routing.LinkGenerator> APIs allow specifying a base path.</span></span> <span data-ttu-id="777c4-396">Укажите пустой базовый путь для отмены влияния `Map*` на создание ссылок.</span><span class="sxs-lookup"><span data-stu-id="777c4-396">Specify an empty base path to undo the `Map*` affect on link generation.</span></span>

### <a name="middleware-example"></a><span data-ttu-id="777c4-397">Пример ПО промежуточного слоя</span><span class="sxs-lookup"><span data-stu-id="777c4-397">Middleware example</span></span>

<span data-ttu-id="777c4-398">В следующем примере ПО промежуточного слоя использует API <xref:Microsoft.AspNetCore.Routing.LinkGenerator>, чтобы создать ссылку на метод действия, который перечисляет хранимые продукты.</span><span class="sxs-lookup"><span data-stu-id="777c4-398">In the following example, a middleware uses the <xref:Microsoft.AspNetCore.Routing.LinkGenerator> API to create a link to an action method that lists store products.</span></span> <span data-ttu-id="777c4-399">Использование генератора ссылок путем его внедрения в класс и вызова `GenerateLink` доступно для любого класса в приложении.</span><span class="sxs-lookup"><span data-stu-id="777c4-399">Using the link generator by injecting it into a class and calling `GenerateLink` is available to any class in an app:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/Middleware/ProductsLinkMiddleware.cs?name=snippet)]

<a name="rtr"></a>

## <a name="route-template-reference"></a><span data-ttu-id="777c4-400">Справочник по шаблону маршрута</span><span class="sxs-lookup"><span data-stu-id="777c4-400">Route template reference</span></span>

<span data-ttu-id="777c4-401">Токены в фигурных скобках (`{}`) определяют параметры маршрута, которые будут привязаны при совпадении маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-401">Tokens within `{}` define route parameters that are bound if the route is matched.</span></span> <span data-ttu-id="777c4-402">В сегменте маршрута можно определить несколько параметров маршрута, однако они должны разделяться литеральным значением.</span><span class="sxs-lookup"><span data-stu-id="777c4-402">More than one route parameter can be defined in a route segment, but route parameters  must be separated by a literal value.</span></span> <span data-ttu-id="777c4-403">Например, `{controller=Home}{action=Index}` будет недопустимым маршрутом, так как между `{controller}` и `{action}` нет литерального значения.</span><span class="sxs-lookup"><span data-stu-id="777c4-403">For example, `{controller=Home}{action=Index}` isn't a valid route, since there's no literal value between `{controller}` and `{action}`.</span></span>  <span data-ttu-id="777c4-404">Параметрам маршрута должны быть присвоены имена, и для них могут быть определены дополнительные атрибуты.</span><span class="sxs-lookup"><span data-stu-id="777c4-404">Route parameters must have a name and may have additional attributes specified.</span></span>

<span data-ttu-id="777c4-405">Весь текст, кроме параметров маршрута (например, `{id}`) и разделителя пути `/`, должен соответствовать тексту в URL-адресе.</span><span class="sxs-lookup"><span data-stu-id="777c4-405">Literal text other than route parameters (for example, `{id}`) and the path separator `/` must match the text in the URL.</span></span> <span data-ttu-id="777c4-406">Сопоставление текста производится без учета регистра на основе декодированного представления пути URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-406">Text matching is case-insensitive and based on the decoded representation of the URL's path.</span></span> <span data-ttu-id="777c4-407">Для сопоставления с литеральным разделителем параметров маршрута (`{` или `}`) разделитель следует экранировать путем повтора символа.</span><span class="sxs-lookup"><span data-stu-id="777c4-407">To match a literal route parameter delimiter `{` or `}`, escape the delimiter by repeating the character.</span></span> <span data-ttu-id="777c4-408">Например, `{{` или `}}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-408">For example `{{` or `}}`.</span></span>

<span data-ttu-id="777c4-409">Звездочка `*` или двойная звездочка `**`:</span><span class="sxs-lookup"><span data-stu-id="777c4-409">Asterisk `*` or double asterisk `**`:</span></span>

* <span data-ttu-id="777c4-410">Можно использовать в качестве префикса параметра маршрута для привязки к остальной части URI.</span><span class="sxs-lookup"><span data-stu-id="777c4-410">Can be used as a prefix to a route parameter to bind to the rest of the URI.</span></span>
* <span data-ttu-id="777c4-411">Такие параметры называются **универсальными**.</span><span class="sxs-lookup"><span data-stu-id="777c4-411">Are called a **catch-all** parameters.</span></span> <span data-ttu-id="777c4-412">Например, `blog/{**slug}`:</span><span class="sxs-lookup"><span data-stu-id="777c4-412">For example, `blog/{**slug}`:</span></span>
  * <span data-ttu-id="777c4-413">Соответствует любому URI, который начинается с `/blog` и имеет любое значение после него.</span><span class="sxs-lookup"><span data-stu-id="777c4-413">Matches any URI that starts with `/blog` and has any value following it.</span></span>
  * <span data-ttu-id="777c4-414">Значение после `/blog` присваивается значению [динамического](https://developer.mozilla.org/docs/Glossary/Slug) маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-414">The value following `/blog` is assigned to the [slug](https://developer.mozilla.org/docs/Glossary/Slug) route value.</span></span>

[!INCLUDE[](~/includes/catchall.md)]

<span data-ttu-id="777c4-415">Универсальные параметры также могут соответствовать пустой строке.</span><span class="sxs-lookup"><span data-stu-id="777c4-415">Catch-all parameters can also match the empty string.</span></span>

<span data-ttu-id="777c4-416">Универсальный параметр экранирует соответствующие символы, если маршрут использует для формирования URL-адрес, включая символы разделителей пути (`/`).</span><span class="sxs-lookup"><span data-stu-id="777c4-416">The catch-all parameter escapes the appropriate characters when the route is used to generate a URL, including path separator `/` characters.</span></span> <span data-ttu-id="777c4-417">Например, маршрут `foo/{*path}` со значениями маршрутов `{ path = "my/path" }` формирует `foo/my%2Fpath`.</span><span class="sxs-lookup"><span data-stu-id="777c4-417">For example, the route `foo/{*path}` with route values `{ path = "my/path" }` generates `foo/my%2Fpath`.</span></span> <span data-ttu-id="777c4-418">Обратите внимание на экранированный знак косой черты.</span><span class="sxs-lookup"><span data-stu-id="777c4-418">Note the escaped forward slash.</span></span> <span data-ttu-id="777c4-419">В качестве символов разделителя кругового пути используйте префикс параметра маршрута `**`.</span><span class="sxs-lookup"><span data-stu-id="777c4-419">To round-trip path separator characters, use the `**` route parameter prefix.</span></span> <span data-ttu-id="777c4-420">Маршрут `foo/{**path}` с `{ path = "my/path" }` формирует `foo/my/path`.</span><span class="sxs-lookup"><span data-stu-id="777c4-420">The route `foo/{**path}` with `{ path = "my/path" }` generates `foo/my/path`.</span></span>

<span data-ttu-id="777c4-421">Шаблоны URL-адресов, которые пытаются получить имя файла с необязательным расширением, имеют свои особенности.</span><span class="sxs-lookup"><span data-stu-id="777c4-421">URL patterns that attempt to capture a file name with an optional file extension have additional considerations.</span></span> <span data-ttu-id="777c4-422">Например, рассмотрим шаблон `files/{filename}.{ext?}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-422">For example, consider the template `files/{filename}.{ext?}`.</span></span> <span data-ttu-id="777c4-423">Когда значения для `filename` и `ext` существуют, заполняются оба значения.</span><span class="sxs-lookup"><span data-stu-id="777c4-423">When values for both `filename` and `ext` exist, both values are populated.</span></span> <span data-ttu-id="777c4-424">Если в URL-адресе есть только значение для `filename`, маршрут совпадает, так как точка в конце (`.`) является необязательной.</span><span class="sxs-lookup"><span data-stu-id="777c4-424">If only a value for `filename` exists in the URL, the route matches because the trailing `.` is  optional.</span></span> <span data-ttu-id="777c4-425">Следующие URL-адреса соответствуют этому маршруту:</span><span class="sxs-lookup"><span data-stu-id="777c4-425">The following URLs match this route:</span></span>

* `/files/myFile.txt`
* `/files/myFile`

<span data-ttu-id="777c4-426">Параметры маршрута могут иметь **значения по умолчанию**. Они указываются после имени параметра и знака равенства (`=`).</span><span class="sxs-lookup"><span data-stu-id="777c4-426">Route parameters may have **default values** designated by specifying the default value after the parameter name separated by an equals sign (`=`).</span></span> <span data-ttu-id="777c4-427">Например, `{controller=Home}` определяет `Home` в качестве значения по умолчанию для `controller`.</span><span class="sxs-lookup"><span data-stu-id="777c4-427">For example, `{controller=Home}` defines `Home` as the default value for `controller`.</span></span> <span data-ttu-id="777c4-428">Значение по умолчанию используется, если для параметра нет значения в URL-адресе.</span><span class="sxs-lookup"><span data-stu-id="777c4-428">The default value is used if no value is present in the URL for the parameter.</span></span> <span data-ttu-id="777c4-429">Параметры маршрута могут быть необязательными, для этого необходимо добавить вопросительный знак (`?`) в конец имени параметра.</span><span class="sxs-lookup"><span data-stu-id="777c4-429">Route parameters are made optional by appending a question mark (`?`) to the end of the parameter name.</span></span> <span data-ttu-id="777c4-430">Например, `id?`.</span><span class="sxs-lookup"><span data-stu-id="777c4-430">For example, `id?`.</span></span> <span data-ttu-id="777c4-431">Разница между необязательными значениями и параметрами маршрута по умолчанию</span><span class="sxs-lookup"><span data-stu-id="777c4-431">The difference between optional values and default route parameters is:</span></span>

* <span data-ttu-id="777c4-432">Параметр маршрута со значением по умолчанию всегда создает значение.</span><span class="sxs-lookup"><span data-stu-id="777c4-432">A route parameter with a default value always produces a value.</span></span>
* <span data-ttu-id="777c4-433">Необязательный параметр имеет значение только в том случае, если в URL-адресе запроса указано значение.</span><span class="sxs-lookup"><span data-stu-id="777c4-433">An optional parameter has a value only when a value is provided by the request URL.</span></span>

<span data-ttu-id="777c4-434">Параметры маршрута могут иметь ограничения, которые должны соответствовать значению маршрута из URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-434">Route parameters may have constraints that must match the route value bound from the URL.</span></span> <span data-ttu-id="777c4-435">Добавив двоеточие (`:`) и имя ограничения после имени параметра маршрута, можно указать встроенные ограничения для параметра маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-435">Adding `:` and constraint name after the route parameter name specifies an inline constraint on a route parameter.</span></span> <span data-ttu-id="777c4-436">Если для ограничения требуются аргументы, они указываются в скобках `(...)` после имени ограничения.</span><span class="sxs-lookup"><span data-stu-id="777c4-436">If the constraint requires arguments, they're enclosed in parentheses `(...)` after the constraint name.</span></span> <span data-ttu-id="777c4-437">Чтобы указать несколько *встроенных ограничений*, добавьте еще одно двоеточие (`:`) и имя ограничения.</span><span class="sxs-lookup"><span data-stu-id="777c4-437">Multiple *inline constraints* can be specified by appending another `:` and constraint name.</span></span>

<span data-ttu-id="777c4-438">Имя и аргументы ограничения передаются в службу <xref:Microsoft.AspNetCore.Routing.IInlineConstraintResolver> для создания экземпляра интерфейса <xref:Microsoft.AspNetCore.Routing.IRouteConstraint>, который будет использоваться при обработке URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-438">The constraint name and arguments are passed to the <xref:Microsoft.AspNetCore.Routing.IInlineConstraintResolver> service to create an instance of <xref:Microsoft.AspNetCore.Routing.IRouteConstraint> to use in URL processing.</span></span> <span data-ttu-id="777c4-439">Например, в шаблоне маршрута `blog/{article:minlength(10)}` определяется ограничение `minlength` с аргументом `10`.</span><span class="sxs-lookup"><span data-stu-id="777c4-439">For example, the route template `blog/{article:minlength(10)}` specifies a `minlength` constraint with the argument `10`.</span></span> <span data-ttu-id="777c4-440">Более подробное описание ограничений маршрутов и список ограничений, предоставляемых платформой, см. в разделе [Справочник по ограничениям маршрутов](#route-constraint-reference).</span><span class="sxs-lookup"><span data-stu-id="777c4-440">For more information on route constraints and a list of the constraints provided by the framework, see the [Route constraint reference](#route-constraint-reference) section.</span></span>

<span data-ttu-id="777c4-441">Параметры маршрута также могут иметь преобразователи параметров,</span><span class="sxs-lookup"><span data-stu-id="777c4-441">Route parameters may also have parameter transformers.</span></span> <span data-ttu-id="777c4-442">которые преобразуют значение параметра при создании ссылок и сопоставлении действий и страниц с URL-адресами.</span><span class="sxs-lookup"><span data-stu-id="777c4-442">Parameter transformers transform a parameter's value when generating links and matching actions and pages to URLs.</span></span> <span data-ttu-id="777c4-443">Как и ограничения, преобразователи параметров можно включать в параметр маршрута, добавив двоеточие (`:`) и имя преобразователя после имени параметра маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-443">Like constraints, parameter transformers can be added inline to a route parameter by adding a `:` and transformer name after the route parameter name.</span></span> <span data-ttu-id="777c4-444">Например, шаблон маршрута `blog/{article:slugify}` задает преобразователь `slugify`.</span><span class="sxs-lookup"><span data-stu-id="777c4-444">For example, the route template `blog/{article:slugify}` specifies a `slugify` transformer.</span></span> <span data-ttu-id="777c4-445">Дополнительные сведения о преобразователях параметров см. в разделе [Справочник по преобразователям параметров](#parameter-transformer-reference).</span><span class="sxs-lookup"><span data-stu-id="777c4-445">For more information on parameter transformers, see the [Parameter transformer reference](#parameter-transformer-reference) section.</span></span>

<span data-ttu-id="777c4-446">В приведенной ниже таблице показаны некоторые примеры шаблонов маршрутов и их поведение.</span><span class="sxs-lookup"><span data-stu-id="777c4-446">The following table demonstrates example route templates and their behavior:</span></span>

| <span data-ttu-id="777c4-447">Шаблон маршрута</span><span class="sxs-lookup"><span data-stu-id="777c4-447">Route Template</span></span>                           | <span data-ttu-id="777c4-448">Пример соответствующего URI</span><span class="sxs-lookup"><span data-stu-id="777c4-448">Example Matching URI</span></span>    | <span data-ttu-id="777c4-449">URI запроса&hellip;</span><span class="sxs-lookup"><span data-stu-id="777c4-449">The request URI&hellip;</span></span>                                                    |
| ---------------------------------------- | ----------------------- | -------------------------------------------------------------------------- |
| `hello`                                  | `/hello`                | <span data-ttu-id="777c4-450">Соответствует только одному пути `/hello`.</span><span class="sxs-lookup"><span data-stu-id="777c4-450">Only matches the single path `/hello`.</span></span>                                     |
| `{Page=Home}`                            | `/`                     | <span data-ttu-id="777c4-451">Соответствует и задает для параметра `Page` значение `Home`.</span><span class="sxs-lookup"><span data-stu-id="777c4-451">Matches and sets `Page` to `Home`.</span></span>                                         |
| `{Page=Home}`                            | `/Contact`              | <span data-ttu-id="777c4-452">Соответствует и задает для параметра `Page` значение `Contact`.</span><span class="sxs-lookup"><span data-stu-id="777c4-452">Matches and sets `Page` to `Contact`.</span></span>                                      |
| `{controller}/{action}/{id?}`            | `/Products/List`        | <span data-ttu-id="777c4-453">Сопоставляется с контроллером `Products` и действием `List`.</span><span class="sxs-lookup"><span data-stu-id="777c4-453">Maps to the `Products` controller and `List` action.</span></span>                       |
| `{controller}/{action}/{id?}`            | `/Products/Details/123` | <span data-ttu-id="777c4-454">Сопоставляется с контроллером `Products` и действием `Details` (`id` имеет значение 123).</span><span class="sxs-lookup"><span data-stu-id="777c4-454">Maps to the `Products` controller and  `Details` action with`id` set to 123.</span></span> |
| `{controller=Home}/{action=Index}/{id?}` | `/`                     | <span data-ttu-id="777c4-455">Сопоставляется с контроллером `Home` и методом `Index`.</span><span class="sxs-lookup"><span data-stu-id="777c4-455">Maps to the `Home` controller and `Index` method.</span></span> <span data-ttu-id="777c4-456">`id` не учитывается.</span><span class="sxs-lookup"><span data-stu-id="777c4-456">`id` is ignored.</span></span>        |
| `{controller=Home}/{action=Index}/{id?}` | `/Products`         | <span data-ttu-id="777c4-457">Сопоставляется с контроллером `Products` и методом `Index`.</span><span class="sxs-lookup"><span data-stu-id="777c4-457">Maps to the `Products` controller and `Index` method.</span></span> <span data-ttu-id="777c4-458">`id` не учитывается.</span><span class="sxs-lookup"><span data-stu-id="777c4-458">`id` is ignored.</span></span>        |

<span data-ttu-id="777c4-459">Использование шаблона — это, как правило, самый простой подход к маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-459">Using a template is generally the simplest approach to routing.</span></span> <span data-ttu-id="777c4-460">Ограничения и значения по умолчанию также могут указываться вне шаблона маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-460">Constraints and defaults can also be specified outside the route template.</span></span>

### <a name="complex-segments"></a><span data-ttu-id="777c4-461">Сложные сегменты</span><span class="sxs-lookup"><span data-stu-id="777c4-461">Complex segments</span></span>

<span data-ttu-id="777c4-462">Сложные сегменты обрабатываются путем [нежадного](#greedy) сопоставления разделителей литералов справа налево.</span><span class="sxs-lookup"><span data-stu-id="777c4-462">Complex segments are processed by matching up literal delimiters from right to left in a [non-greedy](#greedy) way.</span></span> <span data-ttu-id="777c4-463">Например, `[Route("/a{b}c{d}")]` является сложным сегментом.</span><span class="sxs-lookup"><span data-stu-id="777c4-463">For example, `[Route("/a{b}c{d}")]` is a complex segment.</span></span>
<span data-ttu-id="777c4-464">Сложные сегменты работают определенным способом, который должен быть понятен для их успешного использования.</span><span class="sxs-lookup"><span data-stu-id="777c4-464">Complex segments work in a particular way that must be understood to use them successfully.</span></span> <span data-ttu-id="777c4-465">В примере в этом разделе показано, почему сложные сегменты действительно хорошо работают только в том случае, если текст разделителя отсутствует в значениях параметров.</span><span class="sxs-lookup"><span data-stu-id="777c4-465">The example in this section demonstrates why complex segments only really work well when the delimiter text doesn't appear inside the parameter values.</span></span> <span data-ttu-id="777c4-466">Для более сложных случаев требуется использовать [регулярное выражение](/dotnet/standard/base-types/regular-expressions), а затем вручную извлечь значения.</span><span class="sxs-lookup"><span data-stu-id="777c4-466">Using a [regex](/dotnet/standard/base-types/regular-expressions) and then manually extracting the values is needed for more complex cases.</span></span>

[!INCLUDE[](~/includes/regex.md)]

<span data-ttu-id="777c4-467">Это сводка действий, выполняемых маршрутизацией с использованием шаблона `/a{b}c{d}` и URL-пути `/abcd`.</span><span class="sxs-lookup"><span data-stu-id="777c4-467">This is a summary of the steps that routing performs with the template `/a{b}c{d}` and the URL path `/abcd`.</span></span> <span data-ttu-id="777c4-468">`|` используется для визуализации принципа работы алгоритма.</span><span class="sxs-lookup"><span data-stu-id="777c4-468">The `|` is used to help visualize how the algorithm works:</span></span>

* <span data-ttu-id="777c4-469">Первый литерал, справа налево — `c`.</span><span class="sxs-lookup"><span data-stu-id="777c4-469">The first literal, right to left, is `c`.</span></span> <span data-ttu-id="777c4-470">Таким образом, поиск `/abcd` выполняется справа, после чего находится `/ab|c|d`.</span><span class="sxs-lookup"><span data-stu-id="777c4-470">So `/abcd` is searched from right and finds `/ab|c|d`.</span></span>
* <span data-ttu-id="777c4-471">Все, что находится справа (`d`), теперь сопоставляется с параметром маршрута `{d}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-471">Everything to the right (`d`) is now matched to the route parameter `{d}`.</span></span>
* <span data-ttu-id="777c4-472">Следующий литерал, справа налево — `a`.</span><span class="sxs-lookup"><span data-stu-id="777c4-472">The next literal, right to left, is `a`.</span></span> <span data-ttu-id="777c4-473">Поэтому поиск `/ab|c|d` начинается с того места, где мы остановились, после чего находится `a` в `/|a|b|c|d`.</span><span class="sxs-lookup"><span data-stu-id="777c4-473">So `/ab|c|d` is searched starting where we left off, then `a` is found `/|a|b|c|d`.</span></span>
* <span data-ttu-id="777c4-474">Значение справа (`b`) теперь сопоставляется с параметром маршрута `{b}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-474">The value to the right (`b`) is now matched to the route parameter `{b}`.</span></span>
* <span data-ttu-id="777c4-475">Больше не осталось текста и шаблонов маршрута, поэтому это считается совпадением.</span><span class="sxs-lookup"><span data-stu-id="777c4-475">There is no remaining text and no remaining route template, so this is a match.</span></span>

<span data-ttu-id="777c4-476">Ниже приведен пример отрицательного результата с использованием того же шаблона `/a{b}c{d}` и URL-пути `/aabcd`.</span><span class="sxs-lookup"><span data-stu-id="777c4-476">Here's an example of a negative case using the same template `/a{b}c{d}` and the URL path `/aabcd`.</span></span> <span data-ttu-id="777c4-477">`|` используется для визуализации принципа работы алгоритма:</span><span class="sxs-lookup"><span data-stu-id="777c4-477">The `|` is used to help visualize how the algorithm works.</span></span> <span data-ttu-id="777c4-478">Это не совпадение, что объясняется тем же алгоритмом.</span><span class="sxs-lookup"><span data-stu-id="777c4-478">This case isn't a match, which is explained by the same algorithm:</span></span>
* <span data-ttu-id="777c4-479">Первый литерал, справа налево — `c`.</span><span class="sxs-lookup"><span data-stu-id="777c4-479">The first literal, right to left, is `c`.</span></span> <span data-ttu-id="777c4-480">Таким образом, поиск `/aabcd` выполняется справа, после чего находится `/aab|c|d`.</span><span class="sxs-lookup"><span data-stu-id="777c4-480">So `/aabcd` is searched from right and finds `/aab|c|d`.</span></span>
* <span data-ttu-id="777c4-481">Все, что находится справа (`d`), теперь сопоставляется с параметром маршрута `{d}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-481">Everything to the right (`d`) is now matched to the route parameter `{d}`.</span></span>
* <span data-ttu-id="777c4-482">Следующий литерал, справа налево — `a`.</span><span class="sxs-lookup"><span data-stu-id="777c4-482">The next literal, right to left, is `a`.</span></span> <span data-ttu-id="777c4-483">Поэтому поиск `/aab|c|d` начинается с того места, где мы остановились, после чего находится `a` в `/a|a|b|c|d`.</span><span class="sxs-lookup"><span data-stu-id="777c4-483">So `/aab|c|d` is searched starting where we left off, then `a` is found `/a|a|b|c|d`.</span></span>
* <span data-ttu-id="777c4-484">Значение справа (`b`) теперь сопоставляется с параметром маршрута `{b}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-484">The value to the right (`b`) is now matched to the route parameter `{b}`.</span></span>
* <span data-ttu-id="777c4-485">На этом этапе имеется оставшийся текст `a`, однако больше нет шаблонов маршрутов для синтаксического анализа, поэтому это не является совпадением.</span><span class="sxs-lookup"><span data-stu-id="777c4-485">At this point there is remaining text `a`, but the algorithm has run out of route template to parse, so this is not a match.</span></span>

<span data-ttu-id="777c4-486">Поскольку алгоритм сопоставления [нежадный](#greedy):</span><span class="sxs-lookup"><span data-stu-id="777c4-486">Since the matching algorithm is [non-greedy](#greedy):</span></span>

* <span data-ttu-id="777c4-487">Он сопоставляет наименьший объем текста, допустимый для каждого шага.</span><span class="sxs-lookup"><span data-stu-id="777c4-487">It matches the smallest amount of text possible in each step.</span></span>
* <span data-ttu-id="777c4-488">Случаи, когда значение разделителя находится в значениях параметров, не являются совпадением.</span><span class="sxs-lookup"><span data-stu-id="777c4-488">Any case where the delimiter value appears inside the parameter values results in not matching.</span></span>

<span data-ttu-id="777c4-489">Регулярные выражения обеспечивают гораздо больший контроль сопоставления.</span><span class="sxs-lookup"><span data-stu-id="777c4-489">Regular expressions provide much more control over their matching behavior.</span></span>

<a name="greedy"></a>

<span data-ttu-id="777c4-490">При жадном сопоставлении, также известном как [ленивое сопоставление](https://wikipedia.org/wiki/Regular_expression#Lazy_matching), выполняется поиск соответствия по наибольшей возможной строке.</span><span class="sxs-lookup"><span data-stu-id="777c4-490">Greedy matching, also know as [lazy matching](https://wikipedia.org/wiki/Regular_expression#Lazy_matching), matches the largest possible string.</span></span> <span data-ttu-id="777c4-491">При нежадном сопоставлении выполняется поиск соответствия по наименьшей возможной строке.</span><span class="sxs-lookup"><span data-stu-id="777c4-491">Non-greedy matches the smallest possible string.</span></span>

## <a name="route-constraint-reference"></a><span data-ttu-id="777c4-492">Справочник по ограничениям маршрутов</span><span class="sxs-lookup"><span data-stu-id="777c4-492">Route constraint reference</span></span>

<span data-ttu-id="777c4-493">Ограничения маршрута применяются, когда найдено соответствие входящему URL-адресу и путь URL-адреса был разобран на значения маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-493">Route constraints execute when a match has occurred to the incoming URL and the URL path is tokenized into route values.</span></span> <span data-ttu-id="777c4-494">Как правило, ограничения маршрута служат для проверки значения маршрута, связанного посредством шаблона маршрута, и принятия решения касательно того, является ли значение приемлемым (истина или ложь).</span><span class="sxs-lookup"><span data-stu-id="777c4-494">Route constraints generally inspect the route value associated via the route template and make a true or false decision about whether the value is acceptable.</span></span> <span data-ttu-id="777c4-495">Некоторые ограничения маршрута используют данные, не относящиеся к значению маршрута, для определения возможности маршрутизации запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-495">Some route constraints use data outside the route value to consider whether the request can be routed.</span></span> <span data-ttu-id="777c4-496">Например, <xref:Microsoft.AspNetCore.Routing.Constraints.HttpMethodRouteConstraint> может принимать или отклонять запрос в зависимости от HTTP-команды.</span><span class="sxs-lookup"><span data-stu-id="777c4-496">For example, the <xref:Microsoft.AspNetCore.Routing.Constraints.HttpMethodRouteConstraint> can accept or reject a request based on its HTTP verb.</span></span> <span data-ttu-id="777c4-497">Ограничения используются в маршрутизации запросов и создании ссылок.</span><span class="sxs-lookup"><span data-stu-id="777c4-497">Constraints are used in routing requests and link generation.</span></span>

> [!WARNING]
> <span data-ttu-id="777c4-498">Не используйте ограничения для проверки входных данных.</span><span class="sxs-lookup"><span data-stu-id="777c4-498">Don't use constraints for input validation.</span></span> <span data-ttu-id="777c4-499">Если для проверки входных данных используются ограничения, недопустимые входные данные приводят к ошибке `404` ("Не найдено").</span><span class="sxs-lookup"><span data-stu-id="777c4-499">If constraints are used for input validation, invalid input results in a `404` Not Found response.</span></span> <span data-ttu-id="777c4-500">Недопустимые входные данные должны привести к ошибке `400` ("Неверный запрос") с соответствующим сообщением об ошибке.</span><span class="sxs-lookup"><span data-stu-id="777c4-500">Invalid input should produce a `400` Bad Request with an appropriate error message.</span></span> <span data-ttu-id="777c4-501">Ограничения маршрутов следует использовать для разрешения неоднозначности похожих маршрутов, а не для проверки входных данных определенного маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-501">Route constraints are used to disambiguate similar routes, not to validate the inputs for a particular route.</span></span>

<span data-ttu-id="777c4-502">В приведенной ниже таблице показаны примеры ограничения маршрутов и их ожидаемое поведение.</span><span class="sxs-lookup"><span data-stu-id="777c4-502">The following table demonstrates example route constraints and their expected behavior:</span></span>

| <span data-ttu-id="777c4-503">ограничение</span><span class="sxs-lookup"><span data-stu-id="777c4-503">constraint</span></span> | <span data-ttu-id="777c4-504">Пример</span><span class="sxs-lookup"><span data-stu-id="777c4-504">Example</span></span> | <span data-ttu-id="777c4-505">Примеры совпадений</span><span class="sxs-lookup"><span data-stu-id="777c4-505">Example Matches</span></span> | <span data-ttu-id="777c4-506">Примечания</span><span class="sxs-lookup"><span data-stu-id="777c4-506">Notes</span></span> |
| ---------- | ------- | --------------- | ----- |
| `int` | `{id:int}` | <span data-ttu-id="777c4-507">`123456789`, `-123456789`</span><span class="sxs-lookup"><span data-stu-id="777c4-507">`123456789`, `-123456789`</span></span> | <span data-ttu-id="777c4-508">Соответствует любому целому числу</span><span class="sxs-lookup"><span data-stu-id="777c4-508">Matches any integer</span></span> |
| `bool` | `{active:bool}` | <span data-ttu-id="777c4-509">`true`, `FALSE`</span><span class="sxs-lookup"><span data-stu-id="777c4-509">`true`, `FALSE`</span></span> | <span data-ttu-id="777c4-510">Соответствует `true` или `false`.</span><span class="sxs-lookup"><span data-stu-id="777c4-510">Matches `true` or `false`.</span></span> <span data-ttu-id="777c4-511">Без учета регистра</span><span class="sxs-lookup"><span data-stu-id="777c4-511">Case-insensitive</span></span> |
| `datetime` | `{dob:datetime}` | <span data-ttu-id="777c4-512">`2016-12-31`, `2016-12-31 7:32pm`</span><span class="sxs-lookup"><span data-stu-id="777c4-512">`2016-12-31`, `2016-12-31 7:32pm`</span></span> | <span data-ttu-id="777c4-513">Соответствует допустимому значению `DateTime` для инвариантного языка и региональных параметров.</span><span class="sxs-lookup"><span data-stu-id="777c4-513">Matches a valid `DateTime` value in the invariant culture.</span></span> <span data-ttu-id="777c4-514">См. предупреждение выше.</span><span class="sxs-lookup"><span data-stu-id="777c4-514">See preceding warning.</span></span> |
| `decimal` | `{price:decimal}` | <span data-ttu-id="777c4-515">`49.99`, `-1,000.01`</span><span class="sxs-lookup"><span data-stu-id="777c4-515">`49.99`, `-1,000.01`</span></span> | <span data-ttu-id="777c4-516">Соответствует допустимому значению `decimal` для инвариантного языка и региональных параметров.</span><span class="sxs-lookup"><span data-stu-id="777c4-516">Matches a valid `decimal` value in the invariant culture.</span></span> <span data-ttu-id="777c4-517">См. предупреждение выше.</span><span class="sxs-lookup"><span data-stu-id="777c4-517">See preceding warning.</span></span>|
| `double` | `{weight:double}` | <span data-ttu-id="777c4-518">`1.234`, `-1,001.01e8`</span><span class="sxs-lookup"><span data-stu-id="777c4-518">`1.234`, `-1,001.01e8`</span></span> | <span data-ttu-id="777c4-519">Соответствует допустимому значению `double` для инвариантного языка и региональных параметров.</span><span class="sxs-lookup"><span data-stu-id="777c4-519">Matches a valid `double` value in the invariant culture.</span></span> <span data-ttu-id="777c4-520">См. предупреждение выше.</span><span class="sxs-lookup"><span data-stu-id="777c4-520">See preceding warning.</span></span>|
| `float` | `{weight:float}` | <span data-ttu-id="777c4-521">`1.234`, `-1,001.01e8`</span><span class="sxs-lookup"><span data-stu-id="777c4-521">`1.234`, `-1,001.01e8`</span></span> | <span data-ttu-id="777c4-522">Соответствует допустимому значению `float` для инвариантного языка и региональных параметров.</span><span class="sxs-lookup"><span data-stu-id="777c4-522">Matches a valid `float` value in the invariant culture.</span></span> <span data-ttu-id="777c4-523">См. предупреждение выше.</span><span class="sxs-lookup"><span data-stu-id="777c4-523">See preceding warning.</span></span>|
| `guid` | `{id:guid}` | `CD2C1638-1638-72D5-1638-DEADBEEF1638` | <span data-ttu-id="777c4-524">Соответствует допустимому значению `Guid`</span><span class="sxs-lookup"><span data-stu-id="777c4-524">Matches a valid `Guid` value</span></span> |
| `long` | `{ticks:long}` | <span data-ttu-id="777c4-525">`123456789`, `-123456789`</span><span class="sxs-lookup"><span data-stu-id="777c4-525">`123456789`, `-123456789`</span></span> | <span data-ttu-id="777c4-526">Соответствует допустимому значению `long`</span><span class="sxs-lookup"><span data-stu-id="777c4-526">Matches a valid `long` value</span></span> |
| `minlength(value)` | `{username:minlength(4)}` | `Rick` | <span data-ttu-id="777c4-527">Строка должна содержать не менее 4 символов</span><span class="sxs-lookup"><span data-stu-id="777c4-527">String must be at least 4 characters</span></span> |
| `maxlength(value)` | `{filename:maxlength(8)}` | `MyFile` | <span data-ttu-id="777c4-528">Строка должна содержать не более 8 символов</span><span class="sxs-lookup"><span data-stu-id="777c4-528">String must be no more than 8 characters</span></span> |
| `length(length)` | `{filename:length(12)}` | `somefile.txt` | <span data-ttu-id="777c4-529">Длина строки должна составлять ровно 12 символов</span><span class="sxs-lookup"><span data-stu-id="777c4-529">String must be exactly 12 characters long</span></span> |
| `length(min,max)` | `{filename:length(8,16)}` | `somefile.txt` | <span data-ttu-id="777c4-530">Строка должна содержать от 8 до 16 символов</span><span class="sxs-lookup"><span data-stu-id="777c4-530">String must be at least 8 and no more than 16 characters long</span></span> |
| `min(value)` | `{age:min(18)}` | `19` | <span data-ttu-id="777c4-531">Целочисленное значение не меньше 18</span><span class="sxs-lookup"><span data-stu-id="777c4-531">Integer value must be at least 18</span></span> |
| `max(value)` | `{age:max(120)}` | `91` | <span data-ttu-id="777c4-532">Целочисленное значение не больше 120</span><span class="sxs-lookup"><span data-stu-id="777c4-532">Integer value must be no more than 120</span></span> |
| `range(min,max)` | `{age:range(18,120)}` | `91` | <span data-ttu-id="777c4-533">Целочисленное значение от 18 до 120</span><span class="sxs-lookup"><span data-stu-id="777c4-533">Integer value must be at least 18 but no more than 120</span></span> |
| `alpha` | `{name:alpha}` | `Rick` | <span data-ttu-id="777c4-534">Строка должна состоять из одной буквы или нескольких (`a`-`z`) без учета регистра.</span><span class="sxs-lookup"><span data-stu-id="777c4-534">String must consist of one or more alphabetical characters, `a`-`z` and case-insensitive.</span></span> |
| `regex(expression)` | `{ssn:regex(^\\d{{3}}-\\d{{2}}-\\d{{4}}$)}` | `123-45-6789` | <span data-ttu-id="777c4-535">Строка должна соответствовать регулярному выражению.</span><span class="sxs-lookup"><span data-stu-id="777c4-535">String must match the regular expression.</span></span> <span data-ttu-id="777c4-536">См. советы по определению регулярного выражения.</span><span class="sxs-lookup"><span data-stu-id="777c4-536">See tips about defining a regular expression.</span></span> |
| `required` | `{name:required}` | `Rick` | <span data-ttu-id="777c4-537">Определяет обязательное наличие значения, не относящегося к параметру, во время формирования URL-адреса</span><span class="sxs-lookup"><span data-stu-id="777c4-537">Used to enforce that a non-parameter value is present during URL generation</span></span> |

[!INCLUDE[](~/includes/regex.md)]

<span data-ttu-id="777c4-538">К одному параметру может применяться несколько разделенных запятой ограничений.</span><span class="sxs-lookup"><span data-stu-id="777c4-538">Multiple, colon delimited constraints can be applied to a single parameter.</span></span> <span data-ttu-id="777c4-539">Например, следующее ограничение ограничивает параметр целочисленным значением 1 или больше:</span><span class="sxs-lookup"><span data-stu-id="777c4-539">For example, the following constraint restricts a parameter to an integer value of 1 or greater:</span></span>

```csharp
[Route("users/{id:int:min(1)}")]
public User GetUserById(int id) { }
```

> [!WARNING]
> <span data-ttu-id="777c4-540">Ограничения маршрута, которые проверяют URL-адрес и могут быть преобразованы в тип CLR, всегда используют инвариантный язык и региональные параметры.</span><span class="sxs-lookup"><span data-stu-id="777c4-540">Route constraints that verify the URL and are converted to a CLR type always use the invariant culture.</span></span> <span data-ttu-id="777c4-541">Например, преобразование в тип CLR `int` или `DateTime`.</span><span class="sxs-lookup"><span data-stu-id="777c4-541">For example, conversion to the CLR type `int` or `DateTime`.</span></span> <span data-ttu-id="777c4-542">Эти ограничения предполагают, что для URL-адреса не предусмотрена локализация.</span><span class="sxs-lookup"><span data-stu-id="777c4-542">These constraints assume that the URL is not localizable.</span></span> <span data-ttu-id="777c4-543">Предоставляемые платформой ограничения маршрутов не изменяют значения, хранящиеся в значениях маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-543">The framework-provided route constraints don't modify the values stored in route values.</span></span> <span data-ttu-id="777c4-544">Все значения маршрута, переданные из URL-адреса, сохраняются как строки.</span><span class="sxs-lookup"><span data-stu-id="777c4-544">All route values parsed from the URL are stored as strings.</span></span> <span data-ttu-id="777c4-545">Например, ограничение `float` пытается преобразовать значение маршрута в число с плавающей запятой, но преобразованное значение служит только для проверки возможности такого преобразования.</span><span class="sxs-lookup"><span data-stu-id="777c4-545">For example, the `float` constraint attempts to convert the route value to a float, but the converted value is used only to verify it can be converted to a float.</span></span>

### <a name="regular-expressions-in-constraints"></a><span data-ttu-id="777c4-546">Регулярные выражения в ограничениях</span><span class="sxs-lookup"><span data-stu-id="777c4-546">Regular expressions in constraints</span></span>

[!INCLUDE[](~/includes/regex.md)]

<span data-ttu-id="777c4-547">Регулярные выражения могут быть определены как встроенные ограничения с помощью ограничения маршрута `regex(...)`.</span><span class="sxs-lookup"><span data-stu-id="777c4-547">Regular expressions can be specified as inline constraints using the `regex(...)` route constraint.</span></span> <span data-ttu-id="777c4-548">Методы в семействе <xref:Microsoft.AspNetCore.Builder.ControllerEndpointRouteBuilderExtensions.MapControllerRoute*> также принимают объектный литерал ограничений.</span><span class="sxs-lookup"><span data-stu-id="777c4-548">Methods in the <xref:Microsoft.AspNetCore.Builder.ControllerEndpointRouteBuilderExtensions.MapControllerRoute*> family also accept an object literal of constraints.</span></span> <span data-ttu-id="777c4-549">При использовании этой формы строковые значения будут интерпретироваться как регулярные выражения.</span><span class="sxs-lookup"><span data-stu-id="777c4-549">If that form is used, string values are interpreted as regular expressions.</span></span>

<span data-ttu-id="777c4-550">В следующем коде используется встроенное ограничение регулярного выражения.</span><span class="sxs-lookup"><span data-stu-id="777c4-550">The following code uses an inline regex constraint:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/StartupRegex.cs?name=snippet)]

<span data-ttu-id="777c4-551">В следующем коде объектный литерал используется для указания ограничения регулярного выражения.</span><span class="sxs-lookup"><span data-stu-id="777c4-551">The following code uses an object literal to specify a regex constraint:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/StartupRegex2.cs?name=snippet)]

<span data-ttu-id="777c4-552">В платформе ASP.NET Core в конструктор регулярных выражений добавляются члены `RegexOptions.IgnoreCase | RegexOptions.Compiled | RegexOptions.CultureInvariant`.</span><span class="sxs-lookup"><span data-stu-id="777c4-552">The ASP.NET Core framework adds `RegexOptions.IgnoreCase | RegexOptions.Compiled | RegexOptions.CultureInvariant` to the regular expression constructor.</span></span> <span data-ttu-id="777c4-553">Описание этих членов см. в разделе <xref:System.Text.RegularExpressions.RegexOptions>.</span><span class="sxs-lookup"><span data-stu-id="777c4-553">See <xref:System.Text.RegularExpressions.RegexOptions> for a description of these members.</span></span>

<span data-ttu-id="777c4-554">В регулярных выражениях применяются разделители и токены, аналогичные используемым функцией маршрутизации и в языке C#.</span><span class="sxs-lookup"><span data-stu-id="777c4-554">Regular expressions use delimiters and tokens similar to those used by routing and the C# language.</span></span> <span data-ttu-id="777c4-555">Токены регулярного выражения должны быть экранированы.</span><span class="sxs-lookup"><span data-stu-id="777c4-555">Regular expression tokens must be escaped.</span></span> <span data-ttu-id="777c4-556">Чтобы использовать регулярное выражение `^\d{3}-\d{2}-\d{4}$` во встроенном ограничении, используйте один из следующих способов.</span><span class="sxs-lookup"><span data-stu-id="777c4-556">To use the regular expression `^\d{3}-\d{2}-\d{4}$` in an inline constraint, use one of the following:</span></span>

* <span data-ttu-id="777c4-557">Замените символы `\`, представленные в строке, символами `\\` в исходном файле C#, чтобы экранировать escape-символ строки `\`.</span><span class="sxs-lookup"><span data-stu-id="777c4-557">Replace `\` characters provided in the string as `\\` characters in the C# source file in order to escape the `\` string escape character.</span></span>
* <span data-ttu-id="777c4-558">[Буквальные строковые литералы](/dotnet/csharp/language-reference/keywords/string).</span><span class="sxs-lookup"><span data-stu-id="777c4-558">[Verbatim string literals](/dotnet/csharp/language-reference/keywords/string).</span></span>

<span data-ttu-id="777c4-559">Чтобы экранировать символы разделения параметров маршрутизации `{`, `}`, `[`, `]`, используйте их дважды в выражении (например, `{{`, `}}`, `[[`, `]]`).</span><span class="sxs-lookup"><span data-stu-id="777c4-559">To escape routing parameter delimiter characters `{`, `}`, `[`, `]`, double the characters in the expression, for example, `{{`, `}}`, `[[`, `]]`.</span></span> <span data-ttu-id="777c4-560">В следующей таблице показаны регулярные выражения и их экранированные варианты.</span><span class="sxs-lookup"><span data-stu-id="777c4-560">The following table shows a regular expression and its escaped version:</span></span>

| <span data-ttu-id="777c4-561">Регулярное выражение</span><span class="sxs-lookup"><span data-stu-id="777c4-561">Regular expression</span></span>    | <span data-ttu-id="777c4-562">Экранированное регулярное выражение</span><span class="sxs-lookup"><span data-stu-id="777c4-562">Escaped regular expression</span></span>     |
| --------------------- | ------------------------------ |
| `^\d{3}-\d{2}-\d{4}$` | `^\\d{{3}}-\\d{{2}}-\\d{{4}}$` |
| `^[a-z]{2}$`          | `^[[a-z]]{{2}}$`               |

<span data-ttu-id="777c4-563">Регулярные выражения, используемые при маршрутизации, часто начинаются с символа `^` и соответствуют начальной позиции строки.</span><span class="sxs-lookup"><span data-stu-id="777c4-563">Regular expressions used in routing often start with the `^` character and match the starting position of the string.</span></span> <span data-ttu-id="777c4-564">Выражения часто заканчиваются символом `$` и соответствуют концу строки.</span><span class="sxs-lookup"><span data-stu-id="777c4-564">The expressions often end with the `$` character and match the end of the string.</span></span> <span data-ttu-id="777c4-565">Благодаря символам `^` и `$` регулярное выражение сопоставляется со всем значением параметра маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-565">The `^` and `$` characters ensure that the regular expression matches the entire route parameter value.</span></span> <span data-ttu-id="777c4-566">Если символы `^` и `$` отсутствуют, регулярное выражение сопоставляется с любой подстрокой внутри строки, что обычно нежелательно.</span><span class="sxs-lookup"><span data-stu-id="777c4-566">Without the `^` and `$` characters, the regular expression matches any substring within the string, which is often undesirable.</span></span> <span data-ttu-id="777c4-567">В таблице ниже представлен ряд примеров и объясняются причины соответствия или несоответствия.</span><span class="sxs-lookup"><span data-stu-id="777c4-567">The following table provides examples and explains why they match or fail to match:</span></span>

| <span data-ttu-id="777c4-568">Выражение</span><span class="sxs-lookup"><span data-stu-id="777c4-568">Expression</span></span>   | <span data-ttu-id="777c4-569">Строка</span><span class="sxs-lookup"><span data-stu-id="777c4-569">String</span></span>    | <span data-ttu-id="777c4-570">Соответствие</span><span class="sxs-lookup"><span data-stu-id="777c4-570">Match</span></span> | <span data-ttu-id="777c4-571">Добавление примечаний</span><span class="sxs-lookup"><span data-stu-id="777c4-571">Comment</span></span>               |
| ------------ | --------- | :---: |  -------------------- |
| `[a-z]{2}`   | <span data-ttu-id="777c4-572">hello</span><span class="sxs-lookup"><span data-stu-id="777c4-572">hello</span></span>     | <span data-ttu-id="777c4-573">Да</span><span class="sxs-lookup"><span data-stu-id="777c4-573">Yes</span></span>   | <span data-ttu-id="777c4-574">Соответствие подстроки</span><span class="sxs-lookup"><span data-stu-id="777c4-574">Substring matches</span></span>     |
| `[a-z]{2}`   | <span data-ttu-id="777c4-575">123abc456</span><span class="sxs-lookup"><span data-stu-id="777c4-575">123abc456</span></span> | <span data-ttu-id="777c4-576">Да</span><span class="sxs-lookup"><span data-stu-id="777c4-576">Yes</span></span>   | <span data-ttu-id="777c4-577">Соответствие подстроки</span><span class="sxs-lookup"><span data-stu-id="777c4-577">Substring matches</span></span>     |
| `[a-z]{2}`   | <span data-ttu-id="777c4-578">mz</span><span class="sxs-lookup"><span data-stu-id="777c4-578">mz</span></span>        | <span data-ttu-id="777c4-579">Да</span><span class="sxs-lookup"><span data-stu-id="777c4-579">Yes</span></span>   | <span data-ttu-id="777c4-580">Соответствует выражению</span><span class="sxs-lookup"><span data-stu-id="777c4-580">Matches expression</span></span>    |
| `[a-z]{2}`   | <span data-ttu-id="777c4-581">MZ</span><span class="sxs-lookup"><span data-stu-id="777c4-581">MZ</span></span>        | <span data-ttu-id="777c4-582">Да</span><span class="sxs-lookup"><span data-stu-id="777c4-582">Yes</span></span>   | <span data-ttu-id="777c4-583">Без учета регистра</span><span class="sxs-lookup"><span data-stu-id="777c4-583">Not case sensitive</span></span>    |
| `^[a-z]{2}$` | <span data-ttu-id="777c4-584">hello</span><span class="sxs-lookup"><span data-stu-id="777c4-584">hello</span></span>     | <span data-ttu-id="777c4-585">Нет</span><span class="sxs-lookup"><span data-stu-id="777c4-585">No</span></span>    | <span data-ttu-id="777c4-586">См. замечания, касающиеся символов `^` и `$`, выше</span><span class="sxs-lookup"><span data-stu-id="777c4-586">See `^` and `$` above</span></span> |
| `^[a-z]{2}$` | <span data-ttu-id="777c4-587">123abc456</span><span class="sxs-lookup"><span data-stu-id="777c4-587">123abc456</span></span> | <span data-ttu-id="777c4-588">Нет</span><span class="sxs-lookup"><span data-stu-id="777c4-588">No</span></span>    | <span data-ttu-id="777c4-589">См. замечания, касающиеся символов `^` и `$`, выше</span><span class="sxs-lookup"><span data-stu-id="777c4-589">See `^` and `$` above</span></span> |

<span data-ttu-id="777c4-590">Дополнительные сведения о синтаксисе регулярных выражений см. в статье [Регулярные выражения в .NET Framework](/dotnet/standard/base-types/regular-expression-language-quick-reference).</span><span class="sxs-lookup"><span data-stu-id="777c4-590">For more information on regular expression syntax, see [.NET Framework Regular Expressions](/dotnet/standard/base-types/regular-expression-language-quick-reference).</span></span>

<span data-ttu-id="777c4-591">Чтобы ограничить возможные значения параметра набором известных значений, используйте регулярное выражение.</span><span class="sxs-lookup"><span data-stu-id="777c4-591">To constrain a parameter to a known set of possible values, use a regular expression.</span></span> <span data-ttu-id="777c4-592">Например, при использовании выражения `{action:regex(^(list|get|create)$)}` значение маршрута `action` будет соответствовать только `list`, `get` или `create`.</span><span class="sxs-lookup"><span data-stu-id="777c4-592">For example, `{action:regex(^(list|get|create)$)}` only matches the `action` route value to `list`, `get`, or `create`.</span></span> <span data-ttu-id="777c4-593">При передаче в словарь ограничений строка `^(list|get|create)$` будет эквивалентной.</span><span class="sxs-lookup"><span data-stu-id="777c4-593">If passed into the constraints dictionary, the string `^(list|get|create)$` is equivalent.</span></span> <span data-ttu-id="777c4-594">Ограничения, которые передаются в словарь ограничений и не соответствуют одному из известных ограничений, также рассматриваются как регулярные выражения.</span><span class="sxs-lookup"><span data-stu-id="777c4-594">Constraints that are passed in the constraints dictionary that don't match one of the known constraints are also treated as regular expressions.</span></span> <span data-ttu-id="777c4-595">Ограничения, которые передаются в шаблоне и не соответствуют одному из известных ограничений, не рассматриваются как регулярные выражения.</span><span class="sxs-lookup"><span data-stu-id="777c4-595">Constraints that are passed  within a template that don't match one of the known constraints are not treated as regular expressions.</span></span>

### <a name="custom-route-constraints"></a><span data-ttu-id="777c4-596">Пользовательские ограничения маршрутов</span><span class="sxs-lookup"><span data-stu-id="777c4-596">Custom route constraints</span></span>

<span data-ttu-id="777c4-597">Пользовательские ограничения маршрутов можно создать путем внедрения интерфейса <xref:Microsoft.AspNetCore.Routing.IRouteConstraint>.</span><span class="sxs-lookup"><span data-stu-id="777c4-597">Custom route constraints can be created by implementing the <xref:Microsoft.AspNetCore.Routing.IRouteConstraint> interface.</span></span> <span data-ttu-id="777c4-598">Интерфейс `IRouteConstraint` содержит метод, <xref:System.Web.Routing.IRouteConstraint.Match*>, который возвращает `true`, если ограничение удовлетворяется, и `false` — если нет.</span><span class="sxs-lookup"><span data-stu-id="777c4-598">The `IRouteConstraint` interface contains <xref:System.Web.Routing.IRouteConstraint.Match*>, which returns `true` if the constraint is satisfied and `false` otherwise.</span></span>

<span data-ttu-id="777c4-599">Пользовательские ограничения маршрутов используются довольно редко.</span><span class="sxs-lookup"><span data-stu-id="777c4-599">Custom route constraints are rarely needed.</span></span> <span data-ttu-id="777c4-600">Перед реализацией пользовательского ограничения маршрута рассмотрите альтернативные варианты, такие как привязка модели.</span><span class="sxs-lookup"><span data-stu-id="777c4-600">Before implementing a custom route constraint, consider alternatives, such as model binding.</span></span>

<span data-ttu-id="777c4-601">В папке ASP.NET Core [Constraints](https://github.com/dotnet/aspnetcore/tree/master/src/Http/Routing/src/Constraints) приведены хорошие примеры создания ограничений.</span><span class="sxs-lookup"><span data-stu-id="777c4-601">The ASP.NET Core [Constraints](https://github.com/dotnet/aspnetcore/tree/master/src/Http/Routing/src/Constraints) folder provides good examples of creating a constraints.</span></span> <span data-ttu-id="777c4-602">Например, [GuidRouteConstraint](https://github.com/dotnet/aspnetcore/blob/master/src/Http/Routing/src/Constraints/GuidRouteConstraint.cs#L18).</span><span class="sxs-lookup"><span data-stu-id="777c4-602">For example, [GuidRouteConstraint](https://github.com/dotnet/aspnetcore/blob/master/src/Http/Routing/src/Constraints/GuidRouteConstraint.cs#L18).</span></span>

<span data-ttu-id="777c4-603">Чтобы применить пользовательский метод `IRouteConstraint`, тип ограничения маршрута необходимо зарегистрировать с помощью <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap> приложения в контейнере службы.</span><span class="sxs-lookup"><span data-stu-id="777c4-603">To use a custom `IRouteConstraint`, the route constraint type must be registered with the app's <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap> in the service container.</span></span> <span data-ttu-id="777c4-604">Объект `ConstraintMap` — это словарь, который сопоставляет ключи ограничений пути с реализациями `IRouteConstraint`, которые проверяют эти ограничения.</span><span class="sxs-lookup"><span data-stu-id="777c4-604">A `ConstraintMap` is a dictionary that maps route constraint keys to `IRouteConstraint` implementations that validate those constraints.</span></span> <span data-ttu-id="777c4-605">`ConstraintMap` приложения можно преобразовать в `Startup.ConfigureServices` как часть вызова [services.AddRouting](xref:Microsoft.Extensions.DependencyInjection.RoutingServiceCollectionExtensions.AddRouting*) или путем настройки <xref:Microsoft.AspNetCore.Routing.RouteOptions> непосредственно с помощью `services.Configure<RouteOptions>`.</span><span class="sxs-lookup"><span data-stu-id="777c4-605">An app's `ConstraintMap` can be updated in `Startup.ConfigureServices` either as part of a [services.AddRouting](xref:Microsoft.Extensions.DependencyInjection.RoutingServiceCollectionExtensions.AddRouting*) call or by configuring <xref:Microsoft.AspNetCore.Routing.RouteOptions> directly with `services.Configure<RouteOptions>`.</span></span> <span data-ttu-id="777c4-606">Пример:</span><span class="sxs-lookup"><span data-stu-id="777c4-606">For example:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/StartupConstraint.cs?name=snippet)]

<span data-ttu-id="777c4-607">Предыдущее ограничение применяется в следующем коде.</span><span class="sxs-lookup"><span data-stu-id="777c4-607">The preceding constraint is applied in the following code:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/Controllers/TestController.cs?name=snippet&highlight=6,13)]

[!INCLUDE[](~/includes/MyDisplayRouteInfo.md)]

<span data-ttu-id="777c4-608">Реализация `MyCustomConstraint` препятствует применению `0` к параметру маршрута:</span><span class="sxs-lookup"><span data-stu-id="777c4-608">The implementation of `MyCustomConstraint` prevents `0` being applied to a route parameter:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/StartupConstraint.cs?name=snippet2)]

[!INCLUDE[](~/includes/regex.md)]

<span data-ttu-id="777c4-609">Предыдущий код:</span><span class="sxs-lookup"><span data-stu-id="777c4-609">The preceding code:</span></span>

* <span data-ttu-id="777c4-610">Предотвращает `0` в сегменте `{id}` маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-610">Prevents `0` in the `{id}` segment of the route.</span></span>
* <span data-ttu-id="777c4-611">Отображается для предоставления базового примера реализации настраиваемого ограничения.</span><span class="sxs-lookup"><span data-stu-id="777c4-611">Is shown to provide a basic example of implementing a custom constraint.</span></span> <span data-ttu-id="777c4-612">Не следует использовать в рабочем приложении.</span><span class="sxs-lookup"><span data-stu-id="777c4-612">It should not be used in a production app.</span></span>

<span data-ttu-id="777c4-613">Следующий код является лучшим подходом к предотвращению обработки `id` с `0`.</span><span class="sxs-lookup"><span data-stu-id="777c4-613">The following code is a better approach to preventing an `id` containing a `0` from being processed:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/Controllers/TestController.cs?name=snippet2)]

<span data-ttu-id="777c4-614">Приведенный выше код имеет следующие преимущества по сравнению с подходом `MyCustomConstraint`.</span><span class="sxs-lookup"><span data-stu-id="777c4-614">The preceding code has the following advantages over the `MyCustomConstraint` approach:</span></span>

* <span data-ttu-id="777c4-615">Пользовательское ограничение не требуется.</span><span class="sxs-lookup"><span data-stu-id="777c4-615">It doesn't require a custom constraint.</span></span>
* <span data-ttu-id="777c4-616">Он возвращает более понятную ошибку, если параметр маршрута включает `0`.</span><span class="sxs-lookup"><span data-stu-id="777c4-616">It returns a more descriptive error when the route parameter includes `0`.</span></span>

## <a name="parameter-transformer-reference"></a><span data-ttu-id="777c4-617">Справочник по преобразователям параметров</span><span class="sxs-lookup"><span data-stu-id="777c4-617">Parameter transformer reference</span></span>

<span data-ttu-id="777c4-618">Преобразователи параметров:</span><span class="sxs-lookup"><span data-stu-id="777c4-618">Parameter transformers:</span></span>

* <span data-ttu-id="777c4-619">Выполняются при формировании ссылки с помощью <xref:Microsoft.AspNetCore.Routing.LinkGenerator>.</span><span class="sxs-lookup"><span data-stu-id="777c4-619">Execute when generating a link using <xref:Microsoft.AspNetCore.Routing.LinkGenerator>.</span></span>
* <span data-ttu-id="777c4-620">Реализуйте расширение <xref:Microsoft.AspNetCore.Routing.IOutboundParameterTransformer?displayProperty=fullName>.</span><span class="sxs-lookup"><span data-stu-id="777c4-620">Implement <xref:Microsoft.AspNetCore.Routing.IOutboundParameterTransformer?displayProperty=fullName>.</span></span>
* <span data-ttu-id="777c4-621">Настраиваются с помощью <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap>.</span><span class="sxs-lookup"><span data-stu-id="777c4-621">Are configured using <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap>.</span></span>
* <span data-ttu-id="777c4-622">Принимают значение маршрута параметра и изменяют его на новое строковое значение.</span><span class="sxs-lookup"><span data-stu-id="777c4-622">Take the parameter's route value and transform it to a new string value.</span></span>
* <span data-ttu-id="777c4-623">Приводят к использованию преобразованного значения в сформированной ссылке.</span><span class="sxs-lookup"><span data-stu-id="777c4-623">Result in using the transformed value in the generated link.</span></span>

<span data-ttu-id="777c4-624">Например, пользовательский преобразователь параметра `slugify` в шаблоне маршрута `blog\{article:slugify}` с `Url.Action(new { article = "MyTestArticle" })` формирует значение `blog\my-test-article`.</span><span class="sxs-lookup"><span data-stu-id="777c4-624">For example, a custom `slugify` parameter transformer in route pattern `blog\{article:slugify}` with `Url.Action(new { article = "MyTestArticle" })` generates `blog\my-test-article`.</span></span>

<span data-ttu-id="777c4-625">Рассмотрим следующую реализацию `IOutboundParameterTransformer`.</span><span class="sxs-lookup"><span data-stu-id="777c4-625">Consider the following `IOutboundParameterTransformer` implementation:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/StartupConstraint2.cs?name=snippet2)]

<span data-ttu-id="777c4-626">Чтобы использовать преобразователь параметров в шаблоне маршрута, настройте его с помощью <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap> в `Startup.ConfigureServices`.</span><span class="sxs-lookup"><span data-stu-id="777c4-626">To use a parameter transformer in a route pattern, configure it using <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap> in `Startup.ConfigureServices`:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/StartupConstraint2.cs?name=snippet)]

<span data-ttu-id="777c4-627">В платформе ASP.NET Core преобразователи параметров используются для преобразования URI, где разрешается конечная точка.</span><span class="sxs-lookup"><span data-stu-id="777c4-627">The ASP.NET Core framework uses parameter transformers to transform the URI where an endpoint resolves.</span></span> <span data-ttu-id="777c4-628">Например, преобразователи параметров преобразуют значения маршрута, используемые для сопоставления `area`, `controller`, `action` и `page`.</span><span class="sxs-lookup"><span data-stu-id="777c4-628">For example, parameter transformers transform the route values used to match an `area`, `controller`, `action`, and `page`.</span></span>

```csharp
routes.MapControllerRoute(
    name: "default",
    template: "{controller:slugify=Home}/{action:slugify=Index}/{id?}");
```

<span data-ttu-id="777c4-629">С помощью предыдущего шаблона маршрута действие `SubscriptionManagementController.GetAll` сопоставляется с URI `/subscription-management/get-all`.</span><span class="sxs-lookup"><span data-stu-id="777c4-629">With the preceding route template, the action `SubscriptionManagementController.GetAll` is matched with the URI `/subscription-management/get-all`.</span></span> <span data-ttu-id="777c4-630">Преобразователь параметра не изменяет значения маршрута, используемые для формирования ссылки.</span><span class="sxs-lookup"><span data-stu-id="777c4-630">A parameter transformer doesn't change the route values used to generate a link.</span></span> <span data-ttu-id="777c4-631">Например, `Url.Action("GetAll", "SubscriptionManagement")` выводит `/subscription-management/get-all`.</span><span class="sxs-lookup"><span data-stu-id="777c4-631">For example, `Url.Action("GetAll", "SubscriptionManagement")` outputs `/subscription-management/get-all`.</span></span>

<span data-ttu-id="777c4-632">ASP.NET Core предоставляет соглашения об API для использования преобразователей параметров со сформированными маршрутами.</span><span class="sxs-lookup"><span data-stu-id="777c4-632">ASP.NET Core provides API conventions for using parameter transformers with generated routes:</span></span>

* <span data-ttu-id="777c4-633">Соглашение <xref:Microsoft.AspNetCore.Mvc.ApplicationModels.RouteTokenTransformerConvention?displayProperty=fullName> MVC применяет указанный преобразователь параметров ко всем маршрутам атрибутов в приложении.</span><span class="sxs-lookup"><span data-stu-id="777c4-633">The <xref:Microsoft.AspNetCore.Mvc.ApplicationModels.RouteTokenTransformerConvention?displayProperty=fullName> MVC convention applies a specified parameter transformer to all attribute routes in the app.</span></span> <span data-ttu-id="777c4-634">Преобразователь параметров преобразует маркеры маршрутов атрибутов по мере их замены.</span><span class="sxs-lookup"><span data-stu-id="777c4-634">The parameter transformer transforms attribute route tokens as they are replaced.</span></span> <span data-ttu-id="777c4-635">Дополнительные сведения см. в разделе об [использовании преобразователя параметров для настройки замены маркеров](xref:mvc/controllers/routing#use-a-parameter-transformer-to-customize-token-replacement).</span><span class="sxs-lookup"><span data-stu-id="777c4-635">For more information, see [Use a parameter transformer to customize token replacement](xref:mvc/controllers/routing#use-a-parameter-transformer-to-customize-token-replacement).</span></span>
* <span data-ttu-id="777c4-636">Razor Pages использует соглашение об API <xref:Microsoft.AspNetCore.Mvc.ApplicationModels.PageRouteTransformerConvention>.</span><span class="sxs-lookup"><span data-stu-id="777c4-636">Razor Pages uses the <xref:Microsoft.AspNetCore.Mvc.ApplicationModels.PageRouteTransformerConvention> API convention.</span></span> <span data-ttu-id="777c4-637">Это соглашение применяет указанный преобразователь параметров ко всем автоматически обнаруженным страницам Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="777c4-637">This convention applies a specified parameter transformer to all automatically discovered Razor Pages.</span></span> <span data-ttu-id="777c4-638">Преобразователь параметров преобразует сегменты папок и имен файлов маршрутов Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="777c4-638">The parameter transformer transforms the folder and file name segments of Razor Pages routes.</span></span> <span data-ttu-id="777c4-639">Дополнительные сведения см. в разделе об [использовании преобразователя параметров для настройки маршрутов страниц](xref:razor-pages/razor-pages-conventions#use-a-parameter-transformer-to-customize-page-routes).</span><span class="sxs-lookup"><span data-stu-id="777c4-639">For more information, see [Use a parameter transformer to customize page routes](xref:razor-pages/razor-pages-conventions#use-a-parameter-transformer-to-customize-page-routes).</span></span>

<a name="ugr"></a>

## <a name="url-generation-reference"></a><span data-ttu-id="777c4-640">Справочник по формированию URL-адресов</span><span class="sxs-lookup"><span data-stu-id="777c4-640">URL generation reference</span></span>

<span data-ttu-id="777c4-641">В этом разделе представлен справочник по алгоритму, реализованному при формировании URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-641">This section contains a reference for the algorithm implemented by URL generation.</span></span> <span data-ttu-id="777c4-642">На практике в большинстве сложных примеров формирования URL-адресов используются контроллеры или Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="777c4-642">In practice, most complex examples of URL generation use controllers or Razor Pages.</span></span> <span data-ttu-id="777c4-643">Дополнительные сведения см. в разделе [Маршрутизация в контроллерах](xref:mvc/controllers/routing).</span><span class="sxs-lookup"><span data-stu-id="777c4-643">See  [routing in controllers](xref:mvc/controllers/routing) for additional information.</span></span>

<span data-ttu-id="777c4-644">Процесс формирования URL-адреса начинается с вызова [LinkGenerator.GetPathByAddress](xref:Microsoft.AspNetCore.Routing.LinkGenerator.GetPathByAddress*) или аналогичного метода.</span><span class="sxs-lookup"><span data-stu-id="777c4-644">The URL generation process begins with a call to [LinkGenerator.GetPathByAddress](xref:Microsoft.AspNetCore.Routing.LinkGenerator.GetPathByAddress*) or a similar method.</span></span> <span data-ttu-id="777c4-645">Метод предоставляется с адресом, набором значений маршрута и при необходимости со сведениями о текущем запросе из `HttpContext`.</span><span class="sxs-lookup"><span data-stu-id="777c4-645">The method is provided with an address, a set of route values, and optionally information about the current request from `HttpContext`.</span></span>

<span data-ttu-id="777c4-646">Первым шагом является использование адреса для разрешения набора конечных точек-кандидатов с помощью [`IEndpointAddressScheme<TAddress>`](xref:Microsoft.AspNetCore.Routing.IEndpointAddressScheme`1), соответствующих типу адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-646">The first step is to use the address to resolve a set of candidate endpoints using an [`IEndpointAddressScheme<TAddress>`](xref:Microsoft.AspNetCore.Routing.IEndpointAddressScheme`1) that matches the address's type.</span></span>

<span data-ttu-id="777c4-647">После того как набор кандидатов найден в схеме адресов, конечные точки упорядочиваются и обрабатываются последовательно до тех пор, пока операция формирования URL-адреса не завершится.</span><span class="sxs-lookup"><span data-stu-id="777c4-647">Once of set of candidates is found by the address scheme, the endpoints are ordered and processed iteratively until a URL generation operation succeeds.</span></span> <span data-ttu-id="777c4-648">При создании URL-адреса **не** выполняется проверка на неоднозначность; первый возвращенный результат является окончательным результатом.</span><span class="sxs-lookup"><span data-stu-id="777c4-648">URL generation does **not** check for ambiguities, the first result returned is the final result.</span></span>

### <a name="troubleshooting-url-generation-with-logging"></a><span data-ttu-id="777c4-649">Устранение неполадок при формировании URL-адресов с помощью ведения журнала</span><span class="sxs-lookup"><span data-stu-id="777c4-649">Troubleshooting URL generation with logging</span></span>

<span data-ttu-id="777c4-650">Первым шагом при устранении неполадок при формировании URL-адресов является установка уровня ведения журнала `Microsoft.AspNetCore.Routing` для `TRACE`.</span><span class="sxs-lookup"><span data-stu-id="777c4-650">The first step in troubleshooting URL generation is setting the logging level of `Microsoft.AspNetCore.Routing` to `TRACE`.</span></span> <span data-ttu-id="777c4-651">`LinkGenerator` фиксирует в журнале множество сведений об обработке, которые могут быть полезны при устранении неполадок.</span><span class="sxs-lookup"><span data-stu-id="777c4-651">`LinkGenerator` logs many details about its processing which can be useful to troubleshoot problems.</span></span>

<span data-ttu-id="777c4-652">Дополнительные сведения о формировании URL-адресов см. в разделе [Справочник по формированию URL-адресов](#ugr).</span><span class="sxs-lookup"><span data-stu-id="777c4-652">See [URL generation reference](#ugr) for details on URL generation.</span></span>

### <a name="addresses"></a><span data-ttu-id="777c4-653">Адреса</span><span class="sxs-lookup"><span data-stu-id="777c4-653">Addresses</span></span>

<span data-ttu-id="777c4-654">Адреса являются основным понятием в формировании URL-адресов и используются для привязки вызова генератора ссылок к набору конечных точек-кандидатов.</span><span class="sxs-lookup"><span data-stu-id="777c4-654">Addresses are the concept in URL generation used to bind a call into the link generator to a set of candidate endpoints.</span></span>

<span data-ttu-id="777c4-655">Адреса — это расширяемое понятие, которое по умолчанию поставляется с двумя реализациями.</span><span class="sxs-lookup"><span data-stu-id="777c4-655">Addresses are an extensible concept that come with two implementations by default:</span></span>

* <span data-ttu-id="777c4-656">Использование *имени конечной точки* (`string`) в качестве адреса:</span><span class="sxs-lookup"><span data-stu-id="777c4-656">Using *endpoint name* (`string`) as the address:</span></span>
    * <span data-ttu-id="777c4-657">Предоставляет аналогичные функции для имени маршрута MVC.</span><span class="sxs-lookup"><span data-stu-id="777c4-657">Provides similar functionality to MVC's route name.</span></span>
    * <span data-ttu-id="777c4-658">Использует тип метаданных <xref:Microsoft.AspNetCore.Routing.IEndpointNameMetadata>.</span><span class="sxs-lookup"><span data-stu-id="777c4-658">Uses the <xref:Microsoft.AspNetCore.Routing.IEndpointNameMetadata> metadata type.</span></span>
    * <span data-ttu-id="777c4-659">Разрешает указанную строку в соответствии с метаданными всех зарегистрированных конечных точек.</span><span class="sxs-lookup"><span data-stu-id="777c4-659">Resolves the provided string against the metadata of all registered endpoints.</span></span>
    * <span data-ttu-id="777c4-660">Создает исключение при запуске, если несколько конечных точек использует одно и то же имя.</span><span class="sxs-lookup"><span data-stu-id="777c4-660">Throws an exception on startup if multiple endpoints use the same name.</span></span>
    * <span data-ttu-id="777c4-661">Рекомендуется для общего использования за пределами контроллеров и Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="777c4-661">Recommended for general-purpose use outside of controllers and Razor Pages.</span></span>
* <span data-ttu-id="777c4-662">Использование *значений маршрута* (<xref:Microsoft.AspNetCore.Routing.RouteValuesAddress>) в качестве адреса:</span><span class="sxs-lookup"><span data-stu-id="777c4-662">Using *route values* (<xref:Microsoft.AspNetCore.Routing.RouteValuesAddress>) as the address:</span></span>
    * <span data-ttu-id="777c4-663">Предоставляет аналогичные устаревшие функции по формированию URL-адресов для контроллеров и Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="777c4-663">Provides similar functionality to controllers and Razor Pages legacy URL generation.</span></span>
    * <span data-ttu-id="777c4-664">Очень сложные расширение и отладка.</span><span class="sxs-lookup"><span data-stu-id="777c4-664">Very complex to extend and debug.</span></span>
    * <span data-ttu-id="777c4-665">Предоставляет реализацию, используемую `IUrlHelper`, вспомогательными функциями тегов, вспомогательными методами HTML, результатами действий и т. д.</span><span class="sxs-lookup"><span data-stu-id="777c4-665">Provides the implementation used by `IUrlHelper`, Tag Helpers, HTML Helpers, Action Results, etc.</span></span>

<span data-ttu-id="777c4-666">Роль схемы адресов заключается в том, чтобы создать связь между адресом и соответствующими конечными точками по произвольным критериям.</span><span class="sxs-lookup"><span data-stu-id="777c4-666">The role of the address scheme is to make the association between the address and matching endpoints by arbitrary criteria:</span></span>

* <span data-ttu-id="777c4-667">При использовании схемы имен конечных точек выполняется простой поиск по словарю.</span><span class="sxs-lookup"><span data-stu-id="777c4-667">The endpoint name scheme performs a basic dictionary lookup.</span></span>
* <span data-ttu-id="777c4-668">Схема значений маршрута сложная и включает лучшее подмножество множества алгоритмов.</span><span class="sxs-lookup"><span data-stu-id="777c4-668">The route values scheme has a complex best subset of set algorithm.</span></span>

<a name="ambient"></a>

### <a name="ambient-values-and-explicit-values"></a><span data-ttu-id="777c4-669">Значения окружения и явные значения</span><span class="sxs-lookup"><span data-stu-id="777c4-669">Ambient values and explicit values</span></span>

<span data-ttu-id="777c4-670">Из текущего запроса маршрутизация обращается к значениям маршрута текущего запроса `HttpContext.Request.RouteValues`.</span><span class="sxs-lookup"><span data-stu-id="777c4-670">From the current request, routing accesses the route values of the current request `HttpContext.Request.RouteValues`.</span></span> <span data-ttu-id="777c4-671">Значения, связанные с текущим запросом, называются **значениями окружения**.</span><span class="sxs-lookup"><span data-stu-id="777c4-671">The values associated with the current request are referred to as the **ambient values**.</span></span> <span data-ttu-id="777c4-672">В целях ясности в документации подразумеваются значения маршрута, передаваемые в методы как **явные значения**.</span><span class="sxs-lookup"><span data-stu-id="777c4-672">For the purpose of clarity, the documentation refers to the route values passed in to methods as **explicit values**.</span></span>

<span data-ttu-id="777c4-673">В следующем примере показаны значения окружения и явные значения.</span><span class="sxs-lookup"><span data-stu-id="777c4-673">The following example shows ambient values and explicit values.</span></span> <span data-ttu-id="777c4-674">Он предоставляет значения окружения из текущего запроса и явные значения: `{ id = 17, }`:</span><span class="sxs-lookup"><span data-stu-id="777c4-674">It provides ambient values from the current request and explicit values: `{ id = 17, }`:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/Controllers/WidgetController.cs?name=snippet)]

<span data-ttu-id="777c4-675">Предыдущий код:</span><span class="sxs-lookup"><span data-stu-id="777c4-675">The preceding code:</span></span>

* <span data-ttu-id="777c4-676">Возвращает `/Widget/Index/17`.</span><span class="sxs-lookup"><span data-stu-id="777c4-676">Returns `/Widget/Index/17`</span></span>
* <span data-ttu-id="777c4-677">Получает <xref:Microsoft.AspNetCore.Routing.LinkGenerator> через [DI](xref:fundamentals/dependency-injection).</span><span class="sxs-lookup"><span data-stu-id="777c4-677">Gets <xref:Microsoft.AspNetCore.Routing.LinkGenerator> via [DI](xref:fundamentals/dependency-injection).</span></span>

<span data-ttu-id="777c4-678">Следующий код не предоставляет значения окружения и явные значения: `{ controller = "Home", action = "Subscribe", id = 17, }`:</span><span class="sxs-lookup"><span data-stu-id="777c4-678">The following code provides no ambient values and explicit values: `{ controller = "Home", action = "Subscribe", id = 17, }`:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/Controllers/WidgetController.cs?name=snippet2)]

<span data-ttu-id="777c4-679">Предыдущий метод возвращает `/Home/Subscribe/17`</span><span class="sxs-lookup"><span data-stu-id="777c4-679">The preceding  method returns `/Home/Subscribe/17`</span></span>

<span data-ttu-id="777c4-680">Следующий код в `WidgetController` возвращает `/Widget/Subscribe/17`:</span><span class="sxs-lookup"><span data-stu-id="777c4-680">The following code in the `WidgetController` returns `/Widget/Subscribe/17`:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/Controllers/WidgetController.cs?name=snippet3)]

<span data-ttu-id="777c4-681">Следующий код предоставляет контроллер из значений окружения в текущем запросе и явные значения: `{ action = "Edit", id = 17, }`:</span><span class="sxs-lookup"><span data-stu-id="777c4-681">The following code provides the controller from ambient values in the current request and explicit values: `{ action = "Edit", id = 17, }`:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/Controllers/GadgetController.cs?name=snippet)]

<span data-ttu-id="777c4-682">В приведенном выше коде:</span><span class="sxs-lookup"><span data-stu-id="777c4-682">In the preceding code:</span></span>

* <span data-ttu-id="777c4-683">Возвращается `/Gadget/Edit/17`.</span><span class="sxs-lookup"><span data-stu-id="777c4-683">`/Gadget/Edit/17` is returned.</span></span>
* <span data-ttu-id="777c4-684"><xref:Microsoft.AspNetCore.Mvc.ControllerBase.Url> получает <xref:Microsoft.AspNetCore.Mvc.IUrlHelper>.</span><span class="sxs-lookup"><span data-stu-id="777c4-684"><xref:Microsoft.AspNetCore.Mvc.ControllerBase.Url> gets the <xref:Microsoft.AspNetCore.Mvc.IUrlHelper>.</span></span>
* <xref:Microsoft.AspNetCore.Mvc.UrlHelperExtensions.Action*>   
<span data-ttu-id="777c4-685">создает URL-адрес с абсолютным путем для метода действия.</span><span class="sxs-lookup"><span data-stu-id="777c4-685">generates a URL with an absolute path for an action method.</span></span> <span data-ttu-id="777c4-686">URL-адрес содержит указанное имя `action` и значения `route`.</span><span class="sxs-lookup"><span data-stu-id="777c4-686">The URL contains the specified `action` name and `route` values.</span></span>

<span data-ttu-id="777c4-687">Следующий код предоставляет значения окружения из текущего запроса и явные значения: `{ page = "./Edit, id = 17, }`:</span><span class="sxs-lookup"><span data-stu-id="777c4-687">The following code provides ambient values from the current request and explicit values: `{ page = "./Edit, id = 17, }`:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/Pages/Index.cshtml.cs?name=snippet)]

<span data-ttu-id="777c4-688">Приведенный выше код задает для `/Edit/17` значение `url`, когда страница Edit Razor содержит следующую директиву:</span><span class="sxs-lookup"><span data-stu-id="777c4-688">The preceding code sets `url` to  `/Edit/17` when the Edit Razor Page contains the following page directive:</span></span>

 `@page "{id:int}"`

<span data-ttu-id="777c4-689">Если страница Edit не содержит шаблон маршрута `"{id:int}"`, то `url` будет `/Edit?id=17`.</span><span class="sxs-lookup"><span data-stu-id="777c4-689">If the Edit page doesn't contain the `"{id:int}"` route template, `url` is `/Edit?id=17`.</span></span>

<span data-ttu-id="777c4-690">Поведение <xref:Microsoft.AspNetCore.Mvc.IUrlHelper> MVC добавляет уровень сложности, помимо правил, описанных здесь.</span><span class="sxs-lookup"><span data-stu-id="777c4-690">The behavior of MVC's <xref:Microsoft.AspNetCore.Mvc.IUrlHelper> adds a layer of complexity in addition to the rules described here:</span></span>

* <span data-ttu-id="777c4-691">`IUrlHelper` всегда предоставляет значения маршрута из текущего запроса как значения окружения.</span><span class="sxs-lookup"><span data-stu-id="777c4-691">`IUrlHelper` always provides the route values from the current request as ambient values.</span></span>
* <span data-ttu-id="777c4-692">[IUrlHelper.Action](xref:Microsoft.AspNetCore.Mvc.UrlHelperExtensions.Action*) всегда копирует текущие значения маршрута `action` и `controller` как явные значения, если они не переопределены разработчиком.</span><span class="sxs-lookup"><span data-stu-id="777c4-692">[IUrlHelper.Action](xref:Microsoft.AspNetCore.Mvc.UrlHelperExtensions.Action*) always copies the current `action` and `controller` route values as explicit values unless overridden by the developer.</span></span>
* <span data-ttu-id="777c4-693">[IUrlHelper.Page](xref:Microsoft.AspNetCore.Mvc.UrlHelperExtensions.Page*) всегда копирует текущее значение маршрута `page` как явное значение, если оно не переопределено.</span><span class="sxs-lookup"><span data-stu-id="777c4-693">[IUrlHelper.Page](xref:Microsoft.AspNetCore.Mvc.UrlHelperExtensions.Page*) always copies the current `page` route value as an explicit value unless overridden.</span></span> <!--by the user-->
* <span data-ttu-id="777c4-694">`IUrlHelper.Page` всегда переопределяет текущее значение маршрута `handler` на `null` как явные значения, если оно не переопределено.</span><span class="sxs-lookup"><span data-stu-id="777c4-694">`IUrlHelper.Page` always overrides the current `handler` route value with `null` as an explicit values unless overridden.</span></span>

<span data-ttu-id="777c4-695">Пользователи часто удивляются сведениям о поведении значений окружения, поскольку MVC не следует собственным правилам.</span><span class="sxs-lookup"><span data-stu-id="777c4-695">Users are often surprised by the behavioral details of ambient values, because MVC doesn't seem to follow its own rules.</span></span> <span data-ttu-id="777c4-696">По историческим причинам и для обеспечения совместимости для некоторых значений маршрута, таких как `action`, `controller`, `page` и `handler`, предусмотрено собственное поведение в особых случаях.</span><span class="sxs-lookup"><span data-stu-id="777c4-696">For historical and compatibility reasons, certain route values such as `action`, `controller`, `page`, and `handler` have their own special-case behavior.</span></span>

<span data-ttu-id="777c4-697">Аналогичные функции, предоставляемые `LinkGenerator.GetPathByAction` и `LinkGenerator.GetPathByPage`, дублируют эти аномалии `IUrlHelper` для обеспечения совместимости.</span><span class="sxs-lookup"><span data-stu-id="777c4-697">The equivalent functionality provided by `LinkGenerator.GetPathByAction` and `LinkGenerator.GetPathByPage` duplicates these anomalies of `IUrlHelper` for compatibility.</span></span>

### <a name="url-generation-process"></a><span data-ttu-id="777c4-698">Процесс формирования URL-адреса</span><span class="sxs-lookup"><span data-stu-id="777c4-698">URL generation process</span></span>

<span data-ttu-id="777c4-699">После обнаружения набора конечных точек-кандидатов алгоритм формирования URL-адресов:</span><span class="sxs-lookup"><span data-stu-id="777c4-699">Once the set of candidate endpoints are found, the URL generation algorithm:</span></span>

* <span data-ttu-id="777c4-700">последовательно обрабатывает конечные точки;</span><span class="sxs-lookup"><span data-stu-id="777c4-700">Processes the endpoints iteratively.</span></span>
* <span data-ttu-id="777c4-701">возвращает первый успешный результат.</span><span class="sxs-lookup"><span data-stu-id="777c4-701">Returns the first successful result.</span></span>

<span data-ttu-id="777c4-702">Первый шаг этого процесса называется **аннулированием значения маршрута**.</span><span class="sxs-lookup"><span data-stu-id="777c4-702">The first step in this process is called **route value invalidation**.</span></span>  <span data-ttu-id="777c4-703">Аннулирование значения маршрута — это процесс, с помощью которого маршрутизация решает, какие значения маршрута должны использоваться из значений окружения, а какие следует игнорировать.</span><span class="sxs-lookup"><span data-stu-id="777c4-703">Route value invalidation is the process by which routing decides which route values from the ambient values should be used and which should be ignored.</span></span> <span data-ttu-id="777c4-704">Каждое значение окружения учитывается и либо объединяется с явными значениями, либо игнорируется.</span><span class="sxs-lookup"><span data-stu-id="777c4-704">Each ambient value is considered and either combined with the explicit values, or ignored.</span></span>

<span data-ttu-id="777c4-705">Роль значений окружения заключается в том, что в некоторых распространенных случаях они позволяют сократить для разработчиков объем вводимой информации.</span><span class="sxs-lookup"><span data-stu-id="777c4-705">The best way to think about the role of ambient values is that they attempt to save application developers typing, in some common cases.</span></span> <span data-ttu-id="777c4-706">Как правило, сценарии, в которых полезно использовать значения окружения, связаны с MVC.</span><span class="sxs-lookup"><span data-stu-id="777c4-706">Traditionally, the scenarios where ambient values are helpful are related to MVC:</span></span>

* <span data-ttu-id="777c4-707">При связывании с другим действием в том же контроллере не требуется указывать имя контроллера.</span><span class="sxs-lookup"><span data-stu-id="777c4-707">When linking to another action in the same controller, the controller name doesn't need to be specified.</span></span>
* <span data-ttu-id="777c4-708">При связывании с другим контроллером в той же области не требуется указывать имя области.</span><span class="sxs-lookup"><span data-stu-id="777c4-708">When linking to another controller in the same area, the area name doesn't need to be specified.</span></span>
* <span data-ttu-id="777c4-709">При связывании с тем же методом действия не требуется указывать значения маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-709">When linking to the same action method, route values don't need to be specified.</span></span>
* <span data-ttu-id="777c4-710">При связывании с другой частью приложения, когда вы не хотите передавать значения маршрута, не имеющие смысла в этой части приложения.</span><span class="sxs-lookup"><span data-stu-id="777c4-710">When linking to another part of the app, you don't want to carry over route values that have no meaning in that part of the app.</span></span>

<span data-ttu-id="777c4-711">Вызовы `LinkGenerator` или `IUrlHelper`, которые возвращают `null`, обычно вызываются в результате неправильного понимания аннулирования значения маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-711">Calls to `LinkGenerator` or `IUrlHelper` that return `null` are usually caused by not understanding route value invalidation.</span></span> <span data-ttu-id="777c4-712">Для устранения неполадок аннулирования значения маршрута явно укажите дополнительные значения маршрута, чтобы определить, устранена ли проблема.</span><span class="sxs-lookup"><span data-stu-id="777c4-712">Troubleshoot route value invalidation by explicitly specifying more of the route values to see if that solves the problem.</span></span>

<span data-ttu-id="777c4-713">Аннулирование значения маршрута предполагает, что схема URL-адреса приложения является иерархической, в которой иерархия сформирована слева направо.</span><span class="sxs-lookup"><span data-stu-id="777c4-713">Route value invalidation works on the assumption that the app's URL scheme is hierarchical, with a hierarchy formed from left-to-right.</span></span> <span data-ttu-id="777c4-714">Рассмотрим шаблон маршрута базового контроллера `{controller}/{action}/{id?}`, чтобы понять, как это работает на практике.</span><span class="sxs-lookup"><span data-stu-id="777c4-714">Consider the basic controller route template `{controller}/{action}/{id?}` to get an intuitive sense of how this works in practice.</span></span> <span data-ttu-id="777c4-715">**Изменение** значения **делает недействительными** все значения маршрута, которые отображаются справа.</span><span class="sxs-lookup"><span data-stu-id="777c4-715">A **change** to a value **invalidates** all of the route values that appear to the right.</span></span> <span data-ttu-id="777c4-716">Это отражает предположение об иерархии.</span><span class="sxs-lookup"><span data-stu-id="777c4-716">This reflects the assumption about hierarchy.</span></span> <span data-ttu-id="777c4-717">Если приложение имеет значение окружения для `id`, а операция указывает другое значение для `controller`:</span><span class="sxs-lookup"><span data-stu-id="777c4-717">If the app has an ambient value for `id`, and the operation specifies a different value for the `controller`:</span></span>

* <span data-ttu-id="777c4-718">`id` не будет использоваться повторно, поскольку `{controller}` находится слева от `{id?}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-718">`id` won't be reused because `{controller}` is to the left of `{id?}`.</span></span>

<span data-ttu-id="777c4-719">Некоторые примеры, демонстрирующие этот принцип</span><span class="sxs-lookup"><span data-stu-id="777c4-719">Some examples demonstrating this principle:</span></span>

* <span data-ttu-id="777c4-720">Если явные значения содержат значение для `id`, значение окружения для `id` игнорируется.</span><span class="sxs-lookup"><span data-stu-id="777c4-720">If the explicit values contain a value for `id`, the ambient value for `id` is ignored.</span></span> <span data-ttu-id="777c4-721">Можно использовать значения окружения для `controller` и `action`.</span><span class="sxs-lookup"><span data-stu-id="777c4-721">The ambient values for `controller` and `action` can be used.</span></span>
* <span data-ttu-id="777c4-722">Если явные значения содержат значение для `action`, любое значение окружения для `action` игнорируется.</span><span class="sxs-lookup"><span data-stu-id="777c4-722">If the explicit values contain a value for `action`, any ambient value for `action` is ignored.</span></span> <span data-ttu-id="777c4-723">Можно использовать значения окружения для `controller`.</span><span class="sxs-lookup"><span data-stu-id="777c4-723">The ambient values for `controller` can be used.</span></span> <span data-ttu-id="777c4-724">Если явное значение для `action` отличается от значения окружения для `action`, значение `id` не будет использоваться.</span><span class="sxs-lookup"><span data-stu-id="777c4-724">If the explicit value for `action` is different from the ambient value for `action`, the `id` value won't be used.</span></span>  <span data-ttu-id="777c4-725">Если явное значение для `action` совпадает со значением окружения для `action`, можно использовать значение `id`.</span><span class="sxs-lookup"><span data-stu-id="777c4-725">If the explicit value for `action` is the same as the ambient value for `action`, the `id` value can be used.</span></span>
* <span data-ttu-id="777c4-726">Если явные значения содержат значение для `controller`, любое значение окружения для `controller` игнорируется.</span><span class="sxs-lookup"><span data-stu-id="777c4-726">If the explicit values contain a value for `controller`, any ambient value for `controller` is ignored.</span></span> <span data-ttu-id="777c4-727">Если явное значение для `controller` отличается от значения окружения для `controller`, значения `action` и `id` не будут использоваться.</span><span class="sxs-lookup"><span data-stu-id="777c4-727">If the explicit value for `controller` is different from the ambient value for `controller`, the `action` and `id` values won't be used.</span></span> <span data-ttu-id="777c4-728">Если явное значение для `controller` совпадает со значением окружения для `controller`, можно использовать значения `action` и `id`.</span><span class="sxs-lookup"><span data-stu-id="777c4-728">If the explicit value for `controller` is the same as the ambient value for `controller`, the `action` and `id` values can be used.</span></span>

<span data-ttu-id="777c4-729">Этот процесс усложняется за счет наличия маршрутов атрибутов и выделенных стандартных маршрутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-729">This process is further complicated by the existence of attribute routes and dedicated conventional routes.</span></span> <span data-ttu-id="777c4-730">Стандартные маршруты контроллера, такие как `{controller}/{action}/{id?}`, указывают иерархию с помощью параметров маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-730">Controller conventional routes such as `{controller}/{action}/{id?}` specify a hierarchy using route parameters.</span></span> <span data-ttu-id="777c4-731">Для [выделенных стандартных маршрутов](xref:mvc/controllers/routing#dcr) и [маршрутов атрибутов](xref:mvc/controllers/routing#ar) для контроллеров и Razor Pages:</span><span class="sxs-lookup"><span data-stu-id="777c4-731">For [dedicated conventional routes](xref:mvc/controllers/routing#dcr) and [attribute routes](xref:mvc/controllers/routing#ar) to controllers and Razor Pages:</span></span>

* <span data-ttu-id="777c4-732">Существует иерархия значений маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-732">There is a hierarchy of route values.</span></span>
* <span data-ttu-id="777c4-733">Они не отображаются в шаблоне.</span><span class="sxs-lookup"><span data-stu-id="777c4-733">They don't appear in the template.</span></span>

<span data-ttu-id="777c4-734">В таких случаях формирование URL-адресов определяет концепцию **необходимых значений**.</span><span class="sxs-lookup"><span data-stu-id="777c4-734">For these cases, URL generation defines the **required values** concept.</span></span> <span data-ttu-id="777c4-735">Для конечных точек, созданных контроллерами и Razor Pages, указаны обязательные значения, позволяющие использовать аннулирование значений маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-735">Endpoints created by controllers and Razor Pages have required values specified that allow route value invalidation to work.</span></span>

<span data-ttu-id="777c4-736">Подробный алгоритм аннулирования значения маршрута</span><span class="sxs-lookup"><span data-stu-id="777c4-736">The route value invalidation algorithm in detail:</span></span>

* <span data-ttu-id="777c4-737">Имена обязательных значений объединяются с параметрами маршрута, а затем обрабатываются слева направо.</span><span class="sxs-lookup"><span data-stu-id="777c4-737">The required value names are combined with the route parameters, then processed from left-to-right.</span></span>
* <span data-ttu-id="777c4-738">Для каждого параметра сравнивается значение окружения и явное значение.</span><span class="sxs-lookup"><span data-stu-id="777c4-738">For each parameter, the ambient value and explicit value are compared:</span></span>
    * <span data-ttu-id="777c4-739">Если значение окружения и явное значение совпадают, процесс продолжается.</span><span class="sxs-lookup"><span data-stu-id="777c4-739">If the ambient value and explicit value are the same, the process continues.</span></span>
    * <span data-ttu-id="777c4-740">Если значение окружения задано, а явное значение не задано, то при формировании URL-адреса используется значение окружения.</span><span class="sxs-lookup"><span data-stu-id="777c4-740">If the ambient value is present and the explicit value isn't, the ambient value is used when generating the URL.</span></span>
    * <span data-ttu-id="777c4-741">Если значение окружения отсутствует, а явное значение задано, следует отклонить значение окружения и все последующие значения окружения.</span><span class="sxs-lookup"><span data-stu-id="777c4-741">If the ambient value isn't present and the explicit value is, reject the ambient value and all subsequent ambient values.</span></span>
    * <span data-ttu-id="777c4-742">Если заданы и значение окружения, и явное значение, однако они отличаются, следует отклонить значение окружения и все последующие значения окружения.</span><span class="sxs-lookup"><span data-stu-id="777c4-742">If the ambient value and the explicit value are present, and the two values are different, reject the ambient value and all subsequent ambient values.</span></span>

<span data-ttu-id="777c4-743">На этом этапе операция формирования URL-адреса готова к оценке ограничений маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-743">At this point, the URL generation operation is ready to evaluate route constraints.</span></span> <span data-ttu-id="777c4-744">Набор допустимых значений объединяется со значениями по умолчанию для параметра, предоставляемыми ограничениям.</span><span class="sxs-lookup"><span data-stu-id="777c4-744">The set of accepted values is combined with the parameter default values, which is provided to constraints.</span></span> <span data-ttu-id="777c4-745">Если все ограничения пройдены, операция продолжается.</span><span class="sxs-lookup"><span data-stu-id="777c4-745">If the constraints all pass, the operation continues.</span></span>

<span data-ttu-id="777c4-746">Затем **допустимые значения** можно использовать для расширения шаблона маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-746">Next, the **accepted values** can be used to expand the route template.</span></span> <span data-ttu-id="777c4-747">Шаблон маршрута обрабатывается:</span><span class="sxs-lookup"><span data-stu-id="777c4-747">The route template is processed:</span></span>

* <span data-ttu-id="777c4-748">Слева направо.</span><span class="sxs-lookup"><span data-stu-id="777c4-748">From left-to-right.</span></span>
* <span data-ttu-id="777c4-749">Для каждого параметра заменяется допустимое значение.</span><span class="sxs-lookup"><span data-stu-id="777c4-749">Each parameter has its accepted value substituted.</span></span>
* <span data-ttu-id="777c4-750">В следующих особых случаях:</span><span class="sxs-lookup"><span data-stu-id="777c4-750">With the following special cases:</span></span>
  * <span data-ttu-id="777c4-751">Если в допустимых значениях отсутствует значение и параметр имеет значение по умолчанию, используется значение по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="777c4-751">If the accepted values is missing a value and the parameter has a default value, the default value is used.</span></span>
  * <span data-ttu-id="777c4-752">Если в допустимых значениях отсутствует значение, а параметр является необязательным, обработка продолжается.</span><span class="sxs-lookup"><span data-stu-id="777c4-752">If the accepted values is missing a value and the parameter is optional, processing continues.</span></span>
  * <span data-ttu-id="777c4-753">Если любой параметр маршрута справа от отсутствующего необязательного параметра имеет значение, операция завершается ошибкой.</span><span class="sxs-lookup"><span data-stu-id="777c4-753">If any route parameter to the right of a missing optional parameter has a value, the operation fails.</span></span>
  * <!-- review default-valued parameters optional parameters --> <span data-ttu-id="777c4-754">Смежные параметры со значениями по умолчанию и необязательные параметры по возможности сворачиваются.</span><span class="sxs-lookup"><span data-stu-id="777c4-754">Contiguous default-valued parameters and optional parameters are collapsed where possible.</span></span>

<span data-ttu-id="777c4-755">Явно предоставленные значения, которые не соответствуют сегменту маршрута, добавляются в строку запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-755">Values explicitly provided that don't match a segment of the route are added to the query string.</span></span> <span data-ttu-id="777c4-756">В приведенной ниже таблице показан результат использования шаблона маршрута `{controller}/{action}/{id?}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-756">The following table shows the result when using the route template `{controller}/{action}/{id?}`.</span></span>

| <span data-ttu-id="777c4-757">Значения окружения</span><span class="sxs-lookup"><span data-stu-id="777c4-757">Ambient Values</span></span>                     | <span data-ttu-id="777c4-758">Явные значения</span><span class="sxs-lookup"><span data-stu-id="777c4-758">Explicit Values</span></span>                        | <span data-ttu-id="777c4-759">Результат</span><span class="sxs-lookup"><span data-stu-id="777c4-759">Result</span></span>                  |
| ---------------------------------- | -------------------------------------- | ----------------------- |
| <span data-ttu-id="777c4-760">controller = "Home"</span><span class="sxs-lookup"><span data-stu-id="777c4-760">controller = "Home"</span></span>                | <span data-ttu-id="777c4-761">action = "About"</span><span class="sxs-lookup"><span data-stu-id="777c4-761">action = "About"</span></span>                       | `/Home/About`           |
| <span data-ttu-id="777c4-762">controller = "Home"</span><span class="sxs-lookup"><span data-stu-id="777c4-762">controller = "Home"</span></span>                | <span data-ttu-id="777c4-763">controller = "Order", action = "About"</span><span class="sxs-lookup"><span data-stu-id="777c4-763">controller = "Order", action = "About"</span></span> | `/Order/About`          |
| <span data-ttu-id="777c4-764">controller = "Home", color = "Red"</span><span class="sxs-lookup"><span data-stu-id="777c4-764">controller = "Home", color = "Red"</span></span> | <span data-ttu-id="777c4-765">action = "About"</span><span class="sxs-lookup"><span data-stu-id="777c4-765">action = "About"</span></span>                       | `/Home/About`           |
| <span data-ttu-id="777c4-766">controller = "Home"</span><span class="sxs-lookup"><span data-stu-id="777c4-766">controller = "Home"</span></span>                | <span data-ttu-id="777c4-767">action = "About", color = "Red"</span><span class="sxs-lookup"><span data-stu-id="777c4-767">action = "About", color = "Red"</span></span>        | `/Home/About?color=Red` |

### <a name="problems-with-route-value-invalidation"></a><span data-ttu-id="777c4-768">Проблемы с аннулированием значений маршрута</span><span class="sxs-lookup"><span data-stu-id="777c4-768">Problems with route value invalidation</span></span>

<span data-ttu-id="777c4-769">Начиная с ASP.NET Core 3.0, некоторые схемы формирования URL-адресов, которые используются в более ранних версиях ASP.NET Core, не подходят для формирования URL-адресов.</span><span class="sxs-lookup"><span data-stu-id="777c4-769">As of ASP.NET Core 3.0, some URL generation schemes used in earlier ASP.NET Core versions don't work well with URL generation.</span></span> <span data-ttu-id="777c4-770">Команда ASP.NET Core планирует добавить функции для решения этих задач в будущем выпуске.</span><span class="sxs-lookup"><span data-stu-id="777c4-770">The ASP.NET Core team plans to add features to address these needs in a future release.</span></span> <span data-ttu-id="777c4-771">В настоящее время самое лучшее решение — использовать устаревшую маршрутизацию.</span><span class="sxs-lookup"><span data-stu-id="777c4-771">For now the best solution is to use legacy routing.</span></span>

<span data-ttu-id="777c4-772">В следующем коде показан пример схемы формирования URL-адреса, которая не поддерживается маршрутизацией.</span><span class="sxs-lookup"><span data-stu-id="777c4-772">The following code shows an example of a URL generation scheme that's not supported by routing.</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/StartupUnsupported.cs?name=snippet)]

<span data-ttu-id="777c4-773">В приведенном выше коде параметр маршрута `culture` используется для локализации.</span><span class="sxs-lookup"><span data-stu-id="777c4-773">In the preceding code, the `culture` route parameter is used for localization.</span></span> <span data-ttu-id="777c4-774">Необходимо, чтобы параметр `culture` всегда принимался как значение окружения.</span><span class="sxs-lookup"><span data-stu-id="777c4-774">The desire is to have the `culture` parameter always accepted as an ambient value.</span></span> <span data-ttu-id="777c4-775">Однако параметр `culture` не принимается как значение окружения ввиду способа работы требуемых значений.</span><span class="sxs-lookup"><span data-stu-id="777c4-775">However, the `culture` parameter is not accepted as an ambient value because of the way required values work:</span></span>

* <span data-ttu-id="777c4-776">В шаблоне маршрута `"default"` параметр маршрута `culture` находится слева от `controller`, поэтому изменения `controller` не приведут к аннулированию `culture`.</span><span class="sxs-lookup"><span data-stu-id="777c4-776">In the `"default"` route template, the `culture` route parameter is to the left of `controller`, so changes to `controller` won't invalidate `culture`.</span></span>
* <span data-ttu-id="777c4-777">В шаблоне маршрута `"blog"` параметр маршрута `culture` рассматривается как находящийся справа от `controller`, который имеется в требуемых значениях.</span><span class="sxs-lookup"><span data-stu-id="777c4-777">In the `"blog"` route template, the `culture` route parameter is considered to be to the right of `controller`, which appears in the required values.</span></span>

## <a name="configuring-endpoint-metadata"></a><span data-ttu-id="777c4-778">Настройка метаданных конечной точки</span><span class="sxs-lookup"><span data-stu-id="777c4-778">Configuring endpoint metadata</span></span>

<span data-ttu-id="777c4-779">Сведения о настройке метаданных конечной точки см. на следующих веб-страницах:</span><span class="sxs-lookup"><span data-stu-id="777c4-779">The following links provide information on configuring endpoint metadata:</span></span>

* [<span data-ttu-id="777c4-780">Включение CORS с маршрутизацией конечных точек</span><span class="sxs-lookup"><span data-stu-id="777c4-780">Enable Cors with endpoint routing</span></span>](xref:security/cors#enable-cors-with-endpoint-routing)
* <span data-ttu-id="777c4-781">[Пример IAuthorizationPolicyProvider](https://github.com/dotnet/AspNetCore/tree/release/3.1/src/Security/samples/CustomPolicyProvider) с использованием настраиваемого атрибута `[MinimumAgeAuthorize]`</span><span class="sxs-lookup"><span data-stu-id="777c4-781">[IAuthorizationPolicyProvider sample](https://github.com/dotnet/AspNetCore/tree/release/3.1/src/Security/samples/CustomPolicyProvider) using a custom `[MinimumAgeAuthorize]` attribute</span></span>
* <span data-ttu-id="777c4-782">[Тестирование проверки подлинности с использованием атрибута [Authorize]](xref:security/authentication/identity#test-identity)</span><span class="sxs-lookup"><span data-stu-id="777c4-782">[Test authentication with the [Authorize] attribute](xref:security/authentication/identity#test-identity)</span></span>
* <xref:Microsoft.AspNetCore.Builder.AuthorizationEndpointConventionBuilderExtensions.RequireAuthorization*>
* <span data-ttu-id="777c4-783">[Выбор схемы с использованием атрибута [Authorize]](xref:security/authorization/limitingidentitybyscheme#selecting-the-scheme-with-the-authorize-attribute)</span><span class="sxs-lookup"><span data-stu-id="777c4-783">[Selecting the scheme with the [Authorize] attribute](xref:security/authorization/limitingidentitybyscheme#selecting-the-scheme-with-the-authorize-attribute)</span></span>
* <span data-ttu-id="777c4-784">[Применение политик с использованием атрибута [Authorize]](xref:security/authorization/policies#apply-policies-to-mvc-controllers)</span><span class="sxs-lookup"><span data-stu-id="777c4-784">[Apply policies using the [Authorize] attribute](xref:security/authorization/policies#apply-policies-to-mvc-controllers)</span></span>
* <xref:security/authorization/roles>

<a name="hostmatch"></a>

## <a name="host-matching-in-routes-with-requirehost"></a><span data-ttu-id="777c4-785">Сопоставление узлов в маршрутах с помощью RequireHost</span><span class="sxs-lookup"><span data-stu-id="777c4-785">Host matching in routes with RequireHost</span></span>

<span data-ttu-id="777c4-786"><xref:Microsoft.AspNetCore.Builder.RoutingEndpointConventionBuilderExtensions.RequireHost*> применяет к ограничение маршруту, которому требуется указанный узел.</span><span class="sxs-lookup"><span data-stu-id="777c4-786"><xref:Microsoft.AspNetCore.Builder.RoutingEndpointConventionBuilderExtensions.RequireHost*> applies a constraint to the route which requires the specified host.</span></span> <span data-ttu-id="777c4-787">Параметр `RequireHost` или [[Host]](xref:Microsoft.AspNetCore.Routing.HostAttribute) может иметь следующее значение.</span><span class="sxs-lookup"><span data-stu-id="777c4-787">The `RequireHost` or [[Host]](xref:Microsoft.AspNetCore.Routing.HostAttribute) parameter can be:</span></span>

* <span data-ttu-id="777c4-788">Узел: `www.domain.com`, соответствует `www.domain.com` с любым портом.</span><span class="sxs-lookup"><span data-stu-id="777c4-788">Host: `www.domain.com`, matches `www.domain.com` with any port.</span></span>
* <span data-ttu-id="777c4-789">Узел с подстановочным знаком: `*.domain.com`, соответствует `www.domain.com`, `subdomain.domain.com` или `www.subdomain.domain.com` для любого порта.</span><span class="sxs-lookup"><span data-stu-id="777c4-789">Host with wildcard: `*.domain.com`, matches `www.domain.com`, `subdomain.domain.com`, or `www.subdomain.domain.com` on any port.</span></span>
* <span data-ttu-id="777c4-790">Порт: `*:5000`, соответствует порту 5000 с любым узлом.</span><span class="sxs-lookup"><span data-stu-id="777c4-790">Port: `*:5000`, matches port 5000 with any host.</span></span>
* <span data-ttu-id="777c4-791">Узел и порт: `www.domain.com:5000` или `*.domain.com:5000`, соответствует узлу и порту.</span><span class="sxs-lookup"><span data-stu-id="777c4-791">Host and port: `www.domain.com:5000` or `*.domain.com:5000`, matches host and port.</span></span>

<span data-ttu-id="777c4-792">С помощью `RequireHost` или `[Host]` можно указать несколько параметров.</span><span class="sxs-lookup"><span data-stu-id="777c4-792">Multiple parameters can be specified using `RequireHost` or `[Host]`.</span></span> <span data-ttu-id="777c4-793">Ограничение соответствует узлам, допустимым для любого из параметров.</span><span class="sxs-lookup"><span data-stu-id="777c4-793">The constraint  matches hosts valid for any of the parameters.</span></span> <span data-ttu-id="777c4-794">Например, `[Host("domain.com", "*.domain.com")]` соответствует `domain.com`, `www.domain.com` и `subdomain.domain.com`.</span><span class="sxs-lookup"><span data-stu-id="777c4-794">For example, `[Host("domain.com", "*.domain.com")]` matches `domain.com`, `www.domain.com`, and `subdomain.domain.com`.</span></span>

<span data-ttu-id="777c4-795">Следующий код использует `RequireHost`, чтобы запрашивать указанный узел в маршруте:</span><span class="sxs-lookup"><span data-stu-id="777c4-795">The following code uses `RequireHost` to require the specified host on the route:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/StartupRequireHost.cs?name=snippet)]

<span data-ttu-id="777c4-796">Следующий код использует атрибут `[Host]` в контроллере, чтобы запрашивать любой из указанных узлов.</span><span class="sxs-lookup"><span data-stu-id="777c4-796">The following code uses the `[Host]` attribute on the controller to require any of the specified hosts:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/Controllers/ProductController.cs?name=snippet)]

<span data-ttu-id="777c4-797">Если атрибут `[Host]` применяется как к контроллеру, так и к методу действия, выполняется следующее.</span><span class="sxs-lookup"><span data-stu-id="777c4-797">When the `[Host]` attribute is applied to both the controller and action method:</span></span>

* <span data-ttu-id="777c4-798">Используется атрибут действия.</span><span class="sxs-lookup"><span data-stu-id="777c4-798">The attribute on the action is used.</span></span>
* <span data-ttu-id="777c4-799">Атрибут контроллера не учитывается.</span><span class="sxs-lookup"><span data-stu-id="777c4-799">The controller attribute is ignored.</span></span>

## <a name="performance-guidance-for-routing"></a><span data-ttu-id="777c4-800">Рекомендации по производительности для маршрутизации</span><span class="sxs-lookup"><span data-stu-id="777c4-800">Performance guidance for routing</span></span>

<span data-ttu-id="777c4-801">В ASP.NET Core 3.0 была обновлена большая часть маршрутизации, чтобы повысить производительность.</span><span class="sxs-lookup"><span data-stu-id="777c4-801">Most of routing was updated in ASP.NET Core 3.0 to increase performance.</span></span>

<span data-ttu-id="777c4-802">Проблемы с производительностью в приложении зачастую связывали с маршрутизацией.</span><span class="sxs-lookup"><span data-stu-id="777c4-802">When an app has performance problems, routing is often suspected as the problem.</span></span> <span data-ttu-id="777c4-803">Причиной этому является то, что такие платформы, как контроллеры и Razor Pages, сообщают о количестве времени, затраченном на работу платформы, в сообщениях журнала.</span><span class="sxs-lookup"><span data-stu-id="777c4-803">The reason routing is suspected is that frameworks like controllers and Razor Pages report the amount of time spent inside the framework in their logging messages.</span></span> <span data-ttu-id="777c4-804">Если время, указанное контроллерами, значительно отличается от общего времени запроса:</span><span class="sxs-lookup"><span data-stu-id="777c4-804">When there's a significant difference between the time reported by controllers and the total time of the request:</span></span>

* <span data-ttu-id="777c4-805">Разработчики исключают код приложения из списка возможных источников проблемы.</span><span class="sxs-lookup"><span data-stu-id="777c4-805">Developers eliminate their app code as the source of the problem.</span></span>
* <span data-ttu-id="777c4-806">Обычно предполагается, что причиной является маршрутизация.</span><span class="sxs-lookup"><span data-stu-id="777c4-806">It's common to assume routing is the cause.</span></span>

<span data-ttu-id="777c4-807">Для проверки производительности маршрутизации используются тысячи конечных точек.</span><span class="sxs-lookup"><span data-stu-id="777c4-807">Routing is performance tested using thousands of endpoints.</span></span> <span data-ttu-id="777c4-808">Маловероятно, что обычное приложение столкнется с проблемами с производительностью только лишь из-за того, что оно слишком большое.</span><span class="sxs-lookup"><span data-stu-id="777c4-808">It's unlikely that a typical app will encounter a performance problem just by being too large.</span></span> <span data-ttu-id="777c4-809">Наиболее распространенная причина снижения производительности маршрутизации обычно кроется в неправильной работе настраиваемого ПО промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="777c4-809">The most common root cause of slow routing performance is usually a badly-behaving custom middleware.</span></span>

<span data-ttu-id="777c4-810">В следующем примере кода показан базовый метод сокращения источника задержки.</span><span class="sxs-lookup"><span data-stu-id="777c4-810">This following code sample demonstrates a basic technique for narrowing down the source of delay:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/StartupDelay.cs?name=snippet)]

<span data-ttu-id="777c4-811">Для маршрутизации времени:</span><span class="sxs-lookup"><span data-stu-id="777c4-811">To time routing:</span></span>

* <span data-ttu-id="777c4-812">Чередуйте каждое ПО промежуточного слоя с копией ПО промежуточного слоя времени, показанного в предыдущем коде.</span><span class="sxs-lookup"><span data-stu-id="777c4-812">Interleave each middleware with a copy of the timing middleware shown in the preceding code.</span></span>
* <span data-ttu-id="777c4-813">Добавьте уникальный идентификатор для сопоставления данных о времени с кодом.</span><span class="sxs-lookup"><span data-stu-id="777c4-813">Add a unique identifier to correlate the timing data with the code.</span></span>

<span data-ttu-id="777c4-814">Это базовый способ сократить задержку, когда она является существенной, например более `10ms`.</span><span class="sxs-lookup"><span data-stu-id="777c4-814">This is a basic way to narrow down the delay when it's significant, for example, more than `10ms`.</span></span>  <span data-ttu-id="777c4-815">Вычитание `Time 2` из `Time 1` позволяет получить время, затраченное в ПО промежуточного слоя `UseRouting`.</span><span class="sxs-lookup"><span data-stu-id="777c4-815">Subtracting `Time 2` from `Time 1` reports the time spent inside the `UseRouting` middleware.</span></span>

<span data-ttu-id="777c4-816">Следующий код использует более компактный подход к предыдущему коду времени.</span><span class="sxs-lookup"><span data-stu-id="777c4-816">The following code uses a more compact approach to the preceding timing code:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/StartupSW.cs?name=snippetSW)]

[!code-csharp[](routing/samples/3.x/RoutingSample/StartupSW.cs?name=snippet)]

### <a name="potentially-expensive-routing-features"></a><span data-ttu-id="777c4-817">Потенциально ресурсоемкие функции маршрутизации</span><span class="sxs-lookup"><span data-stu-id="777c4-817">Potentially expensive routing features</span></span>

<span data-ttu-id="777c4-818">В списке ниже представлены некоторые сведения о функциях маршрутизации, которые относительно ресурсоемкие по сравнению с базовыми шаблонами маршрутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-818">The following list provides some insight into routing features that are relatively expensive compared with basic route templates:</span></span>

* <span data-ttu-id="777c4-819">Регулярные выражения: можно написать регулярные выражения, которые являются сложными или имеют длительное время выполнения и небольшой объем входных данных.</span><span class="sxs-lookup"><span data-stu-id="777c4-819">Regular expressions: It's possible to write regular expressions that are complex, or have long running time with a small amount of input.</span></span>

* <span data-ttu-id="777c4-820">Сложные сегменты (`{x}-{y}-{z}`):</span><span class="sxs-lookup"><span data-stu-id="777c4-820">Complex segments (`{x}-{y}-{z}`):</span></span> 
  * <span data-ttu-id="777c4-821">значительно более ресурсоемкие, чем анализ обычного сегмента URL-пути.</span><span class="sxs-lookup"><span data-stu-id="777c4-821">Are significantly more expensive than parsing a regular URL path segment.</span></span>
  * <span data-ttu-id="777c4-822">В результате выделяется множество дополнительных подстрок.</span><span class="sxs-lookup"><span data-stu-id="777c4-822">Result in many more substrings being allocated.</span></span>
  * <span data-ttu-id="777c4-823">В обновлении производительности маршрутизации ASP.NET Core 3.0 не была обновлена логика комплексного сегмента.</span><span class="sxs-lookup"><span data-stu-id="777c4-823">The complex segment logic was not updated in ASP.NET Core 3.0 routing performance update.</span></span>

* <span data-ttu-id="777c4-824">Синхронный доступ к данным: многие сложные приложения имеют доступ к базе данных в рамках своей маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-824">Synchronous data access: Many complex apps have database access as part of their routing.</span></span> <span data-ttu-id="777c4-825">Маршрутизация в ASP.NET Core 2.2 и более ранних версиях может не предоставлять надлежащие точки расширения для поддержки маршрутизации доступа к базе данных.</span><span class="sxs-lookup"><span data-stu-id="777c4-825">ASP.NET Core 2.2 and earlier routing might not provide the right extensibility points to support database access routing.</span></span> <span data-ttu-id="777c4-826">Например, <xref:Microsoft.AspNetCore.Routing.IRouteConstraint> и <xref:Microsoft.AspNetCore.Mvc.ActionConstraints.IActionConstraint> являются синхронными.</span><span class="sxs-lookup"><span data-stu-id="777c4-826">For example, <xref:Microsoft.AspNetCore.Routing.IRouteConstraint>, and <xref:Microsoft.AspNetCore.Mvc.ActionConstraints.IActionConstraint> are synchronous.</span></span> <span data-ttu-id="777c4-827">Точки расширения, такие как <xref:Microsoft.AspNetCore.Routing.MatcherPolicy> и <xref:Microsoft.AspNetCore.Routing.EndpointSelectorContext>, являются асинхронными.</span><span class="sxs-lookup"><span data-stu-id="777c4-827">Extensibility points such as <xref:Microsoft.AspNetCore.Routing.MatcherPolicy> and <xref:Microsoft.AspNetCore.Routing.EndpointSelectorContext> are asynchronous.</span></span>

## <a name="guidance-for-library-authors"></a><span data-ttu-id="777c4-828">Руководство для авторов библиотек</span><span class="sxs-lookup"><span data-stu-id="777c4-828">Guidance for library authors</span></span>

<span data-ttu-id="777c4-829">В этом разделе содержатся рекомендации для авторов библиотек, создающих библиотеки на основе маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-829">This section contains guidance for library authors building on top of routing.</span></span> <span data-ttu-id="777c4-830">Эти сведения предназначены для предоставления разработчикам приложений сведений об эффективном использовании библиотек и платформ, расширяющих маршрутизацию.</span><span class="sxs-lookup"><span data-stu-id="777c4-830">These details are intended to ensure that app developers have a good experience using libraries and frameworks that extend routing.</span></span>

### <a name="define-endpoints"></a><span data-ttu-id="777c4-831">Определение конечных точек</span><span class="sxs-lookup"><span data-stu-id="777c4-831">Define endpoints</span></span>

<span data-ttu-id="777c4-832">Чтобы создать платформу, использующую маршрутизацию для сопоставления URL-адресов, начните с определения пользовательского интерфейса, который строится поверх <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseEndpoints*>.</span><span class="sxs-lookup"><span data-stu-id="777c4-832">To create a framework that uses routing for URL matching, start by defining a user experience that builds on top of <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseEndpoints*>.</span></span>

<span data-ttu-id="777c4-833">**ВЫПОЛНИТЕ** сборку поверх <xref:Microsoft.AspNetCore.Routing.IEndpointRouteBuilder>.</span><span class="sxs-lookup"><span data-stu-id="777c4-833">**DO** build on top of <xref:Microsoft.AspNetCore.Routing.IEndpointRouteBuilder>.</span></span> <span data-ttu-id="777c4-834">Это позволит пользователям создать инфраструктуру с другими функциями ASP.NET Core без путаницы.</span><span class="sxs-lookup"><span data-stu-id="777c4-834">This allows users to compose your framework with other ASP.NET Core features without confusion.</span></span> <span data-ttu-id="777c4-835">Каждый шаблон ASP.NET Core включает в себя маршрутизацию.</span><span class="sxs-lookup"><span data-stu-id="777c4-835">Every ASP.NET Core template includes routing.</span></span> <span data-ttu-id="777c4-836">Предположим, что маршрутизация имеется и пользователи знакомы с ней.</span><span class="sxs-lookup"><span data-stu-id="777c4-836">Assume routing is present and familiar for users.</span></span>

```csharp
app.UseEndpoints(endpoints =>
{
    // Your framework
    endpoints.MapMyFramework(...);

    endpoints.MapHealthChecks("/healthz");
});
```

<span data-ttu-id="777c4-837">**ВЕРНИТЕ** запечатанный конкретный тип из вызова `MapMyFramework(...)`, реализующего <xref:Microsoft.AspNetCore.Builder.IEndpointConventionBuilder>.</span><span class="sxs-lookup"><span data-stu-id="777c4-837">**DO** return a sealed concrete type from a call to `MapMyFramework(...)` that implements <xref:Microsoft.AspNetCore.Builder.IEndpointConventionBuilder>.</span></span> <span data-ttu-id="777c4-838">Большинство методов `Map...` платформы соответствует этому шаблону.</span><span class="sxs-lookup"><span data-stu-id="777c4-838">Most framework `Map...` methods follow this pattern.</span></span> <span data-ttu-id="777c4-839">Интерфейс `IEndpointConventionBuilder`:</span><span class="sxs-lookup"><span data-stu-id="777c4-839">The `IEndpointConventionBuilder` interface:</span></span>

* <span data-ttu-id="777c4-840">Обеспечивает сочетаемость метаданных.</span><span class="sxs-lookup"><span data-stu-id="777c4-840">Allows composability of metadata.</span></span>
* <span data-ttu-id="777c4-841">Предназначен для различных методов расширения.</span><span class="sxs-lookup"><span data-stu-id="777c4-841">Is targeted by a variety of extension methods.</span></span>

<span data-ttu-id="777c4-842">Объявление собственного типа позволяет добавлять в построитель собственные функции для конкретной платформы.</span><span class="sxs-lookup"><span data-stu-id="777c4-842">Declaring your own type allows you to add your own framework-specific functionality to the builder.</span></span> <span data-ttu-id="777c4-843">Можно заключить в оболочку построитель, объявленный в платформе, и пересылать в него вызовы.</span><span class="sxs-lookup"><span data-stu-id="777c4-843">It's ok to wrap a framework-declared builder and forward calls to it.</span></span>

```csharp
app.UseEndpoints(endpoints =>
{
    // Your framework
    endpoints.MapMyFramework(...).RequireAuthorization()
                                 .WithMyFrameworkFeature(awesome: true);

    endpoints.MapHealthChecks("/healthz");
});
```

<span data-ttu-id="777c4-844">**НАПИШИТЕ** собственный <xref:Microsoft.AspNetCore.Routing.EndpointDataSource>.</span><span class="sxs-lookup"><span data-stu-id="777c4-844">**CONSIDER** writing your own <xref:Microsoft.AspNetCore.Routing.EndpointDataSource>.</span></span> <span data-ttu-id="777c4-845">`EndpointDataSource` — это низкоуровневый примитив для объявления и обновления коллекции конечных точек.</span><span class="sxs-lookup"><span data-stu-id="777c4-845">`EndpointDataSource` is the low-level primitive for declaring and updating a collection of endpoints.</span></span> <span data-ttu-id="777c4-846">`EndpointDataSource` — это эффективный API, используемый контроллерами и Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="777c4-846">`EndpointDataSource` is a powerful API used by controllers and Razor Pages.</span></span>

<span data-ttu-id="777c4-847">В тестах маршрутизации имеется [простой пример](https://github.com/aspnet/AspNetCore/blob/master/src/Http/Routing/test/testassets/RoutingSandbox/Framework/FrameworkEndpointDataSource.cs#L17) источника данных, который не обновляется.</span><span class="sxs-lookup"><span data-stu-id="777c4-847">The routing tests have a [basic example](https://github.com/aspnet/AspNetCore/blob/master/src/Http/Routing/test/testassets/RoutingSandbox/Framework/FrameworkEndpointDataSource.cs#L17) of a non-updating data source.</span></span>

<span data-ttu-id="777c4-848">**НЕ** пытайтесь зарегистрировать `EndpointDataSource` по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="777c4-848">**DO NOT** attempt to register an `EndpointDataSource` by default.</span></span> <span data-ttu-id="777c4-849">Требуйте от пользователей, чтобы они регистрировали вашу платформу в <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseEndpoints*>.</span><span class="sxs-lookup"><span data-stu-id="777c4-849">Require users to register your framework in <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseEndpoints*>.</span></span> <span data-ttu-id="777c4-850">Философия маршрутизации заключается в том, что по умолчанию ничего не включено и `UseEndpoints` представляет собой место для регистрации конечных точек.</span><span class="sxs-lookup"><span data-stu-id="777c4-850">The philosophy of routing is that nothing is included by default, and that `UseEndpoints` is the place to register endpoints.</span></span>

### <a name="creating-routing-integrated-middleware"></a><span data-ttu-id="777c4-851">Создание ПО промежуточного слоя со встроенной маршрутизацией</span><span class="sxs-lookup"><span data-stu-id="777c4-851">Creating routing-integrated middleware</span></span>

<span data-ttu-id="777c4-852">**РАССМОТРИТЕ ВОЗМОЖНОСТЬ** определения типов метаданных в качестве интерфейса.</span><span class="sxs-lookup"><span data-stu-id="777c4-852">**CONSIDER** defining metadata types as an interface.</span></span>

<span data-ttu-id="777c4-853">**СДЕЛАЙТЕ** возможным использование типов метаданных в качестве атрибута в классах и методах.</span><span class="sxs-lookup"><span data-stu-id="777c4-853">**DO** make it possible to use metadata types as an attribute on classes and methods.</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/ICoolMetadata.cs?name=snippet2)]

<span data-ttu-id="777c4-854">Платформы, такие как контроллеры и Razor Pages, поддерживают применение атрибутов метаданных к типам и методам.</span><span class="sxs-lookup"><span data-stu-id="777c4-854">Frameworks like controllers and Razor Pages support applying metadata attributes to types and methods.</span></span> <span data-ttu-id="777c4-855">При объявлении типов метаданных:</span><span class="sxs-lookup"><span data-stu-id="777c4-855">If you declare metadata types:</span></span>

* <span data-ttu-id="777c4-856">Сделайте их доступными в качестве [атрибутов](/dotnet/csharp/programming-guide/concepts/attributes/).</span><span class="sxs-lookup"><span data-stu-id="777c4-856">Make them accessible as [attributes](/dotnet/csharp/programming-guide/concepts/attributes/).</span></span>
* <span data-ttu-id="777c4-857">Большинство пользователей знакомы с применением атрибутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-857">Most users are familiar with applying attributes.</span></span>

<span data-ttu-id="777c4-858">Объявление типа метаданных в качестве интерфейса добавляет еще один уровень гибкости.</span><span class="sxs-lookup"><span data-stu-id="777c4-858">Declaring a metadata type as an interface adds another layer of flexibility:</span></span>

* <span data-ttu-id="777c4-859">Интерфейсы являются составными.</span><span class="sxs-lookup"><span data-stu-id="777c4-859">Interfaces are composable.</span></span>
* <span data-ttu-id="777c4-860">Разработчики могут объявлять собственные типы, объединяющие несколько политик.</span><span class="sxs-lookup"><span data-stu-id="777c4-860">Developers can declare their own types that combine multiple policies.</span></span>

<span data-ttu-id="777c4-861">**СДЕЛАЙТЕ** возможным переопределение метаданных, как показано в следующем примере.</span><span class="sxs-lookup"><span data-stu-id="777c4-861">**DO** make it possible to override metadata, as shown in the following example:</span></span>

[!code-csharp[](routing/samples/3.x/RoutingSample/ICoolMetadata.cs?name=snippet)]

<span data-ttu-id="777c4-862">Следуйте этим рекомендациям, чтобы избежать определения **метаданных маркера**.</span><span class="sxs-lookup"><span data-stu-id="777c4-862">The best way to follow these guidelines is to avoid defining **marker metadata**:</span></span>

* <span data-ttu-id="777c4-863">Не стоит просто искать тип метаданных.</span><span class="sxs-lookup"><span data-stu-id="777c4-863">Don't just look for the presence of a metadata type.</span></span>
* <span data-ttu-id="777c4-864">Определите свойство метаданных и проверьте его.</span><span class="sxs-lookup"><span data-stu-id="777c4-864">Define a property on the metadata and check the property.</span></span>

<span data-ttu-id="777c4-865">Коллекция метаданных является упорядоченной и поддерживает переопределение приоритета.</span><span class="sxs-lookup"><span data-stu-id="777c4-865">The metadata collection is ordered and supports overriding by priority.</span></span> <span data-ttu-id="777c4-866">В случае с контроллерами метаданные в методе действия являются наиболее специфичными.</span><span class="sxs-lookup"><span data-stu-id="777c4-866">In the case of controllers, metadata on the action method is most specific.</span></span>

<span data-ttu-id="777c4-867">**СДЕЛАЙТЕ** ПО промежуточного слоя полезным как с маршрутизацией, так и без нее.</span><span class="sxs-lookup"><span data-stu-id="777c4-867">**DO** make middleware useful with and without routing.</span></span>

```csharp
app.UseRouting();

app.UseAuthorization(new AuthorizationPolicy() { ... });

app.UseEndpoints(endpoints =>
{
    // Your framework
    endpoints.MapMyFramework(...).RequireAuthorization();
});
```

<span data-ttu-id="777c4-868">В качестве примера этой рекомендации рассмотрим ПО промежуточного слоя `UseAuthorization`.</span><span class="sxs-lookup"><span data-stu-id="777c4-868">As an example of this guideline, consider the `UseAuthorization` middleware.</span></span> <span data-ttu-id="777c4-869">ПО промежуточного слоя авторизации позволяет передавать политику отката.</span><span class="sxs-lookup"><span data-stu-id="777c4-869">The authorization middleware allows you to pass in a fallback policy.</span></span> <!-- shown where?  (shown here) --> <span data-ttu-id="777c4-870">Политика отката, если она указана, применяется к обоим элементам:</span><span class="sxs-lookup"><span data-stu-id="777c4-870">The fallback policy, if specified, applies to both:</span></span>

* <span data-ttu-id="777c4-871">конечные точки без указанной политики;</span><span class="sxs-lookup"><span data-stu-id="777c4-871">Endpoints without a specified policy.</span></span>
* <span data-ttu-id="777c4-872">запросы, которые не соответствуют конечной точке.</span><span class="sxs-lookup"><span data-stu-id="777c4-872">Requests that don't match an endpoint.</span></span>

<span data-ttu-id="777c4-873">Это сделает ПО промежуточного слоя авторизации полезным вне контекста маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-873">This makes the authorization middleware useful outside of the context of routing.</span></span> <span data-ttu-id="777c4-874">ПО промежуточного слоя авторизации можно использовать для традиционного программирования ПО промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="777c4-874">The authorization middleware can be used for traditional middleware programming.</span></span>

[!INCLUDE[](~/includes/dbg-route.md)]

::: moniker-end

::: moniker range="= aspnetcore-2.2"

<span data-ttu-id="777c4-875">Маршрутизация отвечает за сопоставление URI запросов с конечными точками и отправку входящих запросов к этим конечным точкам.</span><span class="sxs-lookup"><span data-stu-id="777c4-875">Routing is responsible for mapping request URIs to endpoints and dispatching incoming requests to those endpoints.</span></span> <span data-ttu-id="777c4-876">Маршруты определяются в приложении и настраиваются при его запуске.</span><span class="sxs-lookup"><span data-stu-id="777c4-876">Routes are defined in the app and configured when the app starts.</span></span> <span data-ttu-id="777c4-877">Маршрут может также извлекать значения из содержащегося в запросе URL-адреса, которые затем используются для обработки запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-877">A route can optionally extract values from the URL contained in the request, and these values can then be used for request processing.</span></span> <span data-ttu-id="777c4-878">С помощью сведений о маршрутах из приложения маршрутизация также может формировать URL-адреса, которые сопоставляются с конечными точками.</span><span class="sxs-lookup"><span data-stu-id="777c4-878">Using route information from the app, routing is also able to generate URLs that map to endpoints.</span></span>

<span data-ttu-id="777c4-879">Чтобы использовать новейшие сценарии маршрутизации в ASP.NET Core 2.2, укажите [совместимую версию](xref:mvc/compatibility-version) для регистрации служб MVC в `Startup.ConfigureServices`:</span><span class="sxs-lookup"><span data-stu-id="777c4-879">To use the latest routing scenarios in ASP.NET Core 2.2, specify the [compatibility version](xref:mvc/compatibility-version) to the MVC services registration in `Startup.ConfigureServices`:</span></span>

```csharp
services.AddMvc()
    .SetCompatibilityVersion(CompatibilityVersion.Version_2_2);
```

<span data-ttu-id="777c4-880">Параметр <xref:Microsoft.AspNetCore.Mvc.MvcOptions.EnableEndpointRouting> определяет, должна ли маршрутизация внутренне использовать логику, основанную на конечных точках, или логику, основанную на <xref:Microsoft.AspNetCore.Routing.IRouter>, в ASP.NET Core 2.1 или более ранней версии.</span><span class="sxs-lookup"><span data-stu-id="777c4-880">The <xref:Microsoft.AspNetCore.Mvc.MvcOptions.EnableEndpointRouting> option determines if routing should internally use endpoint-based logic or the <xref:Microsoft.AspNetCore.Routing.IRouter>-based logic of ASP.NET Core 2.1 or earlier.</span></span> <span data-ttu-id="777c4-881">Если установлена совместимая версия 2.2 или более поздняя, значение по умолчанию — `true`.</span><span class="sxs-lookup"><span data-stu-id="777c4-881">When the compatibility version is set to 2.2 or later, the default value is `true`.</span></span> <span data-ttu-id="777c4-882">Задайте значение `false`, чтобы использовать предыдущую логику маршрутизации:</span><span class="sxs-lookup"><span data-stu-id="777c4-882">Set the value to `false` to use the prior routing logic:</span></span>

```csharp
// Use the routing logic of ASP.NET Core 2.1 or earlier:
services.AddMvc(options => options.EnableEndpointRouting = false)
    .SetCompatibilityVersion(CompatibilityVersion.Version_2_2);
```

<span data-ttu-id="777c4-883">Дополнительные сведения о маршрутизации на основе <xref:Microsoft.AspNetCore.Routing.IRouter> см. в разделе [о версии ASP.NET Core 2.1 в этой статье](?view=aspnetcore-2.1).</span><span class="sxs-lookup"><span data-stu-id="777c4-883">For more information on <xref:Microsoft.AspNetCore.Routing.IRouter>-based routing, see the [ASP.NET Core 2.1 version of this topic](?view=aspnetcore-2.1).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="777c4-884">В этом документе рассматривается низкоуровневая маршрутизация ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="777c4-884">This document covers low-level ASP.NET Core routing.</span></span> <span data-ttu-id="777c4-885">Сведения о маршрутизации ASP.NET Core MVC см. в разделе <xref:mvc/controllers/routing>.</span><span class="sxs-lookup"><span data-stu-id="777c4-885">For information on ASP.NET Core MVC routing, see <xref:mvc/controllers/routing>.</span></span> <span data-ttu-id="777c4-886">Сведения о соглашениях о маршрутизации в Razor Pages см. в разделе <xref:razor-pages/razor-pages-conventions>.</span><span class="sxs-lookup"><span data-stu-id="777c4-886">For information on routing conventions in Razor Pages, see <xref:razor-pages/razor-pages-conventions>.</span></span>

<span data-ttu-id="777c4-887">[Просмотреть или скачать образец кода](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/fundamentals/routing/samples) ([как скачивать](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="777c4-887">[View or download sample code](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/fundamentals/routing/samples) ([how to download](xref:index#how-to-download-a-sample))</span></span>

## <a name="routing-basics"></a><span data-ttu-id="777c4-888">Основы маршрутизации</span><span class="sxs-lookup"><span data-stu-id="777c4-888">Routing basics</span></span>

<span data-ttu-id="777c4-889">Для большинства приложений следует выбрать базовую описательную схему маршрутизации таким образом, чтобы URL-адреса были удобочитаемыми и осмысленными.</span><span class="sxs-lookup"><span data-stu-id="777c4-889">Most apps should choose a basic and descriptive routing scheme so that URLs are readable and meaningful.</span></span> <span data-ttu-id="777c4-890">Традиционный маршрут по умолчанию `{controller=Home}/{action=Index}/{id?}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-890">The default conventional route `{controller=Home}/{action=Index}/{id?}`:</span></span>

* <span data-ttu-id="777c4-891">Поддерживает основную и описательную схемы маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-891">Supports a basic and descriptive routing scheme.</span></span>
* <span data-ttu-id="777c4-892">Является отправной точкой для приложений на базе пользовательского интерфейса.</span><span class="sxs-lookup"><span data-stu-id="777c4-892">Is a useful starting point for UI-based apps.</span></span>

<span data-ttu-id="777c4-893">Как правило, в зонах приложения с высоким трафиком и в особых случаях добавляются дополнительные краткие маршруты с использованием [маршрутизации с помощью атрибутов](xref:mvc/controllers/routing#attribute-routing) или выделенные традиционные маршруты.</span><span class="sxs-lookup"><span data-stu-id="777c4-893">Developers commonly add additional terse routes to high-traffic areas of an app in specialized situations using [attribute routing](xref:mvc/controllers/routing#attribute-routing) or dedicated conventional routes.</span></span> <span data-ttu-id="777c4-894">Ниже приведены характерные ситуации, например конечные точки блога и интернет-магазина.</span><span class="sxs-lookup"><span data-stu-id="777c4-894">Specialized situations examples include, blog and ecommerce endpoints.</span></span>

<span data-ttu-id="777c4-895">Веб-интерфейсы API должны использовать маршрутизацию с помощью атрибутов, чтобы моделировать функциональность приложения в качестве набора ресурсов, где операции представлены с помощью команд HTTP.</span><span class="sxs-lookup"><span data-stu-id="777c4-895">Web APIs should use attribute routing to model the app's functionality as a set of resources where operations are represented by HTTP verbs.</span></span> <span data-ttu-id="777c4-896">Это означает, что многие операции (например, GET, POST) на одном логическом ресурсе используют одинаковый URL-адрес.</span><span class="sxs-lookup"><span data-stu-id="777c4-896">This means that many operations, for example, GET, and POST, on the same logical resource use the same URL.</span></span> <span data-ttu-id="777c4-897">Маршрутизация с помощью атрибутов обеспечивает необходимый уровень контроля, позволяющий тщательно разработать схему общедоступных конечных точек API-интерфейса.</span><span class="sxs-lookup"><span data-stu-id="777c4-897">Attribute routing provides a level of control that's needed to carefully design an API's public endpoint layout.</span></span>

<span data-ttu-id="777c4-898">Приложения Razor Pages используют стандартную маршрутизацию по умолчанию для предоставления именованных ресурсов в папке *Pages* приложения.</span><span class="sxs-lookup"><span data-stu-id="777c4-898">Razor Pages apps use default conventional routing to serve named resources in the *Pages* folder of an app.</span></span> <span data-ttu-id="777c4-899">Доступны дополнительные соглашения, которые позволяют настроить поведение маршрутизации Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="777c4-899">Additional conventions are available that allow you to customize Razor Pages routing behavior.</span></span> <span data-ttu-id="777c4-900">Дополнительные сведения см. в разделах <xref:razor-pages/index> и <xref:razor-pages/razor-pages-conventions>.</span><span class="sxs-lookup"><span data-stu-id="777c4-900">For more information, see <xref:razor-pages/index> and <xref:razor-pages/razor-pages-conventions>.</span></span>

<span data-ttu-id="777c4-901">Благодаря поддержке создания URL-адресов приложение можно разрабатывать без жесткого программирования URL-адресов для связывания компонентов приложения.</span><span class="sxs-lookup"><span data-stu-id="777c4-901">URL generation support allows the app to be developed without hard-coding URLs to link the app together.</span></span> <span data-ttu-id="777c4-902">Это обеспечивает начало работы с основной конфигурацией маршрутизации и изменение маршрутов после определения схемы ресурсов приложения.</span><span class="sxs-lookup"><span data-stu-id="777c4-902">This support allows for starting with a basic routing configuration and modifying the routes after the app's resource layout is determined.</span></span>

<span data-ttu-id="777c4-903">Маршрутизация использует *конечные точки* (`Endpoint`) для представления логических конечных точек в приложении.</span><span class="sxs-lookup"><span data-stu-id="777c4-903">Routing uses *endpoints* (`Endpoint`) to represent logical endpoints in an app.</span></span>

<span data-ttu-id="777c4-904">Конечная точка определяет делегат для обработки запросов и коллекцию произвольных метаданных.</span><span class="sxs-lookup"><span data-stu-id="777c4-904">An endpoint defines a delegate to process requests and a collection of arbitrary metadata.</span></span> <span data-ttu-id="777c4-905">Метаданные используются для реализации сквозной функциональности на основе политик и конфигурации каждой конечной точки.</span><span class="sxs-lookup"><span data-stu-id="777c4-905">The metadata is used implement cross-cutting concerns based on policies and configuration attached to each endpoint.</span></span>

<span data-ttu-id="777c4-906">Система маршрутизации обладает следующими характеристиками:</span><span class="sxs-lookup"><span data-stu-id="777c4-906">The routing system has the following characteristics:</span></span>

* <span data-ttu-id="777c4-907">Синтаксис шаблона маршрута используется для определения маршрутов с помощью параметров размеченного маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-907">Route template syntax is used to define routes with tokenized route parameters.</span></span>
* <span data-ttu-id="777c4-908">Допускается конфигурация конечной точки в стандартном стиле и с атрибутами.</span><span class="sxs-lookup"><span data-stu-id="777c4-908">Conventional-style and attribute-style endpoint configuration is permitted.</span></span>
* <span data-ttu-id="777c4-909"><xref:Microsoft.AspNetCore.Routing.IRouteConstraint> используется для определения того, содержит ли параметр URL-адреса допустимое значение для ограничения заданной конечной точки.</span><span class="sxs-lookup"><span data-stu-id="777c4-909"><xref:Microsoft.AspNetCore.Routing.IRouteConstraint> is used to determine whether a URL parameter contains a valid value for a given endpoint constraint.</span></span>
* <span data-ttu-id="777c4-910">Модели приложения, такие как MVC и Razor Pages, регистрируют все свои конечные точки, имеющие предсказуемую реализацию сценариев маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-910">App models, such as MVC/Razor Pages, register all of their endpoints, which have a predictable implementation of routing scenarios.</span></span>
* <span data-ttu-id="777c4-911">Реализация маршрутизации принимает решения о маршрутизации в нужном месте конвейера ПО промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="777c4-911">The routing implementation makes routing decisions wherever desired in the middleware pipeline.</span></span>
* <span data-ttu-id="777c4-912">ПО промежуточного слоя, которое появляется после ПО промежуточного слоя маршрутизации, может проверить результат принятия решений о конечной точке, принятое ПО промежуточного слоя маршрутизации для заданного URI запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-912">Middleware that appears after a Routing Middleware can inspect the result of the Routing Middleware's endpoint decision for a given request URI.</span></span>
* <span data-ttu-id="777c4-913">Можно перечислить все конечные точки в приложении в любом месте конвейера ПО промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="777c4-913">It's possible to enumerate all of the endpoints in the app anywhere in the middleware pipeline.</span></span>
* <span data-ttu-id="777c4-914">Приложение может использовать маршрутизацию для формирования URL-адресов (например, для перенаправления или ссылок) на основе сведений о конечной точке, что позволяет избежать жесткого задания URL-адресов и упрощает поддержку.</span><span class="sxs-lookup"><span data-stu-id="777c4-914">An app can use routing to generate URLs (for example, for redirection or links) based on endpoint information and thus avoid hard-coded URLs, which helps maintainability.</span></span>
* <span data-ttu-id="777c4-915">Формирование URL-адреса основано на адресах, которые поддерживают произвольную расширяемость:</span><span class="sxs-lookup"><span data-stu-id="777c4-915">URL generation is based on addresses, which support arbitrary extensibility:</span></span>

  * <span data-ttu-id="777c4-916">API генератора ссылок (<xref:Microsoft.AspNetCore.Routing.LinkGenerator>) может быть разрешено в любом месте с помощью [внедрения зависимостей (DI)](xref:fundamentals/dependency-injection) для формирования URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-916">The Link Generator API (<xref:Microsoft.AspNetCore.Routing.LinkGenerator>) can be resolved anywhere using [dependency injection (DI)](xref:fundamentals/dependency-injection) to generate URLs.</span></span>
  * <span data-ttu-id="777c4-917">Если API генератора ссылок недоступно через внедрение зависимостей, <xref:Microsoft.AspNetCore.Mvc.IUrlHelper> предлагает методы для создания URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-917">Where the Link Generator API isn't available via DI, <xref:Microsoft.AspNetCore.Mvc.IUrlHelper> offers methods to build URLs.</span></span>

> [!NOTE]
> <span data-ttu-id="777c4-918">С появлением маршрутизации по конечным точкам в ASP.NET Core 2.2 связывание конечных точек стало ограничено действиями и страницами MVC и Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="777c4-918">With the release of endpoint routing in ASP.NET Core 2.2, endpoint linking is limited to MVC/Razor Pages actions and pages.</span></span> <span data-ttu-id="777c4-919">Расширение функций связывания конечных точек планируется в будущих выпусках.</span><span class="sxs-lookup"><span data-stu-id="777c4-919">The expansions of endpoint-linking capabilities is planned for future releases.</span></span>

<span data-ttu-id="777c4-920">Функция маршрутизации подключается к конвейеру [ПО промежуточного слоя](xref:fundamentals/middleware/index) с помощью класса <xref:Microsoft.AspNetCore.Builder.RouterMiddleware>.</span><span class="sxs-lookup"><span data-stu-id="777c4-920">Routing is connected to the [middleware](xref:fundamentals/middleware/index) pipeline by the <xref:Microsoft.AspNetCore.Builder.RouterMiddleware> class.</span></span> <span data-ttu-id="777c4-921">[ASP.NET Core MVC](xref:mvc/overview) добавляет функцию маршрутизации в конвейер ПО промежуточного слоя в процессе настройки и обрабатывает маршрутизацию в приложениях MVC и Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="777c4-921">[ASP.NET Core MVC](xref:mvc/overview) adds routing to the middleware pipeline as part of its configuration and handles routing in MVC and Razor Pages apps.</span></span> <span data-ttu-id="777c4-922">Сведения об использовании маршрутизации в виде отдельного компонента см. в руководстве по [использованию ПО промежуточного слоя маршрутизации](#use-routing-middleware).</span><span class="sxs-lookup"><span data-stu-id="777c4-922">To learn how to use routing as a standalone component, see the [Use Routing Middleware](#use-routing-middleware) section.</span></span>

### <a name="url-matching"></a><span data-ttu-id="777c4-923">Соответствие URL-адресов</span><span class="sxs-lookup"><span data-stu-id="777c4-923">URL matching</span></span>

<span data-ttu-id="777c4-924">Сопоставление URL-адресов — это процесс, с помощью которого функция маршрутизации отправляет входящий запрос в *конечную точку*.</span><span class="sxs-lookup"><span data-stu-id="777c4-924">URL matching is the process by which routing dispatches an incoming request to an *endpoint*.</span></span> <span data-ttu-id="777c4-925">Этот процесс основывается на данных в пути URL-адреса, но может быть расширен для учета любых данных в запросе.</span><span class="sxs-lookup"><span data-stu-id="777c4-925">This process is based on data in the URL path but can be extended to consider any data in the request.</span></span> <span data-ttu-id="777c4-926">Возможность отправки запросов в отдельные обработчики имеет первостепенное значение для масштабирования размера и сложности приложения.</span><span class="sxs-lookup"><span data-stu-id="777c4-926">The ability to dispatch requests to separate handlers is key to scaling the size and complexity of an app.</span></span>

<span data-ttu-id="777c4-927">Система маршрутизации в маршрутизации по конечным точкам принимает все решения об отправке.</span><span class="sxs-lookup"><span data-stu-id="777c4-927">The routing system in endpoint routing is responsible for all dispatching decisions.</span></span> <span data-ttu-id="777c4-928">Так как ПО промежуточного слоя применяет политики в зависимости от выбранной конечной точки, очень важно, чтобы любое решение, которое может повлиять на отправку или применение политик безопасности, принималось внутри системы маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-928">Since the middleware applies policies based on the selected endpoint, it's important that any decision that can affect dispatching or the application of security policies is made inside the routing system.</span></span>

<span data-ttu-id="777c4-929">Когда делегат конечной точки выполняется, свойствам [RouteContext.RouteData](xref:Microsoft.AspNetCore.Routing.RouteContext.RouteData) присваиваются значения с учетом уже выполненной на текущий момент обработки.</span><span class="sxs-lookup"><span data-stu-id="777c4-929">When the endpoint delegate is executed, the properties of [RouteContext.RouteData](xref:Microsoft.AspNetCore.Routing.RouteContext.RouteData) are set to appropriate values based on the request processing performed thus far.</span></span>

<span data-ttu-id="777c4-930">[RouteData.Values](xref:Microsoft.AspNetCore.Routing.RouteData.Values*) — это словарь *значений маршрута*, полученных из маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-930">[RouteData.Values](xref:Microsoft.AspNetCore.Routing.RouteData.Values*) is a dictionary of *route values* produced from the route.</span></span> <span data-ttu-id="777c4-931">Как правило, эти значения определяются путем разбивки URL-адреса на сегменты и могут использоваться для принятия входных данных пользователя или принятия дальнейших решений об отправке в приложении.</span><span class="sxs-lookup"><span data-stu-id="777c4-931">These values are usually determined by tokenizing the URL and can be used to accept user input or to make further dispatching decisions inside the app.</span></span>

<span data-ttu-id="777c4-932">[RouteData.DataTokens](xref:Microsoft.AspNetCore.Routing.RouteData.DataTokens*) — это контейнер свойств с дополнительными данными, связанными с соответствующим маршрутом.</span><span class="sxs-lookup"><span data-stu-id="777c4-932">[RouteData.DataTokens](xref:Microsoft.AspNetCore.Routing.RouteData.DataTokens*) is a property bag of additional data related to the matched route.</span></span> <span data-ttu-id="777c4-933">Свойства <xref:Microsoft.AspNetCore.Routing.RouteData.DataTokens*> обеспечивают связывание данных состояния с каждым маршрутом, что позволяет приложению принимать решения в зависимости от соответствующего маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-933"><xref:Microsoft.AspNetCore.Routing.RouteData.DataTokens*> are provided to support associating state data with each route so that the app can make decisions based on which route matched.</span></span> <span data-ttu-id="777c4-934">Эти значения определяются разработчиком и никоим образом **не** влияют на поведение маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-934">These values are developer-defined and do **not** affect the behavior of routing in any way.</span></span> <span data-ttu-id="777c4-935">Кроме того, значения, спрятанные в токенах [RouteData.DataToken](xref:Microsoft.AspNetCore.Routing.RouteData.DataTokens*), могут быть любого типа в отличие от значений [RouteData.Value](xref:Microsoft.AspNetCore.Routing.RouteData.Values), которые должны легко преобразовываться в строки и из строк.</span><span class="sxs-lookup"><span data-stu-id="777c4-935">Additionally, values stashed in [RouteData.DataTokens](xref:Microsoft.AspNetCore.Routing.RouteData.DataTokens*) can be of any type, in contrast to [RouteData.Values](xref:Microsoft.AspNetCore.Routing.RouteData.Values), which must be convertible to and from strings.</span></span>

<span data-ttu-id="777c4-936">[RouteData.Routers](xref:Microsoft.AspNetCore.Routing.RouteData.Routers) — это список маршрутов, которые участвовали в успешном сопоставлении с запросом.</span><span class="sxs-lookup"><span data-stu-id="777c4-936">[RouteData.Routers](xref:Microsoft.AspNetCore.Routing.RouteData.Routers) is a list of the routes that took part in successfully matching the request.</span></span> <span data-ttu-id="777c4-937">Маршруты могут быть вложены друг в друга.</span><span class="sxs-lookup"><span data-stu-id="777c4-937">Routes can be nested inside of one another.</span></span> <span data-ttu-id="777c4-938">Свойство <xref:Microsoft.AspNetCore.Routing.RouteData.Routers> отражает путь по логическому дереву маршрутов, который привел к совпадению.</span><span class="sxs-lookup"><span data-stu-id="777c4-938">The <xref:Microsoft.AspNetCore.Routing.RouteData.Routers> property reflects the path through the logical tree of routes that resulted in a match.</span></span> <span data-ttu-id="777c4-939">Как правило, первый элемент в свойстве <xref:Microsoft.AspNetCore.Routing.RouteData.Routers> — это коллекция маршрутов, используемая для формирования URL-адресов.</span><span class="sxs-lookup"><span data-stu-id="777c4-939">Generally, the first item in <xref:Microsoft.AspNetCore.Routing.RouteData.Routers> is the route collection and should be used for URL generation.</span></span> <span data-ttu-id="777c4-940">Последний элемент в свойстве <xref:Microsoft.AspNetCore.Routing.RouteData.Routers> — это соответствующий обработчик маршрутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-940">The last item in <xref:Microsoft.AspNetCore.Routing.RouteData.Routers> is the route handler that matched.</span></span>

<a name="lg"></a>

### <a name="url-generation-with-linkgenerator"></a><span data-ttu-id="777c4-941">Создание URL-адреса с помощью LinkGenerator</span><span class="sxs-lookup"><span data-stu-id="777c4-941">URL generation with LinkGenerator</span></span>

<span data-ttu-id="777c4-942">Формирование URL-адреса — это процесс создания пути URL-адреса функцией маршрутизации на основе набора значений маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-942">URL generation is the process by which routing can create a URL path based on a set of route values.</span></span> <span data-ttu-id="777c4-943">Он обеспечивает логическое разделение конечных точек и URL-адресов, по которым к ним осуществляется доступ.</span><span class="sxs-lookup"><span data-stu-id="777c4-943">This allows for a logical separation between your endpoints and the URLs that access them.</span></span>

<span data-ttu-id="777c4-944">Маршрутизация по конечным точкам включает в себя API генератора ссылок (<xref:Microsoft.AspNetCore.Routing.LinkGenerator>).</span><span class="sxs-lookup"><span data-stu-id="777c4-944">Endpoint routing includes the Link Generator API (<xref:Microsoft.AspNetCore.Routing.LinkGenerator>).</span></span> <span data-ttu-id="777c4-945"><xref:Microsoft.AspNetCore.Routing.LinkGenerator> — это отдельная служба, которую можно получить из [DI](xref:fundamentals/dependency-injection).</span><span class="sxs-lookup"><span data-stu-id="777c4-945"><xref:Microsoft.AspNetCore.Routing.LinkGenerator> is a singleton service that can be retrieved from [DI](xref:fundamentals/dependency-injection).</span></span> <span data-ttu-id="777c4-946">API можно использовать вне контекста выполнения запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-946">The API can be used outside of the context of an executing request.</span></span> <span data-ttu-id="777c4-947"><xref:Microsoft.AspNetCore.Mvc.IUrlHelper> MVC и сценарии, которые зависят от <xref:Microsoft.AspNetCore.Mvc.IUrlHelper>, такие как [вспомогательные функции тегов](xref:mvc/views/tag-helpers/intro), вспомогательные методы HTML и [результаты действий](xref:mvc/controllers/actions), используют генератор ссылок для предоставления возможностей создания ссылок.</span><span class="sxs-lookup"><span data-stu-id="777c4-947">MVC's <xref:Microsoft.AspNetCore.Mvc.IUrlHelper> and scenarios that rely on <xref:Microsoft.AspNetCore.Mvc.IUrlHelper>, such as [Tag Helpers](xref:mvc/views/tag-helpers/intro), HTML Helpers, and [Action Results](xref:mvc/controllers/actions), use the link generator to provide link generating capabilities.</span></span>

<span data-ttu-id="777c4-948">Генератор ссылок использует концепции *адреса* и *схем адресов*.</span><span class="sxs-lookup"><span data-stu-id="777c4-948">The link generator is backed by the concept of an *address* and *address schemes*.</span></span> <span data-ttu-id="777c4-949">Схема адресов — это способ определения конечных точек, которые должны рассматриваться для создания ссылки.</span><span class="sxs-lookup"><span data-stu-id="777c4-949">An address scheme is a way of determining the endpoints that should be considered for link generation.</span></span> <span data-ttu-id="777c4-950">Например, сценарии с именем маршрута и значениями маршрута, с которыми многие пользователи знакомы по MVC и Razor Pages, реализуются как схема адресов.</span><span class="sxs-lookup"><span data-stu-id="777c4-950">For example, the route name and route values scenarios many users are familiar with from MVC/Razor Pages are implemented as an address scheme.</span></span>

<span data-ttu-id="777c4-951">Генератор ссылок может установить связь с действиями и страницами MVC и Razor Pages с помощью следующих методов расширения:</span><span class="sxs-lookup"><span data-stu-id="777c4-951">The link generator can link to MVC/Razor Pages actions and pages via the following extension methods:</span></span>

* <xref:Microsoft.AspNetCore.Routing.ControllerLinkGeneratorExtensions.GetPathByAction*>
* <xref:Microsoft.AspNetCore.Routing.ControllerLinkGeneratorExtensions.GetUriByAction*>
* <xref:Microsoft.AspNetCore.Routing.PageLinkGeneratorExtensions.GetPathByPage*>
* <xref:Microsoft.AspNetCore.Routing.PageLinkGeneratorExtensions.GetUriByPage*>

<span data-ttu-id="777c4-952">Перегрузка этих методов принимает аргументы, которые включают `HttpContext`.</span><span class="sxs-lookup"><span data-stu-id="777c4-952">An overload of these methods accepts arguments that include the `HttpContext`.</span></span> <span data-ttu-id="777c4-953">Эти методы являются функциональными эквивалентами `Url.Action` и `Url.Page`, но предлагают дополнительную гибкость и параметры.</span><span class="sxs-lookup"><span data-stu-id="777c4-953">These methods are functionally equivalent to `Url.Action` and `Url.Page` but offer additional flexibility and options.</span></span>

<span data-ttu-id="777c4-954">Методы `GetPath*` наиболее схожи с `Url.Action` и `Url.Page` в том, что создают URI, содержащий абсолютный путь.</span><span class="sxs-lookup"><span data-stu-id="777c4-954">The `GetPath*` methods are most similar to `Url.Action` and `Url.Page` in that they generate a URI containing an absolute path.</span></span> <span data-ttu-id="777c4-955">Методы `GetUri*` всегда создают абсолютный URI, содержащий схему и узел.</span><span class="sxs-lookup"><span data-stu-id="777c4-955">The `GetUri*` methods always generate an absolute URI containing a scheme and host.</span></span> <span data-ttu-id="777c4-956">Методы, которые принимают `HttpContext`, создают URI в контексте выполнения запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-956">The methods that accept an `HttpContext` generate a URI in the context of the executing request.</span></span> <span data-ttu-id="777c4-957">Используются значения окружения маршрута, базовый URL-адрес, схема и узел из выполняющегося запроса, если не указано иное.</span><span class="sxs-lookup"><span data-stu-id="777c4-957">The ambient route values, URL base path, scheme, and host from the executing request are used unless overridden.</span></span>

<span data-ttu-id="777c4-958"><xref:Microsoft.AspNetCore.Routing.LinkGenerator> вызывается с адресом.</span><span class="sxs-lookup"><span data-stu-id="777c4-958"><xref:Microsoft.AspNetCore.Routing.LinkGenerator> is called with an address.</span></span> <span data-ttu-id="777c4-959">Создание URI происходит в два этапа:</span><span class="sxs-lookup"><span data-stu-id="777c4-959">Generating a URI occurs in two steps:</span></span>

1. <span data-ttu-id="777c4-960">Адрес привязан к списку конечных точек, соответствующих адресу.</span><span class="sxs-lookup"><span data-stu-id="777c4-960">An address is bound to a list of endpoints that match the address.</span></span>
1. <span data-ttu-id="777c4-961">`RoutePattern` конечной точки вычисляется, пока не будет найден шаблон маршрута, который соответствует предоставленным значениям.</span><span class="sxs-lookup"><span data-stu-id="777c4-961">Each endpoint's `RoutePattern` is evaluated until a route pattern that matches the supplied values is found.</span></span> <span data-ttu-id="777c4-962">Полученный результат объединяется с другими частями URI, предоставленными генератору ссылок и возвращенными.</span><span class="sxs-lookup"><span data-stu-id="777c4-962">The resulting output is combined with the other URI parts supplied to the link generator and returned.</span></span>

<span data-ttu-id="777c4-963">Методы, предоставляемые <xref:Microsoft.AspNetCore.Routing.LinkGenerator>, поддерживают стандартные возможности создания ссылки для любого типа адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-963">The methods provided by <xref:Microsoft.AspNetCore.Routing.LinkGenerator> support standard link generation capabilities for any type of address.</span></span> <span data-ttu-id="777c4-964">Самый удобный способ использовать генератор ссылки — через методы расширения, которые выполняют операции для определенного типа адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-964">The most convenient way to use the link generator is through extension methods that perform operations for a specific address type.</span></span>

| <span data-ttu-id="777c4-965">Метод расширения</span><span class="sxs-lookup"><span data-stu-id="777c4-965">Extension Method</span></span>   | <span data-ttu-id="777c4-966">Описание</span><span class="sxs-lookup"><span data-stu-id="777c4-966">Description</span></span>                                                         |
| ------------------ | ------------------------------------------------------------------- |
| <xref:Microsoft.AspNetCore.Routing.LinkGenerator.GetPathByAddress*> | <span data-ttu-id="777c4-967">Создает URI с абсолютным путем на основе предоставленных значений.</span><span class="sxs-lookup"><span data-stu-id="777c4-967">Generates a URI with an absolute path based on the provided values.</span></span> |
| <xref:Microsoft.AspNetCore.Routing.LinkGenerator.GetUriByAddress*> | <span data-ttu-id="777c4-968">Создает абсолютный URI на основе предоставленных значений.</span><span class="sxs-lookup"><span data-stu-id="777c4-968">Generates an absolute URI based on the provided values.</span></span>             |

> [!WARNING]
> <span data-ttu-id="777c4-969">Обратите внимание на следующие последствия вызова методов <xref:Microsoft.AspNetCore.Routing.LinkGenerator>:</span><span class="sxs-lookup"><span data-stu-id="777c4-969">Pay attention to the following implications of calling <xref:Microsoft.AspNetCore.Routing.LinkGenerator> methods:</span></span>
>
> * <span data-ttu-id="777c4-970">Используйте методы расширения `GetUri*` с осторожностью в конфигурации приложения, которая не проверяет заголовок входящих запросов `Host`.</span><span class="sxs-lookup"><span data-stu-id="777c4-970">Use `GetUri*` extension methods with caution in an app configuration that doesn't validate the `Host` header of incoming requests.</span></span> <span data-ttu-id="777c4-971">Если не проверить заголовок входящих запросов `Host`, входные данные в запросе без доверия могут отправляться обратно клиенту в URI в представлении или странице.</span><span class="sxs-lookup"><span data-stu-id="777c4-971">If the `Host` header of incoming requests isn't validated, untrusted request input can be sent back to the client in URIs in a view/page.</span></span> <span data-ttu-id="777c4-972">Рекомендуется, чтобы все рабочие приложения настраивали свой сервер на проверку заголовка `Host` относительно известных допустимых значений.</span><span class="sxs-lookup"><span data-stu-id="777c4-972">We recommend that all production apps configure their server to validate the `Host` header against known valid values.</span></span>
>
> * <span data-ttu-id="777c4-973">Используйте <xref:Microsoft.AspNetCore.Routing.LinkGenerator> с осторожностью в ПО промежуточного слоя в сочетании с `Map` или `MapWhen`.</span><span class="sxs-lookup"><span data-stu-id="777c4-973">Use <xref:Microsoft.AspNetCore.Routing.LinkGenerator> with caution in middleware in combination with `Map` or `MapWhen`.</span></span> <span data-ttu-id="777c4-974">`Map*` изменяет базовый путь выполняющегося запроса, что влияет на выходные данные создания ссылки.</span><span class="sxs-lookup"><span data-stu-id="777c4-974">`Map*` changes the base path of the executing request, which affects the output of link generation.</span></span> <span data-ttu-id="777c4-975">Все API <xref:Microsoft.AspNetCore.Routing.LinkGenerator> разрешают указание базового пути.</span><span class="sxs-lookup"><span data-stu-id="777c4-975">All of the <xref:Microsoft.AspNetCore.Routing.LinkGenerator> APIs allow specifying a base path.</span></span> <span data-ttu-id="777c4-976">Всегда указывайте пустой базовый путь для отмены влияния `Map*` на создание ссылок.</span><span class="sxs-lookup"><span data-stu-id="777c4-976">Always specify an empty base path to undo `Map*`'s affect on link generation.</span></span>

## <a name="differences-from-earlier-versions-of-routing"></a><span data-ttu-id="777c4-977">Отличия от более ранних версий маршрутизации</span><span class="sxs-lookup"><span data-stu-id="777c4-977">Differences from earlier versions of routing</span></span>

<span data-ttu-id="777c4-978">Существует несколько различий между маршрутизацией по конечным точкам в ASP.NET Core 2.2 или более поздней версии и более ранними версиями маршрутизации в ASP.NET Core:</span><span class="sxs-lookup"><span data-stu-id="777c4-978">A few differences exist between endpoint routing in ASP.NET Core 2.2 or later and earlier versions of routing in ASP.NET Core:</span></span>

* <span data-ttu-id="777c4-979">Система маршрутизации по конечным точкам не поддерживает расширяемость на основе <xref:Microsoft.AspNetCore.Routing.IRouter>, включая наследование от <xref:Microsoft.AspNetCore.Routing.Route>.</span><span class="sxs-lookup"><span data-stu-id="777c4-979">The endpoint routing system doesn't support <xref:Microsoft.AspNetCore.Routing.IRouter>-based extensibility, including inheriting from <xref:Microsoft.AspNetCore.Routing.Route>.</span></span>

* <span data-ttu-id="777c4-980">Маршрутизация по конечным точкам не поддерживает [WebApiCompatShim](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.WebApiCompatShim).</span><span class="sxs-lookup"><span data-stu-id="777c4-980">Endpoint routing doesn't support [WebApiCompatShim](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.WebApiCompatShim).</span></span> <span data-ttu-id="777c4-981">Используйте [совместимую версию](xref:mvc/compatibility-version) 2.1 (`.SetCompatibilityVersion(CompatibilityVersion.Version_2_1)`), чтобы продолжить использование оболочек совместимости.</span><span class="sxs-lookup"><span data-stu-id="777c4-981">Use the 2.1 [compatibility version](xref:mvc/compatibility-version) (`.SetCompatibilityVersion(CompatibilityVersion.Version_2_1)`) to continue using the compatibility shim.</span></span>

* <span data-ttu-id="777c4-982">Маршрутизация по конечным точкам иначе обрабатывает регистр созданных URI при использовании стандартных маршрутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-982">Endpoint Routing has different behavior for the casing of generated URIs when using conventional routes.</span></span>

  <span data-ttu-id="777c4-983">Рассмотрим следующий шаблон маршрута по умолчанию:</span><span class="sxs-lookup"><span data-stu-id="777c4-983">Consider the following default route template:</span></span>

  ```csharp
  app.UseMvc(routes =>
  {
      routes.MapRoute("default", "{controller=Home}/{action=Index}/{id?}");
  });
  ```

  <span data-ttu-id="777c4-984">Предположим, вы создаете ссылку на действие с помощью следующего маршрута:</span><span class="sxs-lookup"><span data-stu-id="777c4-984">Suppose you generate a link to an action using the following route:</span></span>

  ```csharp
  var link = Url.Action("ReadPost", "blog", new { id = 17, });
  ```

  <span data-ttu-id="777c4-985">С помощью маршрутизации на основе <xref:Microsoft.AspNetCore.Routing.IRouter> этот код создает URI из `/blog/ReadPost/17`, который учитывает регистр предоставленного значения маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-985">With <xref:Microsoft.AspNetCore.Routing.IRouter>-based routing, this code generates a URI of `/blog/ReadPost/17`, which respects the casing of the provided route value.</span></span> <span data-ttu-id="777c4-986">Маршрутизация по конечным точкам в ASP.NET Core 2.2 или более поздней версии создает `/Blog/ReadPost/17` ("Blog" — с прописной буквы).</span><span class="sxs-lookup"><span data-stu-id="777c4-986">Endpoint routing in ASP.NET Core 2.2 or later produces `/Blog/ReadPost/17` ("Blog" is capitalized).</span></span> <span data-ttu-id="777c4-987">Маршрутизация по конечным точкам предоставляет интерфейс `IOutboundParameterTransformer`, который можно использовать для настройки этого поведения на глобальном уровне или применения других соглашения для сопоставления URL-адресов.</span><span class="sxs-lookup"><span data-stu-id="777c4-987">Endpoint routing provides the `IOutboundParameterTransformer` interface that can be used to customize this behavior globally or to apply different conventions for mapping URLs.</span></span>

  <span data-ttu-id="777c4-988">Дополнительные сведения см. в разделе [Справочник по преобразователям параметров](#parameter-transformer-reference).</span><span class="sxs-lookup"><span data-stu-id="777c4-988">For more information, see the [Parameter transformer reference](#parameter-transformer-reference) section.</span></span>

* <span data-ttu-id="777c4-989">Создание ссылок, используемых MVC и Razor Pages со стандартными маршрутами, работает иначе при попытке сослаться на контроллер, действие или страницу, которые не существуют.</span><span class="sxs-lookup"><span data-stu-id="777c4-989">Link Generation used by MVC/Razor Pages with conventional routes behaves differently when attempting to link to an controller/action or page that doesn't exist.</span></span>

  <span data-ttu-id="777c4-990">Рассмотрим следующий шаблон маршрута по умолчанию:</span><span class="sxs-lookup"><span data-stu-id="777c4-990">Consider the following default route template:</span></span>

  ```csharp
  app.UseMvc(routes =>
  {
      routes.MapRoute("default", "{controller=Home}/{action=Index}/{id?}");
  });
  ```

  <span data-ttu-id="777c4-991">Предположим, вы создаете ссылку на действие с помощью шаблона по умолчанию:</span><span class="sxs-lookup"><span data-stu-id="777c4-991">Suppose you generate a link to an action using the default template with the following:</span></span>

  ```csharp
  var link = Url.Action("ReadPost", "Blog", new { id = 17, });
  ```

  <span data-ttu-id="777c4-992">С маршрутизацией на основе `IRouter` результатом всегда будет `/Blog/ReadPost/17`, даже если `BlogController` не существует или не имеет метода действия `ReadPost`.</span><span class="sxs-lookup"><span data-stu-id="777c4-992">With `IRouter`-based routing, the result is always `/Blog/ReadPost/17`, even if the `BlogController` doesn't exist or doesn't have a `ReadPost` action method.</span></span> <span data-ttu-id="777c4-993">Как и ожидалось, маршрутизация по конечным точкам в ASP.NET Core 2.2 или более поздней версии создает `/Blog/ReadPost/17`, если метод действия существует.</span><span class="sxs-lookup"><span data-stu-id="777c4-993">As expected, endpoint routing in ASP.NET Core 2.2 or later produces `/Blog/ReadPost/17` if the action method exists.</span></span> <span data-ttu-id="777c4-994">*Но маршрутизация по конечным точкам создает пустую строку, если действие не существует.*</span><span class="sxs-lookup"><span data-stu-id="777c4-994">*However, endpoint routing produces an empty string if the action doesn't exist.*</span></span> <span data-ttu-id="777c4-995">По существу, маршрутизация по конечным точкам не предполагает, что конечная точка существует, если действие не существует.</span><span class="sxs-lookup"><span data-stu-id="777c4-995">Conceptually, endpoint routing doesn't assume that the endpoint exists if the action doesn't exist.</span></span>

* <span data-ttu-id="777c4-996">*Алгоритм отмены значения окружения* при создании ссылок работает иначе при маршрутизации по конечным точкам.</span><span class="sxs-lookup"><span data-stu-id="777c4-996">The link generation *ambient value invalidation algorithm* behaves differently when used with endpoint routing.</span></span>

  <span data-ttu-id="777c4-997">*Отмена значения окружения* — это алгоритм, который решает, какие значения маршрута из текущего выполняемого запроса (значения окружения) могут использоваться в операции создания ссылки.</span><span class="sxs-lookup"><span data-stu-id="777c4-997">*Ambient value invalidation* is the algorithm that decides which route values from the currently executing request (the ambient values) can be used in link generation operations.</span></span> <span data-ttu-id="777c4-998">Стандартная маршрутизация всегда отменяет лишние значения маршрута при привязке к другому действию.</span><span class="sxs-lookup"><span data-stu-id="777c4-998">Conventional routing always invalidated extra route values when linking to a different action.</span></span> <span data-ttu-id="777c4-999">Маршрутизация с помощью атрибутов работала иначе до выпуска ASP.NET Core 2.2.</span><span class="sxs-lookup"><span data-stu-id="777c4-999">Attribute routing didn't have this behavior prior to the release of ASP.NET Core 2.2.</span></span> <span data-ttu-id="777c4-1000">В более ранних версиях ASP.NET Core ссылки на другое действие, которые используют те же имена параметров маршрута, приводили к ошибкам создания ссылки.</span><span class="sxs-lookup"><span data-stu-id="777c4-1000">In earlier versions of ASP.NET Core, links to another action that use the same route parameter names resulted in link generation errors.</span></span> <span data-ttu-id="777c4-1001">В ASP.NET Core 2.2 или более поздней версии обе формы маршрутизации отменяют значения при привязке к другому действию.</span><span class="sxs-lookup"><span data-stu-id="777c4-1001">In ASP.NET Core 2.2 or later, both forms of routing invalidate values when linking to another action.</span></span>

  <span data-ttu-id="777c4-1002">Рассмотрим следующий пример в ASP.NET Core 2.1 или более ранней версии.</span><span class="sxs-lookup"><span data-stu-id="777c4-1002">Consider the following example in ASP.NET Core 2.1 or earlier.</span></span> <span data-ttu-id="777c4-1003">При привязке к другому действию (или странице) значения маршрута могут использоваться повторно нежелательным образом.</span><span class="sxs-lookup"><span data-stu-id="777c4-1003">When linking to another action (or another page), route values can be reused in undesirable ways.</span></span>

  <span data-ttu-id="777c4-1004">В */Pages/Store/Product.cshtml*:</span><span class="sxs-lookup"><span data-stu-id="777c4-1004">In */Pages/Store/Product.cshtml*:</span></span>

  ```cshtml
  @page "{id}"
  @Url.Page("/Login")
  ```

  <span data-ttu-id="777c4-1005">В */Pages/Login.cshtml*:</span><span class="sxs-lookup"><span data-stu-id="777c4-1005">In */Pages/Login.cshtml*:</span></span>

  ```cshtml
  @page "{id?}"
  ```

  <span data-ttu-id="777c4-1006">Если URI — `/Store/Product/18` в ASP.NET Core 2.1 или более ранней версии, ссылка, созданная на странице Store/Info с помощью `@Url.Page("/Login")` — `/Login/18`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1006">If the URI is `/Store/Product/18` in ASP.NET Core 2.1 or earlier, the link generated on the Store/Info page by `@Url.Page("/Login")` is `/Login/18`.</span></span> <span data-ttu-id="777c4-1007">Значение `id` 18 используется повторно, хотя конечный объект ссылки является совсем другой частью приложения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1007">The `id` value of 18 is reused, even though the link destination is different part of the app entirely.</span></span> <span data-ttu-id="777c4-1008">Значение маршрута `id` в контексте страницы `/Login`, вероятно, является значением идентификатора пользователя, а не кодом хранимого продукта.</span><span class="sxs-lookup"><span data-stu-id="777c4-1008">The `id` route value in the context of the `/Login` page is probably a user ID value, not a store product ID value.</span></span>

  <span data-ttu-id="777c4-1009">При маршрутизации по конечным точкам в ASP.NET Core 2.2 или более поздней версии результатом является `/Login`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1009">In endpoint routing with ASP.NET Core 2.2 or later, the result is `/Login`.</span></span> <span data-ttu-id="777c4-1010">Значения окружения не используются повторно, если конечный объект ссылки является другим действием или страницей.</span><span class="sxs-lookup"><span data-stu-id="777c4-1010">Ambient values aren't reused when the linked destination is a different action or page.</span></span>

* <span data-ttu-id="777c4-1011">Синтаксис параметра кругового маршрута: символы прямой косой черты не кодируются при использовании синтаксиса универсального параметра с двумя звездочками (`**`).</span><span class="sxs-lookup"><span data-stu-id="777c4-1011">Round-tripping route parameter syntax: Forward slashes aren't encoded when using a double-asterisk (`**`) catch-all parameter syntax.</span></span>

  <span data-ttu-id="777c4-1012">Во время создания ссылки система маршрутизации кодирует значение, записанное в универсальном параметре с двумя звездочками (`**`) (например, `{**myparametername}`), за исключением прямой косой черты.</span><span class="sxs-lookup"><span data-stu-id="777c4-1012">During link generation, the routing system encodes the value captured in a double-asterisk (`**`) catch-all parameter (for example, `{**myparametername}`) except the forward slashes.</span></span> <span data-ttu-id="777c4-1013">Универсальный параметр с двумя звездочками поддерживается в маршрутизации на основе `IRouter` в ASP.NET Core 2.2 или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="777c4-1013">The double-asterisk catch-all is supported with `IRouter`-based routing in ASP.NET Core 2.2 or later.</span></span>

  <span data-ttu-id="777c4-1014">Синтаксис универсального параметра с одной звездочкой в предыдущих версиях ASP.NET Core (`{*myparametername}`) поддерживается, и прямая косая черта кодируется.</span><span class="sxs-lookup"><span data-stu-id="777c4-1014">The single asterisk catch-all parameter syntax in prior versions of ASP.NET Core (`{*myparametername}`) remains supported, and forward slashes are encoded.</span></span>

  | <span data-ttu-id="777c4-1015">Маршрут</span><span class="sxs-lookup"><span data-stu-id="777c4-1015">Route</span></span>              | <span data-ttu-id="777c4-1016">Ссылка, созданная с помощью</span><span class="sxs-lookup"><span data-stu-id="777c4-1016">Link generated with</span></span><br>`Url.Action(new { category = "admin/products" })`&hellip; |
  | ------------------ | --------------------------------------------------------------------- |
  | `/search/{*page}`  | <span data-ttu-id="777c4-1017">`/search/admin%2Fproducts` (прямая косая черта кодируется)</span><span class="sxs-lookup"><span data-stu-id="777c4-1017">`/search/admin%2Fproducts` (the forward slash is encoded)</span></span>             |
  | `/search/{**page}` | `/search/admin/products`                                              |

### <a name="middleware-example"></a><span data-ttu-id="777c4-1018">Пример ПО промежуточного слоя</span><span class="sxs-lookup"><span data-stu-id="777c4-1018">Middleware example</span></span>

<span data-ttu-id="777c4-1019">В следующем примере ПО промежуточного слоя использует API <xref:Microsoft.AspNetCore.Routing.LinkGenerator>, чтобы создать ссылку на метод действия, который перечисляет хранимые продукты.</span><span class="sxs-lookup"><span data-stu-id="777c4-1019">In the following example, a middleware uses the <xref:Microsoft.AspNetCore.Routing.LinkGenerator> API to create link to an action method that lists store products.</span></span> <span data-ttu-id="777c4-1020">Использование генератора ссылок путем его внедрения в класс и вызова `GenerateLink` доступно для любого класса в приложении.</span><span class="sxs-lookup"><span data-stu-id="777c4-1020">Using the link generator by injecting it into a class and calling `GenerateLink` is available to any class in an app.</span></span>

```csharp
using Microsoft.AspNetCore.Routing;

public class ProductsLinkMiddleware
{
    private readonly LinkGenerator _linkGenerator;

    public ProductsLinkMiddleware(RequestDelegate next, LinkGenerator linkGenerator)
    {
        _linkGenerator = linkGenerator;
    }

    public async Task InvokeAsync(HttpContext httpContext)
    {
        var url = _linkGenerator.GetPathByAction("ListProducts", "Store");

        httpContext.Response.ContentType = "text/plain";

        await httpContext.Response.WriteAsync($"Go to {url} to see our products.");
    }
}
```

### <a name="create-routes"></a><span data-ttu-id="777c4-1021">Создание маршрутов</span><span class="sxs-lookup"><span data-stu-id="777c4-1021">Create routes</span></span>

<span data-ttu-id="777c4-1022">Большинство приложений создают маршруты, вызывая метод <xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> или один из аналогичных методов расширения, определенных в интерфейсе <xref:Microsoft.AspNetCore.Routing.IRouteBuilder>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1022">Most apps create routes by calling <xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> or one of the similar extension methods defined on <xref:Microsoft.AspNetCore.Routing.IRouteBuilder>.</span></span> <span data-ttu-id="777c4-1023">Все методы расширения <xref:Microsoft.AspNetCore.Routing.IRouteBuilder> создают экземпляр <xref:Microsoft.AspNetCore.Routing.Route> и добавляют его в коллекцию маршрутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1023">Any of the <xref:Microsoft.AspNetCore.Routing.IRouteBuilder> extension methods create an instance of <xref:Microsoft.AspNetCore.Routing.Route> and add it to the route collection.</span></span>

<span data-ttu-id="777c4-1024"><xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> не принимает параметр обработчика маршрутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1024"><xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> doesn't accept a route handler parameter.</span></span> <span data-ttu-id="777c4-1025"><xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> только добавляет маршруты, которые обрабатываются <xref:Microsoft.AspNetCore.Routing.RouteBuilder.DefaultHandler*>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1025"><xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> only adds routes that are handled by the <xref:Microsoft.AspNetCore.Routing.RouteBuilder.DefaultHandler*>.</span></span> <span data-ttu-id="777c4-1026">Дополнительные сведения о маршрутизации в MVC см. в разделе <xref:mvc/controllers/routing>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1026">To learn more about routing in MVC, see <xref:mvc/controllers/routing>.</span></span>

<span data-ttu-id="777c4-1027">В следующем коде приводится пример вызова <xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*>, используемого в типичном определении маршрута ASP.NET Core MVC:</span><span class="sxs-lookup"><span data-stu-id="777c4-1027">The following code example is an example of a <xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> call used by a typical ASP.NET Core MVC route definition:</span></span>

```csharp
routes.MapRoute(
    name: "default",
    template: "{controller=Home}/{action=Index}/{id?}");
```

<span data-ttu-id="777c4-1028">Этот шаблон соответствует пути URL-адреса и извлекает значения маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1028">This template matches a URL path and extracts the route values.</span></span> <span data-ttu-id="777c4-1029">Например, путь `/Products/Details/17` создает следующие значения маршрута: `{ controller = Products, action = Details, id = 17 }`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1029">For example, the path `/Products/Details/17` generates the following route values: `{ controller = Products, action = Details, id = 17 }`.</span></span>

<span data-ttu-id="777c4-1030">Значения маршрута определяются с помощью разделения пути URL-адреса на сегменты и сопоставления каждого сегмента с именем *параметра маршрута* в шаблоне маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1030">Route values are determined by splitting the URL path into segments and matching each segment with the *route parameter* name in the route template.</span></span> <span data-ttu-id="777c4-1031">Параметры маршрута являются именованными.</span><span class="sxs-lookup"><span data-stu-id="777c4-1031">Route parameters are named.</span></span> <span data-ttu-id="777c4-1032">Параметры определяются путем заключения имени параметра в фигурные скобки `{ ... }`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1032">The parameters defined by enclosing the parameter name in braces `{ ... }`.</span></span>

<span data-ttu-id="777c4-1033">Приведенный выше шаблон может также соответствовать пути URL-адреса `/`. В этом случае он предоставляет значения `{ controller = Home, action = Index }`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1033">The preceding template could also match the URL path `/` and produce the values `{ controller = Home, action = Index }`.</span></span> <span data-ttu-id="777c4-1034">Связано это с тем, что параметры маршрута `{controller}` и `{action}` имеют значения по умолчанию, а параметр маршрута `id` является необязательным.</span><span class="sxs-lookup"><span data-stu-id="777c4-1034">This occurs because the `{controller}` and `{action}` route parameters have default values and the `id` route parameter is optional.</span></span> <span data-ttu-id="777c4-1035">Значение по умолчанию для параметра маршрута определяется с помощью знака равенства (`=`), за которым следует значение после имени параметра.</span><span class="sxs-lookup"><span data-stu-id="777c4-1035">An equals sign (`=`) followed by a value after the route parameter name defines a default value for the parameter.</span></span> <span data-ttu-id="777c4-1036">Вопросительный знак (`?`) после имени параметра маршрута определяет параметр как необязательный.</span><span class="sxs-lookup"><span data-stu-id="777c4-1036">A question mark (`?`) after the route parameter name defines an optional parameter.</span></span>

<span data-ttu-id="777c4-1037">Параметры маршрута со значением по умолчанию *всегда* предоставляют значения маршрута при совпадении маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1037">Route parameters with a default value *always* produce a route value when the route matches.</span></span> <span data-ttu-id="777c4-1038">Необязательные параметры не предоставляют значение маршрута, если нет соответствующего сегмента пути URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1038">Optional parameters don't produce a route value if there is no corresponding URL path segment.</span></span> <span data-ttu-id="777c4-1039">Подробное описание сценариев и синтаксиса шаблона маршрута см. в разделе [Справочник по шаблонам маршрутов](#route-template-reference).</span><span class="sxs-lookup"><span data-stu-id="777c4-1039">See the [Route template reference](#route-template-reference) section for a thorough description of route template scenarios and syntax.</span></span>

<span data-ttu-id="777c4-1040">В следующем примере в определении параметра маршрута `{id:int}` определяется [ограничение маршрута](#route-constraint-reference) для параметра маршрута `id`:</span><span class="sxs-lookup"><span data-stu-id="777c4-1040">In the following example, the route parameter definition `{id:int}` defines a [route constraint](#route-constraint-reference) for the `id` route parameter:</span></span>

```csharp
routes.MapRoute(
    name: "default",
    template: "{controller=Home}/{action=Index}/{id:int}");
```

<span data-ttu-id="777c4-1041">Этот шаблон соответствует такому пути URL-адреса, как `/Products/Details/17`, но не `/Products/Details/Apples`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1041">This template matches a URL path like `/Products/Details/17` but not `/Products/Details/Apples`.</span></span> <span data-ttu-id="777c4-1042">Ограничения маршрута реализуют интерфейс <xref:Microsoft.AspNetCore.Routing.IRouteConstraint> и проверяют значения маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1042">Route constraints implement <xref:Microsoft.AspNetCore.Routing.IRouteConstraint> and inspect route values to verify them.</span></span> <span data-ttu-id="777c4-1043">В этом примере значение маршрута `id` должно иметь возможность преобразования в целое число.</span><span class="sxs-lookup"><span data-stu-id="777c4-1043">In this example, the route value `id` must be convertible to an integer.</span></span> <span data-ttu-id="777c4-1044">Более подробное описание ограничений маршрутов, предоставляемых платформой, см. в разделе [Справочник по ограничениям маршрутов](#route-constraint-reference).</span><span class="sxs-lookup"><span data-stu-id="777c4-1044">See [route-constraint-reference](#route-constraint-reference) for an explanation of route constraints provided by the framework.</span></span>

<span data-ttu-id="777c4-1045">Дополнительные перегрузки <xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> принимают значения для параметров `constraints`, `dataTokens` и `defaults`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1045">Additional overloads of <xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> accept values for `constraints`, `dataTokens`, and `defaults`.</span></span> <span data-ttu-id="777c4-1046">Типичное применение этих параметров состоит в передаче анонимно типизированного объекта, причем имена свойств анонимного типа соответствуют именам параметров маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1046">The typical usage of these parameters is to pass an anonymously typed object, where the property names of the anonymous type match route parameter names.</span></span>

<span data-ttu-id="777c4-1047">В следующих примерах <xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> создаются эквивалентные маршруты:</span><span class="sxs-lookup"><span data-stu-id="777c4-1047">The following <xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> examples create equivalent routes:</span></span>

```csharp
routes.MapRoute(
    name: "default_route",
    template: "{controller}/{action}/{id?}",
    defaults: new { controller = "Home", action = "Index" });

routes.MapRoute(
    name: "default_route",
    template: "{controller=Home}/{action=Index}/{id?}");
```

> [!TIP]
> <span data-ttu-id="777c4-1048">Встроенный синтаксис определения ограничений и значений по умолчанию может быть удобнее для простых маршрутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1048">The inline syntax for defining constraints and defaults can be convenient for simple routes.</span></span> <span data-ttu-id="777c4-1049">Однако некоторые сценарии, например токены данных, не поддерживаются встроенным синтаксисом.</span><span class="sxs-lookup"><span data-stu-id="777c4-1049">However, there are scenarios, such as data tokens, that aren't supported by inline syntax.</span></span>

<span data-ttu-id="777c4-1050">В следующем примере показано еще несколько сценариев:</span><span class="sxs-lookup"><span data-stu-id="777c4-1050">The following example demonstrates a few additional scenarios:</span></span>

```csharp
routes.MapRoute(
    name: "blog",
    template: "Blog/{**article}",
    defaults: new { controller = "Blog", action = "ReadArticle" });
```

<span data-ttu-id="777c4-1051">Предыдущий шаблон соответствует такому пути URL-адреса, как `/Blog/All-About-Routing/Introduction`, и извлекает значения `{ controller = Blog, action = ReadArticle, article = All-About-Routing/Introduction }`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1051">The preceding template matches a URL path like `/Blog/All-About-Routing/Introduction` and extracts the values `{ controller = Blog, action = ReadArticle, article = All-About-Routing/Introduction }`.</span></span> <span data-ttu-id="777c4-1052">Значения маршрута по умолчанию для `controller` и `action` предоставляются маршрутом несмотря на то, что в шаблоне нет соответствующих параметров маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1052">The default route values for `controller` and `action` are produced by the route even though there are no corresponding route parameters in the template.</span></span> <span data-ttu-id="777c4-1053">Значения по умолчанию можно указать в шаблоне маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1053">Default values can be specified in the route template.</span></span> <span data-ttu-id="777c4-1054">Параметр маршрута `article` определяется как *универсальный* с помощью двух звездочек (`**`) перед именем.</span><span class="sxs-lookup"><span data-stu-id="777c4-1054">The `article` route parameter is defined as a *catch-all* by the appearance of an double asterisk (`**`) before the route parameter name.</span></span> <span data-ttu-id="777c4-1055">Универсальные параметры маршрута служат для фиксации оставшейся части пути URL-адреса, а также могут соответствовать пустой строке.</span><span class="sxs-lookup"><span data-stu-id="777c4-1055">Catch-all route parameters capture the remainder of the URL path and can also match the empty string.</span></span>

<span data-ttu-id="777c4-1056">В следующем примере добавляются ограничения маршрута и токены данных:</span><span class="sxs-lookup"><span data-stu-id="777c4-1056">The following example adds route constraints and data tokens:</span></span>

```csharp
routes.MapRoute(
    name: "us_english_products",
    template: "en-US/Products/{id}",
    defaults: new { controller = "Products", action = "Details" },
    constraints: new { id = new IntRouteConstraint() },
    dataTokens: new { locale = "en-US" });
```

<span data-ttu-id="777c4-1057">Предыдущий шаблон будет соответствовать такому пути URL-адреса, как `/en-US/Products/5`, и будет извлекать значения `{ controller = Products, action = Details, id = 5 }` и токены данных `{ locale = en-US }`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1057">The preceding template matches a URL path like `/en-US/Products/5` and extracts the values `{ controller = Products, action = Details, id = 5 }` and the data tokens `{ locale = en-US }`.</span></span>

![Токены в окне "Локальные"](routing/_static/tokens.png)

### <a name="route-class-url-generation"></a><span data-ttu-id="777c4-1059">Формирование URL-адреса класса маршрута</span><span class="sxs-lookup"><span data-stu-id="777c4-1059">Route class URL generation</span></span>

<span data-ttu-id="777c4-1060">Класс <xref:Microsoft.AspNetCore.Routing.Route> может также формировать URL-адрес, объединяя набор значений маршрута с шаблоном маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1060">The <xref:Microsoft.AspNetCore.Routing.Route> class can also perform URL generation by combining a set of route values with its route template.</span></span> <span data-ttu-id="777c4-1061">С логической точки зрения, этот процесс обратен сопоставлению пути URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1061">This is logically the reverse process of matching the URL path.</span></span>

> [!TIP]
> <span data-ttu-id="777c4-1062">Чтобы лучше понять процесс формирования URL-адреса, представьте себе, какой URL-адрес нужно создать, а затем подумайте, как шаблон маршрута будет сопоставляться с этим URL-адресом.</span><span class="sxs-lookup"><span data-stu-id="777c4-1062">To better understand URL generation, imagine what URL you want to generate and then think about how a route template would match that URL.</span></span> <span data-ttu-id="777c4-1063">Какие значения будут получены?</span><span class="sxs-lookup"><span data-stu-id="777c4-1063">What values would be produced?</span></span> <span data-ttu-id="777c4-1064">Примерно так производится формирование URL-адреса в классе <xref:Microsoft.AspNetCore.Routing.Route>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1064">This is the rough equivalent of how URL generation works in the <xref:Microsoft.AspNetCore.Routing.Route> class.</span></span>

<span data-ttu-id="777c4-1065">В следующем примере используется общий маршрут по умолчанию ASP.NET Core MVC:</span><span class="sxs-lookup"><span data-stu-id="777c4-1065">The following example uses a general ASP.NET Core MVC default route:</span></span>

```csharp
routes.MapRoute(
    name: "default",
    template: "{controller=Home}/{action=Index}/{id?}");
```

<span data-ttu-id="777c4-1066">При значениях маршрута `{ controller = Products, action = List }` создается URL-адрес `/Products/List`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1066">With the route values `{ controller = Products, action = List }`, the URL `/Products/List` is generated.</span></span> <span data-ttu-id="777c4-1067">Значения маршрута заменяются на соответствующие параметры маршрута для образования пути URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1067">The route values are substituted for the corresponding route parameters to form the URL path.</span></span> <span data-ttu-id="777c4-1068">Так как `id` является необязательным параметром маршрута, URL-адрес успешно создается без значения для `id`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1068">Since `id` is an optional route parameter, the URL is successfully generated without a value for `id`.</span></span>

<span data-ttu-id="777c4-1069">При значениях маршрута `{ controller = Home, action = Index }` создается URL-адрес `/`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1069">With the route values `{ controller = Home, action = Index }`, the URL `/` is generated.</span></span> <span data-ttu-id="777c4-1070">Предоставленные значения маршрута соответствуют значениям по умолчанию, поэтому сегменты, соответствующие значениям по умолчанию, можно спокойно опустить.</span><span class="sxs-lookup"><span data-stu-id="777c4-1070">The provided route values match the default values, and the segments corresponding to the default values are safely omitted.</span></span>

<span data-ttu-id="777c4-1071">Оба созданных URL-адреса будут совершать круговой путь с таким же определением маршрута (`/Home/Index` и `/`) и предоставлять те же значения маршрута, которые использовались для формирования URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1071">Both URLs generated round-trip with the following route definition (`/Home/Index` and `/`) produce the same route values that were used to generate the URL.</span></span>

> [!NOTE]
> <span data-ttu-id="777c4-1072">Приложение, использующее платформу ASP.NET Core MVC, должно создавать URL-адреса с помощью объекта <xref:Microsoft.AspNetCore.Mvc.Routing.UrlHelper>, а не вызывать маршрутизацию напрямую.</span><span class="sxs-lookup"><span data-stu-id="777c4-1072">An app using ASP.NET Core MVC should use <xref:Microsoft.AspNetCore.Mvc.Routing.UrlHelper> to generate URLs instead of calling into routing directly.</span></span>

<span data-ttu-id="777c4-1073">Дополнительные сведения о формировании URL-адресов см. в [справочнике по формированию URL-адресов](#url-generation-reference).</span><span class="sxs-lookup"><span data-stu-id="777c4-1073">For more information on URL generation, see the [Url generation reference](#url-generation-reference) section.</span></span>

## <a name="use-routing-middleware"></a><span data-ttu-id="777c4-1074">Использование ПО промежуточного слоя маршрутизации</span><span class="sxs-lookup"><span data-stu-id="777c4-1074">Use Routing Middleware</span></span>

<span data-ttu-id="777c4-1075">Ссылка на [метапакет Microsoft.AspNetCore.App](xref:fundamentals/metapackage-app) в файле проекта приложения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1075">Reference the [Microsoft.AspNetCore.App metapackage](xref:fundamentals/metapackage-app) in the app's project file.</span></span>

<span data-ttu-id="777c4-1076">Добавьте маршрутизацию в контейнер службы в файле `Startup.ConfigureServices`:</span><span class="sxs-lookup"><span data-stu-id="777c4-1076">Add routing to the service container in `Startup.ConfigureServices`:</span></span>

[!code-csharp[](routing/samples/2.x/RoutingSample/Startup.cs?name=snippet_ConfigureServices&highlight=3)]

<span data-ttu-id="777c4-1077">Маршруты должны настраиваться в методе `Startup.Configure`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1077">Routes must be configured in the `Startup.Configure` method.</span></span> <span data-ttu-id="777c4-1078">В этом примере приложения используются следующие API:</span><span class="sxs-lookup"><span data-stu-id="777c4-1078">The sample app uses the following APIs:</span></span>

* <xref:Microsoft.AspNetCore.Routing.RouteBuilder>
* <span data-ttu-id="777c4-1079"><xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapGet*>. Соответствует только HTTP-запросам GET.</span><span class="sxs-lookup"><span data-stu-id="777c4-1079"><xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapGet*>: Matches only HTTP GET requests.</span></span>
* <xref:Microsoft.AspNetCore.Builder.RoutingBuilderExtensions.UseRouter*>

[!code-csharp[](routing/samples/2.x/RoutingSample/Startup.cs?name=snippet_RouteHandler)]

<span data-ttu-id="777c4-1080">В таблице ниже приведены ответы с данными универсальными кодами ресурсов (URI).</span><span class="sxs-lookup"><span data-stu-id="777c4-1080">The following table shows the responses with the given URIs.</span></span>

| <span data-ttu-id="777c4-1081">URI</span><span class="sxs-lookup"><span data-stu-id="777c4-1081">URI</span></span>                    | <span data-ttu-id="777c4-1082">Ответ</span><span class="sxs-lookup"><span data-stu-id="777c4-1082">Response</span></span>                                          |
| ---------------------- | ------------------------------------------------- |
| `/package/create/3`    | <span data-ttu-id="777c4-1083">Hello!</span><span class="sxs-lookup"><span data-stu-id="777c4-1083">Hello!</span></span> <span data-ttu-id="777c4-1084">Значения маршрута: [operation, create], [id, 3]</span><span class="sxs-lookup"><span data-stu-id="777c4-1084">Route values: [operation, create], [id, 3]</span></span> |
| `/package/track/-3`    | <span data-ttu-id="777c4-1085">Hello!</span><span class="sxs-lookup"><span data-stu-id="777c4-1085">Hello!</span></span> <span data-ttu-id="777c4-1086">Значения маршрута: [operation, track], [id, -3]</span><span class="sxs-lookup"><span data-stu-id="777c4-1086">Route values: [operation, track], [id, -3]</span></span> |
| `/package/track/-3/`   | <span data-ttu-id="777c4-1087">Hello!</span><span class="sxs-lookup"><span data-stu-id="777c4-1087">Hello!</span></span> <span data-ttu-id="777c4-1088">Значения маршрута: [operation, track], [id, -3]</span><span class="sxs-lookup"><span data-stu-id="777c4-1088">Route values: [operation, track], [id, -3]</span></span> |
| `/package/track/`      | <span data-ttu-id="777c4-1089">Запрос не дал результата, нет совпадений.</span><span class="sxs-lookup"><span data-stu-id="777c4-1089">The request falls through, no match.</span></span>              |
| `GET /hello/Joe`       | <span data-ttu-id="777c4-1090">Hi, Joe!</span><span class="sxs-lookup"><span data-stu-id="777c4-1090">Hi, Joe!</span></span>                                          |
| `POST /hello/Joe`      | <span data-ttu-id="777c4-1091">Запрос не дал результата, совпадение только с HTTP GET.</span><span class="sxs-lookup"><span data-stu-id="777c4-1091">The request falls through, matches HTTP GET only.</span></span> |
| `GET /hello/Joe/Smith` | <span data-ttu-id="777c4-1092">Запрос не дал результата, нет совпадений.</span><span class="sxs-lookup"><span data-stu-id="777c4-1092">The request falls through, no match.</span></span>              |

<span data-ttu-id="777c4-1093">Платформа предоставляет наборов методов расширения для создания маршрутов (<xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions>):</span><span class="sxs-lookup"><span data-stu-id="777c4-1093">The framework provides a set of extension methods for creating routes (<xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions>):</span></span>

* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapDelete*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapGet*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapMiddlewareDelete*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapMiddlewareGet*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapMiddlewarePost*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapMiddlewarePut*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapMiddlewareRoute*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapMiddlewareVerb*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapPost*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapPut*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapRoute*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapVerb*>

<span data-ttu-id="777c4-1094">Методы `Map[Verb]` используют ограничения, чтобы ограничить маршрут к HTTP-команде в имени метода.</span><span class="sxs-lookup"><span data-stu-id="777c4-1094">The `Map[Verb]` methods use constraints to limit the route to the HTTP Verb in the method name.</span></span> <span data-ttu-id="777c4-1095">Например, см. класс <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapGet*> и тип <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapVerb*>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1095">For example, see <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapGet*> and <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapVerb*>.</span></span>

## <a name="route-template-reference"></a><span data-ttu-id="777c4-1096">Справочник по шаблону маршрута</span><span class="sxs-lookup"><span data-stu-id="777c4-1096">Route template reference</span></span>

<span data-ttu-id="777c4-1097">Токены в фигурных скобках (`{ ... }`) определяют *параметры маршрута*, которые будут привязаны при совпадении маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1097">Tokens within curly braces (`{ ... }`) define *route parameters* that are bound if the route is matched.</span></span> <span data-ttu-id="777c4-1098">В сегменте маршрута можно определить несколько параметров маршрута, но они должны разделяться литеральным значением.</span><span class="sxs-lookup"><span data-stu-id="777c4-1098">You can define more than one route parameter in a route segment, but they must be separated by a literal value.</span></span> <span data-ttu-id="777c4-1099">Например, `{controller=Home}{action=Index}` будет недопустимым маршрутом, так как между `{controller}` и `{action}` нет литерального значения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1099">For example, `{controller=Home}{action=Index}` isn't a valid route, since there's no literal value between `{controller}` and `{action}`.</span></span> <span data-ttu-id="777c4-1100">Эти параметры маршрута должны иметь имена, и для них могут быть определены дополнительные атрибуты.</span><span class="sxs-lookup"><span data-stu-id="777c4-1100">These route parameters must have a name and may have additional attributes specified.</span></span>

<span data-ttu-id="777c4-1101">Весь текст, кроме параметров маршрута (например, `{id}`) и разделителя пути `/`, должен соответствовать тексту в URL-адресе.</span><span class="sxs-lookup"><span data-stu-id="777c4-1101">Literal text other than route parameters (for example, `{id}`) and the path separator `/` must match the text in the URL.</span></span> <span data-ttu-id="777c4-1102">Сопоставление текста производится без учета регистра на основе декодированного представления путь URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1102">Text matching is case-insensitive and based on the decoded representation of the URLs path.</span></span> <span data-ttu-id="777c4-1103">Для сопоставления с литеральным разделителем параметров маршрута (`{` или `}`) разделитель следует экранировать путем повтора символа (`{{` или `}}`).</span><span class="sxs-lookup"><span data-stu-id="777c4-1103">To match a literal route parameter delimiter (`{` or `}`), escape the delimiter by repeating the character (`{{` or `}}`).</span></span>

<span data-ttu-id="777c4-1104">Шаблоны URL-адресов, которые пытаются получить имя файла с необязательным расширением, имеют свои особенности.</span><span class="sxs-lookup"><span data-stu-id="777c4-1104">URL patterns that attempt to capture a file name with an optional file extension have additional considerations.</span></span> <span data-ttu-id="777c4-1105">Например, рассмотрим шаблон `files/{filename}.{ext?}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1105">For example, consider the template `files/{filename}.{ext?}`.</span></span> <span data-ttu-id="777c4-1106">Когда значения для `filename` и `ext` существуют, заполняются оба значения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1106">When values for both `filename` and `ext` exist, both values are populated.</span></span> <span data-ttu-id="777c4-1107">Если в URL-адресе есть только значение для `filename`, маршрут совпадает, так как точка в конце (`.`) является необязательной.</span><span class="sxs-lookup"><span data-stu-id="777c4-1107">If only a value for `filename` exists in the URL, the route matches because the trailing period (`.`) is  optional.</span></span> <span data-ttu-id="777c4-1108">Следующие URL-адреса соответствуют этому маршруту:</span><span class="sxs-lookup"><span data-stu-id="777c4-1108">The following URLs match this route:</span></span>

* `/files/myFile.txt`
* `/files/myFile`

<span data-ttu-id="777c4-1109">Вы можете использовать звездочку (`*`) или две звездочки (`**`) в качестве префикса параметра маршрута для привязки к остальной части URI.</span><span class="sxs-lookup"><span data-stu-id="777c4-1109">You can use an asterisk (`*`) or double asterisk (`**`) as a prefix to a route parameter to bind to the rest of the URI.</span></span> <span data-ttu-id="777c4-1110">Такие параметры называются *универсальными*.</span><span class="sxs-lookup"><span data-stu-id="777c4-1110">These are called a *catch-all* parameters.</span></span> <span data-ttu-id="777c4-1111">Например, `blog/{**slug}` соответствует любому URI, начинающемуся с сегмента `/blog`, за которым следует любое значение, присваиваемое в качестве значения маршрута `slug`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1111">For example, `blog/{**slug}` matches any URI that starts with `/blog` and has any value following it, which is assigned to the `slug` route value.</span></span> <span data-ttu-id="777c4-1112">Универсальные параметры также могут соответствовать пустой строке.</span><span class="sxs-lookup"><span data-stu-id="777c4-1112">Catch-all parameters can also match the empty string.</span></span>

<span data-ttu-id="777c4-1113">Универсальный параметр экранирует соответствующие символы, если маршрут использует для формирования URL-адрес, включая символы разделителей пути (`/`).</span><span class="sxs-lookup"><span data-stu-id="777c4-1113">The catch-all parameter escapes the appropriate characters when the route is used to generate a URL, including path separator (`/`) characters.</span></span> <span data-ttu-id="777c4-1114">Например, маршрут `foo/{*path}` со значениями маршрутов `{ path = "my/path" }` формирует `foo/my%2Fpath`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1114">For example, the route `foo/{*path}` with route values `{ path = "my/path" }` generates `foo/my%2Fpath`.</span></span> <span data-ttu-id="777c4-1115">Обратите внимание на экранированный знак косой черты.</span><span class="sxs-lookup"><span data-stu-id="777c4-1115">Note the escaped forward slash.</span></span> <span data-ttu-id="777c4-1116">В качестве символов разделителя кругового пути используйте префикс параметра маршрута `**`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1116">To round-trip path separator characters, use the `**` route parameter prefix.</span></span> <span data-ttu-id="777c4-1117">Маршрут `foo/{**path}` с `{ path = "my/path" }` формирует `foo/my/path`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1117">The route `foo/{**path}` with `{ path = "my/path" }` generates `foo/my/path`.</span></span>

<span data-ttu-id="777c4-1118">Параметры маршрута могут иметь *значения по умолчанию*. Они указываются после имени параметра и знака равенства (`=`).</span><span class="sxs-lookup"><span data-stu-id="777c4-1118">Route parameters may have *default values* designated by specifying the default value after the parameter name separated by an equals sign (`=`).</span></span> <span data-ttu-id="777c4-1119">Например, `{controller=Home}` определяет `Home` в качестве значения по умолчанию для `controller`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1119">For example, `{controller=Home}` defines `Home` as the default value for `controller`.</span></span> <span data-ttu-id="777c4-1120">Значение по умолчанию используется, если для параметра нет значения в URL-адресе.</span><span class="sxs-lookup"><span data-stu-id="777c4-1120">The default value is used if no value is present in the URL for the parameter.</span></span> <span data-ttu-id="777c4-1121">Параметры маршрута могут быть необязательными (для этого необходимо добавить вопросительный знак (`?`) в конец имени параметра, например `id?`).</span><span class="sxs-lookup"><span data-stu-id="777c4-1121">Route parameters are made optional by appending a question mark (`?`) to the end of the parameter name, as in `id?`.</span></span> <span data-ttu-id="777c4-1122">Различие между необязательными параметрами и параметрами маршрута по умолчанию в том, что вторые всегда имеют значения &mdash; необязательный параметр имеет значение, только если оно предоставлено URL-адресом запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1122">The difference between optional values and default route parameters is that a route parameter with a default value always produces a value&mdash;an optional parameter has a value only when a value is provided by the request URL.</span></span>

<span data-ttu-id="777c4-1123">Параметры маршрута могут иметь ограничения, которые должны соответствовать значению маршрута из URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1123">Route parameters may have constraints that must match the route value bound from the URL.</span></span> <span data-ttu-id="777c4-1124">Добавив двоеточие (`:`) и имя ограничения после имени параметра маршрута, можно указать *встроенные ограничения* для параметра маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1124">Adding a colon (`:`) and constraint name after the route parameter name specifies an *inline constraint* on a route parameter.</span></span> <span data-ttu-id="777c4-1125">Если для ограничения требуются аргументы, они указываются в скобках (`(...)`) после имени ограничения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1125">If the constraint requires arguments, they're enclosed in parentheses (`(...)`) after the constraint name.</span></span> <span data-ttu-id="777c4-1126">Чтобы указать несколько встроенных ограничений, добавьте еще одно двоеточие (`:`) и имя ограничения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1126">Multiple inline constraints can be specified by appending another colon (`:`) and constraint name.</span></span>

<span data-ttu-id="777c4-1127">Имя и аргументы ограничения передаются в службу <xref:Microsoft.AspNetCore.Routing.IInlineConstraintResolver> для создания экземпляра интерфейса <xref:Microsoft.AspNetCore.Routing.IRouteConstraint>, который будет использоваться при обработке URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1127">The constraint name and arguments are passed to the <xref:Microsoft.AspNetCore.Routing.IInlineConstraintResolver> service to create an instance of <xref:Microsoft.AspNetCore.Routing.IRouteConstraint> to use in URL processing.</span></span> <span data-ttu-id="777c4-1128">Например, в шаблоне маршрута `blog/{article:minlength(10)}` определяется ограничение `minlength` с аргументом `10`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1128">For example, the route template `blog/{article:minlength(10)}` specifies a `minlength` constraint with the argument `10`.</span></span> <span data-ttu-id="777c4-1129">Более подробное описание ограничений маршрутов и список ограничений, предоставляемых платформой, см. в разделе [Справочник по ограничениям маршрутов](#route-constraint-reference).</span><span class="sxs-lookup"><span data-stu-id="777c4-1129">For more information on route constraints and a list of the constraints provided by the framework, see the [Route constraint reference](#route-constraint-reference) section.</span></span>

<span data-ttu-id="777c4-1130">Параметры маршрута также могут иметь преобразователи параметров, которые преобразуют значение параметра при создании ссылок и сопоставлении действий и страниц с URL-адресами.</span><span class="sxs-lookup"><span data-stu-id="777c4-1130">Route parameters may also have parameter transformers, which transform a parameter's value when generating links and matching actions and pages to URLs.</span></span> <span data-ttu-id="777c4-1131">Как и ограничения, преобразователи параметров можно включать в параметр маршрута, добавив двоеточие (`:`) и имя преобразователя после имени параметра маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1131">Like constraints, parameter transformers can be added inline to a route parameter by adding a colon (`:`) and transformer name after the route parameter name.</span></span> <span data-ttu-id="777c4-1132">Например, шаблон маршрута `blog/{article:slugify}` задает преобразователь `slugify`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1132">For example, the route template `blog/{article:slugify}` specifies a `slugify` transformer.</span></span> <span data-ttu-id="777c4-1133">Дополнительные сведения о преобразователях параметров см. в разделе [Справочник по преобразователям параметров](#parameter-transformer-reference).</span><span class="sxs-lookup"><span data-stu-id="777c4-1133">For more information on parameter transformers, see the [Parameter transformer reference](#parameter-transformer-reference) section.</span></span>

<span data-ttu-id="777c4-1134">В приведенной ниже таблице показаны некоторые примеры шаблонов маршрутов и их поведение.</span><span class="sxs-lookup"><span data-stu-id="777c4-1134">The following table demonstrates example route templates and their behavior.</span></span>

| <span data-ttu-id="777c4-1135">Шаблон маршрута</span><span class="sxs-lookup"><span data-stu-id="777c4-1135">Route Template</span></span>                           | <span data-ttu-id="777c4-1136">Пример соответствующего URI</span><span class="sxs-lookup"><span data-stu-id="777c4-1136">Example Matching URI</span></span>    | <span data-ttu-id="777c4-1137">URI запроса&hellip;</span><span class="sxs-lookup"><span data-stu-id="777c4-1137">The request URI&hellip;</span></span>                                                    |
| ---------------------------------------- | ----------------------- | -------------------------------------------------------------------------- |
| `hello`                                  | `/hello`                | <span data-ttu-id="777c4-1138">Соответствует только одному пути `/hello`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1138">Only matches the single path `/hello`.</span></span>                                     |
| `{Page=Home}`                            | `/`                     | <span data-ttu-id="777c4-1139">Соответствует и задает для параметра `Page` значение `Home`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1139">Matches and sets `Page` to `Home`.</span></span>                                         |
| `{Page=Home}`                            | `/Contact`              | <span data-ttu-id="777c4-1140">Соответствует и задает для параметра `Page` значение `Contact`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1140">Matches and sets `Page` to `Contact`.</span></span>                                      |
| `{controller}/{action}/{id?}`            | `/Products/List`        | <span data-ttu-id="777c4-1141">Сопоставляется с контроллером `Products` и действием `List`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1141">Maps to the `Products` controller and `List` action.</span></span>                       |
| `{controller}/{action}/{id?}`            | `/Products/Details/123` | <span data-ttu-id="777c4-1142">Сопоставляется с контроллером `Products` и действием `Details` (`id` имеет значение 123).</span><span class="sxs-lookup"><span data-stu-id="777c4-1142">Maps to the `Products` controller and  `Details` action (`id` set to 123).</span></span> |
| `{controller=Home}/{action=Index}/{id?}` | `/`                     | <span data-ttu-id="777c4-1143">Сопоставляется с контроллером `Home` и методом `Index` (`id` пропускается).</span><span class="sxs-lookup"><span data-stu-id="777c4-1143">Maps to the `Home` controller and `Index` method (`id` is ignored).</span></span>        |

<span data-ttu-id="777c4-1144">Использование шаблона — это, как правило, самый простой подход к маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-1144">Using a template is generally the simplest approach to routing.</span></span> <span data-ttu-id="777c4-1145">Ограничения и значения по умолчанию также могут указываться вне шаблона маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1145">Constraints and defaults can also be specified outside the route template.</span></span>

> [!TIP]
> <span data-ttu-id="777c4-1146">Чтобы увидеть, как встроенные реализации маршрутизации, такие как <xref:Microsoft.AspNetCore.Routing.Route>, сопоставляются с запросами, включите [ведение журнала](xref:fundamentals/logging/index).</span><span class="sxs-lookup"><span data-stu-id="777c4-1146">Enable [Logging](xref:fundamentals/logging/index) to see how the built-in routing implementations, such as <xref:Microsoft.AspNetCore.Routing.Route>, match requests.</span></span>

## <a name="reserved-routing-names"></a><span data-ttu-id="777c4-1147">Зарезервированные имена маршрутизации</span><span class="sxs-lookup"><span data-stu-id="777c4-1147">Reserved routing names</span></span>

<span data-ttu-id="777c4-1148">Следующие ключевые слова являются зарезервированными именами и не могут использоваться как имена маршрутов или параметры:</span><span class="sxs-lookup"><span data-stu-id="777c4-1148">The following keywords are reserved names and can't be used as route names or parameters:</span></span>

* `action`
* `area`
* `controller`
* `handler`
* `page`

## <a name="route-constraint-reference"></a><span data-ttu-id="777c4-1149">Справочник по ограничениям маршрутов</span><span class="sxs-lookup"><span data-stu-id="777c4-1149">Route constraint reference</span></span>

<span data-ttu-id="777c4-1150">Ограничения маршрута применяются, когда найдено соответствие входящему URL-адресу и путь URL-адреса был разобран на значения маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1150">Route constraints execute when a match has occurred to the incoming URL and the URL path is tokenized into route values.</span></span> <span data-ttu-id="777c4-1151">Как правило, ограничения маршрута служат для проверки значения маршрута, связанного посредством шаблона маршрута, и принятия решения касательно того, является ли значение приемлемым (да или нет).</span><span class="sxs-lookup"><span data-stu-id="777c4-1151">Route constraints generally inspect the route value associated via the route template and make a yes/no decision about whether or not the value is acceptable.</span></span> <span data-ttu-id="777c4-1152">Некоторые ограничения маршрута используют данные, не относящиеся к значению маршрута, для определения возможности маршрутизации запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1152">Some route constraints use data outside the route value to consider whether the request can be routed.</span></span> <span data-ttu-id="777c4-1153">Например, <xref:Microsoft.AspNetCore.Routing.Constraints.HttpMethodRouteConstraint> может принимать или отклонять запрос в зависимости от HTTP-команды.</span><span class="sxs-lookup"><span data-stu-id="777c4-1153">For example, the <xref:Microsoft.AspNetCore.Routing.Constraints.HttpMethodRouteConstraint> can accept or reject a request based on its HTTP verb.</span></span> <span data-ttu-id="777c4-1154">Ограничения используются в маршрутизации запросов и создании ссылок.</span><span class="sxs-lookup"><span data-stu-id="777c4-1154">Constraints are used in routing requests and link generation.</span></span>

> [!WARNING]
> <span data-ttu-id="777c4-1155">Не используйте ограничения для **проверки входных данных**.</span><span class="sxs-lookup"><span data-stu-id="777c4-1155">Don't use constraints for **input validation**.</span></span> <span data-ttu-id="777c4-1156">Если ограничения используются для **проверки входных данных**, недопустимые входные данные будут вызывать ошибку *404 (не найдено)* вместо ошибки *400 (неверный запрос)* с соответствующим сообщением.</span><span class="sxs-lookup"><span data-stu-id="777c4-1156">If constraints are used for **input validation**, invalid input results in a *404 - Not Found* response instead of a *400 - Bad Request* with an appropriate error message.</span></span> <span data-ttu-id="777c4-1157">Ограничения маршрутов следует использовать для **разрешения неоднозначности** похожих маршрутов, а не для проверки входных данных определенного маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1157">Route constraints are used to **disambiguate** similar routes, not to validate the inputs for a particular route.</span></span>

<span data-ttu-id="777c4-1158">В приведенной ниже таблице показаны примеры ограничения маршрутов и их ожидаемое поведение.</span><span class="sxs-lookup"><span data-stu-id="777c4-1158">The following table demonstrates example route constraints and their expected behavior.</span></span>

| <span data-ttu-id="777c4-1159">Ограничение</span><span class="sxs-lookup"><span data-stu-id="777c4-1159">Constraint</span></span> | <span data-ttu-id="777c4-1160">Пример</span><span class="sxs-lookup"><span data-stu-id="777c4-1160">Example</span></span> | <span data-ttu-id="777c4-1161">Примеры совпадений</span><span class="sxs-lookup"><span data-stu-id="777c4-1161">Example matches</span></span> | <span data-ttu-id="777c4-1162">Примечания</span><span class="sxs-lookup"><span data-stu-id="777c4-1162">Notes</span></span> |
|------------|---------|-----------------|-------|
| `int` | `{id:int}` | <span data-ttu-id="777c4-1163">`123456789`, `-123456789`</span><span class="sxs-lookup"><span data-stu-id="777c4-1163">`123456789`, `-123456789`</span></span> | <span data-ttu-id="777c4-1164">Соответствует любому целому числу.</span><span class="sxs-lookup"><span data-stu-id="777c4-1164">Matches any integer.</span></span>|
| `bool` | `{active:bool}` | <span data-ttu-id="777c4-1165">`true`, `FALSE`</span><span class="sxs-lookup"><span data-stu-id="777c4-1165">`true`, `FALSE`</span></span> | <span data-ttu-id="777c4-1166">Соответствует `true` или `false`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1166">Matches `true` or `false`.</span></span> <span data-ttu-id="777c4-1167">Без учета регистра.</span><span class="sxs-lookup"><span data-stu-id="777c4-1167">Case-insensitive.</span></span>|
| `datetime` | `{dob:datetime}` | <span data-ttu-id="777c4-1168">`2016-12-31`, `2016-12-31 7:32pm`</span><span class="sxs-lookup"><span data-stu-id="777c4-1168">`2016-12-31`, `2016-12-31 7:32pm`</span></span> | <span data-ttu-id="777c4-1169">Соответствует допустимому значению `DateTime` для инвариантного языка и региональных параметров.</span><span class="sxs-lookup"><span data-stu-id="777c4-1169">Matches a valid `DateTime` value in the invariant culture.</span></span> <span data-ttu-id="777c4-1170">См. предупреждение выше.</span><span class="sxs-lookup"><span data-stu-id="777c4-1170">See preceding warning.</span></span>|
| `decimal` | `{price:decimal}` | <span data-ttu-id="777c4-1171">`49.99`, `-1,000.01`</span><span class="sxs-lookup"><span data-stu-id="777c4-1171">`49.99`, `-1,000.01`</span></span> | <span data-ttu-id="777c4-1172">Соответствует допустимому значению `decimal` для инвариантного языка и региональных параметров.</span><span class="sxs-lookup"><span data-stu-id="777c4-1172">Matches a valid `decimal` value in the invariant culture.</span></span> <span data-ttu-id="777c4-1173">См. предупреждение выше.</span><span class="sxs-lookup"><span data-stu-id="777c4-1173">See  preceding warning.</span></span>|
| `double` | `{weight:double}` | <span data-ttu-id="777c4-1174">`1.234`, `-1,001.01e8`</span><span class="sxs-lookup"><span data-stu-id="777c4-1174">`1.234`, `-1,001.01e8`</span></span> | <span data-ttu-id="777c4-1175">Соответствует допустимому значению `double` для инвариантного языка и региональных параметров.</span><span class="sxs-lookup"><span data-stu-id="777c4-1175">Matches a valid `double` value in the invariant culture.</span></span> <span data-ttu-id="777c4-1176">См. предупреждение выше.</span><span class="sxs-lookup"><span data-stu-id="777c4-1176">See  preceding warning.</span></span>|
| `float` | `{weight:float}` | <span data-ttu-id="777c4-1177">`1.234`, `-1,001.01e8`</span><span class="sxs-lookup"><span data-stu-id="777c4-1177">`1.234`, `-1,001.01e8`</span></span> | <span data-ttu-id="777c4-1178">Соответствует допустимому значению `float` для инвариантного языка и региональных параметров.</span><span class="sxs-lookup"><span data-stu-id="777c4-1178">Matches a valid `float` value in the invariant culture.</span></span> <span data-ttu-id="777c4-1179">См. предупреждение выше.</span><span class="sxs-lookup"><span data-stu-id="777c4-1179">See  preceding warning.</span></span>|
| `guid` | `{id:guid}` | <span data-ttu-id="777c4-1180">`CD2C1638-1638-72D5-1638-DEADBEEF1638`, `{CD2C1638-1638-72D5-1638-DEADBEEF1638}`</span><span class="sxs-lookup"><span data-stu-id="777c4-1180">`CD2C1638-1638-72D5-1638-DEADBEEF1638`, `{CD2C1638-1638-72D5-1638-DEADBEEF1638}`</span></span> | <span data-ttu-id="777c4-1181">Соответствует допустимому значению `Guid`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1181">Matches a valid `Guid` value.</span></span>|
| `long` | `{ticks:long}` | <span data-ttu-id="777c4-1182">`123456789`, `-123456789`</span><span class="sxs-lookup"><span data-stu-id="777c4-1182">`123456789`, `-123456789`</span></span> | <span data-ttu-id="777c4-1183">Соответствует допустимому значению `long`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1183">Matches a valid `long` value.</span></span>|
| `minlength(value)` | `{username:minlength(4)}` | `Rick` | <span data-ttu-id="777c4-1184">Строка должна содержать не менее 4 символов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1184">String must be at least 4 characters.</span></span>|
| `maxlength(value)` | `{filename:maxlength(8)}` | `MyFile` | <span data-ttu-id="777c4-1185">Строка должна содержать не более 8 символов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1185">String has maximum of 8 characters.</span></span>|
| `length(length)` | `{filename:length(12)}` | `somefile.txt` | <span data-ttu-id="777c4-1186">Длина строки должна составлять ровно 12 символов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1186">String must be exactly 12 characters long.</span></span>|
| `length(min,max)` | `{filename:length(8,16)}` | `somefile.txt` | <span data-ttu-id="777c4-1187">Строка должна содержать не менее 8 и не более 16 символов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1187">String must be at least 8 and has maximum of 16 characters.</span></span>|
| `min(value)` | `{age:min(18)}` | `19` | <span data-ttu-id="777c4-1188">Целочисленное значение не меньше 18.</span><span class="sxs-lookup"><span data-stu-id="777c4-1188">Integer value must be at least 18.</span></span>|
| `max(value)` | `{age:max(120)}` | `91` | <span data-ttu-id="777c4-1189">Целочисленное значение не больше 120.</span><span class="sxs-lookup"><span data-stu-id="777c4-1189">Integer value maximum of 120.</span></span>|
| `range(min,max)` | `{age:range(18,120)}` | `91` | <span data-ttu-id="777c4-1190">Целочисленное значение не меньше 18 и не больше 120.</span><span class="sxs-lookup"><span data-stu-id="777c4-1190">Integer value must be at least 18 and maximum of 120.</span></span>|
| `alpha` | `{name:alpha}` | `Rick` | <span data-ttu-id="777c4-1191">Строка должна состоять из одной буквы или нескольких (`a`-`z`).</span><span class="sxs-lookup"><span data-stu-id="777c4-1191">String must consist of one or more alphabetical characters `a`-`z`.</span></span> <span data-ttu-id="777c4-1192">Без учета регистра.</span><span class="sxs-lookup"><span data-stu-id="777c4-1192">Case-insensitive.</span></span>|
| `regex(expression)` | `{ssn:regex(^\\d{{3}}-\\d{{2}}-\\d{{4}}$)}` | `123-45-6789` | <span data-ttu-id="777c4-1193">Строка должна соответствовать регулярному выражению.</span><span class="sxs-lookup"><span data-stu-id="777c4-1193">String must match the regular expression.</span></span> <span data-ttu-id="777c4-1194">См. советы по определению регулярного выражения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1194">See tips about defining a regular expression.</span></span>|
| `required` | `{name:required}` | `Rick` | <span data-ttu-id="777c4-1195">Определяет обязательное наличие значения, не относящегося к параметру, во время формирования URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1195">Used to enforce that a non-parameter value is present during URL generation.</span></span>|

<span data-ttu-id="777c4-1196">К одному параметру может применяться несколько разделенных запятой ограничений.</span><span class="sxs-lookup"><span data-stu-id="777c4-1196">Multiple, colon-delimited constraints can be applied to a single parameter.</span></span> <span data-ttu-id="777c4-1197">Например, следующее ограничение ограничивает параметр целочисленным значением 1 или больше:</span><span class="sxs-lookup"><span data-stu-id="777c4-1197">For example, the following constraint restricts a parameter to an integer value of 1 or greater:</span></span>

```csharp
[Route("users/{id:int:min(1)}")]
public User GetUserById(int id) { }
```

> [!WARNING]
> <span data-ttu-id="777c4-1198">Ограничения маршрута, которые проверяют URL-адрес и могут быть преобразованы в тип CLR (например, `int` или `DateTime`), всегда используют инвариантные язык и региональные параметры.</span><span class="sxs-lookup"><span data-stu-id="777c4-1198">Route constraints that verify the URL and are converted to a CLR type (such as `int` or `DateTime`) always use the invariant culture.</span></span> <span data-ttu-id="777c4-1199">Эти ограничения предполагают, что URL-адрес является нелокализуемым.</span><span class="sxs-lookup"><span data-stu-id="777c4-1199">These constraints assume that the URL is non-localizable.</span></span> <span data-ttu-id="777c4-1200">Предоставляемые платформой ограничения маршрутов не изменяют значения, хранящиеся в значениях маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1200">The framework-provided route constraints don't modify the values stored in route values.</span></span> <span data-ttu-id="777c4-1201">Все значения маршрута, переданные из URL-адреса, сохраняются как строки.</span><span class="sxs-lookup"><span data-stu-id="777c4-1201">All route values parsed from the URL are stored as strings.</span></span> <span data-ttu-id="777c4-1202">Например, ограничение `float` пытается преобразовать значение маршрута в число с плавающей запятой, но преобразованное значение служит только для проверки возможности такого преобразования.</span><span class="sxs-lookup"><span data-stu-id="777c4-1202">For example, the `float` constraint attempts to convert the route value to a float, but the converted value is used only to verify it can be converted to a float.</span></span>

## <a name="regular-expressions"></a><span data-ttu-id="777c4-1203">Регулярные выражения</span><span class="sxs-lookup"><span data-stu-id="777c4-1203">Regular expressions</span></span>

<span data-ttu-id="777c4-1204">В платформе ASP.NET Core в конструктор регулярных выражений добавляются члены `RegexOptions.IgnoreCase | RegexOptions.Compiled | RegexOptions.CultureInvariant`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1204">The ASP.NET Core framework adds `RegexOptions.IgnoreCase | RegexOptions.Compiled | RegexOptions.CultureInvariant` to the regular expression constructor.</span></span> <span data-ttu-id="777c4-1205">Описание этих членов см. в разделе <xref:System.Text.RegularExpressions.RegexOptions>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1205">See <xref:System.Text.RegularExpressions.RegexOptions> for a description of these members.</span></span>

<span data-ttu-id="777c4-1206">В регулярных выражениях применяются разделители и токены, аналогичные используемым функцией маршрутизации и в языке C#.</span><span class="sxs-lookup"><span data-stu-id="777c4-1206">Regular expressions use delimiters and tokens similar to those used by routing and the C# language.</span></span> <span data-ttu-id="777c4-1207">Токены регулярного выражения должны быть экранированы.</span><span class="sxs-lookup"><span data-stu-id="777c4-1207">Regular expression tokens must be escaped.</span></span> <span data-ttu-id="777c4-1208">Чтобы использовать регулярное выражение `^\d{3}-\d{2}-\d{4}$` в маршрутизации:</span><span class="sxs-lookup"><span data-stu-id="777c4-1208">To use the regular expression `^\d{3}-\d{2}-\d{4}$` in routing:</span></span>

* <span data-ttu-id="777c4-1209">Выражение должно содержать символы одинарной обратной косой черты (`\`), представленные в строке с символами двойной обратной косой черты (`\\`) в исходном коде.</span><span class="sxs-lookup"><span data-stu-id="777c4-1209">The expression must have the single backslash `\` characters provided in the string as double backslash `\\` characters in the source code.</span></span>
* <span data-ttu-id="777c4-1210">Регулярное выражение должно использовать `\\` для экранирования строкового escape-символа `\`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1210">The regular expression must us `\\` in order to escape the `\` string escape character.</span></span>
* <span data-ttu-id="777c4-1211">Регулярное выражение не требует `\\` при использовании [буквальных строковых литералов](/dotnet/csharp/language-reference/keywords/string).</span><span class="sxs-lookup"><span data-stu-id="777c4-1211">The regular expression doesn't require `\\` when using [verbatim string literals](/dotnet/csharp/language-reference/keywords/string).</span></span>

<span data-ttu-id="777c4-1212">Чтобы экранировать символы разделения параметров маршрутизации (`{`, `}`, `[`, `]`), используйте их дважды в выражении (`{{`, `}`, `[[`, `]]`).</span><span class="sxs-lookup"><span data-stu-id="777c4-1212">To escape routing parameter delimiter characters `{`, `}`, `[`, `]`, double the characters in the expression `{{`, `}`, `[[`, `]]`.</span></span> <span data-ttu-id="777c4-1213">В следующей таблице показаны регулярные выражения и их экранированные варианты.</span><span class="sxs-lookup"><span data-stu-id="777c4-1213">The following table shows a regular expression and the escaped version:</span></span>

| <span data-ttu-id="777c4-1214">Регулярное выражение</span><span class="sxs-lookup"><span data-stu-id="777c4-1214">Regular Expression</span></span>    | <span data-ttu-id="777c4-1215">Экранированное регулярное выражение</span><span class="sxs-lookup"><span data-stu-id="777c4-1215">Escaped Regular Expression</span></span>     |
| --------------------- | ------------------------------ |
| `^\d{3}-\d{2}-\d{4}$` | `^\\d{{3}}-\\d{{2}}-\\d{{4}}$` |
| `^[a-z]{2}$`          | `^[[a-z]]{{2}}$`               |

<span data-ttu-id="777c4-1216">Регулярные выражения, используемые при маршрутизации, часто начинаются с символа карет (`^`) и соответствуют начальной позиции строки.</span><span class="sxs-lookup"><span data-stu-id="777c4-1216">Regular expressions used in routing often start with the caret `^` character and match starting position of the string.</span></span> <span data-ttu-id="777c4-1217">Выражения часто заканчиваются знаком доллара (`$`) и соответствуют концу строки.</span><span class="sxs-lookup"><span data-stu-id="777c4-1217">The expressions often end with the dollar sign `$` character and match end of the string.</span></span> <span data-ttu-id="777c4-1218">Благодаря символам `^` и `$` регулярное выражение сопоставляется со всем значением параметра маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1218">The `^` and `$` characters ensure that the regular expression match the entire route parameter value.</span></span> <span data-ttu-id="777c4-1219">Если символы `^` и `$` отсутствуют, регулярное выражение сопоставляется с любой подстрокой внутри строки, что обычно нежелательно.</span><span class="sxs-lookup"><span data-stu-id="777c4-1219">Without the `^` and `$` characters, the regular expression match any substring within the string, which is often undesirable.</span></span> <span data-ttu-id="777c4-1220">В следующей таблице представлен ряд примеров и объясняются причины соответствия или несоответствия.</span><span class="sxs-lookup"><span data-stu-id="777c4-1220">The following table provides examples and explains why they match or fail to match.</span></span>

| <span data-ttu-id="777c4-1221">Выражение</span><span class="sxs-lookup"><span data-stu-id="777c4-1221">Expression</span></span>   | <span data-ttu-id="777c4-1222">Строка</span><span class="sxs-lookup"><span data-stu-id="777c4-1222">String</span></span>    | <span data-ttu-id="777c4-1223">Соответствие</span><span class="sxs-lookup"><span data-stu-id="777c4-1223">Match</span></span> | <span data-ttu-id="777c4-1224">Добавление примечаний</span><span class="sxs-lookup"><span data-stu-id="777c4-1224">Comment</span></span>               |
| ------------ | --------- | :---: |  -------------------- |
| `[a-z]{2}`   | <span data-ttu-id="777c4-1225">hello</span><span class="sxs-lookup"><span data-stu-id="777c4-1225">hello</span></span>     | <span data-ttu-id="777c4-1226">Да</span><span class="sxs-lookup"><span data-stu-id="777c4-1226">Yes</span></span>   | <span data-ttu-id="777c4-1227">Соответствие подстроки</span><span class="sxs-lookup"><span data-stu-id="777c4-1227">Substring matches</span></span>     |
| `[a-z]{2}`   | <span data-ttu-id="777c4-1228">123abc456</span><span class="sxs-lookup"><span data-stu-id="777c4-1228">123abc456</span></span> | <span data-ttu-id="777c4-1229">Да</span><span class="sxs-lookup"><span data-stu-id="777c4-1229">Yes</span></span>   | <span data-ttu-id="777c4-1230">Соответствие подстроки</span><span class="sxs-lookup"><span data-stu-id="777c4-1230">Substring matches</span></span>     |
| `[a-z]{2}`   | <span data-ttu-id="777c4-1231">mz</span><span class="sxs-lookup"><span data-stu-id="777c4-1231">mz</span></span>        | <span data-ttu-id="777c4-1232">Да</span><span class="sxs-lookup"><span data-stu-id="777c4-1232">Yes</span></span>   | <span data-ttu-id="777c4-1233">Соответствует выражению</span><span class="sxs-lookup"><span data-stu-id="777c4-1233">Matches expression</span></span>    |
| `[a-z]{2}`   | <span data-ttu-id="777c4-1234">MZ</span><span class="sxs-lookup"><span data-stu-id="777c4-1234">MZ</span></span>        | <span data-ttu-id="777c4-1235">Да</span><span class="sxs-lookup"><span data-stu-id="777c4-1235">Yes</span></span>   | <span data-ttu-id="777c4-1236">Без учета регистра</span><span class="sxs-lookup"><span data-stu-id="777c4-1236">Not case sensitive</span></span>    |
| `^[a-z]{2}$` | <span data-ttu-id="777c4-1237">hello</span><span class="sxs-lookup"><span data-stu-id="777c4-1237">hello</span></span>     | <span data-ttu-id="777c4-1238">Нет</span><span class="sxs-lookup"><span data-stu-id="777c4-1238">No</span></span>    | <span data-ttu-id="777c4-1239">См. замечания, касающиеся символов `^` и `$`, выше</span><span class="sxs-lookup"><span data-stu-id="777c4-1239">See `^` and `$` above</span></span> |
| `^[a-z]{2}$` | <span data-ttu-id="777c4-1240">123abc456</span><span class="sxs-lookup"><span data-stu-id="777c4-1240">123abc456</span></span> | <span data-ttu-id="777c4-1241">Нет</span><span class="sxs-lookup"><span data-stu-id="777c4-1241">No</span></span>    | <span data-ttu-id="777c4-1242">См. замечания, касающиеся символов `^` и `$`, выше</span><span class="sxs-lookup"><span data-stu-id="777c4-1242">See `^` and `$` above</span></span> |

<span data-ttu-id="777c4-1243">Дополнительные сведения о синтаксисе регулярных выражений см. в статье [Регулярные выражения в .NET Framework](/dotnet/standard/base-types/regular-expression-language-quick-reference).</span><span class="sxs-lookup"><span data-stu-id="777c4-1243">For more information on regular expression syntax, see [.NET Framework Regular Expressions](/dotnet/standard/base-types/regular-expression-language-quick-reference).</span></span>

<span data-ttu-id="777c4-1244">Чтобы ограничить возможные значения параметра набором известных значений, используйте регулярное выражение.</span><span class="sxs-lookup"><span data-stu-id="777c4-1244">To constrain a parameter to a known set of possible values, use a regular expression.</span></span> <span data-ttu-id="777c4-1245">Например, при использовании выражения `{action:regex(^(list|get|create)$)}` значение маршрута `action` будет соответствовать только `list`, `get` или `create`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1245">For example, `{action:regex(^(list|get|create)$)}` only matches the `action` route value to `list`, `get`, or `create`.</span></span> <span data-ttu-id="777c4-1246">При передаче в словарь ограничений строка `^(list|get|create)$` будет эквивалентной.</span><span class="sxs-lookup"><span data-stu-id="777c4-1246">If passed into the constraints dictionary, the string `^(list|get|create)$` is equivalent.</span></span> <span data-ttu-id="777c4-1247">Ограничения, которые передаются в словарь ограничений (то есть не являются встроенными ограничениями шаблона) и не соответствуют одному из известных ограничений, также рассматриваются как регулярные выражения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1247">Constraints that are passed in the constraints dictionary (not inline within a template) that don't match one of the known constraints are also treated as regular expressions.</span></span>

## <a name="custom-route-constraints"></a><span data-ttu-id="777c4-1248">Пользовательские ограничения маршрутов</span><span class="sxs-lookup"><span data-stu-id="777c4-1248">Custom route constraints</span></span>

<span data-ttu-id="777c4-1249">Помимо встроенных ограничений маршрутов пользовательские ограничения маршрутов можно создать путем внедрения интерфейса <xref:Microsoft.AspNetCore.Routing.IRouteConstraint>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1249">In addition to the built-in route constraints, custom route constraints can be created by implementing the <xref:Microsoft.AspNetCore.Routing.IRouteConstraint> interface.</span></span> <span data-ttu-id="777c4-1250">Интерфейс <xref:Microsoft.AspNetCore.Routing.IRouteConstraint> содержит один метод, `Match`, который возвращает `true`, если ограничение удовлетворяется, и `false` — если нет.</span><span class="sxs-lookup"><span data-stu-id="777c4-1250">The <xref:Microsoft.AspNetCore.Routing.IRouteConstraint> interface contains a single method, `Match`, which returns `true` if the constraint is satisfied and `false` otherwise.</span></span>

<span data-ttu-id="777c4-1251">Чтобы применить пользовательский метод <xref:Microsoft.AspNetCore.Routing.IRouteConstraint>, тип ограничения маршрута необходимо зарегистрировать с помощью <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap> приложения в контейнере службы приложения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1251">To use a custom <xref:Microsoft.AspNetCore.Routing.IRouteConstraint>, the route constraint type must be registered with the app's <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap> in the app's service container.</span></span> <span data-ttu-id="777c4-1252">Объект <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap> — это словарь, который сопоставляет ключи ограничений пути с реализациями <xref:Microsoft.AspNetCore.Routing.IRouteConstraint>, которые проверяют эти ограничения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1252">A <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap> is a dictionary that maps route constraint keys to <xref:Microsoft.AspNetCore.Routing.IRouteConstraint> implementations that validate those constraints.</span></span> <span data-ttu-id="777c4-1253"><xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap> приложения можно преобразовать в `Startup.ConfigureServices` как часть вызова [services.AddRouting](xref:Microsoft.Extensions.DependencyInjection.RoutingServiceCollectionExtensions.AddRouting*) или путем настройки <xref:Microsoft.AspNetCore.Routing.RouteOptions> непосредственно с помощью `services.Configure<RouteOptions>`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1253">An app's <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap> can be updated in `Startup.ConfigureServices` either as part of a [services.AddRouting](xref:Microsoft.Extensions.DependencyInjection.RoutingServiceCollectionExtensions.AddRouting*) call or by configuring <xref:Microsoft.AspNetCore.Routing.RouteOptions> directly with `services.Configure<RouteOptions>`.</span></span> <span data-ttu-id="777c4-1254">Пример:</span><span class="sxs-lookup"><span data-stu-id="777c4-1254">For example:</span></span>

```csharp
services.AddRouting(options =>
{
    options.ConstraintMap.Add("customName", typeof(MyCustomConstraint));
});
```

<span data-ttu-id="777c4-1255">Ограничения могут применяться к маршрутам обычным способом с использованием имени, указанного при регистрации типа ограничения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1255">The constraint can then be applied to routes in the usual manner, using the name specified when registering the constraint type.</span></span> <span data-ttu-id="777c4-1256">Пример:</span><span class="sxs-lookup"><span data-stu-id="777c4-1256">For example:</span></span>

```csharp
[HttpGet("{id:customName}")]
public ActionResult<string> Get(string id)
```

## <a name="parameter-transformer-reference"></a><span data-ttu-id="777c4-1257">Справочник по преобразователям параметров</span><span class="sxs-lookup"><span data-stu-id="777c4-1257">Parameter transformer reference</span></span>

<span data-ttu-id="777c4-1258">Преобразователи параметров:</span><span class="sxs-lookup"><span data-stu-id="777c4-1258">Parameter transformers:</span></span>

* <span data-ttu-id="777c4-1259">Выполняются при формировании ссылки для <xref:Microsoft.AspNetCore.Routing.Route>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1259">Execute when generating a link for a <xref:Microsoft.AspNetCore.Routing.Route>.</span></span>
* <span data-ttu-id="777c4-1260">Реализуйте расширение `Microsoft.AspNetCore.Routing.IOutboundParameterTransformer`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1260">Implement `Microsoft.AspNetCore.Routing.IOutboundParameterTransformer`.</span></span>
* <span data-ttu-id="777c4-1261">Настраиваются с помощью <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1261">Are configured using <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap>.</span></span>
* <span data-ttu-id="777c4-1262">Принимают значение маршрута параметра и изменяют его на новое строковое значение.</span><span class="sxs-lookup"><span data-stu-id="777c4-1262">Take the parameter's route value and transform it to a new string value.</span></span>
* <span data-ttu-id="777c4-1263">Приводят к использованию преобразованного значения в сформированной ссылке.</span><span class="sxs-lookup"><span data-stu-id="777c4-1263">Result in using the transformed value in the generated link.</span></span>

<span data-ttu-id="777c4-1264">Например, пользовательский преобразователь параметра `slugify` в шаблоне маршрута `blog\{article:slugify}` с `Url.Action(new { article = "MyTestArticle" })` формирует значение `blog\my-test-article`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1264">For example, a custom `slugify` parameter transformer in route pattern `blog\{article:slugify}` with `Url.Action(new { article = "MyTestArticle" })` generates `blog\my-test-article`.</span></span>

<span data-ttu-id="777c4-1265">Чтобы использовать преобразователь параметров в шаблоне маршрута, сначала настройте его с помощью <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap> в `Startup.ConfigureServices`:</span><span class="sxs-lookup"><span data-stu-id="777c4-1265">To use a parameter transformer in a route pattern, configure it first using <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap> in `Startup.ConfigureServices`:</span></span>

```csharp
services.AddRouting(options =>
{
    // Replace the type and the name used to refer to it with your own
    // IOutboundParameterTransformer implementation
    options.ConstraintMap["slugify"] = typeof(SlugifyParameterTransformer);
});
```

<span data-ttu-id="777c4-1266">Преобразователи параметров также используются платформами для преобразования URI, где разрешается конечная точка.</span><span class="sxs-lookup"><span data-stu-id="777c4-1266">Parameter transformers are used by the framework to transform the URI where an endpoint resolves.</span></span> <span data-ttu-id="777c4-1267">Например, ASP.NET Core MVC с помощью преобразователей параметров преобразует значение маршрута, используемое для сопоставления `area`, `controller`, `action` и `page`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1267">For example, ASP.NET Core MVC uses parameter transformers to transform the route value used to match an `area`, `controller`, `action`, and `page`.</span></span>

```csharp
routes.MapRoute(
    name: "default",
    template: "{controller:slugify=Home}/{action:slugify=Index}/{id?}");
```

<span data-ttu-id="777c4-1268">С помощью предыдущего маршрута действие `SubscriptionManagementController.GetAll` сопоставляется с URI `/subscription-management/get-all`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1268">With the preceding route, the action `SubscriptionManagementController.GetAll` is matched with the URI `/subscription-management/get-all`.</span></span> <span data-ttu-id="777c4-1269">Преобразователь параметра не изменяет значения маршрута, используемые для формирования ссылки.</span><span class="sxs-lookup"><span data-stu-id="777c4-1269">A parameter transformer doesn't change the route values used to generate a link.</span></span> <span data-ttu-id="777c4-1270">Например, `Url.Action("GetAll", "SubscriptionManagement")` выводит `/subscription-management/get-all`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1270">For example, `Url.Action("GetAll", "SubscriptionManagement")` outputs `/subscription-management/get-all`.</span></span>

<span data-ttu-id="777c4-1271">ASP.NET Core предоставляет соглашения об API для использования преобразователей параметров со сформированными маршрутами:</span><span class="sxs-lookup"><span data-stu-id="777c4-1271">ASP.NET Core provides API conventions for using a parameter transformers with generated routes:</span></span>

* <span data-ttu-id="777c4-1272">ASP.NET Core MVC поддерживает соглашение об API `Microsoft.AspNetCore.Mvc.ApplicationModels.RouteTokenTransformerConvention`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1272">ASP.NET Core MVC has the `Microsoft.AspNetCore.Mvc.ApplicationModels.RouteTokenTransformerConvention` API convention.</span></span> <span data-ttu-id="777c4-1273">Это соглашение применяет указанный преобразователь параметров ко всем маршрутам атрибутов в приложении.</span><span class="sxs-lookup"><span data-stu-id="777c4-1273">This convention applies a specified parameter transformer to all attribute routes in the app.</span></span> <span data-ttu-id="777c4-1274">Преобразователь параметров преобразует маркеры маршрутов атрибутов по мере их замены.</span><span class="sxs-lookup"><span data-stu-id="777c4-1274">The parameter transformer transforms attribute route tokens as they are replaced.</span></span> <span data-ttu-id="777c4-1275">Дополнительные сведения см. в разделе об [использовании преобразователя параметров для настройки замены маркеров](xref:mvc/controllers/routing#use-a-parameter-transformer-to-customize-token-replacement).</span><span class="sxs-lookup"><span data-stu-id="777c4-1275">For more information, see [Use a parameter transformer to customize token replacement](xref:mvc/controllers/routing#use-a-parameter-transformer-to-customize-token-replacement).</span></span>
* <span data-ttu-id="777c4-1276">Razor Pages поддерживает соглашение об API `Microsoft.AspNetCore.Mvc.ApplicationModels.PageRouteTransformerConvention`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1276">Razor Pages has the `Microsoft.AspNetCore.Mvc.ApplicationModels.PageRouteTransformerConvention` API convention.</span></span> <span data-ttu-id="777c4-1277">Это соглашение применяет указанный преобразователь параметров ко всем автоматически обнаруженным страницам Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="777c4-1277">This convention applies a specified parameter transformer to all automatically discovered Razor Pages.</span></span> <span data-ttu-id="777c4-1278">Преобразователь параметров преобразует сегменты папок и имен файлов маршрутов Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="777c4-1278">The parameter transformer transforms the folder and file name segments of Razor Pages routes.</span></span> <span data-ttu-id="777c4-1279">Дополнительные сведения см. в разделе об [использовании преобразователя параметров для настройки маршрутов страниц](xref:razor-pages/razor-pages-conventions#use-a-parameter-transformer-to-customize-page-routes).</span><span class="sxs-lookup"><span data-stu-id="777c4-1279">For more information, see [Use a parameter transformer to customize page routes](xref:razor-pages/razor-pages-conventions#use-a-parameter-transformer-to-customize-page-routes).</span></span>

## <a name="url-generation-reference"></a><span data-ttu-id="777c4-1280">Справочник по формированию URL-адресов</span><span class="sxs-lookup"><span data-stu-id="777c4-1280">URL generation reference</span></span>

<span data-ttu-id="777c4-1281">В приведенном ниже примере показано, как создать ссылку на маршрут с использованием словаря значений маршрута и коллекции <xref:Microsoft.AspNetCore.Routing.RouteCollection>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1281">The following example shows how to generate a link to a route given a dictionary of route values and a <xref:Microsoft.AspNetCore.Routing.RouteCollection>.</span></span>

[!code-csharp[](routing/samples/2.x/RoutingSample/Startup.cs?name=snippet_Dictionary)]

<span data-ttu-id="777c4-1282">В результате приведенного выше примера создается <xref:Microsoft.AspNetCore.Routing.VirtualPathData.VirtualPath> со значением `/package/create/123`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1282">The <xref:Microsoft.AspNetCore.Routing.VirtualPathData.VirtualPath> generated at the end of the preceding sample is `/package/create/123`.</span></span> <span data-ttu-id="777c4-1283">Словарь предоставляет значения маршрута `operation` и `id` шаблона "Отслеживание маршрута пакета", `package/{operation}/{id}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1283">The dictionary supplies the `operation` and `id` route values of the "Track Package Route" template, `package/{operation}/{id}`.</span></span> <span data-ttu-id="777c4-1284">Дополнительные сведения см. в примере кода в разделе [Использование ПО промежуточного слоя маршрутизации](#use-routing-middleware) или в [примере приложения](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/fundamentals/routing/samples).</span><span class="sxs-lookup"><span data-stu-id="777c4-1284">For details, see the sample code in the [Use Routing Middleware](#use-routing-middleware) section or the [sample app](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/fundamentals/routing/samples).</span></span>

<span data-ttu-id="777c4-1285">Второй параметр конструктора <xref:Microsoft.AspNetCore.Routing.VirtualPathContext> — это коллекция *значений окружения*.</span><span class="sxs-lookup"><span data-stu-id="777c4-1285">The second parameter to the <xref:Microsoft.AspNetCore.Routing.VirtualPathContext> constructor is a collection of *ambient values*.</span></span> <span data-ttu-id="777c4-1286">Значения окружения упрощают разработку, ограничивая число значений, которые необходимо указывать в определенном контексте запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1286">Ambient values are convenient to use because they limit the number of values a developer must specify within a request context.</span></span> <span data-ttu-id="777c4-1287">Текущие значения маршрута текущего запроса считаются значениями окружения для создания ссылки.</span><span class="sxs-lookup"><span data-stu-id="777c4-1287">The current route values of the current request are considered ambient values for link generation.</span></span> <span data-ttu-id="777c4-1288">В приложении ASP.NET MVC в действии `About` контроллера `HomeController` не нужно задавать значение маршрута контроллера, указывающее на действие `Index`&mdash; используется значение окружения `Home`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1288">In an ASP.NET Core MVC app's `About` action of the `HomeController`, you don't need to specify the controller route value to link to the `Index` action&mdash;the ambient value of `Home` is used.</span></span>

<span data-ttu-id="777c4-1289">Значения окружения, которые не соответствуют параметру, игнорируются.</span><span class="sxs-lookup"><span data-stu-id="777c4-1289">Ambient values that don't match a parameter are ignored.</span></span> <span data-ttu-id="777c4-1290">Значения окружения также не учитываются, когда явно указанное значение переопределяет значение окружения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1290">Ambient values are also ignored when an explicitly provided value overrides the ambient value.</span></span> <span data-ttu-id="777c4-1291">Сопоставление выполняется слева направо в URL-адресе.</span><span class="sxs-lookup"><span data-stu-id="777c4-1291">Matching occurs from left to right in the URL.</span></span>

<span data-ttu-id="777c4-1292">Явно предоставленные значения, которые не соответствуют сегменту маршрута, добавляются в строку запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1292">Values explicitly provided but that don't match a segment of the route are added to the query string.</span></span> <span data-ttu-id="777c4-1293">В приведенной ниже таблице показан результат использования шаблона маршрута `{controller}/{action}/{id?}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1293">The following table shows the result when using the route template `{controller}/{action}/{id?}`.</span></span>

| <span data-ttu-id="777c4-1294">Значения окружения</span><span class="sxs-lookup"><span data-stu-id="777c4-1294">Ambient Values</span></span>                     | <span data-ttu-id="777c4-1295">Явные значения</span><span class="sxs-lookup"><span data-stu-id="777c4-1295">Explicit Values</span></span>                        | <span data-ttu-id="777c4-1296">Результат</span><span class="sxs-lookup"><span data-stu-id="777c4-1296">Result</span></span>                  |
| ---------------------------------- | -------------------------------------- | ----------------------- |
| <span data-ttu-id="777c4-1297">controller = "Home"</span><span class="sxs-lookup"><span data-stu-id="777c4-1297">controller = "Home"</span></span>                | <span data-ttu-id="777c4-1298">action = "About"</span><span class="sxs-lookup"><span data-stu-id="777c4-1298">action = "About"</span></span>                       | `/Home/About`           |
| <span data-ttu-id="777c4-1299">controller = "Home"</span><span class="sxs-lookup"><span data-stu-id="777c4-1299">controller = "Home"</span></span>                | <span data-ttu-id="777c4-1300">controller = "Order", action = "About"</span><span class="sxs-lookup"><span data-stu-id="777c4-1300">controller = "Order", action = "About"</span></span> | `/Order/About`          |
| <span data-ttu-id="777c4-1301">controller = "Home", color = "Red"</span><span class="sxs-lookup"><span data-stu-id="777c4-1301">controller = "Home", color = "Red"</span></span> | <span data-ttu-id="777c4-1302">action = "About"</span><span class="sxs-lookup"><span data-stu-id="777c4-1302">action = "About"</span></span>                       | `/Home/About`           |
| <span data-ttu-id="777c4-1303">controller = "Home"</span><span class="sxs-lookup"><span data-stu-id="777c4-1303">controller = "Home"</span></span>                | <span data-ttu-id="777c4-1304">action = "About", color = "Red"</span><span class="sxs-lookup"><span data-stu-id="777c4-1304">action = "About", color = "Red"</span></span>        | `/Home/About?color=Red` |

<span data-ttu-id="777c4-1305">Если маршрут имеет значение по умолчанию, которое не соответствует параметру, и это значение предоставлено явным образом, оно должно соответствовать значению по умолчанию:</span><span class="sxs-lookup"><span data-stu-id="777c4-1305">If a route has a default value that doesn't correspond to a parameter and that value is explicitly provided, it must match the default value:</span></span>

```csharp
routes.MapRoute("blog_route", "blog/{*slug}",
    defaults: new { controller = "Blog", action = "ReadPost" });
```

<span data-ttu-id="777c4-1306">Для этого маршрута ссылка будет создана только в том случае, если предоставлены соответствующие значения для `controller` и `action`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1306">Link generation only generates a link for this route when the matching values for `controller` and `action` are provided.</span></span>

## <a name="complex-segments"></a><span data-ttu-id="777c4-1307">Сложные сегменты</span><span class="sxs-lookup"><span data-stu-id="777c4-1307">Complex segments</span></span>

<span data-ttu-id="777c4-1308">Сложные сегменты (например, `[Route("/x{token}y")]`) обрабатываются путем "нежадного" сопоставления литералов справа налево.</span><span class="sxs-lookup"><span data-stu-id="777c4-1308">Complex segments (for example `[Route("/x{token}y")]`) are processed by matching up literals from right to left in a non-greedy way.</span></span> <span data-ttu-id="777c4-1309">Подробные сведения о сопоставлении сложных сегментов см. в [этом коде](https://github.com/dotnet/aspnetcore/blob/v2.2.13/src/Http/Routing/src/Patterns/RoutePatternMatcher.cs#L293).</span><span class="sxs-lookup"><span data-stu-id="777c4-1309">See [this code](https://github.com/dotnet/aspnetcore/blob/v2.2.13/src/Http/Routing/src/Patterns/RoutePatternMatcher.cs#L293) for a detailed explanation of how complex segments are matched.</span></span> <span data-ttu-id="777c4-1310">[Пример кода](https://github.com/dotnet/aspnetcore/blob/v2.2.13/src/Http/Routing/src/Patterns/RoutePatternMatcher.cs#L293) не используется в ASP.NET Core, но он предоставляет подробное объяснение сложных сегментов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1310">The [code sample](https://github.com/dotnet/aspnetcore/blob/v2.2.13/src/Http/Routing/src/Patterns/RoutePatternMatcher.cs#L293) is not used by ASP.NET Core, but it provides a good explanation of complex segments.</span></span>
<!-- While that code is no longer used by ASP.NET Core for complex segment matching, it provides a good match to the current algorithm. The [current code](https://github.com/dotnet/AspNetCore/blob/91514c9af7e0f4c44029b51f05a01c6fe4c96e4c/src/Http/Routing/src/Matching/DfaMatcherBuilder.cs#L227-L244) is too abstracted from matching to be useful for understanding complex segment matching.
-->

::: moniker-end

::: moniker range="< aspnetcore-2.2"

<span data-ttu-id="777c4-1311">Маршрутизация отвечает за сопоставление URI запросов с обработчиками маршрутов и отправку входящих запросов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1311">Routing is responsible for mapping request URIs to route handlers and dispatching an incoming requests.</span></span> <span data-ttu-id="777c4-1312">Маршруты определяются в приложении и настраиваются при его запуске.</span><span class="sxs-lookup"><span data-stu-id="777c4-1312">Routes are defined in the app and configured when the app starts.</span></span> <span data-ttu-id="777c4-1313">Маршрут может также извлекать значения из содержащегося в запросе URL-адреса, которые затем используются для обработки запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1313">A route can optionally extract values from the URL contained in the request, and these values can then be used for request processing.</span></span> <span data-ttu-id="777c4-1314">С помощью настроенных маршрутов из приложения маршрутизация создает URL-адреса, которые сопоставляются с обработчиками маршрутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1314">Using configured routes from the app, routing is able to generate URLs that map to route handlers.</span></span>

<span data-ttu-id="777c4-1315">Чтобы использовать новейшие сценарии маршрутизации в ASP.NET Core 2.1, укажите [совместимую версию](xref:mvc/compatibility-version) для регистрации служб MVC в `Startup.ConfigureServices`:</span><span class="sxs-lookup"><span data-stu-id="777c4-1315">To use the latest routing scenarios in ASP.NET Core 2.1, specify the [compatibility version](xref:mvc/compatibility-version) to the MVC services registration in `Startup.ConfigureServices`:</span></span>

```csharp
services.AddMvc()
    .SetCompatibilityVersion(CompatibilityVersion.Version_2_1);
```

> [!IMPORTANT]
> <span data-ttu-id="777c4-1316">В этом документе рассматривается низкоуровневая маршрутизация ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="777c4-1316">This document covers low-level ASP.NET Core routing.</span></span> <span data-ttu-id="777c4-1317">Сведения о маршрутизации ASP.NET Core MVC см. в разделе <xref:mvc/controllers/routing>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1317">For information on ASP.NET Core MVC routing, see <xref:mvc/controllers/routing>.</span></span> <span data-ttu-id="777c4-1318">Сведения о соглашениях о маршрутизации в Razor Pages см. в разделе <xref:razor-pages/razor-pages-conventions>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1318">For information on routing conventions in Razor Pages, see <xref:razor-pages/razor-pages-conventions>.</span></span>

<span data-ttu-id="777c4-1319">[Просмотреть или скачать образец кода](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/fundamentals/routing/samples) ([как скачивать](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="777c4-1319">[View or download sample code](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/fundamentals/routing/samples) ([how to download](xref:index#how-to-download-a-sample))</span></span>

## <a name="routing-basics"></a><span data-ttu-id="777c4-1320">Основы маршрутизации</span><span class="sxs-lookup"><span data-stu-id="777c4-1320">Routing basics</span></span>

<span data-ttu-id="777c4-1321">Для большинства приложений следует выбрать базовую описательную схему маршрутизации таким образом, чтобы URL-адреса были удобочитаемыми и осмысленными.</span><span class="sxs-lookup"><span data-stu-id="777c4-1321">Most apps should choose a basic and descriptive routing scheme so that URLs are readable and meaningful.</span></span> <span data-ttu-id="777c4-1322">Традиционный маршрут по умолчанию `{controller=Home}/{action=Index}/{id?}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1322">The default conventional route `{controller=Home}/{action=Index}/{id?}`:</span></span>

* <span data-ttu-id="777c4-1323">Поддерживает основную и описательную схемы маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-1323">Supports a basic and descriptive routing scheme.</span></span>
* <span data-ttu-id="777c4-1324">Является отправной точкой для приложений на базе пользовательского интерфейса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1324">Is a useful starting point for UI-based apps.</span></span>

<span data-ttu-id="777c4-1325">Как правило, в зонах приложения с высоким трафиком и в особых случаях (например, конечные точки блога, интернет-магазина) добавляются дополнительные краткие маршруты с использованием [маршрутизации с помощью атрибутов](xref:mvc/controllers/routing#attribute-routing) или выделенные традиционные маршруты.</span><span class="sxs-lookup"><span data-stu-id="777c4-1325">Developers commonly add additional terse routes to high-traffic areas of an app in specialized situations (for example, blog and ecommerce endpoints) using [attribute routing](xref:mvc/controllers/routing#attribute-routing) or dedicated conventional routes.</span></span>

<span data-ttu-id="777c4-1326">Веб-интерфейсы API должны использовать маршрутизацию с помощью атрибутов, чтобы моделировать функциональность приложения в качестве набора ресурсов, где операции представлены с помощью команд HTTP.</span><span class="sxs-lookup"><span data-stu-id="777c4-1326">Web APIs should use attribute routing to model the app's functionality as a set of resources where operations are represented by HTTP verbs.</span></span> <span data-ttu-id="777c4-1327">Это означает, что многие операции (например, GET, POST) на одном логическом ресурсе будут использовать одинаковый URL-адрес.</span><span class="sxs-lookup"><span data-stu-id="777c4-1327">This means that many operations (for example, GET, POST) on the same logical resource will use the same URL.</span></span> <span data-ttu-id="777c4-1328">Маршрутизация с помощью атрибутов обеспечивает необходимый уровень контроля, позволяющий тщательно разработать схему общедоступных конечных точек API-интерфейса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1328">Attribute routing provides a level of control that's needed to carefully design an API's public endpoint layout.</span></span>

<span data-ttu-id="777c4-1329">Приложения Razor Pages используют стандартную маршрутизацию по умолчанию для предоставления именованных ресурсов в папке *Pages* приложения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1329">Razor Pages apps use default conventional routing to serve named resources in the *Pages* folder of an app.</span></span> <span data-ttu-id="777c4-1330">Доступны дополнительные соглашения, которые позволяют настроить поведение маршрутизации Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="777c4-1330">Additional conventions are available that allow you to customize Razor Pages routing behavior.</span></span> <span data-ttu-id="777c4-1331">Дополнительные сведения см. в разделах <xref:razor-pages/index> и <xref:razor-pages/razor-pages-conventions>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1331">For more information, see <xref:razor-pages/index> and <xref:razor-pages/razor-pages-conventions>.</span></span>

<span data-ttu-id="777c4-1332">Благодаря поддержке создания URL-адресов приложение можно разрабатывать без жесткого программирования URL-адресов для связывания компонентов приложения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1332">URL generation support allows the app to be developed without hard-coding URLs to link the app together.</span></span> <span data-ttu-id="777c4-1333">Это обеспечивает начало работы с основной конфигурацией маршрутизации и изменение маршрутов после определения схемы ресурсов приложения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1333">This support allows for starting with a basic routing configuration and modifying the routes after the app's resource layout is determined.</span></span>

<span data-ttu-id="777c4-1334">Маршрутизация использует маршруты (реализации интерфейса <xref:Microsoft.AspNetCore.Routing.IRouter>) в следующих целях:</span><span class="sxs-lookup"><span data-stu-id="777c4-1334">Routing uses routes implementations of <xref:Microsoft.AspNetCore.Routing.IRouter> to:</span></span>

* <span data-ttu-id="777c4-1335">для сопоставления входящих запросов с *обработчиками маршрутов*;</span><span class="sxs-lookup"><span data-stu-id="777c4-1335">Map incoming requests to *route handlers*.</span></span>
* <span data-ttu-id="777c4-1336">для создания URL-адресов, используемых в ответах.</span><span class="sxs-lookup"><span data-stu-id="777c4-1336">Generate the URLs used in responses.</span></span>

<span data-ttu-id="777c4-1337">По умолчанию приложение имеет одну коллекцию маршрутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1337">By default, an app has a single collection of routes.</span></span> <span data-ttu-id="777c4-1338">Когда запрос прибывает, маршруты в коллекции обрабатываются в порядке, в котором они существуют в коллекции.</span><span class="sxs-lookup"><span data-stu-id="777c4-1338">When a request arrives, the routes in the collection are processed in the order that they exist in the collection.</span></span> <span data-ttu-id="777c4-1339">Платформа пытается сопоставить URL-адрес входящего запроса с маршрутом в коллекции, вызывая метод <xref:Microsoft.AspNetCore.Routing.IRouter.RouteAsync*> для каждого маршрута в коллекции.</span><span class="sxs-lookup"><span data-stu-id="777c4-1339">The framework attempts to match an incoming request URL to a route in the collection by calling the <xref:Microsoft.AspNetCore.Routing.IRouter.RouteAsync*> method on each route in the collection.</span></span> <span data-ttu-id="777c4-1340">Отклик может использовать маршрутизацию для формирования URL-адресов (например, для перенаправления или ссылок) на основе сведений о маршруте, что позволяет избежать жесткого задания URL-адресов и упрощает поддержку.</span><span class="sxs-lookup"><span data-stu-id="777c4-1340">A response can use routing to generate URLs (for example, for redirection or links) based on route information and thus avoid hard-coded URLs, which helps maintainability.</span></span>

<span data-ttu-id="777c4-1341">Система маршрутизации обладает следующими характеристиками:</span><span class="sxs-lookup"><span data-stu-id="777c4-1341">The routing system has the following characteristics:</span></span>

* <span data-ttu-id="777c4-1342">Синтаксис шаблона маршрута используется для определения маршрутов с помощью параметров размеченного маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1342">Route template syntax is used to define routes with tokenized route parameters.</span></span>
* <span data-ttu-id="777c4-1343">Допускается конфигурация конечной точки в стандартном стиле и с атрибутами.</span><span class="sxs-lookup"><span data-stu-id="777c4-1343">Conventional-style and attribute-style endpoint configuration is permitted.</span></span>
* <span data-ttu-id="777c4-1344"><xref:Microsoft.AspNetCore.Routing.IRouteConstraint> используется для определения того, содержит ли параметр URL-адреса допустимое значение для ограничения заданной конечной точки.</span><span class="sxs-lookup"><span data-stu-id="777c4-1344"><xref:Microsoft.AspNetCore.Routing.IRouteConstraint> is used to determine whether a URL parameter contains a valid value for a given endpoint constraint.</span></span>
* <span data-ttu-id="777c4-1345">Модели приложения, такие как MVC и Razor Pages, регистрируют все свои маршруты, имеющие предсказуемую реализацию сценариев маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-1345">App models, such as MVC/Razor Pages, register all of their routes, which have a predictable implementation of routing scenarios.</span></span>
* <span data-ttu-id="777c4-1346">Отклик может использовать маршрутизацию для формирования URL-адресов (например, для перенаправления или ссылок) на основе сведений о маршруте, что позволяет избежать жесткого задания URL-адресов и упрощает поддержку.</span><span class="sxs-lookup"><span data-stu-id="777c4-1346">A response can use routing to generate URLs (for example, for redirection or links) based on route information and thus avoid hard-coded URLs, which helps maintainability.</span></span>
* <span data-ttu-id="777c4-1347">Формирование URL-адреса основано на маршрутах, которые поддерживают произвольную расширяемость.</span><span class="sxs-lookup"><span data-stu-id="777c4-1347">URL generation is based on routes, which support arbitrary extensibility.</span></span> <span data-ttu-id="777c4-1348"><xref:Microsoft.AspNetCore.Mvc.IUrlHelper> предоставляет методы для создания URL-адресов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1348"><xref:Microsoft.AspNetCore.Mvc.IUrlHelper> offers methods to build URLs.</span></span>
<!-- fix [middleware](xref:fundamentals/middleware/index) -->
<span data-ttu-id="777c4-1349">Функция маршрутизации подключается к конвейеру [ПО промежуточного слоя](xref:fundamentals/middleware/index) с помощью класса <xref:Microsoft.AspNetCore.Builder.RouterMiddleware>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1349">Routing is connected to the [middleware](xref:fundamentals/middleware/index) pipeline by the <xref:Microsoft.AspNetCore.Builder.RouterMiddleware> class.</span></span> <span data-ttu-id="777c4-1350">[ASP.NET Core MVC](xref:mvc/overview) добавляет функцию маршрутизации в конвейер ПО промежуточного слоя в процессе настройки и обрабатывает маршрутизацию в приложениях MVC и Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="777c4-1350">[ASP.NET Core MVC](xref:mvc/overview) adds routing to the middleware pipeline as part of its configuration and handles routing in MVC and Razor Pages apps.</span></span> <span data-ttu-id="777c4-1351">Сведения об использовании маршрутизации в виде отдельного компонента см. в руководстве по [использованию ПО промежуточного слоя маршрутизации](#use-routing-middleware).</span><span class="sxs-lookup"><span data-stu-id="777c4-1351">To learn how to use routing as a standalone component, see the [Use Routing Middleware](#use-routing-middleware) section.</span></span>

### <a name="url-matching"></a><span data-ttu-id="777c4-1352">Соответствие URL-адресов</span><span class="sxs-lookup"><span data-stu-id="777c4-1352">URL matching</span></span>

<span data-ttu-id="777c4-1353">Соответствие URL-адресов — это процесс, с помощью которого функция маршрутизации отправляет входящий запрос в *обработчик*.</span><span class="sxs-lookup"><span data-stu-id="777c4-1353">URL matching is the process by which routing dispatches an incoming request to a *handler*.</span></span> <span data-ttu-id="777c4-1354">Этот процесс основывается на данных в пути URL-адреса, но может быть расширен для учета любых данных в запросе.</span><span class="sxs-lookup"><span data-stu-id="777c4-1354">This process is based on data in the URL path but can be extended to consider any data in the request.</span></span> <span data-ttu-id="777c4-1355">Возможность отправки запросов в отдельные обработчики имеет первостепенное значение для масштабирования размера и сложности приложения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1355">The ability to dispatch requests to separate handlers is key to scaling the size and complexity of an app.</span></span>

<span data-ttu-id="777c4-1356">Входящие запросы поступают в объект <xref:Microsoft.AspNetCore.Builder.RouterMiddleware>, который вызывает метод <xref:Microsoft.AspNetCore.Routing.IRouter.RouteAsync*> для каждого маршрута по порядку.</span><span class="sxs-lookup"><span data-stu-id="777c4-1356">Incoming requests enter the <xref:Microsoft.AspNetCore.Builder.RouterMiddleware>, which calls the <xref:Microsoft.AspNetCore.Routing.IRouter.RouteAsync*> method on each route in sequence.</span></span> <span data-ttu-id="777c4-1357">Экземпляр <xref:Microsoft.AspNetCore.Routing.IRouter> решает, следует ли *обрабатывать* запрос, присваивая свойству [RouteContext.Handler](xref:Microsoft.AspNetCore.Routing.RouteContext.Handler*) значение <xref:Microsoft.AspNetCore.Http.RequestDelegate>, отличное от NULL.</span><span class="sxs-lookup"><span data-stu-id="777c4-1357">The <xref:Microsoft.AspNetCore.Routing.IRouter> instance chooses whether to *handle* the request by setting the [RouteContext.Handler](xref:Microsoft.AspNetCore.Routing.RouteContext.Handler*) to a non-null <xref:Microsoft.AspNetCore.Http.RequestDelegate>.</span></span> <span data-ttu-id="777c4-1358">Если маршрут задает обработчик для запроса, обработка маршрутов останавливается и обработчик вызывается для обработки запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1358">If a route sets a handler for the request, route processing stops, and the handler is invoked to process the request.</span></span> <span data-ttu-id="777c4-1359">Если обработчик маршрута для обработки запроса не найден, ПО промежуточного слоя передает запрос следующему ПО промежуточного слоя в конвейере запросов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1359">If no route handler is found to process the request, the middleware hands the request off to the next middleware in the request pipeline.</span></span>

<span data-ttu-id="777c4-1360">Основные входные данные метода <xref:Microsoft.AspNetCore.Routing.IRouter.RouteAsync*> — это объект [RouteContext.HttpContext](xref:Microsoft.AspNetCore.Routing.RouteContext.HttpContext*), связанный с текущим запросом.</span><span class="sxs-lookup"><span data-stu-id="777c4-1360">The primary input to <xref:Microsoft.AspNetCore.Routing.IRouter.RouteAsync*> is the [RouteContext.HttpContext](xref:Microsoft.AspNetCore.Routing.RouteContext.HttpContext*) associated with the current request.</span></span> <span data-ttu-id="777c4-1361">[RouteContext.Handler](xref:Microsoft.AspNetCore.Routing.RouteContext.Handler) и [RouteContext.RouteData](xref:Microsoft.AspNetCore.Routing.RouteContext.RouteData*) — это выходные значения, заданные после нахождения соответствующего маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1361">The [RouteContext.Handler](xref:Microsoft.AspNetCore.Routing.RouteContext.Handler) and [RouteContext.RouteData](xref:Microsoft.AspNetCore.Routing.RouteContext.RouteData*) are outputs set after a route is matched.</span></span>

<span data-ttu-id="777c4-1362">При нахождении соответствия, которое вызывает <xref:Microsoft.AspNetCore.Routing.IRouter.RouteAsync*>, свойствам [RouteContext.RouteData](xref:Microsoft.AspNetCore.Routing.RouteContext.RouteData) также присваиваются значения с учетом уже выполненной на текущий момент обработки.</span><span class="sxs-lookup"><span data-stu-id="777c4-1362">A match that calls <xref:Microsoft.AspNetCore.Routing.IRouter.RouteAsync*> also sets the properties of the [RouteContext.RouteData](xref:Microsoft.AspNetCore.Routing.RouteContext.RouteData) to appropriate values based on the request processing performed thus far.</span></span>

<span data-ttu-id="777c4-1363">[RouteData.Values](xref:Microsoft.AspNetCore.Routing.RouteData.Values*) — это словарь *значений маршрута*, полученных из маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1363">[RouteData.Values](xref:Microsoft.AspNetCore.Routing.RouteData.Values*) is a dictionary of *route values* produced from the route.</span></span> <span data-ttu-id="777c4-1364">Как правило, эти значения определяются путем разбивки URL-адреса на сегменты и могут использоваться для принятия входных данных пользователя или принятия дальнейших решений об отправке в приложении.</span><span class="sxs-lookup"><span data-stu-id="777c4-1364">These values are usually determined by tokenizing the URL and can be used to accept user input or to make further dispatching decisions inside the app.</span></span>

<span data-ttu-id="777c4-1365">[RouteData.DataTokens](xref:Microsoft.AspNetCore.Routing.RouteData.DataTokens*) — это контейнер свойств с дополнительными данными, связанными с соответствующим маршрутом.</span><span class="sxs-lookup"><span data-stu-id="777c4-1365">[RouteData.DataTokens](xref:Microsoft.AspNetCore.Routing.RouteData.DataTokens*) is a property bag of additional data related to the matched route.</span></span> <span data-ttu-id="777c4-1366">Свойства <xref:Microsoft.AspNetCore.Routing.RouteData.DataTokens*> обеспечивают связывание данных состояния с каждым маршрутом, что позволяет приложению принимать решения в зависимости от соответствующего маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1366"><xref:Microsoft.AspNetCore.Routing.RouteData.DataTokens*> are provided to support associating state data with each route so that the app can make decisions based on which route matched.</span></span> <span data-ttu-id="777c4-1367">Эти значения определяются разработчиком и никоим образом **не** влияют на поведение маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-1367">These values are developer-defined and do **not** affect the behavior of routing in any way.</span></span> <span data-ttu-id="777c4-1368">Кроме того, значения, спрятанные в токенах [RouteData.DataToken](xref:Microsoft.AspNetCore.Routing.RouteData.DataTokens*), могут быть любого типа в отличие от значений [RouteData.Value](xref:Microsoft.AspNetCore.Routing.RouteData.Values), которые должны легко преобразовываться в строки и из строк.</span><span class="sxs-lookup"><span data-stu-id="777c4-1368">Additionally, values stashed in [RouteData.DataTokens](xref:Microsoft.AspNetCore.Routing.RouteData.DataTokens*) can be of any type, in contrast to [RouteData.Values](xref:Microsoft.AspNetCore.Routing.RouteData.Values), which must be convertible to and from strings.</span></span>

<span data-ttu-id="777c4-1369">[RouteData.Routers](xref:Microsoft.AspNetCore.Routing.RouteData.Routers) — это список маршрутов, которые участвовали в успешном сопоставлении с запросом.</span><span class="sxs-lookup"><span data-stu-id="777c4-1369">[RouteData.Routers](xref:Microsoft.AspNetCore.Routing.RouteData.Routers) is a list of the routes that took part in successfully matching the request.</span></span> <span data-ttu-id="777c4-1370">Маршруты могут быть вложены друг в друга.</span><span class="sxs-lookup"><span data-stu-id="777c4-1370">Routes can be nested inside of one another.</span></span> <span data-ttu-id="777c4-1371">Свойство <xref:Microsoft.AspNetCore.Routing.RouteData.Routers> отражает путь по логическому дереву маршрутов, который привел к совпадению.</span><span class="sxs-lookup"><span data-stu-id="777c4-1371">The <xref:Microsoft.AspNetCore.Routing.RouteData.Routers> property reflects the path through the logical tree of routes that resulted in a match.</span></span> <span data-ttu-id="777c4-1372">Как правило, первый элемент в свойстве <xref:Microsoft.AspNetCore.Routing.RouteData.Routers> — это коллекция маршрутов, используемая для формирования URL-адресов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1372">Generally, the first item in <xref:Microsoft.AspNetCore.Routing.RouteData.Routers> is the route collection and should be used for URL generation.</span></span> <span data-ttu-id="777c4-1373">Последний элемент в свойстве <xref:Microsoft.AspNetCore.Routing.RouteData.Routers> — это соответствующий обработчик маршрутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1373">The last item in <xref:Microsoft.AspNetCore.Routing.RouteData.Routers> is the route handler that matched.</span></span>

<a name="lg"></a>

### <a name="url-generation"></a><span data-ttu-id="777c4-1374">Формирование URL-адреса</span><span class="sxs-lookup"><span data-stu-id="777c4-1374">URL generation</span></span>

<span data-ttu-id="777c4-1375">Формирование URL-адреса — это процесс создания пути URL-адреса функцией маршрутизации на основе набора значений маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1375">URL generation is the process by which routing can create a URL path based on a set of route values.</span></span> <span data-ttu-id="777c4-1376">Он обеспечивает логическое разделение обработчиков маршрутов и URL-адресов, которые получают к ним доступ.</span><span class="sxs-lookup"><span data-stu-id="777c4-1376">This allows for a logical separation between route handlers and the URLs that access them.</span></span>

<span data-ttu-id="777c4-1377">Формирование URL-адреса — это итеративный процесс, который начинается с того, что пользовательский код или код платформы вызывает метод <xref:Microsoft.AspNetCore.Routing.IRouter.GetVirtualPath*> коллекции маршрутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1377">URL generation follows a similar iterative process, but it starts with user or framework code calling into the <xref:Microsoft.AspNetCore.Routing.IRouter.GetVirtualPath*> method of the route collection.</span></span> <span data-ttu-id="777c4-1378">Метод <xref:Microsoft.AspNetCore.Routing.IRouter.GetVirtualPath*> каждого *маршрута* вызывается по очереди, пока не будет возвращен объект <xref:Microsoft.AspNetCore.Routing.VirtualPathData>, отличный от NULL.</span><span class="sxs-lookup"><span data-stu-id="777c4-1378">Each *route* has its <xref:Microsoft.AspNetCore.Routing.IRouter.GetVirtualPath*> method called in sequence until a non-null <xref:Microsoft.AspNetCore.Routing.VirtualPathData> is returned.</span></span>

<span data-ttu-id="777c4-1379">Основные входные параметры метода <xref:Microsoft.AspNetCore.Routing.IRouter.GetVirtualPath*>:</span><span class="sxs-lookup"><span data-stu-id="777c4-1379">The primary inputs to <xref:Microsoft.AspNetCore.Routing.IRouter.GetVirtualPath*> are:</span></span>

* [<span data-ttu-id="777c4-1380">VirtualPathContext.HttpContext</span><span class="sxs-lookup"><span data-stu-id="777c4-1380">VirtualPathContext.HttpContext</span></span>](xref:Microsoft.AspNetCore.Routing.VirtualPathContext.HttpContext)
* [<span data-ttu-id="777c4-1381">VirtualPathContext.Values</span><span class="sxs-lookup"><span data-stu-id="777c4-1381">VirtualPathContext.Values</span></span>](xref:Microsoft.AspNetCore.Routing.VirtualPathContext.Values)
* [<span data-ttu-id="777c4-1382">VirtualPathContext.AmbientValues</span><span class="sxs-lookup"><span data-stu-id="777c4-1382">VirtualPathContext.AmbientValues</span></span>](xref:Microsoft.AspNetCore.Routing.VirtualPathContext.AmbientValues)

<span data-ttu-id="777c4-1383">Для определения возможности создания URL-адреса и включаемых значений в первую очередь используются значения, передаваемые в свойствах <xref:Microsoft.AspNetCore.Routing.VirtualPathContext.Values> и <xref:Microsoft.AspNetCore.Routing.VirtualPathContext.AmbientValues>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1383">Routes primarily use the route values provided by <xref:Microsoft.AspNetCore.Routing.VirtualPathContext.Values> and <xref:Microsoft.AspNetCore.Routing.VirtualPathContext.AmbientValues> to decide whether it's possible to generate a URL and what values to include.</span></span> <span data-ttu-id="777c4-1384"><xref:Microsoft.AspNetCore.Routing.VirtualPathContext.AmbientValues> — это набор значений маршрута, полученных в результате сопоставления текущего запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1384">The <xref:Microsoft.AspNetCore.Routing.VirtualPathContext.AmbientValues> are the set of route values that were produced from matching the current request.</span></span> <span data-ttu-id="777c4-1385">В свою очередь, <xref:Microsoft.AspNetCore.Routing.VirtualPathContext.Values> — это значения, определяющие способ создания нужного URL-адреса для текущей операции.</span><span class="sxs-lookup"><span data-stu-id="777c4-1385">In contrast, <xref:Microsoft.AspNetCore.Routing.VirtualPathContext.Values> are the route values that specify how to generate the desired URL for the current operation.</span></span> <span data-ttu-id="777c4-1386"><xref:Microsoft.AspNetCore.Routing.VirtualPathContext.HttpContext> предоставляется в том случае, если маршруту необходимо получить службы или дополнительные данные, связанные с текущим контекстом.</span><span class="sxs-lookup"><span data-stu-id="777c4-1386">The <xref:Microsoft.AspNetCore.Routing.VirtualPathContext.HttpContext> is provided in case a route should obtain services or additional data associated with the current context.</span></span>

> [!TIP]
> <span data-ttu-id="777c4-1387">Можно рассматривать [VirtualPathContext.Values](xref:Microsoft.AspNetCore.Routing.VirtualPathContext.Values*) как набор переопределений для [VirtualPathContext.AmbientValues](xref:Microsoft.AspNetCore.Routing.VirtualPathContext.AmbientValues*).</span><span class="sxs-lookup"><span data-stu-id="777c4-1387">Think of [VirtualPathContext.Values](xref:Microsoft.AspNetCore.Routing.VirtualPathContext.Values*) as a set of overrides for the [VirtualPathContext.AmbientValues](xref:Microsoft.AspNetCore.Routing.VirtualPathContext.AmbientValues*).</span></span> <span data-ttu-id="777c4-1388">При формировании URL-адреса производится попытка повторного использования значений маршрута из текущего запроса для создания URL-адресов для ссылок с помощью того же маршрута или значений маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1388">URL generation attempts to reuse route values from the current request to generate URLs for links using the same route or route values.</span></span>

<span data-ttu-id="777c4-1389">Выходные данные метода <xref:Microsoft.AspNetCore.Routing.IRouter.GetVirtualPath*> содержатся в объекте <xref:Microsoft.AspNetCore.Routing.VirtualPathData>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1389">The output of <xref:Microsoft.AspNetCore.Routing.IRouter.GetVirtualPath*> is a <xref:Microsoft.AspNetCore.Routing.VirtualPathData>.</span></span> <span data-ttu-id="777c4-1390">Объект <xref:Microsoft.AspNetCore.Routing.VirtualPathData> аналогичен <xref:Microsoft.AspNetCore.Routing.RouteData>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1390"><xref:Microsoft.AspNetCore.Routing.VirtualPathData> is a parallel of <xref:Microsoft.AspNetCore.Routing.RouteData>.</span></span> <span data-ttu-id="777c4-1391"><xref:Microsoft.AspNetCore.Routing.VirtualPathData> содержит <xref:Microsoft.AspNetCore.Routing.VirtualPathData.VirtualPath> для выходного URL-адреса, а также ряд дополнительных свойств, которые должны быть заданы маршрутом.</span><span class="sxs-lookup"><span data-stu-id="777c4-1391"><xref:Microsoft.AspNetCore.Routing.VirtualPathData> contains the <xref:Microsoft.AspNetCore.Routing.VirtualPathData.VirtualPath> for the output URL and some additional properties that should be set by the route.</span></span>

<span data-ttu-id="777c4-1392">Свойство [VirtualPathData.VirtualPath](xref:Microsoft.AspNetCore.Routing.VirtualPathData.VirtualPath*) содержит *виртуальный путь*, создаваемый маршрутом.</span><span class="sxs-lookup"><span data-stu-id="777c4-1392">The [VirtualPathData.VirtualPath](xref:Microsoft.AspNetCore.Routing.VirtualPathData.VirtualPath*) property contains the *virtual path* produced by the route.</span></span> <span data-ttu-id="777c4-1393">В зависимости от ситуации путь может требовать дальнейшей обработки.</span><span class="sxs-lookup"><span data-stu-id="777c4-1393">Depending on your needs, you may need to process the path further.</span></span> <span data-ttu-id="777c4-1394">Чтобы представить созданный URL-адрес в формате HTML, добавьте в его начало базовый путь приложения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1394">If you want to render the generated URL in HTML, prepend the base path of the app.</span></span>

<span data-ttu-id="777c4-1395">[VirtualPathData.Router](xref:Microsoft.AspNetCore.Routing.VirtualPathData.Router*) — это ссылка на маршрут, который успешно создал URL-адрес.</span><span class="sxs-lookup"><span data-stu-id="777c4-1395">The [VirtualPathData.Router](xref:Microsoft.AspNetCore.Routing.VirtualPathData.Router*) is a reference to the route that successfully generated the URL.</span></span>

<span data-ttu-id="777c4-1396">Свойства [VirtualPathData.DataTokens](xref:Microsoft.AspNetCore.Routing.VirtualPathData.DataTokens*) представляют собой словарь дополнительных данных, связанных с маршрутом, который создал URL-адрес.</span><span class="sxs-lookup"><span data-stu-id="777c4-1396">The [VirtualPathData.DataTokens](xref:Microsoft.AspNetCore.Routing.VirtualPathData.DataTokens*) properties is a dictionary of additional data related to the route that generated the URL.</span></span> <span data-ttu-id="777c4-1397">Это эквивалент объекта [RouteData.DataTokens](xref:Microsoft.AspNetCore.Routing.RouteData.DataTokens*).</span><span class="sxs-lookup"><span data-stu-id="777c4-1397">This is the parallel of [RouteData.DataTokens](xref:Microsoft.AspNetCore.Routing.RouteData.DataTokens*).</span></span>

### <a name="create-routes"></a><span data-ttu-id="777c4-1398">Создание маршрутов</span><span class="sxs-lookup"><span data-stu-id="777c4-1398">Create routes</span></span>

<span data-ttu-id="777c4-1399">Маршрутизация предоставляет класс <xref:Microsoft.AspNetCore.Routing.Route> в качестве стандартной реализации <xref:Microsoft.AspNetCore.Routing.IRouter>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1399">Routing provides the <xref:Microsoft.AspNetCore.Routing.Route> class as the standard implementation of <xref:Microsoft.AspNetCore.Routing.IRouter>.</span></span> <span data-ttu-id="777c4-1400">Класс <xref:Microsoft.AspNetCore.Routing.Route> использует синтаксис *шаблона маршрута* для определения шаблонов, которые будут сопоставляться с путем URL-адреса при вызове метода <xref:Microsoft.AspNetCore.Routing.IRouter.RouteAsync*>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1400"><xref:Microsoft.AspNetCore.Routing.Route> uses the *route template* syntax to define patterns to match against the URL path when <xref:Microsoft.AspNetCore.Routing.IRouter.RouteAsync*> is called.</span></span> <span data-ttu-id="777c4-1401">При вызове метода <xref:Microsoft.AspNetCore.Routing.IRouter.GetVirtualPath*> объект <xref:Microsoft.AspNetCore.Routing.Route> будет использовать тот же шаблон маршрута для создания URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1401"><xref:Microsoft.AspNetCore.Routing.Route> uses the same route template to generate a URL when <xref:Microsoft.AspNetCore.Routing.IRouter.GetVirtualPath*> is called.</span></span>

<span data-ttu-id="777c4-1402">Большинство приложений создают маршруты, вызывая метод <xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> или один из аналогичных методов расширения, определенных в интерфейсе <xref:Microsoft.AspNetCore.Routing.IRouteBuilder>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1402">Most apps create routes by calling <xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> or one of the similar extension methods defined on <xref:Microsoft.AspNetCore.Routing.IRouteBuilder>.</span></span> <span data-ttu-id="777c4-1403">Все методы расширения <xref:Microsoft.AspNetCore.Routing.IRouteBuilder> создают экземпляр <xref:Microsoft.AspNetCore.Routing.Route> и добавляют его в коллекцию маршрутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1403">Any of the <xref:Microsoft.AspNetCore.Routing.IRouteBuilder> extension methods create an instance of <xref:Microsoft.AspNetCore.Routing.Route> and add it to the route collection.</span></span>

<span data-ttu-id="777c4-1404"><xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> не принимает параметр обработчика маршрутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1404"><xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> doesn't accept a route handler parameter.</span></span> <span data-ttu-id="777c4-1405"><xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> только добавляет маршруты, которые обрабатываются <xref:Microsoft.AspNetCore.Routing.RouteBuilder.DefaultHandler*>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1405"><xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> only adds routes that are handled by the <xref:Microsoft.AspNetCore.Routing.RouteBuilder.DefaultHandler*>.</span></span> <span data-ttu-id="777c4-1406">Обработчиком по умолчанию является `IRouter`, и обработчик может не обработать запрос.</span><span class="sxs-lookup"><span data-stu-id="777c4-1406">The default handler is an `IRouter`, and the handler might not handle the request.</span></span> <span data-ttu-id="777c4-1407">Например, ASP.NET Core MVC обычно настраивается в качестве обработчика по умолчанию, который обрабатывает только те запросы, которые соответствуют доступным контроллеру и действию.</span><span class="sxs-lookup"><span data-stu-id="777c4-1407">For example, ASP.NET Core MVC is typically configured as a default handler that only handles requests that match an available controller and action.</span></span> <span data-ttu-id="777c4-1408">Дополнительные сведения о маршрутизации в MVC см. в разделе <xref:mvc/controllers/routing>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1408">To learn more about routing in MVC, see <xref:mvc/controllers/routing>.</span></span>

<span data-ttu-id="777c4-1409">В следующем коде приводится пример вызова <xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*>, используемого в типичном определении маршрута ASP.NET Core MVC:</span><span class="sxs-lookup"><span data-stu-id="777c4-1409">The following code example is an example of a <xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> call used by a typical ASP.NET Core MVC route definition:</span></span>

```csharp
routes.MapRoute(
    name: "default",
    template: "{controller=Home}/{action=Index}/{id?}");
```

<span data-ttu-id="777c4-1410">Этот шаблон соответствует пути URL-адреса и извлекает значения маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1410">This template matches a URL path and extracts the route values.</span></span> <span data-ttu-id="777c4-1411">Например, путь `/Products/Details/17` создает следующие значения маршрута: `{ controller = Products, action = Details, id = 17 }`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1411">For example, the path `/Products/Details/17` generates the following route values: `{ controller = Products, action = Details, id = 17 }`.</span></span>

<span data-ttu-id="777c4-1412">Значения маршрута определяются с помощью разделения пути URL-адреса на сегменты и сопоставления каждого сегмента с именем *параметра маршрута* в шаблоне маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1412">Route values are determined by splitting the URL path into segments and matching each segment with the *route parameter* name in the route template.</span></span> <span data-ttu-id="777c4-1413">Параметры маршрута являются именованными.</span><span class="sxs-lookup"><span data-stu-id="777c4-1413">Route parameters are named.</span></span> <span data-ttu-id="777c4-1414">Параметры определяются путем заключения имени параметра в фигурные скобки `{ ... }`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1414">The parameters defined by enclosing the parameter name in braces `{ ... }`.</span></span>

<span data-ttu-id="777c4-1415">Приведенный выше шаблон может также соответствовать пути URL-адреса `/`. В этом случае он предоставляет значения `{ controller = Home, action = Index }`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1415">The preceding template could also match the URL path `/` and produce the values `{ controller = Home, action = Index }`.</span></span> <span data-ttu-id="777c4-1416">Связано это с тем, что параметры маршрута `{controller}` и `{action}` имеют значения по умолчанию, а параметр маршрута `id` является необязательным.</span><span class="sxs-lookup"><span data-stu-id="777c4-1416">This occurs because the `{controller}` and `{action}` route parameters have default values and the `id` route parameter is optional.</span></span> <span data-ttu-id="777c4-1417">Значение по умолчанию для параметра маршрута определяется с помощью знака равенства (`=`), за которым следует значение после имени параметра.</span><span class="sxs-lookup"><span data-stu-id="777c4-1417">An equals sign (`=`) followed by a value after the route parameter name defines a default value for the parameter.</span></span> <span data-ttu-id="777c4-1418">Вопросительный знак (`?`) после имени параметра маршрута определяет параметр как необязательный.</span><span class="sxs-lookup"><span data-stu-id="777c4-1418">A question mark (`?`) after the route parameter name defines an optional parameter.</span></span>

<span data-ttu-id="777c4-1419">Параметры маршрута со значением по умолчанию *всегда* предоставляют значения маршрута при совпадении маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1419">Route parameters with a default value *always* produce a route value when the route matches.</span></span> <span data-ttu-id="777c4-1420">Необязательные параметры не предоставляют значение маршрута, если нет соответствующего сегмента пути URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1420">Optional parameters don't produce a route value if there is no corresponding URL path segment.</span></span> <span data-ttu-id="777c4-1421">Подробное описание сценариев и синтаксиса шаблона маршрута см. в разделе [Справочник по шаблонам маршрутов](#route-template-reference).</span><span class="sxs-lookup"><span data-stu-id="777c4-1421">See the [Route template reference](#route-template-reference) section for a thorough description of route template scenarios and syntax.</span></span>

<span data-ttu-id="777c4-1422">В следующем примере в определении параметра маршрута `{id:int}` определяется [ограничение маршрута](#route-constraint-reference) для параметра маршрута `id`:</span><span class="sxs-lookup"><span data-stu-id="777c4-1422">In the following example, the route parameter definition `{id:int}` defines a [route constraint](#route-constraint-reference) for the `id` route parameter:</span></span>

```csharp
routes.MapRoute(
    name: "default",
    template: "{controller=Home}/{action=Index}/{id:int}");
```

<span data-ttu-id="777c4-1423">Этот шаблон соответствует такому пути URL-адреса, как `/Products/Details/17`, но не `/Products/Details/Apples`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1423">This template matches a URL path like `/Products/Details/17` but not `/Products/Details/Apples`.</span></span> <span data-ttu-id="777c4-1424">Ограничения маршрута реализуют интерфейс <xref:Microsoft.AspNetCore.Routing.IRouteConstraint> и проверяют значения маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1424">Route constraints implement <xref:Microsoft.AspNetCore.Routing.IRouteConstraint> and inspect route values to verify them.</span></span> <span data-ttu-id="777c4-1425">В этом примере значение маршрута `id` должно иметь возможность преобразования в целое число.</span><span class="sxs-lookup"><span data-stu-id="777c4-1425">In this example, the route value `id` must be convertible to an integer.</span></span> <span data-ttu-id="777c4-1426">Более подробное описание ограничений маршрутов, предоставляемых платформой, см. в разделе [Справочник по ограничениям маршрутов](#route-constraint-reference).</span><span class="sxs-lookup"><span data-stu-id="777c4-1426">See [route-constraint-reference](#route-constraint-reference) for an explanation of route constraints provided by the framework.</span></span>

<span data-ttu-id="777c4-1427">Дополнительные перегрузки <xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> принимают значения для параметров `constraints`, `dataTokens` и `defaults`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1427">Additional overloads of <xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> accept values for `constraints`, `dataTokens`, and `defaults`.</span></span> <span data-ttu-id="777c4-1428">Типичное применение этих параметров состоит в передаче анонимно типизированного объекта, причем имена свойств анонимного типа соответствуют именам параметров маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1428">The typical usage of these parameters is to pass an anonymously typed object, where the property names of the anonymous type match route parameter names.</span></span>

<span data-ttu-id="777c4-1429">В следующих примерах <xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> создаются эквивалентные маршруты:</span><span class="sxs-lookup"><span data-stu-id="777c4-1429">The following <xref:Microsoft.AspNetCore.Builder.MapRouteRouteBuilderExtensions.MapRoute*> examples create equivalent routes:</span></span>

```csharp
routes.MapRoute(
    name: "default_route",
    template: "{controller}/{action}/{id?}",
    defaults: new { controller = "Home", action = "Index" });

routes.MapRoute(
    name: "default_route",
    template: "{controller=Home}/{action=Index}/{id?}");
```

> [!TIP]
> <span data-ttu-id="777c4-1430">Встроенный синтаксис определения ограничений и значений по умолчанию может быть удобнее для простых маршрутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1430">The inline syntax for defining constraints and defaults can be convenient for simple routes.</span></span> <span data-ttu-id="777c4-1431">Однако некоторые сценарии, например токены данных, не поддерживаются встроенным синтаксисом.</span><span class="sxs-lookup"><span data-stu-id="777c4-1431">However, there are scenarios, such as data tokens, that aren't supported by inline syntax.</span></span>

<span data-ttu-id="777c4-1432">В следующем примере показано еще несколько сценариев:</span><span class="sxs-lookup"><span data-stu-id="777c4-1432">The following example demonstrates a few additional scenarios:</span></span>

```csharp
routes.MapRoute(
    name: "blog",
    template: "Blog/{*article}",
    defaults: new { controller = "Blog", action = "ReadArticle" });
```

<span data-ttu-id="777c4-1433">Предыдущий шаблон соответствует такому пути URL-адреса, как `/Blog/All-About-Routing/Introduction`, и извлекает значения `{ controller = Blog, action = ReadArticle, article = All-About-Routing/Introduction }`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1433">The preceding template matches a URL path like `/Blog/All-About-Routing/Introduction` and extracts the values `{ controller = Blog, action = ReadArticle, article = All-About-Routing/Introduction }`.</span></span> <span data-ttu-id="777c4-1434">Значения маршрута по умолчанию для `controller` и `action` предоставляются маршрутом несмотря на то, что в шаблоне нет соответствующих параметров маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1434">The default route values for `controller` and `action` are produced by the route even though there are no corresponding route parameters in the template.</span></span> <span data-ttu-id="777c4-1435">Значения по умолчанию можно указать в шаблоне маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1435">Default values can be specified in the route template.</span></span> <span data-ttu-id="777c4-1436">Параметр маршрута `article` определяется как *универсальный* с помощью звездочки (`*`) перед его именем.</span><span class="sxs-lookup"><span data-stu-id="777c4-1436">The `article` route parameter is defined as a *catch-all* by the appearance of an asterisk (`*`) before the route parameter name.</span></span> <span data-ttu-id="777c4-1437">Универсальные параметры маршрута служат для фиксации оставшейся части пути URL-адреса, а также могут соответствовать пустой строке.</span><span class="sxs-lookup"><span data-stu-id="777c4-1437">Catch-all route parameters capture the remainder of the URL path and can also match the empty string.</span></span>

<span data-ttu-id="777c4-1438">В следующем примере добавляются ограничения маршрута и токены данных:</span><span class="sxs-lookup"><span data-stu-id="777c4-1438">The following example adds route constraints and data tokens:</span></span>

```csharp
routes.MapRoute(
    name: "us_english_products",
    template: "en-US/Products/{id}",
    defaults: new { controller = "Products", action = "Details" },
    constraints: new { id = new IntRouteConstraint() },
    dataTokens: new { locale = "en-US" });
```

<span data-ttu-id="777c4-1439">Предыдущий шаблон будет соответствовать такому пути URL-адреса, как `/en-US/Products/5`, и будет извлекать значения `{ controller = Products, action = Details, id = 5 }` и токены данных `{ locale = en-US }`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1439">The preceding template matches a URL path like `/en-US/Products/5` and extracts the values `{ controller = Products, action = Details, id = 5 }` and the data tokens `{ locale = en-US }`.</span></span>

![Токены в окне "Локальные"](routing/_static/tokens.png)

### <a name="route-class-url-generation"></a><span data-ttu-id="777c4-1441">Формирование URL-адреса класса маршрута</span><span class="sxs-lookup"><span data-stu-id="777c4-1441">Route class URL generation</span></span>

<span data-ttu-id="777c4-1442">Класс <xref:Microsoft.AspNetCore.Routing.Route> может также формировать URL-адрес, объединяя набор значений маршрута с шаблоном маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1442">The <xref:Microsoft.AspNetCore.Routing.Route> class can also perform URL generation by combining a set of route values with its route template.</span></span> <span data-ttu-id="777c4-1443">С логической точки зрения, этот процесс обратен сопоставлению пути URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1443">This is logically the reverse process of matching the URL path.</span></span>

> [!TIP]
> <span data-ttu-id="777c4-1444">Чтобы лучше понять процесс формирования URL-адреса, представьте себе, какой URL-адрес нужно создать, а затем подумайте, как шаблон маршрута будет сопоставляться с этим URL-адресом.</span><span class="sxs-lookup"><span data-stu-id="777c4-1444">To better understand URL generation, imagine what URL you want to generate and then think about how a route template would match that URL.</span></span> <span data-ttu-id="777c4-1445">Какие значения будут получены?</span><span class="sxs-lookup"><span data-stu-id="777c4-1445">What values would be produced?</span></span> <span data-ttu-id="777c4-1446">Примерно так производится формирование URL-адреса в классе <xref:Microsoft.AspNetCore.Routing.Route>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1446">This is the rough equivalent of how URL generation works in the <xref:Microsoft.AspNetCore.Routing.Route> class.</span></span>

<span data-ttu-id="777c4-1447">В следующем примере используется общий маршрут по умолчанию ASP.NET Core MVC:</span><span class="sxs-lookup"><span data-stu-id="777c4-1447">The following example uses a general ASP.NET Core MVC default route:</span></span>

```csharp
routes.MapRoute(
    name: "default",
    template: "{controller=Home}/{action=Index}/{id?}");
```

<span data-ttu-id="777c4-1448">При значениях маршрута `{ controller = Products, action = List }` создается URL-адрес `/Products/List`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1448">With the route values `{ controller = Products, action = List }`, the URL `/Products/List` is generated.</span></span> <span data-ttu-id="777c4-1449">Значения маршрута заменяются на соответствующие параметры маршрута для образования пути URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1449">The route values are substituted for the corresponding route parameters to form the URL path.</span></span> <span data-ttu-id="777c4-1450">Так как `id` является необязательным параметром маршрута, URL-адрес успешно создается без значения для `id`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1450">Since `id` is an optional route parameter, the URL is successfully generated without a value for `id`.</span></span>

<span data-ttu-id="777c4-1451">При значениях маршрута `{ controller = Home, action = Index }` создается URL-адрес `/`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1451">With the route values `{ controller = Home, action = Index }`, the URL `/` is generated.</span></span> <span data-ttu-id="777c4-1452">Предоставленные значения маршрута соответствуют значениям по умолчанию, поэтому сегменты, соответствующие значениям по умолчанию, можно спокойно опустить.</span><span class="sxs-lookup"><span data-stu-id="777c4-1452">The provided route values match the default values, and the segments corresponding to the default values are safely omitted.</span></span>

<span data-ttu-id="777c4-1453">Оба созданных URL-адреса будут совершать круговой путь с таким же определением маршрута (`/Home/Index` и `/`) и предоставлять те же значения маршрута, которые использовались для формирования URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1453">Both URLs generated round-trip with the following route definition (`/Home/Index` and `/`) produce the same route values that were used to generate the URL.</span></span>

> [!NOTE]
> <span data-ttu-id="777c4-1454">Приложение, использующее платформу ASP.NET Core MVC, должно создавать URL-адреса с помощью объекта <xref:Microsoft.AspNetCore.Mvc.Routing.UrlHelper>, а не вызывать маршрутизацию напрямую.</span><span class="sxs-lookup"><span data-stu-id="777c4-1454">An app using ASP.NET Core MVC should use <xref:Microsoft.AspNetCore.Mvc.Routing.UrlHelper> to generate URLs instead of calling into routing directly.</span></span>

<span data-ttu-id="777c4-1455">Дополнительные сведения о формировании URL-адресов см. в [справочнике по формированию URL-адресов](#url-generation-reference).</span><span class="sxs-lookup"><span data-stu-id="777c4-1455">For more information on URL generation, see the [Url generation reference](#url-generation-reference) section.</span></span>

## <a name="use-routing-middleware"></a><span data-ttu-id="777c4-1456">Использование ПО промежуточного слоя маршрутизации</span><span class="sxs-lookup"><span data-stu-id="777c4-1456">Use routing middleware</span></span>

<span data-ttu-id="777c4-1457">Ссылка на [метапакет Microsoft.AspNetCore.App](xref:fundamentals/metapackage-app) в файле проекта приложения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1457">Reference the [Microsoft.AspNetCore.App metapackage](xref:fundamentals/metapackage-app) in the app's project file.</span></span>

<span data-ttu-id="777c4-1458">Добавьте маршрутизацию в контейнер службы в файле `Startup.ConfigureServices`:</span><span class="sxs-lookup"><span data-stu-id="777c4-1458">Add routing to the service container in `Startup.ConfigureServices`:</span></span>

[!code-csharp[](routing/samples/2.x/RoutingSample/Startup.cs?name=snippet_ConfigureServices&highlight=3)]

<span data-ttu-id="777c4-1459">Маршруты должны настраиваться в методе `Startup.Configure`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1459">Routes must be configured in the `Startup.Configure` method.</span></span> <span data-ttu-id="777c4-1460">В этом примере приложения используются следующие API:</span><span class="sxs-lookup"><span data-stu-id="777c4-1460">The sample app uses the following APIs:</span></span>

* <xref:Microsoft.AspNetCore.Routing.RouteBuilder>
* <span data-ttu-id="777c4-1461"><xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapGet*>. Соответствует только HTTP-запросам GET.</span><span class="sxs-lookup"><span data-stu-id="777c4-1461"><xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapGet*>: Matches only HTTP GET requests.</span></span>
* <xref:Microsoft.AspNetCore.Builder.RoutingBuilderExtensions.UseRouter*>

[!code-csharp[](routing/samples/2.x/RoutingSample/Startup.cs?name=snippet_RouteHandler)]

<span data-ttu-id="777c4-1462">В таблице ниже приведены ответы с данными универсальными кодами ресурсов (URI).</span><span class="sxs-lookup"><span data-stu-id="777c4-1462">The following table shows the responses with the given URIs.</span></span>

| <span data-ttu-id="777c4-1463">URI</span><span class="sxs-lookup"><span data-stu-id="777c4-1463">URI</span></span>                    | <span data-ttu-id="777c4-1464">Ответ</span><span class="sxs-lookup"><span data-stu-id="777c4-1464">Response</span></span>                                          |
| ---------------------- | ------------------------------------------------- |
| `/package/create/3`    | <span data-ttu-id="777c4-1465">Hello!</span><span class="sxs-lookup"><span data-stu-id="777c4-1465">Hello!</span></span> <span data-ttu-id="777c4-1466">Значения маршрута: [operation, create], [id, 3]</span><span class="sxs-lookup"><span data-stu-id="777c4-1466">Route values: [operation, create], [id, 3]</span></span> |
| `/package/track/-3`    | <span data-ttu-id="777c4-1467">Hello!</span><span class="sxs-lookup"><span data-stu-id="777c4-1467">Hello!</span></span> <span data-ttu-id="777c4-1468">Значения маршрута: [operation, track], [id, -3]</span><span class="sxs-lookup"><span data-stu-id="777c4-1468">Route values: [operation, track], [id, -3]</span></span> |
| `/package/track/-3/`   | <span data-ttu-id="777c4-1469">Hello!</span><span class="sxs-lookup"><span data-stu-id="777c4-1469">Hello!</span></span> <span data-ttu-id="777c4-1470">Значения маршрута: [operation, track], [id, -3]</span><span class="sxs-lookup"><span data-stu-id="777c4-1470">Route values: [operation, track], [id, -3]</span></span> |
| `/package/track/`      | <span data-ttu-id="777c4-1471">Запрос не дал результата, нет совпадений.</span><span class="sxs-lookup"><span data-stu-id="777c4-1471">The request falls through, no match.</span></span>              |
| `GET /hello/Joe`       | <span data-ttu-id="777c4-1472">Hi, Joe!</span><span class="sxs-lookup"><span data-stu-id="777c4-1472">Hi, Joe!</span></span>                                          |
| `POST /hello/Joe`      | <span data-ttu-id="777c4-1473">Запрос не дал результата, совпадение только с HTTP GET.</span><span class="sxs-lookup"><span data-stu-id="777c4-1473">The request falls through, matches HTTP GET only.</span></span> |
| `GET /hello/Joe/Smith` | <span data-ttu-id="777c4-1474">Запрос не дал результата, нет совпадений.</span><span class="sxs-lookup"><span data-stu-id="777c4-1474">The request falls through, no match.</span></span>              |

<span data-ttu-id="777c4-1475">Если вы настраиваете один маршрут, вызовите <xref:Microsoft.AspNetCore.Builder.RoutingBuilderExtensions.UseRouter*>, передав экземпляр `IRouter`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1475">If you're configuring a single route, call <xref:Microsoft.AspNetCore.Builder.RoutingBuilderExtensions.UseRouter*> passing in an `IRouter` instance.</span></span> <span data-ttu-id="777c4-1476">Использовать <xref:Microsoft.AspNetCore.Routing.RouteBuilder> не нужно.</span><span class="sxs-lookup"><span data-stu-id="777c4-1476">You won't need to use <xref:Microsoft.AspNetCore.Routing.RouteBuilder>.</span></span>

<span data-ttu-id="777c4-1477">Платформа предоставляет наборов методов расширения для создания маршрутов (<xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions>):</span><span class="sxs-lookup"><span data-stu-id="777c4-1477">The framework provides a set of extension methods for creating routes (<xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions>):</span></span>

* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapDelete*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapGet*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapMiddlewareDelete*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapMiddlewareGet*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapMiddlewarePost*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapMiddlewarePut*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapMiddlewareRoute*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapMiddlewareVerb*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapPost*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapPut*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapRoute*>
* <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapVerb*>

<span data-ttu-id="777c4-1478">Некоторые из перечисленных методов, такие как <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapGet*>, требуют <xref:Microsoft.AspNetCore.Http.RequestDelegate>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1478">Some of listed methods, such as <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapGet*>, require a <xref:Microsoft.AspNetCore.Http.RequestDelegate>.</span></span> <span data-ttu-id="777c4-1479"><xref:Microsoft.AspNetCore.Http.RequestDelegate> используется в качестве *обработчика маршрутов* при совпадении маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1479">The <xref:Microsoft.AspNetCore.Http.RequestDelegate> is used as the *route handler* when the route matches.</span></span> <span data-ttu-id="777c4-1480">Другие методы из этого семейства позволяют настраивать конвейер ПО промежуточного слоя, который будет использоваться в качестве обработчика маршрутов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1480">Other methods in this family allow configuring a middleware pipeline for use as the route handler.</span></span> <span data-ttu-id="777c4-1481">Если метод `Map*` не принимает обработчик, например <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapRoute*>, он будет использовать объект <xref:Microsoft.AspNetCore.Routing.RouteBuilder.DefaultHandler*>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1481">If the `Map*` method doesn't accept a handler, such as <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapRoute*>, it uses the <xref:Microsoft.AspNetCore.Routing.RouteBuilder.DefaultHandler*>.</span></span>

<span data-ttu-id="777c4-1482">Методы `Map[Verb]` используют ограничения, чтобы ограничить маршрут к HTTP-команде в имени метода.</span><span class="sxs-lookup"><span data-stu-id="777c4-1482">The `Map[Verb]` methods use constraints to limit the route to the HTTP Verb in the method name.</span></span> <span data-ttu-id="777c4-1483">Например, см. класс <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapGet*> и тип <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapVerb*>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1483">For example, see <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapGet*> and <xref:Microsoft.AspNetCore.Routing.RequestDelegateRouteBuilderExtensions.MapVerb*>.</span></span>

## <a name="route-template-reference"></a><span data-ttu-id="777c4-1484">Справочник по шаблону маршрута</span><span class="sxs-lookup"><span data-stu-id="777c4-1484">Route template reference</span></span>

<span data-ttu-id="777c4-1485">Токены в фигурных скобках (`{ ... }`) определяют *параметры маршрута*, которые будут привязаны при совпадении маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1485">Tokens within curly braces (`{ ... }`) define *route parameters* that are bound if the route is matched.</span></span> <span data-ttu-id="777c4-1486">В сегменте маршрута можно определить несколько параметров маршрута, но они должны разделяться литеральным значением.</span><span class="sxs-lookup"><span data-stu-id="777c4-1486">You can define more than one route parameter in a route segment, but they must be separated by a literal value.</span></span> <span data-ttu-id="777c4-1487">Например, `{controller=Home}{action=Index}` будет недопустимым маршрутом, так как между `{controller}` и `{action}` нет литерального значения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1487">For example, `{controller=Home}{action=Index}` isn't a valid route, since there's no literal value between `{controller}` and `{action}`.</span></span> <span data-ttu-id="777c4-1488">Эти параметры маршрута должны иметь имена, и для них могут быть определены дополнительные атрибуты.</span><span class="sxs-lookup"><span data-stu-id="777c4-1488">These route parameters must have a name and may have additional attributes specified.</span></span>

<span data-ttu-id="777c4-1489">Весь текст, кроме параметров маршрута (например, `{id}`) и разделителя пути `/`, должен соответствовать тексту в URL-адресе.</span><span class="sxs-lookup"><span data-stu-id="777c4-1489">Literal text other than route parameters (for example, `{id}`) and the path separator `/` must match the text in the URL.</span></span> <span data-ttu-id="777c4-1490">Сопоставление текста производится без учета регистра на основе декодированного представления путь URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1490">Text matching is case-insensitive and based on the decoded representation of the URLs path.</span></span> <span data-ttu-id="777c4-1491">Для сопоставления с литеральным разделителем параметров маршрута (`{` или `}`) разделитель следует экранировать путем повтора символа (`{{` или `}}`).</span><span class="sxs-lookup"><span data-stu-id="777c4-1491">To match a literal route parameter delimiter (`{` or `}`), escape the delimiter by repeating the character (`{{` or `}}`).</span></span>

<span data-ttu-id="777c4-1492">Шаблоны URL-адресов, которые пытаются получить имя файла с необязательным расширением, имеют свои особенности.</span><span class="sxs-lookup"><span data-stu-id="777c4-1492">URL patterns that attempt to capture a file name with an optional file extension have additional considerations.</span></span> <span data-ttu-id="777c4-1493">Например, рассмотрим шаблон `files/{filename}.{ext?}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1493">For example, consider the template `files/{filename}.{ext?}`.</span></span> <span data-ttu-id="777c4-1494">Когда значения для `filename` и `ext` существуют, заполняются оба значения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1494">When values for both `filename` and `ext` exist, both values are populated.</span></span> <span data-ttu-id="777c4-1495">Если в URL-адресе есть только значение для `filename`, маршрут совпадает, так как точка в конце (`.`) является необязательной.</span><span class="sxs-lookup"><span data-stu-id="777c4-1495">If only a value for `filename` exists in the URL, the route matches because the trailing period (`.`) is  optional.</span></span> <span data-ttu-id="777c4-1496">Следующие URL-адреса соответствуют этому маршруту:</span><span class="sxs-lookup"><span data-stu-id="777c4-1496">The following URLs match this route:</span></span>

* `/files/myFile.txt`
* `/files/myFile`

<span data-ttu-id="777c4-1497">Вы можете использовать звездочку (`*`) в качестве префикса параметра маршрута для привязки к остальной части URI.</span><span class="sxs-lookup"><span data-stu-id="777c4-1497">You can use the asterisk (`*`) as a prefix to a route parameter to bind to the rest of the URI.</span></span> <span data-ttu-id="777c4-1498">Такой параметр называется *универсальным*.</span><span class="sxs-lookup"><span data-stu-id="777c4-1498">This is called a *catch-all* parameter.</span></span> <span data-ttu-id="777c4-1499">Например, `blog/{*slug}` соответствует любому URI, начинающемуся с сегмента `/blog`, за которым следует любое значение, присваиваемое в качестве значения маршрута `slug`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1499">For example, `blog/{*slug}` matches any URI that starts with `/blog` and has any value following it, which is assigned to the `slug` route value.</span></span> <span data-ttu-id="777c4-1500">Универсальные параметры также могут соответствовать пустой строке.</span><span class="sxs-lookup"><span data-stu-id="777c4-1500">Catch-all parameters can also match the empty string.</span></span>

<span data-ttu-id="777c4-1501">Универсальный параметр экранирует соответствующие символы, если маршрут использует для формирования URL-адрес, включая символы разделителей пути (`/`).</span><span class="sxs-lookup"><span data-stu-id="777c4-1501">The catch-all parameter escapes the appropriate characters when the route is used to generate a URL, including path separator (`/`) characters.</span></span> <span data-ttu-id="777c4-1502">Например, маршрут `foo/{*path}` со значениями маршрутов `{ path = "my/path" }` формирует `foo/my%2Fpath`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1502">For example, the route `foo/{*path}` with route values `{ path = "my/path" }` generates `foo/my%2Fpath`.</span></span> <span data-ttu-id="777c4-1503">Обратите внимание на экранированный знак косой черты.</span><span class="sxs-lookup"><span data-stu-id="777c4-1503">Note the escaped forward slash.</span></span>

<span data-ttu-id="777c4-1504">Параметры маршрута могут иметь *значения по умолчанию*. Они указываются после имени параметра и знака равенства (`=`).</span><span class="sxs-lookup"><span data-stu-id="777c4-1504">Route parameters may have *default values* designated by specifying the default value after the parameter name separated by an equals sign (`=`).</span></span> <span data-ttu-id="777c4-1505">Например, `{controller=Home}` определяет `Home` в качестве значения по умолчанию для `controller`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1505">For example, `{controller=Home}` defines `Home` as the default value for `controller`.</span></span> <span data-ttu-id="777c4-1506">Значение по умолчанию используется, если для параметра нет значения в URL-адресе.</span><span class="sxs-lookup"><span data-stu-id="777c4-1506">The default value is used if no value is present in the URL for the parameter.</span></span> <span data-ttu-id="777c4-1507">Параметры маршрута могут быть необязательными (для этого необходимо добавить вопросительный знак (`?`) в конец имени параметра, например `id?`).</span><span class="sxs-lookup"><span data-stu-id="777c4-1507">Route parameters are made optional by appending a question mark (`?`) to the end of the parameter name, as in `id?`.</span></span> <span data-ttu-id="777c4-1508">Различие между необязательными параметрами и параметрами маршрута по умолчанию в том, что вторые всегда имеют значения &mdash; необязательный параметр имеет значение, только если оно предоставлено URL-адресом запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1508">The difference between optional values and default route parameters is that a route parameter with a default value always produces a value&mdash;an optional parameter has a value only when a value is provided by the request URL.</span></span>

<span data-ttu-id="777c4-1509">Параметры маршрута могут иметь ограничения, которые должны соответствовать значению маршрута из URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1509">Route parameters may have constraints that must match the route value bound from the URL.</span></span> <span data-ttu-id="777c4-1510">Добавив двоеточие (`:`) и имя ограничения после имени параметра маршрута, можно указать *встроенные ограничения* для параметра маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1510">Adding a colon (`:`) and constraint name after the route parameter name specifies an *inline constraint* on a route parameter.</span></span> <span data-ttu-id="777c4-1511">Если для ограничения требуются аргументы, они указываются в скобках (`(...)`) после имени ограничения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1511">If the constraint requires arguments, they're enclosed in parentheses (`(...)`) after the constraint name.</span></span> <span data-ttu-id="777c4-1512">Чтобы указать несколько встроенных ограничений, добавьте еще одно двоеточие (`:`) и имя ограничения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1512">Multiple inline constraints can be specified by appending another colon (`:`) and constraint name.</span></span>

<span data-ttu-id="777c4-1513">Имя и аргументы ограничения передаются в службу <xref:Microsoft.AspNetCore.Routing.IInlineConstraintResolver> для создания экземпляра интерфейса <xref:Microsoft.AspNetCore.Routing.IRouteConstraint>, который будет использоваться при обработке URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1513">The constraint name and arguments are passed to the <xref:Microsoft.AspNetCore.Routing.IInlineConstraintResolver> service to create an instance of <xref:Microsoft.AspNetCore.Routing.IRouteConstraint> to use in URL processing.</span></span> <span data-ttu-id="777c4-1514">Например, в шаблоне маршрута `blog/{article:minlength(10)}` определяется ограничение `minlength` с аргументом `10`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1514">For example, the route template `blog/{article:minlength(10)}` specifies a `minlength` constraint with the argument `10`.</span></span> <span data-ttu-id="777c4-1515">Более подробное описание ограничений маршрутов и список ограничений, предоставляемых платформой, см. в разделе [Справочник по ограничениям маршрутов](#route-constraint-reference).</span><span class="sxs-lookup"><span data-stu-id="777c4-1515">For more information on route constraints and a list of the constraints provided by the framework, see the [Route constraint reference](#route-constraint-reference) section.</span></span>

<span data-ttu-id="777c4-1516">В приведенной ниже таблице показаны некоторые примеры шаблонов маршрутов и их поведение.</span><span class="sxs-lookup"><span data-stu-id="777c4-1516">The following table demonstrates example route templates and their behavior.</span></span>

| <span data-ttu-id="777c4-1517">Шаблон маршрута</span><span class="sxs-lookup"><span data-stu-id="777c4-1517">Route Template</span></span>                           | <span data-ttu-id="777c4-1518">Пример соответствующего URI</span><span class="sxs-lookup"><span data-stu-id="777c4-1518">Example Matching URI</span></span>    | <span data-ttu-id="777c4-1519">URI запроса&hellip;</span><span class="sxs-lookup"><span data-stu-id="777c4-1519">The request URI&hellip;</span></span>                                                    |
| ---------------------------------------- | ----------------------- | -------------------------------------------------------------------------- |
| `hello`                                  | `/hello`                | <span data-ttu-id="777c4-1520">Соответствует только одному пути `/hello`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1520">Only matches the single path `/hello`.</span></span>                                     |
| `{Page=Home}`                            | `/`                     | <span data-ttu-id="777c4-1521">Соответствует и задает для параметра `Page` значение `Home`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1521">Matches and sets `Page` to `Home`.</span></span>                                         |
| `{Page=Home}`                            | `/Contact`              | <span data-ttu-id="777c4-1522">Соответствует и задает для параметра `Page` значение `Contact`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1522">Matches and sets `Page` to `Contact`.</span></span>                                      |
| `{controller}/{action}/{id?}`            | `/Products/List`        | <span data-ttu-id="777c4-1523">Сопоставляется с контроллером `Products` и действием `List`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1523">Maps to the `Products` controller and `List` action.</span></span>                       |
| `{controller}/{action}/{id?}`            | `/Products/Details/123` | <span data-ttu-id="777c4-1524">Сопоставляется с контроллером `Products` и действием `Details` (`id` имеет значение 123).</span><span class="sxs-lookup"><span data-stu-id="777c4-1524">Maps to the `Products` controller and  `Details` action (`id` set to 123).</span></span> |
| `{controller=Home}/{action=Index}/{id?}` | `/`                     | <span data-ttu-id="777c4-1525">Сопоставляется с контроллером `Home` и методом `Index` (`id` пропускается).</span><span class="sxs-lookup"><span data-stu-id="777c4-1525">Maps to the `Home` controller and `Index` method (`id` is ignored).</span></span>        |

<span data-ttu-id="777c4-1526">Использование шаблона — это, как правило, самый простой подход к маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="777c4-1526">Using a template is generally the simplest approach to routing.</span></span> <span data-ttu-id="777c4-1527">Ограничения и значения по умолчанию также могут указываться вне шаблона маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1527">Constraints and defaults can also be specified outside the route template.</span></span>

> [!TIP]
> <span data-ttu-id="777c4-1528">Чтобы увидеть, как встроенные реализации маршрутизации, такие как <xref:Microsoft.AspNetCore.Routing.Route>, сопоставляются с запросами, включите [ведение журнала](xref:fundamentals/logging/index).</span><span class="sxs-lookup"><span data-stu-id="777c4-1528">Enable [Logging](xref:fundamentals/logging/index) to see how the built-in routing implementations, such as <xref:Microsoft.AspNetCore.Routing.Route>, match requests.</span></span>

## <a name="route-constraint-reference"></a><span data-ttu-id="777c4-1529">Справочник по ограничениям маршрутов</span><span class="sxs-lookup"><span data-stu-id="777c4-1529">Route constraint reference</span></span>

<span data-ttu-id="777c4-1530">Ограничения маршрута применяются, когда найдено соответствие входящему URL-адресу и путь URL-адреса был разобран на значения маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1530">Route constraints execute when a match has occurred to the incoming URL and the URL path is tokenized into route values.</span></span> <span data-ttu-id="777c4-1531">Как правило, ограничения маршрута служат для проверки значения маршрута, связанного посредством шаблона маршрута, и принятия решения касательно того, является ли значение приемлемым (да или нет).</span><span class="sxs-lookup"><span data-stu-id="777c4-1531">Route constraints generally inspect the route value associated via the route template and make a yes/no decision about whether or not the value is acceptable.</span></span> <span data-ttu-id="777c4-1532">Некоторые ограничения маршрута используют данные, не относящиеся к значению маршрута, для определения возможности маршрутизации запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1532">Some route constraints use data outside the route value to consider whether the request can be routed.</span></span> <span data-ttu-id="777c4-1533">Например, <xref:Microsoft.AspNetCore.Routing.Constraints.HttpMethodRouteConstraint> может принимать или отклонять запрос в зависимости от HTTP-команды.</span><span class="sxs-lookup"><span data-stu-id="777c4-1533">For example, the <xref:Microsoft.AspNetCore.Routing.Constraints.HttpMethodRouteConstraint> can accept or reject a request based on its HTTP verb.</span></span> <span data-ttu-id="777c4-1534">Ограничения используются в маршрутизации запросов и создании ссылок.</span><span class="sxs-lookup"><span data-stu-id="777c4-1534">Constraints are used in routing requests and link generation.</span></span>

> [!WARNING]
> <span data-ttu-id="777c4-1535">Не используйте ограничения для **проверки входных данных**.</span><span class="sxs-lookup"><span data-stu-id="777c4-1535">Don't use constraints for **input validation**.</span></span> <span data-ttu-id="777c4-1536">Если ограничения используются для **проверки входных данных**, недопустимые входные данные будут вызывать ошибку *404 (не найдено)* вместо ошибки *400 (неверный запрос)* с соответствующим сообщением.</span><span class="sxs-lookup"><span data-stu-id="777c4-1536">If constraints are used for **input validation**, invalid input results in a *404 - Not Found* response instead of a *400 - Bad Request* with an appropriate error message.</span></span> <span data-ttu-id="777c4-1537">Ограничения маршрутов следует использовать для **разрешения неоднозначности** похожих маршрутов, а не для проверки входных данных определенного маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1537">Route constraints are used to **disambiguate** similar routes, not to validate the inputs for a particular route.</span></span>

<span data-ttu-id="777c4-1538">В приведенной ниже таблице показаны примеры ограничения маршрутов и их ожидаемое поведение.</span><span class="sxs-lookup"><span data-stu-id="777c4-1538">The following table demonstrates example route constraints and their expected behavior.</span></span>

| <span data-ttu-id="777c4-1539">ограничение</span><span class="sxs-lookup"><span data-stu-id="777c4-1539">constraint</span></span> | <span data-ttu-id="777c4-1540">Пример</span><span class="sxs-lookup"><span data-stu-id="777c4-1540">Example</span></span> | <span data-ttu-id="777c4-1541">Примеры совпадений</span><span class="sxs-lookup"><span data-stu-id="777c4-1541">Example Matches</span></span> | <span data-ttu-id="777c4-1542">Примечания</span><span class="sxs-lookup"><span data-stu-id="777c4-1542">Notes</span></span> |
| ---------- | ------- | --------------- | ----- |
| `int` | `{id:int}` | <span data-ttu-id="777c4-1543">`123456789`, `-123456789`</span><span class="sxs-lookup"><span data-stu-id="777c4-1543">`123456789`, `-123456789`</span></span> | <span data-ttu-id="777c4-1544">Соответствует любому целому числу</span><span class="sxs-lookup"><span data-stu-id="777c4-1544">Matches any integer</span></span> |
| `bool` | `{active:bool}` | <span data-ttu-id="777c4-1545">`true`, `FALSE`</span><span class="sxs-lookup"><span data-stu-id="777c4-1545">`true`, `FALSE`</span></span> | <span data-ttu-id="777c4-1546">Соответствует `true` или `false` (без учета регистра)</span><span class="sxs-lookup"><span data-stu-id="777c4-1546">Matches `true` or `false` (case-insensitive)</span></span> |
| `datetime` | `{dob:datetime}` | <span data-ttu-id="777c4-1547">`2016-12-31`, `2016-12-31 7:32pm`</span><span class="sxs-lookup"><span data-stu-id="777c4-1547">`2016-12-31`, `2016-12-31 7:32pm`</span></span> | <span data-ttu-id="777c4-1548">Соответствует допустимому значению `DateTime` для инвариантного языка и региональных параметров.</span><span class="sxs-lookup"><span data-stu-id="777c4-1548">Matches a valid `DateTime` value in the invariant culture.</span></span> <span data-ttu-id="777c4-1549">См. предупреждение выше.</span><span class="sxs-lookup"><span data-stu-id="777c4-1549">See  preceding warning.</span></span>|
| `decimal` | `{price:decimal}` | <span data-ttu-id="777c4-1550">`49.99`, `-1,000.01`</span><span class="sxs-lookup"><span data-stu-id="777c4-1550">`49.99`, `-1,000.01`</span></span> | <span data-ttu-id="777c4-1551">Соответствует допустимому значению `decimal` для инвариантного языка и региональных параметров.</span><span class="sxs-lookup"><span data-stu-id="777c4-1551">Matches a valid `decimal` value in the invariant culture.</span></span> <span data-ttu-id="777c4-1552">См. предупреждение выше.</span><span class="sxs-lookup"><span data-stu-id="777c4-1552">See  preceding warning.</span></span>|
| `double` | `{weight:double}` | <span data-ttu-id="777c4-1553">`1.234`, `-1,001.01e8`</span><span class="sxs-lookup"><span data-stu-id="777c4-1553">`1.234`, `-1,001.01e8`</span></span> | <span data-ttu-id="777c4-1554">Соответствует допустимому значению `double` для инвариантного языка и региональных параметров.</span><span class="sxs-lookup"><span data-stu-id="777c4-1554">Matches a valid `double` value in the invariant culture.</span></span> <span data-ttu-id="777c4-1555">См. предупреждение выше.</span><span class="sxs-lookup"><span data-stu-id="777c4-1555">See  preceding warning.</span></span>|
| `float` | `{weight:float}` | <span data-ttu-id="777c4-1556">`1.234`, `-1,001.01e8`</span><span class="sxs-lookup"><span data-stu-id="777c4-1556">`1.234`, `-1,001.01e8`</span></span> | <span data-ttu-id="777c4-1557">Соответствует допустимому значению `float` для инвариантного языка и региональных параметров.</span><span class="sxs-lookup"><span data-stu-id="777c4-1557">Matches a valid `float` value in the invariant culture.</span></span> <span data-ttu-id="777c4-1558">См. предупреждение выше.</span><span class="sxs-lookup"><span data-stu-id="777c4-1558">See  preceding warning.</span></span>|
| `guid` | `{id:guid}` | <span data-ttu-id="777c4-1559">`CD2C1638-1638-72D5-1638-DEADBEEF1638`, `{CD2C1638-1638-72D5-1638-DEADBEEF1638}`</span><span class="sxs-lookup"><span data-stu-id="777c4-1559">`CD2C1638-1638-72D5-1638-DEADBEEF1638`, `{CD2C1638-1638-72D5-1638-DEADBEEF1638}`</span></span> | <span data-ttu-id="777c4-1560">Соответствует допустимому значению `Guid`</span><span class="sxs-lookup"><span data-stu-id="777c4-1560">Matches a valid `Guid` value</span></span> |
| `long` | `{ticks:long}` | <span data-ttu-id="777c4-1561">`123456789`, `-123456789`</span><span class="sxs-lookup"><span data-stu-id="777c4-1561">`123456789`, `-123456789`</span></span> | <span data-ttu-id="777c4-1562">Соответствует допустимому значению `long`</span><span class="sxs-lookup"><span data-stu-id="777c4-1562">Matches a valid `long` value</span></span> |
| `minlength(value)` | `{username:minlength(4)}` | `Rick` | <span data-ttu-id="777c4-1563">Строка должна содержать не менее 4 символов</span><span class="sxs-lookup"><span data-stu-id="777c4-1563">String must be at least 4 characters</span></span> |
| `maxlength(value)` | `{filename:maxlength(8)}` | `Richard` | <span data-ttu-id="777c4-1564">Строка должна содержать не более 8 символов</span><span class="sxs-lookup"><span data-stu-id="777c4-1564">String must be no more than 8 characters</span></span> |
| `length(length)` | `{filename:length(12)}` | `somefile.txt` | <span data-ttu-id="777c4-1565">Длина строки должна составлять ровно 12 символов</span><span class="sxs-lookup"><span data-stu-id="777c4-1565">String must be exactly 12 characters long</span></span> |
| `length(min,max)` | `{filename:length(8,16)}` | `somefile.txt` | <span data-ttu-id="777c4-1566">Строка должна содержать от 8 до 16 символов</span><span class="sxs-lookup"><span data-stu-id="777c4-1566">String must be at least 8 and no more than 16 characters long</span></span> |
| `min(value)` | `{age:min(18)}` | `19` | <span data-ttu-id="777c4-1567">Целочисленное значение не меньше 18</span><span class="sxs-lookup"><span data-stu-id="777c4-1567">Integer value must be at least 18</span></span> |
| `max(value)` | `{age:max(120)}` | `91` | <span data-ttu-id="777c4-1568">Целочисленное значение не больше 120</span><span class="sxs-lookup"><span data-stu-id="777c4-1568">Integer value must be no more than 120</span></span> |
| `range(min,max)` | `{age:range(18,120)}` | `91` | <span data-ttu-id="777c4-1569">Целочисленное значение от 18 до 120</span><span class="sxs-lookup"><span data-stu-id="777c4-1569">Integer value must be at least 18 but no more than 120</span></span> |
| `alpha` | `{name:alpha}` | `Rick` | <span data-ttu-id="777c4-1570">Строка должна состоять из одной или нескольких букв (`a`-`z`, без учета регистра)</span><span class="sxs-lookup"><span data-stu-id="777c4-1570">String must consist of one or more alphabetical characters (`a`-`z`, case-insensitive)</span></span> |
| `regex(expression)` | `{ssn:regex(^\\d{{3}}-\\d{{2}}-\\d{{4}}$)}` | `123-45-6789` | <span data-ttu-id="777c4-1571">Строка должна соответствовать регулярному выражению (см. советы по определению регулярного выражения)</span><span class="sxs-lookup"><span data-stu-id="777c4-1571">String must match the regular expression (see tips about defining a regular expression)</span></span> |
| `required` | `{name:required}` | `Rick` | <span data-ttu-id="777c4-1572">Определяет обязательное наличие значения, не относящегося к параметру, во время формирования URL-адреса</span><span class="sxs-lookup"><span data-stu-id="777c4-1572">Used to enforce that a non-parameter value is present during URL generation</span></span> |

<span data-ttu-id="777c4-1573">К одному параметру может применяться несколько разделенных запятой ограничений.</span><span class="sxs-lookup"><span data-stu-id="777c4-1573">Multiple, colon-delimited constraints can be applied to a single parameter.</span></span> <span data-ttu-id="777c4-1574">Например, следующее ограничение ограничивает параметр целочисленным значением 1 или больше:</span><span class="sxs-lookup"><span data-stu-id="777c4-1574">For example, the following constraint restricts a parameter to an integer value of 1 or greater:</span></span>

```csharp
[Route("users/{id:int:min(1)}")]
public User GetUserById(int id) { }
```

> [!WARNING]
> <span data-ttu-id="777c4-1575">Ограничения маршрута, которые проверяют URL-адрес и могут быть преобразованы в тип CLR (например, `int` или `DateTime`), всегда используют инвариантные язык и региональные параметры.</span><span class="sxs-lookup"><span data-stu-id="777c4-1575">Route constraints that verify the URL and are converted to a CLR type (such as `int` or `DateTime`) always use the invariant culture.</span></span> <span data-ttu-id="777c4-1576">Эти ограничения предполагают, что URL-адрес является нелокализуемым.</span><span class="sxs-lookup"><span data-stu-id="777c4-1576">These constraints assume that the URL is non-localizable.</span></span> <span data-ttu-id="777c4-1577">Предоставляемые платформой ограничения маршрутов не изменяют значения, хранящиеся в значениях маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1577">The framework-provided route constraints don't modify the values stored in route values.</span></span> <span data-ttu-id="777c4-1578">Все значения маршрута, переданные из URL-адреса, сохраняются как строки.</span><span class="sxs-lookup"><span data-stu-id="777c4-1578">All route values parsed from the URL are stored as strings.</span></span> <span data-ttu-id="777c4-1579">Например, ограничение `float` пытается преобразовать значение маршрута в число с плавающей запятой, но преобразованное значение служит только для проверки возможности такого преобразования.</span><span class="sxs-lookup"><span data-stu-id="777c4-1579">For example, the `float` constraint attempts to convert the route value to a float, but the converted value is used only to verify it can be converted to a float.</span></span>

## <a name="regular-expressions"></a><span data-ttu-id="777c4-1580">Регулярные выражения</span><span class="sxs-lookup"><span data-stu-id="777c4-1580">Regular expressions</span></span>

<span data-ttu-id="777c4-1581">В платформе ASP.NET Core в конструктор регулярных выражений добавляются члены `RegexOptions.IgnoreCase | RegexOptions.Compiled | RegexOptions.CultureInvariant`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1581">The ASP.NET Core framework adds `RegexOptions.IgnoreCase | RegexOptions.Compiled | RegexOptions.CultureInvariant` to the regular expression constructor.</span></span> <span data-ttu-id="777c4-1582">Описание этих членов см. в разделе <xref:System.Text.RegularExpressions.RegexOptions>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1582">See <xref:System.Text.RegularExpressions.RegexOptions> for a description of these members.</span></span>

<span data-ttu-id="777c4-1583">В регулярных выражениях применяются разделители и токены, аналогичные используемым функцией маршрутизации и в языке C#.</span><span class="sxs-lookup"><span data-stu-id="777c4-1583">Regular expressions use delimiters and tokens similar to those used by Routing and the C# language.</span></span> <span data-ttu-id="777c4-1584">Токены регулярного выражения должны быть экранированы.</span><span class="sxs-lookup"><span data-stu-id="777c4-1584">Regular expression tokens must be escaped.</span></span> <span data-ttu-id="777c4-1585">Чтобы использовать регулярное выражение `^\d{3}-\d{2}-\d{4}$` при маршрутизации, выражение должно иметь символы `\` (обратная косая черта), представленные в строке в виде символов `\\` (двойная обратная косая черта) в исходном файле C#, для экранирования escape-символов строки `\` (если не используются [буквальные строковые литералы](/dotnet/csharp/language-reference/keywords/string)).</span><span class="sxs-lookup"><span data-stu-id="777c4-1585">To use the regular expression `^\d{3}-\d{2}-\d{4}$` in routing, the expression must have the `\` (single backslash) characters provided in the string as `\\` (double backslash) characters in the C# source file in order to escape the `\` string escape character (unless using [verbatim string literals](/dotnet/csharp/language-reference/keywords/string)).</span></span> <span data-ttu-id="777c4-1586">Чтобы экранировать символы разделения параметров маршрутизации (`{`, `}`, `[`, `]`), используйте их дважды в выражении (`{{`, `}`, `[[`, `]]`).</span><span class="sxs-lookup"><span data-stu-id="777c4-1586">To escape routing parameter delimiter characters (`{`, `}`, `[`, `]`), double the characters in the expression (`{{`, `}`, `[[`, `]]`).</span></span> <span data-ttu-id="777c4-1587">В следующей таблице показаны регулярные выражения и их экранированные варианты.</span><span class="sxs-lookup"><span data-stu-id="777c4-1587">The following table shows a regular expression and the escaped version.</span></span>

| <span data-ttu-id="777c4-1588">Регулярное выражение</span><span class="sxs-lookup"><span data-stu-id="777c4-1588">Regular Expression</span></span>    | <span data-ttu-id="777c4-1589">Экранированное регулярное выражение</span><span class="sxs-lookup"><span data-stu-id="777c4-1589">Escaped Regular Expression</span></span>     |
| --------------------- | ------------------------------ |
| `^\d{3}-\d{2}-\d{4}$` | `^\\d{{3}}-\\d{{2}}-\\d{{4}}$` |
| `^[a-z]{2}$`          | `^[[a-z]]{{2}}$`               |

<span data-ttu-id="777c4-1590">Регулярные выражения, используемые при маршрутизации, часто начинаются с символа карета (`^`) и соответствуют начальной позиции строки.</span><span class="sxs-lookup"><span data-stu-id="777c4-1590">Regular expressions used in routing often start with the caret (`^`) character and match starting position of the string.</span></span> <span data-ttu-id="777c4-1591">Выражения часто заканчиваются знаком доллара (`$`) и соответствуют концу строки.</span><span class="sxs-lookup"><span data-stu-id="777c4-1591">The expressions often end with the dollar sign (`$`) character and match end of the string.</span></span> <span data-ttu-id="777c4-1592">Благодаря символам `^` и `$` регулярное выражение сопоставляется со всем значением параметра маршрута.</span><span class="sxs-lookup"><span data-stu-id="777c4-1592">The `^` and `$` characters ensure that the regular expression match the entire route parameter value.</span></span> <span data-ttu-id="777c4-1593">Если символы `^` и `$` отсутствуют, регулярное выражение сопоставляется с любой подстрокой внутри строки, что обычно нежелательно.</span><span class="sxs-lookup"><span data-stu-id="777c4-1593">Without the `^` and `$` characters, the regular expression match any substring within the string, which is often undesirable.</span></span> <span data-ttu-id="777c4-1594">В следующей таблице представлен ряд примеров и объясняются причины соответствия или несоответствия.</span><span class="sxs-lookup"><span data-stu-id="777c4-1594">The following table provides examples and explains why they match or fail to match.</span></span>

| <span data-ttu-id="777c4-1595">Выражение</span><span class="sxs-lookup"><span data-stu-id="777c4-1595">Expression</span></span>   | <span data-ttu-id="777c4-1596">Строка</span><span class="sxs-lookup"><span data-stu-id="777c4-1596">String</span></span>    | <span data-ttu-id="777c4-1597">Соответствие</span><span class="sxs-lookup"><span data-stu-id="777c4-1597">Match</span></span> | <span data-ttu-id="777c4-1598">Добавление примечаний</span><span class="sxs-lookup"><span data-stu-id="777c4-1598">Comment</span></span>               |
| ------------ | --------- | :---: |  -------------------- |
| `[a-z]{2}`   | <span data-ttu-id="777c4-1599">hello</span><span class="sxs-lookup"><span data-stu-id="777c4-1599">hello</span></span>     | <span data-ttu-id="777c4-1600">Да</span><span class="sxs-lookup"><span data-stu-id="777c4-1600">Yes</span></span>   | <span data-ttu-id="777c4-1601">Соответствие подстроки</span><span class="sxs-lookup"><span data-stu-id="777c4-1601">Substring matches</span></span>     |
| `[a-z]{2}`   | <span data-ttu-id="777c4-1602">123abc456</span><span class="sxs-lookup"><span data-stu-id="777c4-1602">123abc456</span></span> | <span data-ttu-id="777c4-1603">Да</span><span class="sxs-lookup"><span data-stu-id="777c4-1603">Yes</span></span>   | <span data-ttu-id="777c4-1604">Соответствие подстроки</span><span class="sxs-lookup"><span data-stu-id="777c4-1604">Substring matches</span></span>     |
| `[a-z]{2}`   | <span data-ttu-id="777c4-1605">mz</span><span class="sxs-lookup"><span data-stu-id="777c4-1605">mz</span></span>        | <span data-ttu-id="777c4-1606">Да</span><span class="sxs-lookup"><span data-stu-id="777c4-1606">Yes</span></span>   | <span data-ttu-id="777c4-1607">Соответствует выражению</span><span class="sxs-lookup"><span data-stu-id="777c4-1607">Matches expression</span></span>    |
| `[a-z]{2}`   | <span data-ttu-id="777c4-1608">MZ</span><span class="sxs-lookup"><span data-stu-id="777c4-1608">MZ</span></span>        | <span data-ttu-id="777c4-1609">Да</span><span class="sxs-lookup"><span data-stu-id="777c4-1609">Yes</span></span>   | <span data-ttu-id="777c4-1610">Без учета регистра</span><span class="sxs-lookup"><span data-stu-id="777c4-1610">Not case sensitive</span></span>    |
| `^[a-z]{2}$` | <span data-ttu-id="777c4-1611">hello</span><span class="sxs-lookup"><span data-stu-id="777c4-1611">hello</span></span>     | <span data-ttu-id="777c4-1612">Нет</span><span class="sxs-lookup"><span data-stu-id="777c4-1612">No</span></span>    | <span data-ttu-id="777c4-1613">См. замечания, касающиеся символов `^` и `$`, выше</span><span class="sxs-lookup"><span data-stu-id="777c4-1613">See `^` and `$` above</span></span> |
| `^[a-z]{2}$` | <span data-ttu-id="777c4-1614">123abc456</span><span class="sxs-lookup"><span data-stu-id="777c4-1614">123abc456</span></span> | <span data-ttu-id="777c4-1615">Нет</span><span class="sxs-lookup"><span data-stu-id="777c4-1615">No</span></span>    | <span data-ttu-id="777c4-1616">См. замечания, касающиеся символов `^` и `$`, выше</span><span class="sxs-lookup"><span data-stu-id="777c4-1616">See `^` and `$` above</span></span> |

<span data-ttu-id="777c4-1617">Дополнительные сведения о синтаксисе регулярных выражений см. в статье [Регулярные выражения в .NET Framework](/dotnet/standard/base-types/regular-expression-language-quick-reference).</span><span class="sxs-lookup"><span data-stu-id="777c4-1617">For more information on regular expression syntax, see [.NET Framework Regular Expressions](/dotnet/standard/base-types/regular-expression-language-quick-reference).</span></span>

<span data-ttu-id="777c4-1618">Чтобы ограничить возможные значения параметра набором известных значений, используйте регулярное выражение.</span><span class="sxs-lookup"><span data-stu-id="777c4-1618">To constrain a parameter to a known set of possible values, use a regular expression.</span></span> <span data-ttu-id="777c4-1619">Например, при использовании выражения `{action:regex(^(list|get|create)$)}` значение маршрута `action` будет соответствовать только `list`, `get` или `create`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1619">For example, `{action:regex(^(list|get|create)$)}` only matches the `action` route value to `list`, `get`, or `create`.</span></span> <span data-ttu-id="777c4-1620">При передаче в словарь ограничений строка `^(list|get|create)$` будет эквивалентной.</span><span class="sxs-lookup"><span data-stu-id="777c4-1620">If passed into the constraints dictionary, the string `^(list|get|create)$` is equivalent.</span></span> <span data-ttu-id="777c4-1621">Ограничения, которые передаются в словарь ограничений (то есть не являются встроенными ограничениями шаблона) и не соответствуют одному из известных ограничений, также рассматриваются как регулярные выражения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1621">Constraints that are passed in the constraints dictionary (not inline within a template) that don't match one of the known constraints are also treated as regular expressions.</span></span>

## <a name="custom-route-constraints"></a><span data-ttu-id="777c4-1622">Пользовательские ограничения маршрутов</span><span class="sxs-lookup"><span data-stu-id="777c4-1622">Custom Route Constraints</span></span>

<span data-ttu-id="777c4-1623">Помимо встроенных ограничений маршрутов пользовательские ограничения маршрутов можно создать путем внедрения интерфейса <xref:Microsoft.AspNetCore.Routing.IRouteConstraint>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1623">In addition to the built-in route constraints, custom route constraints can be created by implementing the <xref:Microsoft.AspNetCore.Routing.IRouteConstraint> interface.</span></span> <span data-ttu-id="777c4-1624">Интерфейс <xref:Microsoft.AspNetCore.Routing.IRouteConstraint> содержит один метод, `Match`, который возвращает `true`, если ограничение удовлетворяется, и `false` — если нет.</span><span class="sxs-lookup"><span data-stu-id="777c4-1624">The <xref:Microsoft.AspNetCore.Routing.IRouteConstraint> interface contains a single method, `Match`, which returns `true` if the constraint is satisfied and `false` otherwise.</span></span>

<span data-ttu-id="777c4-1625">Чтобы применить пользовательский метод <xref:Microsoft.AspNetCore.Routing.IRouteConstraint>, тип ограничения маршрута необходимо зарегистрировать с помощью <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap> приложения в контейнере службы приложения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1625">To use a custom <xref:Microsoft.AspNetCore.Routing.IRouteConstraint>, the route constraint type must be registered with the app's <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap> in the app's service container.</span></span> <span data-ttu-id="777c4-1626">Объект <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap> — это словарь, который сопоставляет ключи ограничений пути с реализациями <xref:Microsoft.AspNetCore.Routing.IRouteConstraint>, которые проверяют эти ограничения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1626">A <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap> is a dictionary that maps route constraint keys to <xref:Microsoft.AspNetCore.Routing.IRouteConstraint> implementations that validate those constraints.</span></span> <span data-ttu-id="777c4-1627"><xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap> приложения можно преобразовать в `Startup.ConfigureServices` как часть вызова [services.AddRouting](xref:Microsoft.Extensions.DependencyInjection.RoutingServiceCollectionExtensions.AddRouting*) или путем настройки <xref:Microsoft.AspNetCore.Routing.RouteOptions> непосредственно с помощью `services.Configure<RouteOptions>`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1627">An app's <xref:Microsoft.AspNetCore.Routing.RouteOptions.ConstraintMap> can be updated in `Startup.ConfigureServices` either as part of a [services.AddRouting](xref:Microsoft.Extensions.DependencyInjection.RoutingServiceCollectionExtensions.AddRouting*) call or by configuring <xref:Microsoft.AspNetCore.Routing.RouteOptions> directly with `services.Configure<RouteOptions>`.</span></span> <span data-ttu-id="777c4-1628">Пример:</span><span class="sxs-lookup"><span data-stu-id="777c4-1628">For example:</span></span>

```csharp
services.AddRouting(options =>
{
    options.ConstraintMap.Add("customName", typeof(MyCustomConstraint));
});
```

<span data-ttu-id="777c4-1629">Ограничения могут применяться к маршрутам обычным способом с использованием имени, указанного при регистрации типа ограничения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1629">The constraint can then be applied to routes in the usual manner, using the name specified when registering the constraint type.</span></span> <span data-ttu-id="777c4-1630">Пример:</span><span class="sxs-lookup"><span data-stu-id="777c4-1630">For example:</span></span>

```csharp
[HttpGet("{id:customName}")]
public ActionResult<string> Get(string id)
```

## <a name="url-generation-reference"></a><span data-ttu-id="777c4-1631">Справочник по формированию URL-адресов</span><span class="sxs-lookup"><span data-stu-id="777c4-1631">URL generation reference</span></span>

<span data-ttu-id="777c4-1632">В приведенном ниже примере показано, как создать ссылку на маршрут с использованием словаря значений маршрута и коллекции <xref:Microsoft.AspNetCore.Routing.RouteCollection>.</span><span class="sxs-lookup"><span data-stu-id="777c4-1632">The following example shows how to generate a link to a route given a dictionary of route values and a <xref:Microsoft.AspNetCore.Routing.RouteCollection>.</span></span>

[!code-csharp[](routing/samples/2.x/RoutingSample/Startup.cs?name=snippet_Dictionary)]

<span data-ttu-id="777c4-1633">В результате приведенного выше примера создается <xref:Microsoft.AspNetCore.Routing.VirtualPathData.VirtualPath> со значением `/package/create/123`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1633">The <xref:Microsoft.AspNetCore.Routing.VirtualPathData.VirtualPath> generated at the end of the preceding sample is `/package/create/123`.</span></span> <span data-ttu-id="777c4-1634">Словарь предоставляет значения маршрута `operation` и `id` шаблона "Отслеживание маршрута пакета", `package/{operation}/{id}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1634">The dictionary supplies the `operation` and `id` route values of the "Track Package Route" template, `package/{operation}/{id}`.</span></span> <span data-ttu-id="777c4-1635">Дополнительные сведения см. в примере кода в разделе [Использование ПО промежуточного слоя маршрутизации](#use-routing-middleware) или в [примере приложения](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/fundamentals/routing/samples).</span><span class="sxs-lookup"><span data-stu-id="777c4-1635">For details, see the sample code in the [Use Routing Middleware](#use-routing-middleware) section or the [sample app](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/fundamentals/routing/samples).</span></span>

<span data-ttu-id="777c4-1636">Второй параметр конструктора <xref:Microsoft.AspNetCore.Routing.VirtualPathContext> — это коллекция *значений окружения*.</span><span class="sxs-lookup"><span data-stu-id="777c4-1636">The second parameter to the <xref:Microsoft.AspNetCore.Routing.VirtualPathContext> constructor is a collection of *ambient values*.</span></span> <span data-ttu-id="777c4-1637">Значения окружения упрощают разработку, ограничивая число значений, которые необходимо указывать в определенном контексте запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1637">Ambient values are convenient to use because they limit the number of values a developer must specify within a request context.</span></span> <span data-ttu-id="777c4-1638">Текущие значения маршрута текущего запроса считаются значениями окружения для создания ссылки.</span><span class="sxs-lookup"><span data-stu-id="777c4-1638">The current route values of the current request are considered ambient values for link generation.</span></span> <span data-ttu-id="777c4-1639">В приложении ASP.NET MVC в действии `About` контроллера `HomeController` не нужно задавать значение маршрута контроллера, указывающее на действие `Index`&mdash; используется значение окружения `Home`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1639">In an ASP.NET Core MVC app's `About` action of the `HomeController`, you don't need to specify the controller route value to link to the `Index` action&mdash;the ambient value of `Home` is used.</span></span>

<span data-ttu-id="777c4-1640">Значения окружения, которые не соответствуют параметру, игнорируются.</span><span class="sxs-lookup"><span data-stu-id="777c4-1640">Ambient values that don't match a parameter are ignored.</span></span> <span data-ttu-id="777c4-1641">Значения окружения также не учитываются, когда явно указанное значение переопределяет значение окружения.</span><span class="sxs-lookup"><span data-stu-id="777c4-1641">Ambient values are also ignored when an explicitly provided value overrides the ambient value.</span></span> <span data-ttu-id="777c4-1642">Сопоставление выполняется слева направо в URL-адресе.</span><span class="sxs-lookup"><span data-stu-id="777c4-1642">Matching occurs from left to right in the URL.</span></span>

<span data-ttu-id="777c4-1643">Явно предоставленные значения, которые не соответствуют сегменту маршрута, добавляются в строку запроса.</span><span class="sxs-lookup"><span data-stu-id="777c4-1643">Values explicitly provided but that don't match a segment of the route are added to the query string.</span></span> <span data-ttu-id="777c4-1644">В приведенной ниже таблице показан результат использования шаблона маршрута `{controller}/{action}/{id?}`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1644">The following table shows the result when using the route template `{controller}/{action}/{id?}`.</span></span>

| <span data-ttu-id="777c4-1645">Значения окружения</span><span class="sxs-lookup"><span data-stu-id="777c4-1645">Ambient Values</span></span>                     | <span data-ttu-id="777c4-1646">Явные значения</span><span class="sxs-lookup"><span data-stu-id="777c4-1646">Explicit Values</span></span>                        | <span data-ttu-id="777c4-1647">Результат</span><span class="sxs-lookup"><span data-stu-id="777c4-1647">Result</span></span>                  |
| ---------------------------------- | -------------------------------------- | ----------------------- |
| <span data-ttu-id="777c4-1648">controller = "Home"</span><span class="sxs-lookup"><span data-stu-id="777c4-1648">controller = "Home"</span></span>                | <span data-ttu-id="777c4-1649">action = "About"</span><span class="sxs-lookup"><span data-stu-id="777c4-1649">action = "About"</span></span>                       | `/Home/About`           |
| <span data-ttu-id="777c4-1650">controller = "Home"</span><span class="sxs-lookup"><span data-stu-id="777c4-1650">controller = "Home"</span></span>                | <span data-ttu-id="777c4-1651">controller = "Order", action = "About"</span><span class="sxs-lookup"><span data-stu-id="777c4-1651">controller = "Order", action = "About"</span></span> | `/Order/About`          |
| <span data-ttu-id="777c4-1652">controller = "Home", color = "Red"</span><span class="sxs-lookup"><span data-stu-id="777c4-1652">controller = "Home", color = "Red"</span></span> | <span data-ttu-id="777c4-1653">action = "About"</span><span class="sxs-lookup"><span data-stu-id="777c4-1653">action = "About"</span></span>                       | `/Home/About`           |
| <span data-ttu-id="777c4-1654">controller = "Home"</span><span class="sxs-lookup"><span data-stu-id="777c4-1654">controller = "Home"</span></span>                | <span data-ttu-id="777c4-1655">action = "About", color = "Red"</span><span class="sxs-lookup"><span data-stu-id="777c4-1655">action = "About", color = "Red"</span></span>        | `/Home/About?color=Red` |

<span data-ttu-id="777c4-1656">Если маршрут имеет значение по умолчанию, которое не соответствует параметру, и это значение предоставлено явным образом, оно должно соответствовать значению по умолчанию:</span><span class="sxs-lookup"><span data-stu-id="777c4-1656">If a route has a default value that doesn't correspond to a parameter and that value is explicitly provided, it must match the default value:</span></span>

```csharp
routes.MapRoute("blog_route", "blog/{*slug}",
    defaults: new { controller = "Blog", action = "ReadPost" });
```

<span data-ttu-id="777c4-1657">Для этого маршрута ссылка будет создана только в том случае, если предоставлены соответствующие значения для `controller` и `action`.</span><span class="sxs-lookup"><span data-stu-id="777c4-1657">Link generation only generates a link for this route when the matching values for `controller` and `action` are provided.</span></span>

## <a name="complex-segments"></a><span data-ttu-id="777c4-1658">Сложные сегменты</span><span class="sxs-lookup"><span data-stu-id="777c4-1658">Complex segments</span></span>

<span data-ttu-id="777c4-1659">Сложные сегменты (например, `[Route("/x{token}y")]`) обрабатываются путем "нежадного" сопоставления литералов справа налево.</span><span class="sxs-lookup"><span data-stu-id="777c4-1659">Complex segments (for example `[Route("/x{token}y")]`) are processed by matching up literals from right to left in a non-greedy way.</span></span> <span data-ttu-id="777c4-1660">Подробные сведения о сопоставлении сложных сегментов см. в [этом коде](https://github.com/dotnet/aspnetcore/blob/v2.2.13/src/Http/Routing/src/Patterns/RoutePatternMatcher.cs#L293).</span><span class="sxs-lookup"><span data-stu-id="777c4-1660">See [this code](https://github.com/dotnet/aspnetcore/blob/v2.2.13/src/Http/Routing/src/Patterns/RoutePatternMatcher.cs#L293) for a detailed explanation of how complex segments are matched.</span></span> <span data-ttu-id="777c4-1661">[Пример кода](https://github.com/dotnet/aspnetcore/blob/v2.2.13/src/Http/Routing/src/Patterns/RoutePatternMatcher.cs#L293) не используется в ASP.NET Core, но он предоставляет подробное объяснение сложных сегментов.</span><span class="sxs-lookup"><span data-stu-id="777c4-1661">The [code sample](https://github.com/dotnet/aspnetcore/blob/v2.2.13/src/Http/Routing/src/Patterns/RoutePatternMatcher.cs#L293) is not used by ASP.NET Core, but it provides a good explanation of complex segments.</span></span>

::: moniker-end
