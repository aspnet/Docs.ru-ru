---
title: Надежные службы gRPC с крайними сроками и отменой
author: jamesnk
description: Узнайте, как создавать надежные службы gRPC с крайними сроками и отменой в .NET.
monikerRange: '>= aspnetcore-3.0'
ms.author: jamesnk
ms.date: 09/07/2020
no-loc:
- appsettings.json
- ASP.NET Core Identity
- cookie
- Cookie
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: grpc/deadlines-cancellation
ms.openlocfilehash: a735ed4d2ca8db1c9b7998acd14f9be761fe7ec6
ms.sourcegitcommit: 3593c4efa707edeaaceffbfa544f99f41fc62535
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/04/2021
ms.locfileid: "93059927"
---
# <a name="reliable-grpc-services-with-deadlines-and-cancellation"></a>Надежные службы gRPC с крайними сроками и отменой

Автор: [Джеймс Ньютон-Кинг](https://twitter.com/jamesnk) (James Newton-King)

Крайние сроки и отмена — это функции, используемые клиентами gRPC для прерывания выполняющихся вызовов. В этой статье описывается, в чем заключается важность крайних сроков и отмены и как использовать их в приложениях .NET gRPC.

## <a name="deadlines"></a>Крайние сроки

Крайний срок позволяет клиенту gRPC указать, как долго он будет ожидать завершения вызова. При наступлении крайнего срока вызов отменяется. Задавать крайний срок важно по той причине, что он ограничивает длительность выполнения вызова. Это позволяет предотвратить бесконечное выполнение служб и исчерпание ресурсов сервера. Крайние сроки — это полезное средство для повышения надежности приложений, поэтому ими не следует пренебрегать.

Настройка крайнего срока:

* Крайний срок настраивается с помощью `CallOptions.Deadline` при выполнении вызова.
* Значение по умолчанию отсутствует. Если крайний срок не указан, время выполнения вызовов gRPC не ограничено.
* Крайний срок — это время в формате UTC. Например, `DateTime.UtcNow.AddSeconds(5)` означает, что крайний срок наступает через 5 секунд от текущего момента.
* Если указано время в прошлом или текущий момент, крайний срок наступает немедленно.
* Крайний срок передается службе вместе с вызовом gRPC и отслеживается независимо клиентом и службой. Возможна ситуация, когда выполнение вызова gRPC завершается на одном компьютере, но к тому времени, когда ответ возвращается клиенту, крайний срок уже истекает.

При наступлении крайнего срока клиент и служба ведут себя по-разному.

* Клиент немедленно прерывает базовый HTTP-запрос и выдает ошибку `DeadlineExceeded`. Клиентское приложение может перехватить ошибку и вывести сообщение об истечении времени ожидания пользователю.
* На сервере выполнение HTTP-запроса прерывается, и вызывается [ServerCallContext.CancellationToken](xref:System.Threading.CancellationToken). Несмотря на то, что HTTP-запрос прерывается, вызов gRPC продолжает выполняться на сервере до тех пор, пока метод не завершит выполнение. Важно передавать токен отмены асинхронным методам, чтобы они отменялись вместе с вызовом. Например, необходимо передавать токен отмены в асинхронные запросы к базе данных и HTTP-запросы. Передача токена отмены позволяет быстро завершить отмененный вызов на сервере и высвободить ресурсы для других вызовов.

Чтобы задать крайний срок для вызова gRPC, настройте `CallOptions.Deadline`:

[!code-csharp[](~/grpc/deadlines-cancellation/deadline-client.cs?highlight=7,12)]

Используйте `ServerCallContext.CancellationToken` в службе gRPC:

[!code-csharp[](~/grpc/deadlines-cancellation/deadline-server.cs?highlight=5)]

### <a name="propagating-deadlines"></a>Распространение крайних сроков

При выполнении вызова gRPC из работающей службы gRPC необходимо распространить крайний срок. Пример:

1. Клиентское приложение вызывает `FrontendService.GetUser` с крайним сроком.
2. `FrontendService` вызывает `UserService.GetUser`. Крайний срок, заданный клиентом, должен быть указан с новым вызовом gRPC.
3. `UserService.GetUser` получает крайний срок. При наступлении крайнего срока время ожидания в клиентском приложении корректно истекает.

В контексте вызова крайний срок указывается с помощью `ServerCallContext.Deadline`:

[!code-csharp[](~/grpc/deadlines-cancellation/deadline-propagate.cs?highlight=7)]

Ручное распространение крайних сроков может быть обременительным. Крайний срок должен быть передан каждому вызову, и легко что-то упустить. Фабрика клиента gRPC позволяет автоматизировать этот процесс. Указание `EnableCallContextPropagation`:

* автоматически распространяет крайний срок и токен отмены на дочерние вызовы;
* является отличным способом обеспечить распространение крайнего срока и отмены в случае со сложными вложенными вызовами gRPC.

[!code-csharp[](~/grpc/deadlines-cancellation/clientfactory-propagate.cs?highlight=6)]

Для получения дополнительной информации см. <xref:grpc/clientfactory#deadline-and-cancellation-propagation>.

## <a name="cancellation"></a>Отмена

Отмена позволяет клиенту gRPC отменять долго выполняющиеся вызовы, которые больше не нужны. Например, когда пользователь посещает страницу на веб-сайте, выполняется вызов gRPC для потоковой передачи обновлений в режиме реального времени. Потоковая передача должна быть отменена, когда пользователь покидает страницу.

Вызов gRPC можно отменить в клиенте путем передачи токена отмены с помощью [CallOptions.CancellationToken](xref:System.Threading.CancellationToken) или вызова `Dispose`.

[!code-csharp[](~/grpc/deadlines-cancellation/cancellation-client.cs?highlight=19)]

Отменяемые службы gRPC должны отвечать указанным ниже требованиям.
* В асинхронные методы должен передаваться `ServerCallContext.CancellationToken`. Отмена асинхронных методов позволяет быстро завершить вызов на сервере.
* Токен отмены должен распространяться на дочерние вызовы. Распространение токена отмены гарантирует, что дочерние вызовы будут отменены вместе с родительскими. [Фабрика клиента gRPC](xref:grpc/clientfactory) и `EnableCallContextPropagation()` автоматически распространяют токен отмены.

## <a name="additional-resources"></a>Дополнительные ресурсы

* <xref:grpc/client>
* <xref:grpc/clientfactory>
