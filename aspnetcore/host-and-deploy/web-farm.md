---
title: Размещение ASP.NET Core в веб-ферме
author: rick-anderson
description: Сведения о размещении нескольких экземпляров приложения ASP.NET Core с общими ресурсами в среде веб-фермы.
monikerRange: '>= aspnetcore-2.1'
ms.author: riande
ms.custom: mvc
ms.date: 01/13/2020
no-loc:
- appsettings.json
- ASP.NET Core Identity
- cookie
- Cookie
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: host-and-deploy/web-farm
ms.openlocfilehash: ee78e80a4eda3089943765700aa6bb62c6c1e07d
ms.sourcegitcommit: 3593c4efa707edeaaceffbfa544f99f41fc62535
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/04/2021
ms.locfileid: "93057522"
---
# <a name="host-aspnet-core-in-a-web-farm"></a>Размещение ASP.NET Core в веб-ферме

Автор: [Крис Росс](https://github.com/Tratcher) (Chris Ross)

*Веб-ферма* — это группа из двух или нескольких веб-серверов (или *узлов*), на которых размещается несколько экземпляров приложения. При поступлении запросов от пользователей на веб-ферму *подсистема балансировки нагрузки* распределяет эти запросы между узлами веб-фермы. Веб-фермы обеспечивают следующие улучшения:

* **Надежность и доступность.** При сбое одного или нескольких узлов подсистема балансировки нагрузки может направлять запросы на другие работающие узлы, чтобы продолжить обработку запросов.
* **Увеличение емкости и повышение производительности.** Несколько узлов могут обрабатывать больше запросов, чем один сервер. Подсистема распределения нагрузки позволяет балансировать нагрузку за счет ее распределения между узлами.
* **Масштабируемость.** Если необходимо увеличить или уменьшить емкость, количество активных узлов можно изменять в соответствии с рабочей нагрузкой. Технологии для размещения веб-ферм, такие как [служба приложений Azure](https://azure.microsoft.com/services/app-service/), могут автоматически добавлять или удалять узлы по запросу системного администратора, а также могут делать это автоматически без вмешательства человека.
* **Удобство поддержки.** Узлы веб-фермы могут использовать набор общих служб, что упрощает управление системой. Например, узлы веб-фермы могут использовать один сервер базы данных и общее расположение в сети для статических ресурсов, таких как изображения и загружаемые файлы.

В этом разделе описаны настройки и зависимости для размещенных в веб-фермах приложений ASP.NET Core, которые зависят от общих ресурсов.

## <a name="general-configuration"></a>Общая конфигурация

<xref:host-and-deploy/index>  
Сведения о настройке сред размещения и развертывании приложений ASP.NET Core. Настройка диспетчера процессов на каждом узле веб-фермы для автоматического запуска и перезапуска приложений. Для каждого узла требуется среда выполнения ASP.NET Core. Дополнительные сведения см. в разделе [Размещение и развертывание ASP.NET Core](xref:host-and-deploy/index).

<xref:host-and-deploy/proxy-load-balancer>  
Сведения о конфигурации приложений, размещаемых за прокси-серверами и подсистемами балансировки нагрузки, которые могут мешать передаче важных сведений в запросах.

<xref:host-and-deploy/azure-apps/index>  
[Служба приложений Azure](https://azure.microsoft.com/services/app-service/) — это [платформа облачных вычислений Microsoft](https://azure.microsoft.com/), предназначенная для размещения веб-приложений, включая ASP.NET Core. Служба приложений — это полностью управляемая платформа, которая обеспечивает автоматическое масштабирование, балансировку нагрузки, исправления и непрерывное развертывание.

## <a name="app-data"></a>Данные приложений

Когда приложение масштабируется до нескольких экземпляров, может возникнуть такое состояние, когда требуется совместное использование на нескольких узлах. Если состояние является временным, рассмотрите возможность совместного использования кэша [IDistributedCache](/dotnet/api/microsoft.extensions.caching.distributed.idistributedcache). Если общее состояние должно сохраняться постоянно, рассмотрите возможность хранения сведений об общем состоянии в базе данных.

## <a name="required-configuration"></a>Необходимая настройка

Для защиты данных и кэширования необходимо настроить приложения, развернутые в веб-ферме.

### <a name="data-protection"></a>Защита данных

[Система защиты данных в ASP.NET Core](xref:security/data-protection/introduction) используется приложениями для защиты данных. Защита данных зависит от набора криптографических ключей, хранящихся в *наборе ключей*. При инициализации системы защиты данных применяются [параметры по умолчанию](xref:security/data-protection/configuration/default-settings), которые предусматривают локальное хранение набора ключей. В соответствии с конфигурацией по умолчанию уникальный набор ключей хранится на каждом узле веб-фермы. Следовательно, узел веб-фермы не может расшифровать данные, зашифрованные с помощью приложения на другом узле. Обычно конфигурация по умолчанию не подходит для размещения приложений в веб-ферме. Кроме использования общего набора ключей можно прибегнуть к варианту, когда запросы пользователей на постоянной основе направляются на один и тот же узел. Дополнительные сведения о настройке системы защиты данных для развертываний в веб-фермах см. в разделе <xref:security/data-protection/configuration/overview>.

### <a name="caching"></a>Кэширование

В среде веб-фермы механизм кэширования должен совместно использовать кэшированные элементы на узлах веб-фермы. Кэширование должно зависеть от общего кэша Redis, общей базы данных SQL Server или пользовательской реализации кэширования, которая совместно использует кэшированные элементы в веб-ферме. Для получения дополнительной информации см. <xref:performance/caching/distributed>.

## <a name="dependent-components"></a>Зависимые компоненты

Для следующих сценариев дополнительная конфигурация не требуется, но они зависят от технологий, которые требуют настройки для веб-ферм.

| Сценарий | Зависит от &hellip; |
| -------- | ------------------- |
| Проверка подлинности | Защита данных (см. раздел <xref:security/data-protection/configuration/overview>).<br><br>Дополнительные сведения см. в разделах <xref:security/authentication/cookie> и <xref:security/cookie-sharing>. |
| Identity | Проверка подлинности и конфигурация базы данных.<br><br>Для получения дополнительной информации см. <xref:security/authentication/identity>. |
| Сеанс | Защита данных (зашифрованные файлы cookie) (см. раздел <xref:security/data-protection/configuration/overview>) и кэширование (см. раздел <xref:performance/caching/distributed>).<br><br>Дополнительные сведения см. в статье [Управление сеансом и состоянием: ASP.NET Core](xref:fundamentals/app-state#session-state). |
| TempData | Защита данных (зашифрованные файлы cookie) (см. в <xref:security/data-protection/configuration/overview>) или в разделе "Сеанс" статьи [Управление сеансом и состоянием: ASP.NET Core](xref:fundamentals/app-state#session-state)).<br><br>Дополнительные сведения см. в статье [Управление сеансом и состоянием: ASP.NET Core](xref:fundamentals/app-state#tempdata). |
| Защита от подделки | Защита данных (см. раздел <xref:security/data-protection/configuration/overview>).<br><br>Для получения дополнительной информации см. <xref:security/anti-request-forgery>. |

## <a name="troubleshoot"></a>Устранение неполадок

### <a name="data-protection-and-caching"></a>Защита и кэширование данных

Если функции защиты данных или кэширования не настроены для среды веб-фермы, при обработке запросов будут периодически возникать ошибки. Это происходит, так как узлы не используют одни и те же ресурсы, а запросы пользователей не всегда перенаправляются на один и тот же узел.

Представьте пользователя, который входит в приложение, используя проверку подлинности с помощью файлов cookie. Пользователь вошел в приложение на одном узле веб-фермы. Если следующий запрос пользователя направляется на тот же узел, на котором был выполнен вход в систему, приложение сможет расшифровать файл cookie проверки подлинности и разрешит доступ к ресурсу приложения. Если же следующий запрос направляется на другой узел, приложение не сможет расшифровать файл cookie проверки подлинности с узла, на котором пользователь вошел в систему, и попытка авторизации для запрашиваемого ресурса будет отклонена.

Если **время от времени** возникают какие-либо из описанных далее симптомов, в большинстве случаев это связано с неправильной конфигурацией функции защиты данных или кэширования для среды веб-фермы.

* Сбои при проверке подлинности — файл cookie проверки подлинности настроен неправильно или не может быть расшифрован. Сбои при попытке использования имен входа для OAuth (Facebook, Майкрософт, Twitter) или OpenIdConnect — попытки завершаются ошибкой "Не удалось выполнить корреляцию".
* Сбои при попытке авторизации — Identity отсутствует.
* Отсутствие данных о состоянии сеанса.
* Удаление кэшированных элементов.
* Сбои свойства TempData.
* Сбои самотестирования при включении питания (POST) — не удается выполнить проверку для защиты от подделки.

Дополнительные сведения о настройке защиты данных для развертываний в веб-фермах см. в разделе <xref:security/data-protection/configuration/overview>. Дополнительные сведения о настройке кэширования для развертываний в веб-фермах см. в здесь: <xref:performance/caching/distributed>.

## <a name="obtain-data-from-apps"></a>Получение данных из приложений

Если фермы веб-приложения способны отвечать на запросы, получите данные о запросе, подключении и дополнительные данные из приложений с помощью встроенного терминала ПО промежуточного слоя. Дополнительные сведения и примеры с кодом см. здесь: <xref:test/troubleshoot#obtain-data-from-an-app>.

## <a name="additional-resources"></a>Дополнительные ресурсы

* [Расширение пользовательских сценариев для Windows](/azure/virtual-machines/extensions/custom-script-windows): скачивает и выполняет сценарии на виртуальных машинах Azure, что удобно для настройки после развертывания и установки программного обеспечения.
* <xref:host-and-deploy/proxy-load-balancer>
 