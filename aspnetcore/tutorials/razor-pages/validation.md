---
title: Часть 8. Добавление проверки
author: rick-anderson
description: Часть 8 серии руководств по Razor Pages.
ms.author: riande
ms.custom: mvc, contperf-fy21q2
ms.date: 09/29/2020
no-loc:
- Index
- appsettings.json
- ASP.NET Core Identity
- cookie
- Cookie
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: tutorials/razor-pages/validation
ms.openlocfilehash: 9774607b641005145bdb1c98d850c9ce79a25476
ms.sourcegitcommit: 3593c4efa707edeaaceffbfa544f99f41fc62535
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/04/2021
ms.locfileid: "97486126"
---
# <a name="part-8-of-tutorial-series-on-no-locrazor-pages"></a>Часть 8 серии руководств по Razor Pages.

Автор: [Рик Андерсон](https://twitter.com/RickAndMSFT) (Rick Anderson)

В этом разделе к модели `Movie` добавляется логика проверки. Правила проверки применяются каждый раз, когда пользователь создает или редактирует фильм.

## <a name="validation"></a>Проверка

Ключевой принцип разработки программного обеспечения называется [DRY](https://wikipedia.org/wiki/Don%27t_repeat_yourself) (от английского "**D** on't **R** epeat **Y** ourself" — не повторяйся). При разработке Razor Pages рекомендуется задавать любые функциональные возможности лишь один раз и затем при необходимости отражать их в рамках всего приложения. Принцип "Не повторяйся" может помочь:

* сократить объем кода в приложении;
* снизить вероятность возникновения ошибки в коде и упростить его тестирование и поддержку.

Ярким примером применения принципа "Не повторяйся" является поддержка проверки, реализуемая в Razor Pages и на платформе Entity Framework:

* Правила проверки декларативно определяются в одном месте, в классе модели.
* Правила применяются по всему приложению.

## <a name="add-validation-rules-to-the-movie-model"></a>Добавление правил проверки к модели фильма

Пространство имен `DataAnnotations` предоставляет:

* Набор встроенных атрибутов проверки, которые декларативно применяются к классу или свойству.
* Атрибуты форматирования (такие как `[DataType]`), которые обеспечивают форматирование и не предназначены для проверки.

Обновите класс `Movie`, чтобы использовать преимущества встроенных атрибутов проверки `[Required]`, `[StringLength]`, `[RegularExpression]` и `[Range]`.

[!code-csharp[](~/tutorials/razor-pages/razor-pages-start/sample/RazorPagesMovie30/Models/MovieDateRatingDA.cs?name=snippet1)]

Атрибуты проверки определяют поведение для свойств модели, к которым они применяются:

* Атрибуты `[Required]` и `[MinimumLength]` означают, что свойство должно иметь значение. Пользователь может свободно вводить пробелы для выполнения этой проверки.
* Атрибут `[RegularExpression]` ограничивает набор допустимых для ввода символов. В приведенном выше коде в `Genre`:

  * должны использоваться только буквы;
  * первая буква должна быть прописной; пробелы, цифры и специальные символы не допускаются.

* `RegularExpression` `Rating`:

  * первый символ должен быть прописной буквой;
  * допускаются специальные символы и цифры, а также последующие пробелы. значение "PG-13" допустимо для рейтинга, но недопустимо для `Genre`;

* атрибут `[Range]` ограничивает значения указанным диапазоном.
* Атрибут `[StringLength]` может задавать максимальную и, при необходимости, минимальную длину строкового свойства.
* Типы значений (например, `decimal`, `int`, `float`, `DateTime`) по своей природе являются обязательными и не требуют атрибута `[Required]`.

Указанные выше правила проверки используются для демонстрации, они не являются оптимальными для рабочей системы. Например, предыдущее исключение не позволяет ввести модель Movie с двумя символами и не допускает специальные знаки в `Genre`.

Наличие правил проверки, которые автоматически применяются ASP.NET Core, помогает:

* повысить степень надежности приложения;
* сократить возможность сохранения недопустимых данных в базе данных.

### <a name="validation-error-ui-in-no-locrazor-pages"></a>Пользовательский интерфейс проверки ошибок в Razor Pages

Запустите приложение и перейдите в раздел "Pages/Movies" (Страницы/фильмы).

Щелкните ссылку **Create New** (Создать). Введите в форму какие-либо недопустимые значения. Если функция проверки jQuery на стороне клиента обнаруживает ошибку, сведения о ней отображаются в соответствующем сообщении.

![Форма просмотра фильма с несколькими ошибками проверки jQuery на стороне клиента](validation/_static/val.png)

[!INCLUDE[](~/includes/localization/currency.md)]

Обратите внимание, что для каждого поля, содержащего недопустимое значение, в форме автоматически отображается сообщение об ошибке проверки. Эти ошибки применяются как на стороне клиента (с помощью JavaScript и jQuery), так и на стороне сервера (если пользователь отключает JavaScript).

Основным преимуществом является то, что на страницах создания или редактирования **не требуется** изменять код. Пользовательский интерфейс проверки активируется после применения к модели атрибутов проверки достоверности. В Razor Pages, создаваемом в рамках этого руководства, правила проверки применяются автоматически (для этого к свойствам класса модели `Movie` применяются атрибуты проверки). При проверке страницы редактирования применяются те же правила.

Данные формы передаются на сервер только после того, как будут устранены все ошибки проверки на стороне клиента. Чтобы убедиться, что данные формы не отправляются, используйте любой из следующих способов.

* Поместите точку останова в метод `OnPostAsync`. Отправьте форму, выбрав **Создать** или **Сохранить**. Точка останова не достигается ни при каких обстоятельствах.
* Используйте [инструмент Fiddler](https://www.telerik.com/fiddler).
* Проследите сетевой трафик с помощью инструментов разработчика для браузера.

### <a name="server-side-validation"></a>Проверка на стороне сервера

Если в браузере отключен JavaScript, форма с ошибками отправляется на сервер.

Реализация проверки на стороне сервера:

1. Отключите JavaScript в браузере. JavaScript можно отключить с помощью средств разработчика в браузере. Если JavaScript невозможно отключить в этом браузере, попробуйте использовать другой браузер.
1. Поместите точку останова в метод `OnPostAsync` страниц создания или редактирования.
1. Отправьте форму с недопустимыми данными.
1. Проверка недопустимого состояния модели:

   ```csharp
    if (!ModelState.IsValid)
    {
       return Page();
    }
   ```
  
Иначе [отключите проверку на стороне клиента на сервере](xref:mvc/models/validation#disable-client-side-validation).

В следующем коде демонстрируется часть страницы *Create.cshtml*, созданной ранее в рамках этого руководства. Она используется на страницах создания и редактирования для выполнения следующих действий:

* Отображения начальной формы.
* Повторного отображения формы в случае ошибки.

[!code-cshtml[](razor-pages-start/sample/RazorPagesMovie/Pages/Movies/Create.cshtml?range=14-20)]

[Вспомогательная функция тега Input](xref:mvc/views/working-with-forms) использует атрибуты [DataAnnotations](/aspnet/mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-6) и создает HTML-атрибуты, необходимые для проверки jQuery на стороне клиента. [Вспомогательная функция тега Validation](xref:mvc/views/working-with-forms#the-validation-tag-helpers) отображает ошибки проверки. Дополнительные сведения см. в разделе [Проверка](xref:mvc/models/validation).

На страницах создания и редактирования не определены правила проверки. Правила проверки и строки ошибок указываются только в классе `Movie`. Они автоматически применяются к Razor Pages, которые редактируют модель `Movie`.

Любые необходимые изменения логики проверки осуществляются исключительно в модели. Проверка применяется согласованно на уровне всего приложения, для чего логика проверки определяется в одном месте. Такой подход позволяет максимально оптимизировать код и упростить его поддержку и обновление.

## <a name="use-datatype-attributes"></a>Использование атрибутов DataType

Проверьте класс `Movie`. В пространстве имен `System.ComponentModel.DataAnnotations` в дополнение к набору встроенных атрибутов проверки предоставляются атрибуты форматирования. Атрибут `[DataType]` применяется к свойствам `ReleaseDate` и `Price`.

[!code-csharp[](razor-pages-start/sample/RazorPagesMovie/Models/MovieDateRatingDA.cs?highlight=2,6&name=snippet2)]

Атрибуты `[DataType]` предоставляют:

* Указания для обработчика представлений для форматирования данных.
* Атрибуты, например `<a>` для URL-адресов и `<a href="mailto:EmailAddress.com">` для электронной почты.

Используйте атрибут `[RegularExpression]` для проверки формата данных. Атрибут `[DataType]` позволяет указать тип данных с более точным определением по сравнению со встроенным типом базы данных. Атрибуты`[DataType]` не предназначены для проверки. В том же приложении отображается только дата (без времени).

Перечисление `DataType` предоставляет множество типов данных, таких как `Date`, `Time`, `PhoneNumber`, `Currency`, `EmailAddress` и т. д. 

Атрибуты `[DataType]`:

* Обеспечивают автоматическое предоставление функций для определенных типов в приложении. Например, можно создавать ссылку `mailto:` для `DataType.EmailAddress`.
* Могут предоставить селектор даты `DataType.Date` в браузерах, поддерживающих HTML5.
* Создают атрибуты HTML 5 `data-`, которые используются браузерами с поддержкой HTML 5.
* **Не предназначены** для проверки.

`DataType.Date` не задает формат отображаемой даты. По умолчанию поле данных отображается с использованием форматов, установленных в параметрах `CultureInfo` сервера.

Требуются заметки к данным `[Column(TypeName = "decimal(18, 2)")]`, чтобы Entity Framework Core корректно сопоставила `Price` с валютой в базе данных. Дополнительные сведения см. в разделе [Типы данных](/ef/core/modeling/relational/data-types).

С помощью атрибута `[DisplayFormat]` можно явно указать формат даты:

```csharp
[DisplayFormat(DataFormatString = "{0:yyyy-MM-dd}", ApplyFormatInEditMode = true)]
public DateTime ReleaseDate { get; set; }
```

Параметр `ApplyFormatInEditMode` указывает, что при отображении значения для редактирования будет применяться форматирование. Это поведение может быть нежелательным для некоторых полей. Например, в полях валюты в пользовательском интерфейсе редактирования использовать символ денежной единицы, как правило, не требуется.

Атрибут `[DisplayFormat]` может использоваться отдельно, однако чаще всего его рекомендуется применять вместе с атрибутом `[DataType]`. Атрибут `[DataType]` передает семантику данных (в отличие от способа их вывода на экран). Атрибут `[DataType]` дает следующие преимущества, недоступные в `[DisplayFormat]`:

* Поддержка функций HTML5 в браузере, например отображение элемента управления календарем, соответствующего языковому стандарту символа валюты, ссылок электронной почты и т. д.
* По умолчанию формат отображения данных в браузере определяется в соответствии с установленным языковым стандартом.
* Атрибут `[DataType]` обеспечивает поддержку платформы ASP.NET Core для выбора соответствующего шаблона поля, применяемого при отображении данных. При отдельном использовании атрибут `DisplayFormat` базируется на строковом шаблоне.

**Примечание**. Проверка jQuery не работает с атрибутом `[Range]` и `DateTime`. Например, следующий код всегда приводит к возникновению ошибки проверки на стороне клиента, даже если дата попадает в указанный диапазон:

```csharp
[Range(typeof(DateTime), "1/1/1966", "1/1/2020")]
   ```

Лучшей методикой будет не компилировать модели с фиксированными датами, поэтому использовать атрибуты `[Range]` и `DateTime` следует крайне осторожно. Используйте [конфигурацию](xref:fundamentals/configuration/index) для диапазонов дат и других значений, подверженных частым изменениям, а не указывайте их в коде.

В следующем коде демонстрируется объединение атрибутов в одной строке:

[!code-csharp[](razor-pages-start/sample/RazorPagesMovie30/Models/MovieDateRatingDAmult.cs?name=snippet1)]

Дополнительные операции EF Core с Razor Pages см. в статье [Начало работы с Razor Pages и EF Core](xref:data/ef-rp/intro).

### <a name="apply-migrations"></a>Применение миграции

DataAnnotation, примененные к классу, изменяют схему. Например, DataAnnotation, примеренные к полю `Title`, выполняют следующее:

[!code-csharp[](razor-pages-start/sample/RazorPagesMovie30/Models/MovieDateRatingDA.cs?name=snippet11)]

* ограничивают число символов до 60;
* не допускают значение `null`.

# <a name="visual-studio"></a>[Visual Studio](#tab/visual-studio)

Сейчас таблица `Movie` имеет следующую схему:

```sql
CREATE TABLE [dbo].[Movie] (
    [ID]          INT             IDENTITY (1, 1) NOT NULL,
    [Title]       NVARCHAR (MAX)  NULL,
    [ReleaseDate] DATETIME2 (7)   NOT NULL,
    [Genre]       NVARCHAR (MAX)  NULL,
    [Price]       DECIMAL (18, 2) NOT NULL,
    [Rating]      NVARCHAR (MAX)  NULL,
    CONSTRAINT [PK_Movie] PRIMARY KEY CLUSTERED ([ID] ASC)
);
```

Предыдущие изменения схемы не приводят к созданию исключения EF. Но следует создать миграцию, чтобы схема соответствовала модели.

В меню **Сервис** последовательно выберите пункты **Диспетчер пакетов NuGet > Консоль диспетчера пакетов**.
В PMC введите следующие команды:

```powershell
Add-Migration New_DataAnnotations
Update-Database
```

`Update-Database` выполняет методы `Up` класса `New_DataAnnotations`. Проверьте метод `Up`.

[!code-csharp[](razor-pages-start/sample/RazorPagesMovie30/Migrations/20190724163003_New_DataAnnotations.cs?name=snippet)]

Обновленная таблица `Movie` имеет следующую схему:

```sql
CREATE TABLE [dbo].[Movie] (
    [ID]          INT             IDENTITY (1, 1) NOT NULL,
    [Title]       NVARCHAR (60)   NOT NULL,
    [ReleaseDate] DATETIME2 (7)   NOT NULL,
    [Genre]       NVARCHAR (30)   NOT NULL,
    [Price]       DECIMAL (18, 2) NOT NULL,
    [Rating]      NVARCHAR (5)    NOT NULL,
    CONSTRAINT [PK_Movie] PRIMARY KEY CLUSTERED ([ID] ASC)
);
```

# <a name="visual-studio-code--visual-studio-for-mac"></a>[Visual Studio Code/Visual Studio для Mac](#tab/visual-studio-code+visual-studio-mac)

Для SQLite миграция не требуется.

---

### <a name="publish-to-azure"></a>Публикация в Azure

Сведения о развертывании в Azure, см. в разделе [Учебник: Создание приложения ASP.NET Core в Azure с подключением к базе данных SQL](/azure/app-service/tutorial-dotnetcore-sqldb-app).

Благодарим вас за изучение общих сведений о страницах Razor. Отличным дополнением к этому руководству является руководство по [началу работы с Razor Pages и EF Core](xref:data/ef-rp/intro).

## <a name="additional-resources"></a>Дополнительные ресурсы

* <xref:mvc/views/working-with-forms>
* <xref:fundamentals/localization>
* <xref:mvc/views/tag-helpers/intro>
* <xref:mvc/views/tag-helpers/authoring>

> [!div class="step-by-step"]
> [Предыдущая статья. Добавление нового поля](xref:tutorials/razor-pages/new-field)
