---
title: Миграция с ASP.NET Core 3,1 на 5,0
author: scottaddie
description: Узнайте, как перенести проект ASP.NET Core 3,1 в ASP.NET Core 5,0.
ms.author: scaddie
ms.custom: mvc
ms.date: 11/17/2020
no-loc:
- appsettings.json
- ASP.NET Core Identity
- cookie
- Cookie
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: migration/31-to-50
ms.openlocfilehash: ea746d0b5292841b0a36f4deaded8fbae8472220
ms.sourcegitcommit: 54fdca99f30b18d69cf0753ca3c84c7dab8f2b0e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/17/2020
ms.locfileid: "94691187"
---
# <a name="migrate-from-aspnet-core-31-to-50"></a><span data-ttu-id="ee0c6-103">Миграция с ASP.NET Core 3,1 на 5,0</span><span class="sxs-lookup"><span data-stu-id="ee0c6-103">Migrate from ASP.NET Core 3.1 to 5.0</span></span>

<span data-ttu-id="ee0c6-104">Автор: [Скотт Адди](https://github.com/scottaddie) (Scott Addie)</span><span class="sxs-lookup"><span data-stu-id="ee0c6-104">By [Scott Addie](https://github.com/scottaddie)</span></span>

<span data-ttu-id="ee0c6-105">В этой статье объясняется, как обновить существующий проект ASP.NET Core 3,1 до ASP.NET Core 5,0.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-105">This article explains how to update an existing ASP.NET Core 3.1 project to ASP.NET Core 5.0.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="ee0c6-106">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="ee0c6-106">Prerequisites</span></span>

# <a name="visual-studio"></a>[<span data-ttu-id="ee0c6-107">Visual Studio</span><span class="sxs-lookup"><span data-stu-id="ee0c6-107">Visual Studio</span></span>](#tab/visual-studio)

[!INCLUDE[](~/includes/net-core-prereqs-vs-5.0.md)]

# <a name="visual-studio-code"></a>[<span data-ttu-id="ee0c6-108">Visual Studio Code</span><span class="sxs-lookup"><span data-stu-id="ee0c6-108">Visual Studio Code</span></span>](#tab/visual-studio-code)

[!INCLUDE[](~/includes/net-core-prereqs-vsc-5.0.md)]

# <a name="visual-studio-for-mac"></a>[<span data-ttu-id="ee0c6-109">Visual Studio для Mac</span><span class="sxs-lookup"><span data-stu-id="ee0c6-109">Visual Studio for Mac</span></span>](#tab/visual-studio-mac)

[!INCLUDE[](~/includes/net-core-prereqs-mac-5.0.md)]

---

## <a name="update-net-core-sdk-version-in-globaljson"></a><span data-ttu-id="ee0c6-110">Обновление версии пакета SDK для .NET Core в файле global.json</span><span class="sxs-lookup"><span data-stu-id="ee0c6-110">Update .NET Core SDK version in global.json</span></span>

<span data-ttu-id="ee0c6-111">Если вы полагаетесь на [global.js](/dotnet/core/tools/global-json) файла для конкретной версии пакет SDK для .NET Core, обновите `version` свойство до установленной версии пакета SDK для .NET 5,0.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-111">If you rely upon a [global.json](/dotnet/core/tools/global-json) file to target a specific .NET Core SDK version, update the `version` property to the .NET 5.0 SDK version that's installed.</span></span> <span data-ttu-id="ee0c6-112">Пример:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-112">For example:</span></span>

```diff
{
  "sdk": {
-    "version": "3.1.200"
+    "version": "5.0.100"
  }
}
```

## <a name="update-the-target-framework"></a><span data-ttu-id="ee0c6-113">Обновление целевой платформы</span><span class="sxs-lookup"><span data-stu-id="ee0c6-113">Update the target framework</span></span>

<span data-ttu-id="ee0c6-114">При обновлении Blazor WebAssembly проекта перейдите к разделу [Обновление Blazor WebAssembly проектов](#update-blazor-webassembly-projects) .</span><span class="sxs-lookup"><span data-stu-id="ee0c6-114">If updating a Blazor WebAssembly project, skip to the [Update Blazor WebAssembly projects](#update-blazor-webassembly-projects) section.</span></span> <span data-ttu-id="ee0c6-115">Для любого другого типа проекта ASP.NET Core обновите [моникер целевой платформы файла проекта (TFM)](/dotnet/standard/frameworks) `net5.0` следующим образом:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-115">For any other ASP.NET Core project type, update the project file's [Target Framework Moniker (TFM)](/dotnet/standard/frameworks) to `net5.0`:</span></span>

```diff
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
-    <TargetFramework>netcoreapp3.1</TargetFramework>
+    <TargetFramework>net5.0</TargetFramework>
  </PropertyGroup>

</Project>
```

## <a name="update-no-locblazor-webassembly-and-no-locblazor-server-projects"></a><span data-ttu-id="ee0c6-116">Обновление Blazor WebAssembly и Blazor Server проекты</span><span class="sxs-lookup"><span data-stu-id="ee0c6-116">Update Blazor WebAssembly and Blazor Server projects</span></span>

<span data-ttu-id="ee0c6-117">*Рекомендации в этом разделе относятся к Blazor моделям размещения. В разделах, следующих за этим разделом, приведены дополнительные рекомендации, относящиеся к размещению моделей и типов приложений. Примените гуиднаце из всех соответствующих разделов к приложению.*</span><span class="sxs-lookup"><span data-stu-id="ee0c6-117">*The guidance in this section applies to both Blazor hosting models. Sections following this section provide additional guidance specific to hosting models and app types. Apply the guidnace from all relevant sections to your app.*</span></span>

1. <span data-ttu-id="ee0c6-118">В `wwwroot/index.html` Blazor WebAssembly приложении или в `Pages/_Host.cshtml` Blazor Server приложении добавьте `<link>` элемент в `<head>` элемент для стилей.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-118">In `wwwroot/index.html` of a Blazor WebAssembly app or the `Pages/_Host.cshtml` of a Blazor Server app, add a `<link>` element to the `<head>` element for styles.</span></span> <span data-ttu-id="ee0c6-119">В следующих `<link>` `href` значениях атрибута element заполнителем `{ASSEMBLY NAME}` является имя сборки приложения.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-119">In the following `<link>` element `href` attribute values, the placeholder `{ASSEMBLY NAME}` is the app's assembly name.</span></span>

    ```diff
    +<link href="{ASSEMBLY NAME}.styles.css" rel="stylesheet" />
    ```
    
    <span data-ttu-id="ee0c6-120">Автономный Blazor WebAssembly или Blazor Server Пример:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-120">Standalone Blazor WebAssembly or Blazor Server example:</span></span>
    
    ```diff
    +<link href="BlazorSample.styles.css" rel="stylesheet" />
    ```

    <span data-ttu-id="ee0c6-121">*`Client`* Пример проекта размещенного Blazor WebAssembly решения:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-121">*`Client`* project of a hosted Blazor WebAssembly solution example:</span></span>
    
    ```diff
    +<link href="BlazorSample.Client.styles.css" rel="stylesheet" />
    ```

1. <span data-ttu-id="ee0c6-122">Включите новое пространство имен в `_Imports.razor` файл приложения для [виртуализации компонентов](xref:blazor/components/virtualization) <xref:Microsoft.AspNetCore.Components.Web.Virtualization?displayProperty=fullName> .</span><span class="sxs-lookup"><span data-stu-id="ee0c6-122">Include a new namespace in the app's `_Imports.razor` file for [component virtualization](xref:blazor/components/virtualization), <xref:Microsoft.AspNetCore.Components.Web.Virtualization?displayProperty=fullName>.</span></span> <span data-ttu-id="ee0c6-123">В следующих `_Imports.razor` файлах показаны пространства имен по умолчанию в приложениях, созданных из Blazor шаблонов проектов.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-123">The following `_Imports.razor` files show the default namespaces in apps generated from the Blazor project templates.</span></span> <span data-ttu-id="ee0c6-124">Заполнитель `{ASSEMBLY NAME}` — это имя сборки приложения.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-124">The placeholder `{ASSEMBLY NAME}` is the app's assembly name.</span></span>

   <span data-ttu-id="ee0c6-125">Blazor WebAssembly (`_Imports.razor`):</span><span class="sxs-lookup"><span data-stu-id="ee0c6-125">Blazor WebAssembly (`_Imports.razor`):</span></span>
   
   ```razor
   @using System.Net.Http
   @using System.Net.Http.Json
   @using Microsoft.AspNetCore.Components.Forms
   @using Microsoft.AspNetCore.Components.Routing
   @using Microsoft.AspNetCore.Components.Web
   @using Microsoft.AspNetCore.Components.Web.Virtualization
   @using Microsoft.AspNetCore.Components.WebAssembly.Http
   @using Microsoft.JSInterop
   @using {ASSEMBLY NAME}
   @using {ASSEMBLY NAME}.Shared
   ```

   <span data-ttu-id="ee0c6-126">Blazor Server (`_Imports.razor`):</span><span class="sxs-lookup"><span data-stu-id="ee0c6-126">Blazor Server (`_Imports.razor`):</span></span>
   
   ```razor
   @using System.Net.Http
   @using Microsoft.AspNetCore.Authorization
   @using Microsoft.AspNetCore.Components.Authorization
   @using Microsoft.AspNetCore.Components.Forms
   @using Microsoft.AspNetCore.Components.Routing
   @using Microsoft.AspNetCore.Components.Web
   @using Microsoft.AspNetCore.Components.Web.Virtualization
   @using Microsoft.JSInterop
   @using {ASSEMBLY NAME}
   @using {ASSEMBLY NAME}.Shared
   ```
   
1. <span data-ttu-id="ee0c6-127">В `MainLayout` компоненте ( `Shared/MainLayout.razor` ) заключите разметку HTML компонента в `<div>` элемент, атрибут которого имеет `class` значение `page` :</span><span class="sxs-lookup"><span data-stu-id="ee0c6-127">In the `MainLayout` component (`Shared/MainLayout.razor`), surround the component's HTML markup with a `<div>` element that has a `class` attribute set to `page`:</span></span>

    ```razor
    <div class="page">
    
        ...
        
    </div>
    ```
    
1. <span data-ttu-id="ee0c6-128">Добавьте в папку следующие файлы `Shared` :</span><span class="sxs-lookup"><span data-stu-id="ee0c6-128">Add the following files to the `Shared` folder:</span></span>

    <span data-ttu-id="ee0c6-129">`MainLayout.razor.css`:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-129">`MainLayout.razor.css`:</span></span>
    
    ```css
    .page {
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .main {
        flex: 1;
    }

    .sidebar {
        background-image: linear-gradient(180deg, rgb(5, 39, 103) 0%, #3a0647 70%);
    }

    .top-row {
        background-color: #f7f7f7;
        border-bottom: 1px solid #d6d5d5;
        justify-content: flex-end;
        height: 3.5rem;
        display: flex;
        align-items: center;
    }

        .top-row ::deep a, .top-row .btn-link {
            white-space: nowrap;
            margin-left: 1.5rem;
        }

        .top-row a:first-child {
            overflow: hidden;
            text-overflow: ellipsis;
        }

    @media (max-width: 767.98px) {
        .top-row:not(.auth) {
            display: none;
        }

        .top-row.auth {
            justify-content: space-between;
        }

        .top-row a, .top-row .btn-link {
            margin-left: 0;
        }
    }

    @media (min-width: 768px) {
        .page {
            flex-direction: row;
        }

        .sidebar {
            width: 250px;
            height: 100vh;
            position: sticky;
            top: 0;
        }

        .top-row {
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .main > div {
            padding-left: 2rem !important;
            padding-right: 1.5rem !important;
        }
    }
    ```
    
    <span data-ttu-id="ee0c6-130">`NavMenu.razor.css`:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-130">`NavMenu.razor.css`:</span></span>
    
    ```css
    .navbar-toggler {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .top-row {
        height: 3.5rem;
        background-color: rgba(0,0,0,0.4);
    }

    .navbar-brand {
        font-size: 1.1rem;
    }

    .oi {
        width: 2rem;
        font-size: 1.1rem;
        vertical-align: text-top;
        top: -2px;
    }

    .nav-item {
        font-size: 0.9rem;
        padding-bottom: 0.5rem;
    }

        .nav-item:first-of-type {
            padding-top: 1rem;
        }

        .nav-item:last-of-type {
            padding-bottom: 1rem;
        }

        .nav-item ::deep a {
            color: #d7d7d7;
            border-radius: 4px;
            height: 3rem;
            display: flex;
            align-items: center;
            line-height: 3rem;
        }

    .nav-item ::deep a.active {
        background-color: rgba(255,255,255,0.25);
        color: white;
    }

    .nav-item ::deep a:hover {
        background-color: rgba(255,255,255,0.1);
        color: white;
    }

    @media (min-width: 768px) {
        .navbar-toggler {
            display: none;
        }

        .collapse {
            /* Never collapse the sidebar for wide screens */
            display: block;
        }
    }
    ```

1. <span data-ttu-id="ee0c6-131">Последний базовый `wwwroot/css/app.css` файл Blazor WebAssembly приложения или `wwwroot/css/site.css` файла Blazor Server приложения содержит следующие стили.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-131">The latest base `wwwroot/css/app.css` file of a Blazor WebAssembly app or `wwwroot/css/site.css` file of a Blazor Server app includes the following styles.</span></span> <span data-ttu-id="ee0c6-132">Удалите дополнительные стили, в которых находятся следующие стили и все, что вы добавили в приложение.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-132">Remove extra styles leaving the following styles and any that you've added to the app.</span></span>

    <span data-ttu-id="ee0c6-133">Следующая таблица стилей содержит только базовые стили и не **включает пользовательские** стили, добавленные разработчиком:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-133">The following stylesheet only includes base styles and does **not** include custom styles added by the developer:</span></span>
   
    ```css
    @import url('open-iconic/font/css/open-iconic-bootstrap.min.css');

    html, body {
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    a, .btn-link {
        color: #0366d6;
    }

    .btn-primary {
        color: #fff;
        background-color: #1b6ec2;
        border-color: #1861ac;
    }

    .content {
        padding-top: 1.1rem;
    }

    .valid.modified:not([type=checkbox]) {
        outline: 1px solid #26b050;
    }

    .invalid {
        outline: 1px solid red;
    }

    .validation-message {
        color: red;
    }

    #blazor-error-ui {
        background: lightyellow;
        bottom: 0;
        box-shadow: 0 -1px 2px rgba(0, 0, 0, 0.2);
        display: none;
        left: 0;
        padding: 0.6rem 1.25rem 0.7rem 1.25rem;
        position: fixed;
        width: 100%;
        z-index: 1000;
    }

    #blazor-error-ui .dismiss {
        cursor: pointer;
        position: absolute;
        right: 0.75rem;
        top: 0.5rem;
    }
    ```

## <a name="update-no-locblazor-webassembly-projects"></a><span data-ttu-id="ee0c6-134">Обновление Blazor WebAssembly проектов</span><span class="sxs-lookup"><span data-stu-id="ee0c6-134">Update Blazor WebAssembly projects</span></span>

<span data-ttu-id="ee0c6-135">Для Blazor WebAssembly проекта, включая *`Client`* проект размещенного Blazor решения, внесите в файл проекта следующие изменения:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-135">For a Blazor WebAssembly project, including the *`Client`* project of a hosted Blazor solution, apply the following changes to the project file:</span></span>

1. <span data-ttu-id="ee0c6-136">Обновите пакет SDK с `Microsoft.NET.Sdk.Web` на `Microsoft.NET.Sdk.BlazorWebAssembly` :</span><span class="sxs-lookup"><span data-stu-id="ee0c6-136">Update the SDK from `Microsoft.NET.Sdk.Web` to `Microsoft.NET.Sdk.BlazorWebAssembly`:</span></span>

    ```diff
    - <Project Sdk="Microsoft.NET.Sdk.Web">
    + <Project Sdk="Microsoft.NET.Sdk.BlazorWebAssembly">
    ```
    
    > [!NOTE]
    > <span data-ttu-id="ee0c6-137">Это обновление применяется только к отдельным Blazor WebAssembly проектам и *`Client`* проектам размещенных Blazor решений.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-137">This update only applies to standalone Blazor WebAssembly projects and the *`Client`* projects of hosted Blazor solutions.</span></span>

1. <span data-ttu-id="ee0c6-138">Обновите следующие свойства:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-138">Update the following properties:</span></span>

    ```diff
    <Project Sdk="Microsoft.NET.Sdk.BlazorWebAssembly">
    
      <PropertyGroup>
    -     <TargetFramework>netstandard2.1</TargetFramework>
    -     <RazorLangVersion>3.0</RazorLangVersion>
    +     <TargetFramework>net5.0</TargetFramework>
      </PropertyGroup>
    ```

1. <span data-ttu-id="ee0c6-139">Удалите ссылку на пакет в [Microsoft. AspNetCore. Components. Assembly. Build](https://www.nuget.org/packages/Microsoft.AspNetCore.Components.WebAssembly.Build):</span><span class="sxs-lookup"><span data-stu-id="ee0c6-139">Remove the package reference to [Microsoft.AspNetCore.Components.WebAssembly.Build](https://www.nuget.org/packages/Microsoft.AspNetCore.Components.WebAssembly.Build):</span></span>

    ```diff
    <ItemGroup>
    -    <PackageReference Include="Microsoft.AspNetCore.Components.WebAssembly.Build" Version="3.2.1" PrivateAssets="all" />
    ```

1. <span data-ttu-id="ee0c6-140">Обновите другие пакеты до их последних версий.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-140">Update other packages to their latest versions.</span></span> <span data-ttu-id="ee0c6-141">Последние версии можно найти по адресу [NuGet.org](https://www.nuget.org).</span><span class="sxs-lookup"><span data-stu-id="ee0c6-141">The latest versions can be found at [NuGet.org](https://www.nuget.org).</span></span>

1. <span data-ttu-id="ee0c6-142">В `wwwroot/index.html` измените элемент, загружающий `App` компонент:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-142">In `wwwroot/index.html`, change the element that loads the `App` component:</span></span>
    
    ```diff
    -<app>Loading...</app>
    +<app id="app">Loading...</app>
    ```
    
1. <span data-ttu-id="ee0c6-143">В `Program.Main` (`Program.cs`):</span><span class="sxs-lookup"><span data-stu-id="ee0c6-143">In `Program.Main` (`Program.cs`):</span></span>

   * <span data-ttu-id="ee0c6-144">Измените ссылку на `<app>` элемент на селектор CSS, добавив в `#` него хэш.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-144">Change the reference to the `<app>` element to a CSS selector by adding a hash `#` to it.</span></span>
   * <span data-ttu-id="ee0c6-145">Измените `HttpClient` регистрацию на область.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-145">Change the `HttpClient` registration to scoped.</span></span>

    ```diff
    -builder.RootComponents.Add<App>("app");
    +builder.RootComponents.Add<App>("#app");
    
    -builder.Services.AddTransient(sp => new HttpClient 
    -    { BaseAddress = new Uri(builder.HostEnvironment.BaseAddress) });
    +builder.Services.AddScoped(sp => new HttpClient 
    +    { BaseAddress = new Uri(builder.HostEnvironment.BaseAddress) });
    ```

### <a name="standalone-no-locblazor-webassembly-app-with-microsoft-accounts"></a><span data-ttu-id="ee0c6-146">Автономное Blazor WebAssembly приложение с учетными записями Майкрософт</span><span class="sxs-lookup"><span data-stu-id="ee0c6-146">Standalone Blazor WebAssembly app with Microsoft Accounts</span></span>

<span data-ttu-id="ee0c6-147">Для автономного Blazor WebAssembly приложения, зарегистрированного в портал Azure для использования Azure Active Directory (AAD) для учетных записей Майкрософт:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-147">For a standalone Blazor WebAssembly app registered in the Azure portal to use Azure Active Directory (AAD) for Microsoft Accounts:</span></span>

* <span data-ttu-id="ee0c6-148">Для приложения требуются `openid` области и `offline_access` :</span><span class="sxs-lookup"><span data-stu-id="ee0c6-148">The app requires the `openid` and `offline_access` scopes:</span></span>

  ```csharp
  options.ProviderOptions.DefaultAccessTokenScopes.Add("openid");
  options.ProviderOptions.DefaultAccessTokenScopes.Add("offline_access");
  ```
  
* <span data-ttu-id="ee0c6-149">В колонке портал Azure **проверки подлинности** регистрации приложений задайте для параметра Конфигурация платформы **одностраничное приложение** с URI перенаправления приложения.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-149">In the Azure portal app registration **Authentication** blade, set the platform configuration to **Single-page application** with the app's redirect URI.</span></span>

* <span data-ttu-id="ee0c6-150">Кроме того, в колонке **Проверка подлинности** отключите **неявное предоставление** для **маркеров доступа** и **маркеров идентификации**.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-150">Also in the **Authentication** blade, disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>

<span data-ttu-id="ee0c6-151">Для получения дополнительной информации см. <xref:blazor/security/webassembly/standalone-with-microsoft-accounts>.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-151">For more information, see <xref:blazor/security/webassembly/standalone-with-microsoft-accounts>.</span></span>

### <a name="standalone-no-locblazor-webassembly-app-with-azure-active-directory-aad"></a><span data-ttu-id="ee0c6-152">Автономное Blazor WebAssembly приложение с Azure Active Directory (AAD)</span><span class="sxs-lookup"><span data-stu-id="ee0c6-152">Standalone Blazor WebAssembly app with Azure Active Directory (AAD)</span></span>

<span data-ttu-id="ee0c6-153">Для автономного Blazor WebAssembly приложения, зарегистрированного в портал Azure для использования Azure Active Directory (AAD):</span><span class="sxs-lookup"><span data-stu-id="ee0c6-153">For a standalone Blazor WebAssembly app registered in the Azure portal to use Azure Active Directory (AAD):</span></span>

* <span data-ttu-id="ee0c6-154">Для приложения требуется `https://graph.microsoft.com/User.Read` область:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-154">The app requires the `https://graph.microsoft.com/User.Read` scope:</span></span>

  ```csharp
  options.ProviderOptions.DefaultAccessTokenScopes
      .Add("https://graph.microsoft.com/User.Read");
  ```
  
* <span data-ttu-id="ee0c6-155">В колонке портал Azure **проверки подлинности** регистрации приложений задайте для параметра Конфигурация платформы **одностраничное приложение** с URI перенаправления приложения.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-155">In the Azure portal app registration **Authentication** blade, set the platform configuration to **Single-page application** with the app's redirect URI.</span></span>

* <span data-ttu-id="ee0c6-156">Кроме того, в колонке **Проверка подлинности** отключите **неявное предоставление** для **маркеров доступа** и **маркеров идентификации**.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-156">Also in the **Authentication** blade, disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>
  
<span data-ttu-id="ee0c6-157">Для получения дополнительной информации см. <xref:blazor/security/webassembly/standalone-with-azure-active-directory>.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-157">For more information, see <xref:blazor/security/webassembly/standalone-with-azure-active-directory>.</span></span>

### <a name="standalone-no-locblazor-app-with-azure-active-directory-aad-b2c"></a><span data-ttu-id="ee0c6-158">Автономное Blazor приложение с Azure Active Directory (AAD) B2C</span><span class="sxs-lookup"><span data-stu-id="ee0c6-158">Standalone Blazor app with Azure Active Directory (AAD) B2C</span></span>

<span data-ttu-id="ee0c6-159">Для автономного Blazor WebAssembly приложения, зарегистрированного в портал Azure для использования Azure Active Directory (AAD) B2C:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-159">For a standalone Blazor WebAssembly app registered in the Azure portal to use Azure Active Directory (AAD) B2C:</span></span>

* <span data-ttu-id="ee0c6-160">Для приложения требуются `openid` области и `offline_access` :</span><span class="sxs-lookup"><span data-stu-id="ee0c6-160">The app requires the `openid` and `offline_access` scopes:</span></span>

  ```csharp
  options.ProviderOptions.DefaultAccessTokenScopes.Add("openid");
  options.ProviderOptions.DefaultAccessTokenScopes.Add("offline_access");
  ```
  
* <span data-ttu-id="ee0c6-161">В колонке портал Azure **проверки подлинности** регистрации приложений задайте для параметра Конфигурация платформы **одностраничное приложение** с URI перенаправления приложения.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-161">In the Azure portal app registration **Authentication** blade, set the platform configuration to **Single-page application** with the app's redirect URI.</span></span>

* <span data-ttu-id="ee0c6-162">Кроме того, в колонке **Проверка подлинности** отключите **неявное предоставление** для **маркеров доступа** и **маркеров идентификации**.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-162">Also in the **Authentication** blade, disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>

<span data-ttu-id="ee0c6-163">Для получения дополнительной информации см. <xref:blazor/security/webassembly/standalone-with-azure-active-directory-b2c>.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-163">For more information, see <xref:blazor/security/webassembly/standalone-with-azure-active-directory-b2c>.</span></span>

### <a name="hosted-no-locblazor-webassembly-app-with-azure-active-directory-aad-or-b2c"></a><span data-ttu-id="ee0c6-164">Размещенное Blazor WebAssembly приложение с Azure Active Directory (AAD) или B2C</span><span class="sxs-lookup"><span data-stu-id="ee0c6-164">Hosted Blazor WebAssembly app with Azure Active Directory (AAD) or B2C</span></span>

<span data-ttu-id="ee0c6-165">*`Client`* Регистрация приложения размещенного Blazor решения, использующего AAD или AAD B2C для проверки подлинности пользователей, должно использовать конфигурацию платформы приложений Azure с **одной страницей** :</span><span class="sxs-lookup"><span data-stu-id="ee0c6-165">The *`Client`* app registration of a hosted Blazor solution that uses AAD or AAD B2C for user authentication should use a **Single-page application** Azure Apps platform configuration:</span></span>

1. <span data-ttu-id="ee0c6-166">В портал Azure регистрации приложения *`Client`* удалите конфигурацию **веб-** платформы.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-166">In the Azure portal app registration for the *`Client`* app, remove the **Web** platform configuration.</span></span>
1. <span data-ttu-id="ee0c6-167">Добавьте конфигурацию платформы **одностраничного приложения** с URI перенаправления приложения.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-167">Add a **Single-page application** platform configuration with the app's redirect URI.</span></span>
1. <span data-ttu-id="ee0c6-168">Отключите **неявное предоставление** для **маркеров доступа** и **маркеров идентификации**.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-168">Disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>

<span data-ttu-id="ee0c6-169">Дополнительные сведения см. в разделе:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-169">For more information, see:</span></span>

* <xref:blazor/security/webassembly/hosted-with-azure-active-directory>
* <xref:blazor/security/webassembly/hosted-with-azure-active-directory-b2c>

### <a name="update-the-server-project-of-a-hosted-no-locblazor-solution"></a><span data-ttu-id="ee0c6-170">Обновление серверного проекта размещенного Blazor решения</span><span class="sxs-lookup"><span data-stu-id="ee0c6-170">Update the Server project of a hosted Blazor solution</span></span>

<span data-ttu-id="ee0c6-171">Обновите *`Server`* проект размещенного Blazor решения как приложение ASP.NET Core, следуя общим рекомендациям в этой статье.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-171">Update the *`Server`* project of a hosted Blazor solution as an ASP.NET Core app following the general guidance in this article.</span></span>

<span data-ttu-id="ee0c6-172">Кроме того, *`Server`* проекты, которые выполняют проверку подлинности пользователей в клиентских Blazor WebAssembly приложениях с помощью Azure Active Directory (AAD) или B2C, должны внедрять новые Identity пакеты Microsoft v 2.0:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-172">Additionally, *`Server`* projects that authenticate users to client Blazor WebAssembly apps with Azure Active Directory (AAD) or B2C should adopt new Microsoft Identity v2.0 packages:</span></span> 
  
<span data-ttu-id="ee0c6-173">Для AAD:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-173">For AAD:</span></span>

```diff
-<PackageReference Include="Microsoft.AspNetCore.Authentication.AzureAD.UI" Version="..." />
+<PackageReference Include="Microsoft.Identity.Web" Version="1.2.0" />
+<PackageReference Include="Microsoft.Identity.Web.UI" Version="1.2.0" />
```

<span data-ttu-id="ee0c6-174">Для AAD B2C:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-174">For AAD B2C:</span></span>

```diff
-<PackageReference Include="Microsoft.AspNetCore.Authentication.AzureADB2C.UI" Version="..." />
+<PackageReference Include="Microsoft.Identity.Web" Version="1.2.0" />
+<PackageReference Include="Microsoft.Identity.Web.UI" Version="1.2.0" />
```

> [!NOTE]
> <span data-ttu-id="ee0c6-175">Пакет SDK *`Server`* проекта в размещенном Blazor WebAssembly решении остается `Microsoft.NET.Sdk.Web` следующим образом:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-175">The SDK of the *`Server`* project in a hosted Blazor WebAssembly solution remains `Microsoft.NET.Sdk.Web`:</span></span>
>
> ```xml
> <Project Sdk="Microsoft.NET.Sdk.Web">
> ```

<span data-ttu-id="ee0c6-176">Дополнительные сведения см. в разделе:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-176">For more information, see:</span></span>

* <xref:blazor/security/webassembly/hosted-with-azure-active-directory>
* <xref:blazor/security/webassembly/hosted-with-azure-active-directory-b2c>

### <a name="unauthorized-client-for-azure-active-directory-aad"></a><span data-ttu-id="ee0c6-177">Неавторизованный клиент для Azure Active Directory (AAD)</span><span class="sxs-lookup"><span data-stu-id="ee0c6-177">Unauthorized client for Azure Active Directory (AAD)</span></span>

<span data-ttu-id="ee0c6-178">После обновления Blazor WebAssembly приложения, использующего AAD для проверки подлинности, может появиться следующая ошибка при обратном вызове входа в приложение после того, как пользователь войдет с помощью AAD:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-178">After upgrading a Blazor WebAssembly app that uses AAD for authentication, you may receive the following error on the login callback to the app after the user signs in with AAD:</span></span>

> <span data-ttu-id="ee0c6-179">Сведения: Не удалось выполнить авторизацию Microsoft.AspNetCore.Authorization.DefaultAuthorizationService[2].</span><span class="sxs-lookup"><span data-stu-id="ee0c6-179">info: Microsoft.AspNetCore.Authorization.DefaultAuthorizationService[2] Authorization failed.</span></span> <span data-ttu-id="ee0c6-180">Не выполнены такие требования: DenyAnonymousAuthorizationRequirement. Требуется пользователь, прошедший проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-180">These requirements were not met: DenyAnonymousAuthorizationRequirement: Requires an authenticated user.</span></span>

<span data-ttu-id="ee0c6-181">Ошибка обратного вызова входа от AAD:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-181">Login callback error from AAD:</span></span>

* <span data-ttu-id="ee0c6-182">Ошибка `unauthorized_client` (У вызывающей стороны нет прав на запись для ресурса: [subscriptions/])</span><span class="sxs-lookup"><span data-stu-id="ee0c6-182">Error: `unauthorized_client`</span></span>
* <span data-ttu-id="ee0c6-183">Описание: `AADB2C90058: The provided application is not configured to allow public clients.`</span><span class="sxs-lookup"><span data-stu-id="ee0c6-183">Description: `AADB2C90058: The provided application is not configured to allow public clients.`</span></span>

<span data-ttu-id="ee0c6-184">Чтобы устранить эту ошибку, сделайте следующее:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-184">To resolve the error:</span></span>

1. <span data-ttu-id="ee0c6-185">На портале Azure перейдите к [манифесту приложения](/azure/active-directory/develop/reference-app-manifest).</span><span class="sxs-lookup"><span data-stu-id="ee0c6-185">In the Azure portal, access the [app's manifest](/azure/active-directory/develop/reference-app-manifest).</span></span>
1. <span data-ttu-id="ee0c6-186">Задайте для атрибута [`allowPublicClient`](/azure/active-directory/develop/reference-app-manifest#allowpublicclient-attribute) значение `null` или `true`.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-186">Set the [`allowPublicClient`](/azure/active-directory/develop/reference-app-manifest#allowpublicclient-attribute) attribute to `null` or `true`.</span></span>

## <a name="update-no-locrazor-class-libraries-rcls"></a><span data-ttu-id="ee0c6-187">Обновление Razor библиотек классов (рклс)</span><span class="sxs-lookup"><span data-stu-id="ee0c6-187">Update Razor class libraries (RCLs)</span></span>

<span data-ttu-id="ee0c6-188">Перенесите Razor библиотеки классов (рклс), чтобы воспользоваться преимуществами новых API-интерфейсов или функций, представленных в составе ASP.NET Core 5,0.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-188">Migrate Razor class libraries (RCLs) to take advantage of new APIs or features that are introduced as part of ASP.NET Core 5.0.</span></span> 

<span data-ttu-id="ee0c6-189">Обновление РКЛ, предназначенного для компонентов:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-189">To update a RCL that targets components:</span></span>

1. <span data-ttu-id="ee0c6-190">Обновите следующие свойства в файле проекта:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-190">Update the following properties in the project file:</span></span>

   ```diff
   <Project Sdk="Microsoft.NET.Sdk.Razor">
    
     <PropertyGroup>
   -     <TargetFramework>netstandard2.0</TargetFramework>
   -     <RazorLangVersion>3.0</RazorLangVersion>
   +     <TargetFramework>net5.0</TargetFramework>
     </PropertyGroup>
   ```

1. <span data-ttu-id="ee0c6-191">Обновите другие пакеты до их последних версий.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-191">Update other packages to their latest versions.</span></span> <span data-ttu-id="ee0c6-192">Последние версии можно найти по адресу [NuGet.org](https://www.nuget.org).</span><span class="sxs-lookup"><span data-stu-id="ee0c6-192">The latest versions can be found at [NuGet.org](https://www.nuget.org).</span></span>

<span data-ttu-id="ee0c6-193">Чтобы обновить РКЛ, предназначенный для MVC, обновите следующие свойства в файле проекта:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-193">To update an RCL targeting MVC, update the following properties in the project file:</span></span>

```diff
<Project Sdk="Microsoft.NET.Sdk.Razor">

  <PropertyGroup>
-    <TargetFramework>netcoreapp3.1</TargetFramework>
+    <TargetFramework>net5.0</TargetFramework>
    <AddRazorSupportForMvc>true</AddRazorSupportForMvc>
  </PropertyGroup>
```

## <a name="update-package-references"></a><span data-ttu-id="ee0c6-194">Обновление ссылок на пакеты</span><span class="sxs-lookup"><span data-stu-id="ee0c6-194">Update package references</span></span>

<span data-ttu-id="ee0c6-195">В файле проекта обновите все файлы [Microsoft. AspNetCore. \*](https://www.nuget.org/packages?q=Microsoft.AspNetCore.*), [Microsoft. EntityFrameworkCore. \*](https://www.nuget.org/packages?q=Microsoft.EntityFrameworkCore.*), [Microsoft. extensions. \*](https://www.nuget.org/packages?q=Microsoft.Extensions.*)и [System.Net.Http.Jsв](https://www.nuget.org/packages/System.Net.Http.Json) атрибуте ссылки на пакет `Version` значение 5.0.0 или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-195">In the project file, update each [Microsoft.AspNetCore.\*](https://www.nuget.org/packages?q=Microsoft.AspNetCore.*), [Microsoft.EntityFrameworkCore.\*](https://www.nuget.org/packages?q=Microsoft.EntityFrameworkCore.*), [Microsoft.Extensions.\*](https://www.nuget.org/packages?q=Microsoft.Extensions.*), and [System.Net.Http.Json](https://www.nuget.org/packages/System.Net.Http.Json) package reference's `Version` attribute to 5.0.0 or later.</span></span> <span data-ttu-id="ee0c6-196">Пример:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-196">For example:</span></span>

```diff
<ItemGroup>
-    <PackageReference Include="Microsoft.AspNetCore.JsonPatch" Version="3.1.6" />
-    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="3.1.6">
-    <PackageReference Include="Microsoft.Extensions.Caching.Abstractions" Version="3.1.6" />
-    <PackageReference Include="System.Net.Http.Json" Version="3.2.1" />
+    <PackageReference Include="Microsoft.AspNetCore.JsonPatch" Version="5.0.0" />
+    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="5.0.0">
+    <PackageReference Include="Microsoft.Extensions.Caching.Abstractions" Version="5.0.0" />
+    <PackageReference Include="System.Net.Http.Json" Version="5.0.0" />
</ItemGroup>
```

## <a name="update-docker-images"></a><span data-ttu-id="ee0c6-197">Обновление образов DOCKER</span><span class="sxs-lookup"><span data-stu-id="ee0c6-197">Update Docker images</span></span>

<span data-ttu-id="ee0c6-198">Для приложений, использующих DOCKER, *Dockerfile* обновите `FROM` инструкции и скрипты Dockerfile.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-198">For apps using Docker, update your *Dockerfile* `FROM` statements and scripts.</span></span> <span data-ttu-id="ee0c6-199">Используйте базовый образ, включающий среду выполнения ASP.NET Core 5,0.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-199">Use a base image that includes the ASP.NET Core 5.0 runtime.</span></span> <span data-ttu-id="ee0c6-200">Рассмотрим следующую `docker pull` команду в различиях между ASP.NET Core 3,1 и 5,0:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-200">Consider the following `docker pull` command difference between ASP.NET Core 3.1 and 5.0:</span></span>

```diff
- docker pull mcr.microsoft.com/dotnet/core/aspnet:3.1
+ docker pull mcr.microsoft.com/dotnet/aspnet:5.0
```

<span data-ttu-id="ee0c6-201">В рамках перехода на .NET в качестве названия продукта образы DOCKER перемещаются из `mcr.microsoft.com/dotnet/core` репозиториев в `mcr.microsoft.com/dotnet` .</span><span class="sxs-lookup"><span data-stu-id="ee0c6-201">As part of the move to ".NET" as the product name, the Docker images moved from the `mcr.microsoft.com/dotnet/core` repositories to `mcr.microsoft.com/dotnet`.</span></span> <span data-ttu-id="ee0c6-202">Дополнительные сведения см. в разделе [DotNet/DotNet-DOCKER # 1939](https://github.com/dotnet/dotnet-docker/issues/1939).</span><span class="sxs-lookup"><span data-stu-id="ee0c6-202">For more information, see [dotnet/dotnet-docker#1939](https://github.com/dotnet/dotnet-docker/issues/1939).</span></span>

## <a name="model-binding-changes-in-aspnet-core-mvc-and-no-locrazor-pages"></a><span data-ttu-id="ee0c6-203">Изменение привязки модели в ASP.NET Core MVC и Razor страницах</span><span class="sxs-lookup"><span data-stu-id="ee0c6-203">Model binding changes in ASP.NET Core MVC and Razor Pages</span></span>

### <a name="datetime-values-are-model-bound-as-utc-times"></a><span data-ttu-id="ee0c6-204">Значения даты и времени привязаны к модели в формате UTC</span><span class="sxs-lookup"><span data-stu-id="ee0c6-204">DateTime values are model bound as UTC times</span></span>

<span data-ttu-id="ee0c6-205">В ASP.NET Core 3,1 и более ранних версиях `DateTime` значения были привязаны к модели как местное время, где часовой пояс был определен сервером.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-205">In ASP.NET Core 3.1 and earlier, `DateTime` values were model-bound as local time, where the timezone was determined by the server.</span></span> <span data-ttu-id="ee0c6-206">`DateTime` значения, связанные с форматированием входных данных (JSON) и `DateTimeOffset` значениями, были привязаны как часовые пояса в формате UTC.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-206">`DateTime` values bound from input formatting (JSON) and `DateTimeOffset` values were bound as UTC timezones.</span></span>

<span data-ttu-id="ee0c6-207">В ASP.NET Core 5,0 и более поздних версиях привязка модели согласованно привязывает `DateTime` значения к часовому поясу UTC.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-207">In ASP.NET Core 5.0 and later, model binding consistently binds `DateTime` values with the UTC timezone.</span></span>

<span data-ttu-id="ee0c6-208">Чтобы удержать предыдущее поведение, удалите `DateTimeModelBinderProvider` в `Startup.ConfigureServices` :</span><span class="sxs-lookup"><span data-stu-id="ee0c6-208">To retain the previous behavior, remove the `DateTimeModelBinderProvider` in `Startup.ConfigureServices`:</span></span>

```csharp
services.AddControllersWithViews(options => 
    options.ModelBinderProviders.RemoveType<DateTimeModelBinderProvider>());
```

### <a name="complexobjectmodelbinderprovider--complexobjectmodelbinder-replace-complextypemodelbinderprovider--complextypemodelbinder"></a><span data-ttu-id="ee0c6-209">Комплексобжектмоделбиндерпровидер \ Комплексобжектмоделбиндер заменить Комплекстипемоделбиндерпровидер \ ComplexTypeModelBinder</span><span class="sxs-lookup"><span data-stu-id="ee0c6-209">ComplexObjectModelBinderProvider \ ComplexObjectModelBinder replace ComplexTypeModelBinderProvider \ ComplexTypeModelBinder</span></span>

<span data-ttu-id="ee0c6-210">Чтобы добавить поддержку для [типов записей привязки модели C# 9](/dotnet/csharp/whats-new/csharp-9#record-types), <xref:Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ComplexTypeModelBinderProvider> используется:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-210">To add support for model binding [C# 9 record types](/dotnet/csharp/whats-new/csharp-9#record-types), the <xref:Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ComplexTypeModelBinderProvider> is:</span></span>

* <span data-ttu-id="ee0c6-211">Помечены как устаревшие.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-211">Annotated as obsolete.</span></span>
* <span data-ttu-id="ee0c6-212">Больше не регистрируется по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-212">No longer registered by default.</span></span>

<span data-ttu-id="ee0c6-213">Приложения, зависящие от наличия `ComplexTypeModelBinderProvider` в `ModelBinderProviders` коллекции, должны ссылаться на новый поставщик подшивки:</span><span class="sxs-lookup"><span data-stu-id="ee0c6-213">Apps that rely on the presence of the `ComplexTypeModelBinderProvider` in the `ModelBinderProviders` collection need to reference the new binder provider:</span></span>

```diff
- var complexModelBinderProvider = options.ModelBinderProviders.OfType<ComplexTypeModelBinderProvider>();
+ var complexModelBinderProvider = options.ModelBinderProviders.OfType<ComplexObjectModelBinderProvider>();
```

## <a name="review-breaking-changes"></a><span data-ttu-id="ee0c6-214">Проверка критических изменений</span><span class="sxs-lookup"><span data-stu-id="ee0c6-214">Review breaking changes</span></span>

<span data-ttu-id="ee0c6-215">Критические изменения с .NET Core 3,1 на .NET 5,0 см. в разделе [критические изменения для миграции с версии 3,1 на 5,0](/dotnet/core/compatibility/3.1-5.0).</span><span class="sxs-lookup"><span data-stu-id="ee0c6-215">For breaking changes from .NET Core 3.1 to .NET 5.0, see [Breaking changes for migration from version 3.1 to 5.0](/dotnet/core/compatibility/3.1-5.0).</span></span> <span data-ttu-id="ee0c6-216">ASP.NET Core и Entity Framework Core также включены в список.</span><span class="sxs-lookup"><span data-stu-id="ee0c6-216">ASP.NET Core and Entity Framework Core are also included in the list.</span></span>
