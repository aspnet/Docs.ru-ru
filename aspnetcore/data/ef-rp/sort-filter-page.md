---
title: Часть 3. Razor Pages с EF Core в ASP.NET Core — сортировка, фильтрация, разбиение на страницы
author: rick-anderson
description: Часть 3 серии руководств по Razor Pages и Entity Framework.
ms.author: riande
ms.custom: mvc
ms.date: 07/22/2019
no-loc:
- appsettings.json
- ASP.NET Core Identity
- cookie
- Cookie
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: data/ef-rp/sort-filter-page
ms.openlocfilehash: 51a1e2a90259898262ac655b7a0e8a55d766f0c7
ms.sourcegitcommit: ca34c1ac578e7d3daa0febf1810ba5fc74f60bbf
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2020
ms.locfileid: "93061045"
---
# <a name="part-3-no-locrazor-pages-with-ef-core-in-aspnet-core---sort-filter-paging"></a>Часть 3. Razor Pages с EF Core в ASP.NET Core — сортировка, фильтрация, разбиение на страницы

Авторы: [Том Дайкстра](https://github.com/tdykstra) (Tom Dykstra), [Рик Андерсон](https://twitter.com/RickAndMSFT) (Rick Anderson) и [Йон П. Смит](https://twitter.com/thereformedprog) (Jon P Smith)

[!INCLUDE [about the series](~/includes/RP-EF/intro.md)]

::: moniker range=">= aspnetcore-3.0"

В этом учебнике вы добавите на страницу учащихся функции сортировки, фильтрации и разбиения на страницы.

На следующем рисунке показана готовая страница. Заголовки столбцов являются ссылками, щелкнув которые, можно отсортировать столбец. Щелкайте заголовок столбца для переключения между сортировкой по возрастанию и убыванию.

![Страница указателя учащихся](sort-filter-page/_static/paging30.png)

## <a name="add-sorting"></a>Добавление сортировки

Чтобы добавить сортировку, замените код в файле *Pages/Students/Index.cshtml.cs* на приведенный ниже.

[!code-csharp[Main](intro/samples/cu30snapshots/3-sorting/Pages/Students/Index1.cshtml.cs?name=snippet_All)]

Предыдущий код:

* Требует добавления `using System;`.
* добавляет свойства, которые будут содержать параметры сортировки;
* изменяет имя свойства `Student` на `Students`;
* заменяет код в методе `OnGetAsync`.

Метод `OnGetAsync` принимает параметр `sortOrder` из строки запроса в URL-адресе. URL-адрес и строка запроса формируются [вспомогательной функцией тегов привязки](xref:mvc/views/tag-helpers/builtin-th/anchor-tag-helper).

Параметр `sortOrder` имеет значение `Name` или `Date`. После параметра `sortOrder` может стоять `_desc`, чтобы указать порядок по убыванию. По умолчанию используется порядок сортировки по возрастанию.

При запросе страницы "Index" по ссылке **Students** строка запроса отсутствует. Учащиеся отображаются по фамилии в порядке возрастания. В операторе `default` сортировка по фамилии в порядке возрастания используется по умолчанию (`switch`). Когда пользователь щелкает ссылку заголовка столбца, в строке запроса указывается соответствующее значение `sortOrder`.

Для формирования гиперссылок в заголовках столбцов страница Razor использует `NameSort` и `DateSort` с соответствующими значениями строки запроса:

[!code-csharp[Main](intro/samples/cu30snapshots/3-sorting/Pages/Students/Index1.cshtml.cs?name=snippet_Ternary)]

В коде используется [условный оператор C# ?:](/dotnet/csharp/language-reference/operators/conditional-operator). Оператор `?:` является тернарным (принимает три операнда). Первая строка указывает, что, когда `sortOrder` равен null или пуст, `NameSort` имеет значение `name_desc`. Если `sortOrder` * *_не является_* _ равным null или пустым, для `NameSort` задается пустая строка.

Следующие два оператора устанавливают гиперссылки в заголовках столбцов на странице следующим образом:

| Текущий порядок сортировки   | Гиперссылка "Last Name" (Фамилия) | Гиперссылка "Date" (Дата) |
|:--------------------:|:-------------------:|:--------------:|
| "Last Name" (Фамилия) по возрастанию  | descending          | ascending      |
| "Last Name" (Фамилия) по убыванию | ascending           | ascending      |
| "Date" (Дата) по возрастанию       | ascending           | descending     |
| "Date" (Дата) по убыванию      | ascending           | ascending      |

Для указания столбца, по которому выполняется сортировка, этот метод использует LINQ to Entities. Код инициализирует `IQueryable<Student>` до оператора switch и изменяет его в этом операторе:

[!code-csharp[Main](intro/samples/cu30snapshots/3-sorting/Pages/Students/Index1.cshtml.cs?name=snippet_IQueryable)]

При создании или изменении `IQueryable` запрос в базу данных не отправляется. Запрос не выполнится, пока объект `IQueryable` не будет преобразован в коллекцию. `IQueryable` преобразуются в коллекцию путем вызова метода, такого как `ToListAsync`. Таким образом, код `IQueryable` создает одиночный запрос, который не выполняется до следующего оператора:

[!code-csharp[Main](intro/samples/cu30snapshots/3-sorting/Pages/Students/Index1.cshtml.cs?name=snippet_SortOnlyRtn)]

`OnGetAsync` можно расширить на случай большого числа сортируемых столбцов. Сведения об альтернативном способе программирования этой функциональности см. в статье [Использование динамических запросов LINQ для упрощения кода](xref:data/ef-mvc/advanced#dynamic-linq) в версии этой серии учебников для MVC.

### <a name="add-column-heading-hyperlinks-to-the-student-index-page"></a>Добавление гиперссылок для заголовков столбцов на странице индексов учащихся

Замените код в файле _Students/Index.cshtml* на приведенный ниже код. Изменения выделены.

[!code-cshtml[Main](intro/samples/cu30snapshots/3-sorting/Pages/Students/Index1.cshtml?highlight=5,8,17-19,22,25-27,33)]

Предыдущий код:

* Добавляет гиперссылки в заголовки столбцов `LastName` и `EnrollmentDate`.
* Использует эти сведения в `NameSort` и `DateSort` для настройки гиперссылок с использованием текущих значений порядка сортировки.
* Изменяет заголовок страницы с Index (Индекс) на Students (Учащиеся).
* Изменяет `Model.Student` на `Model.Students`.

Чтобы проверить работу сортировки, сделайте следующее:

* Запустите приложение и откройте вкладку **Students** (Учащиеся).
* Щелкните заголовки столбцов.

## <a name="add-filtering"></a>Добавление фильтрации

Для добавления фильтрации на страницу индекса учащихся:

* На страницу Razor добавляется текстовое поле и кнопка отправки. Текстовое поле предоставляет строку поиска для имени или фамилии.
* Страничная модель обновляется для использования значения из текстового поля.

### <a name="update-the-ongetasync-method"></a>Обновление метода OnGetAsync

Чтобы добавить фильтрацию, замените код в файле *Students/Index.cshtml.cs* на приведенный ниже.

[!code-csharp[Main](intro/samples/cu30snapshots/3-sorting/Pages/Students/Index2.cshtml.cs?name=snippet_All&highlight=17,22,26-30)]

Предыдущий код:

* Добавляет параметр `searchString` в метод `OnGetAsync` и сохраняет значение параметра в свойстве `CurrentFilter`. Значение строки поиска получается из текстового поля, добавляемого в следующем разделе.
* Добавляет в инструкцию LINQ предложение `Where`. Это предложение `Where` отбирает только учащихся, чье имя или фамилия содержат строку поиска. Оператор LINQ выполняется, только если задано значение для поиска.

### <a name="iqueryable-vs-ienumerable"></a>IQueryable и IEnumerable

Код вызывает метод <xref:System.Linq.Queryable.Where%2A> объекта `IQueryable`, при этом фильтр обрабатывается на сервере. В некоторых случаях приложение может вызывать метод `Where` как метод расширения для коллекции в памяти. Предположим, например, что `_context.Students` меняется с EF Core `DbSet` на метод репозитория, возвращающий коллекцию `IEnumerable`. Обычно результат остается прежним, но в некоторых случаях он может отличаться.

Например, реализация `Contains` в .NET Framework по умолчанию выполняет сравнение с учетом регистра. В SQL Server `Contains` учет регистра определяется параметрами сортировки у экземпляра SQL Server. По умолчанию SQL Server не учитывает регистр. В SQLite по умолчанию регистр учитывается. Можно вызвать `ToUpper`, чтобы явно велеть тесту не учитывать регистр.

```csharp
Where(s => s.LastName.ToUpper().Contains(searchString.ToUpper())`
```

Приведенный выше код гарантирует, что фильтр не учитывает регистр, даже если метод `Where` вызывается для `IEnumerable` или выполняется в SQLite.

Когда `Contains` вызывается для коллекции `IEnumerable`, используется реализация .NET Core. Когда `Contains` вызывается для объекта `IQueryable`, используется реализация базы данных.

Вызов `Contains` для `IQueryable` обычно предпочтительнее по соображениям производительности. При использовании `IQueryable` фильтрация выполняется сервером базы данных. Если сначала создается `IEnumerable`, все строки должны возвращаться с сервера базы данных.

Вызов `ToUpper` снижает производительность. Код `ToUpper` добавляет функцию в предложение WHERE TSQL-оператора SELECT. Добавленная функция не позволяет оптимизатору использовать индекс. Учитывая, что SQL устанавливается без учета регистра, рекомендуется не использовать вызов `ToUpper`, когда он не требуется.

Дополнительные сведения см. в статье [Использование запроса без учета регистра с поставщиком SQLite](https://github.com/aspnet/EntityFrameworkCore/issues/11414).

### <a name="update-the-no-locrazor-page"></a>Обновление страницы Razor

Замените код в файле *Pages/Students/Index.cshtml* , чтобы создать кнопку **Search** (Поиск).

[!code-cshtml[Main](intro/samples/cu30snapshots/3-sorting/Pages/Students/Index2.cshtml?highlight=14-23)]

Для добавления кнопки и поля поиска предыдущий код использует `<form>` [вспомогательную функцию тегов](xref:mvc/views/tag-helpers/intro). По умолчанию вспомогательная функция тегов `<form>` отправляет данные формы с помощью POST. При этом параметры передаются в тексте сообщения HTTP, а не в URL-адресе. При использовании HTTP GET данные формы передаются в виде строк запроса в URL-адресе. Передача данных со строками запроса позволяет пользователям добавлять URL-адрес в закладки. [Руководства консорциума W3C](https://www.w3.org/2001/tag/doc/whenToUseGet.html) рекомендуют использовать GET, когда действие не приводит к обновлению.

Проверьте работу приложения:

* Выберите вкладку **Students** (Учащиеся) и введите строку поиска. При использовании SQLite фильтр не учитывает регистр, только если вы реализовали необязательный код `ToUpper`, приведенный ранее.

* Выберите **Search** (Поиск).

Обратите внимание, что URL-адрес содержит строку поиска. Пример:

```browser-address-bar
https://localhost:5001/Students?SearchString=an
```

Если страница добавлена в закладки, закладка содержит URL-адрес страницы и строку запроса `SearchString`. Формирование строки запроса обеспечивает `method="get"` в теге `form`.

Сейчас при выборе ссылки сортировки заголовка столбца теряется значение фильтра в поле **Search** (Поиск). Потерянное значение фильтра исправляется в следующем разделе.

## <a name="add-paging"></a>Добавление разбиения по страницам

В этом разделе создается класс `PaginatedList` для поддержки разбиения на страницы. Класс `PaginatedList` использует операторы `Skip` и `Take` для фильтрации данных на сервере вместо того, чтобы извлекать все строки таблицы. На следующем рисунке показаны кнопки перелистывания.

![Страница указателя учащихся со ссылками для перелистывания](sort-filter-page/_static/paging30.png)

### <a name="create-the-paginatedlist-class"></a>Создание класса PaginatedList

В папке проекта создайте файл `PaginatedList.cs` со следующим кодом:

[!code-csharp[Main](intro/samples/cu30/PaginatedList.cs)]

В предыдущем коде метод `CreateAsync` принимает размер и номер страницы и вызывает соответствующие методы `Skip` и `Take` объекта `IQueryable`. Метод `ToListAsync` объекта `IQueryable` при вызове возвращает список, содержащий только запрошенную страницу. Для включения и отключения кнопок перелистывания страниц **Previous** (Назад) и **Next** (Далее) используются свойства `HasPreviousPage` и `HasNextPage`.

Метод `CreateAsync` используется для создания `PaginatedList<T>`. Конструктор не позволяет создать объект `PaginatedList<T>`, так как конструкторы не могут выполнять асинхронный код.

### <a name="add-paging-to-the-pagemodel-class"></a>Добавление разбиения на страницы в класс PageModel

Чтобы добавить разбиение на страницы, замените код в файле *Students/Index.cshtml.cs*.

[!code-csharp[Main](intro/samples/cu30/Pages/Students/Index.cshtml.cs?name=snippet_All&highlight=15-20,23-30,57-59)]

Предыдущий код:

* изменяет тип свойства `Students` с `IList<Student>` на `PaginatedList<Student>`;
* добавляет индекс страницы, текущий порядок `sortOrder` и фильтр `currentFilter` в сигнатуру метода `OnGetAsync`;
* сохраняет порядок сортировки в свойстве `CurrentSort`;
* сбрасывает индекс страницы в значение 1 при получении новой строки поиска;
* использует класс `PaginatedList` для получения сущностей Student.
* задает для `pageSize` значение 3. Реальное приложение будет использовать [конфигурацию](xref:fundamentals/configuration/index) для задания значение размера страницы.

Все параметры, получаемые методом `OnGetAsync`, равны NULL, когда:

* Страница вызывается по ссылке **Students** (Учащиеся).
* Пользователь не открывал ссылку перелистывания или сортировки.

При выборе ссылки перелистывания переменная индекса страницы содержит номер страницы для отображения.

Свойство `CurrentSort` предоставляет странице Razor текущий порядок сортировки. Текущий порядок сортировки нужно включить в ссылки перелистывания, чтобы сохранить его при смене страницы.

Свойство `CurrentFilter` предоставляет странице Razor текущую строку фильтра. Значение `CurrentFilter`:

* Нужно включить в ссылки для перелистывания, чтобы сохранить параметры фильтра при смене страницы.
* Нужно восстановить в текстовом поле после обновления страницы.

Если строка поиска изменяется во время перелистывания, номер страницы сбрасывается в значение 1. Номер страницы должен быть сброшен на 1, так как с новым фильтром может измениться состав отображаемых данных. Если введено значение для поиска и нажата кнопка **Submit** (Отправить):

  * Строка поиска изменяется.
  * Значение параметра `searchString` отличается от null.

  Метод `PaginatedList.CreateAsync` преобразует результат запроса учащихся в отдельную страницу коллекции, поддерживающую разбиение на страницы. Эта страница с учащимися передается на страницу Razor.

  Два вопросительных знака после `pageIndex` в вызове `PaginatedList.CreateAsync` являются [оператором объединения с NULL](/dotnet/csharp/language-reference/operators/null-conditional-operator). Оператор объединения с null определяет значение по умолчанию для типа, допускающего значение null. Выражение `pageIndex ?? 1` возвращает значение свойства `pageIndex`, если оно есть. В противном случае возвращается значение 1.

### <a name="add-paging-links-to-the-no-locrazor-page"></a>Добавление ссылок для разбиения по страницам на страницу Razor

Замените код в файле *Students/Index.cshtml* на приведенный ниже код. Изменения выделены:

[!code-cshtml[Main](intro/samples/cu30/Pages/Students/Index.cshtml?highlight=29-32,38-41,69-87)]

Ссылки в заголовках столбцов передают текущую строку поиска в метод `OnGetAsync` с помощью строки запроса:

[!code-cshtml[Main](intro/samples/cu30/Pages/Students/Index.cshtml?range=29-32)]

Кнопки перелистывания отображаются вспомогательными функциями тегов:

[!code-cshtml[Main](intro/samples/cu30/Pages/Students/Index.cshtml?range=73-87)]

Запустите приложение и перейдите на страницу учащихся.

* Чтобы убедиться, что разбиение на страницы работает, нажимайте кнопки перелистывания при различном порядке сортировки.
* Чтобы убедиться, что разбиение на страницы работает корректно вместе с сортировкой и фильтрацией, введите строку поиска и попробуйте перелистнуть страницу.

![Страница указателя учащихся со ссылками для перелистывания](sort-filter-page/_static/paging30.png)

## <a name="add-grouping"></a>Добавление группирования

В этом разделе создается страница About (Сведения), на которой показано количество учащихся, зарегистрированных на каждую дату. Это изменение использует группирование и включает следующие шаги:

* Создание модели представления для данных, используемых страницей **About** (Сведения).
* Обновление страницы "About" (О программе) для использования модели представления.

### <a name="create-the-view-model"></a>Создание модели представления

Создайте папку *Models/SchoolViewModels*.

Создайте файл *SchoolViewModels/EnrollmentDateGroup.cs* со следующим кодом:

[!code-csharp[Main](intro/samples/cu30/Models/SchoolViewModels/EnrollmentDateGroup.cs)]

### <a name="create-the-no-locrazor-page"></a>Создание Razor страницы

Создайте файл *Pages/About.cshtml* со следующим кодом:

[!code-cshtml[Main](intro/samples/cu30/Pages/About.cshtml)]

### <a name="create-the-page-model"></a>Создание модели страницы

Измените файл *Pages/About.cshtml.cs* , используя следующий код:

[!code-csharp[Main](intro/samples/cu30/Pages/About.cshtml.cs)]

Запрос LINQ группирует записи из таблицы студентов по дате зачисления, вычисляет число записей в каждой группе и сохраняет результаты в коллекцию объектов моделей представления `EnrollmentDateGroup`.

Запустите приложение и перейдите на страницу "About" (О программе). Количество зачисленных студентов по дням отображается в таблице.

![Страница About](sort-filter-page/_static/about30.png)

## <a name="next-steps"></a>Следующие шаги

В следующем руководстве приложение использует миграции для обновления модели данных.

> [!div class="step-by-step"]
> [Предыдущий учебник](xref:data/ef-rp/crud)
> [Следующий учебник](xref:data/ef-rp/migrations)

::: moniker-end

::: moniker range="< aspnetcore-3.0"

Это руководство описывает добавление функций сортировки, фильтрации, группировки и разбиения на страницы.

На следующем рисунке показана готовая страница. Заголовки столбцов являются ссылками, щелкнув которые, можно отсортировать столбец. Многократно щелкая заголовок столбца, можно переключаться между сортировкой по возрастанию и убыванию.

![Страница указателя учащихся](sort-filter-page/_static/paging.png)

При возникновении проблем, которые вам не удается устранить, скачайте [готовое приложение](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/data/ef-rp/intro/samples).

## <a name="add-sorting-to-the-index-page"></a>Добавление сортировки на страницу индекса

Добавьте строки в файл *Students/Index.cshtml.cs* `PageModel` для хранения параметров сортировки:

[!code-csharp[](intro/samples/cu21/Pages/Students/Index.cshtml.cs?name=snippet1&highlight=10-13)]

Измените файл *Students/Index.cshtml.cs* `OnGetAsync`, используя следующий код:

[!code-csharp[](intro/samples/cu21/Pages/Students/Index.cshtml.cs?name=snippet_SortOnly)]

Предыдущий код принимает параметр `sortOrder` из строки запроса в URL-адресе. URL-адрес (включая строку запроса) формируется [вспомогательной функцией тегов привязки](xref:mvc/views/tag-helpers/builtin-th/anchor-tag-helper
)

Параметр `sortOrder` имеет значение "Name" или "Date". После параметра `sortOrder` может стоять "_desc", чтобы указать порядок по убыванию. По умолчанию используется порядок сортировки по возрастанию.

При запросе страницы "Index" по ссылке **Students** строка запроса отсутствует. Учащиеся отображаются по фамилии в порядке возрастания. В операторе `switch` сортировка по фамилии в порядке возрастания используется по умолчанию. Когда пользователь щелкает ссылку заголовка столбца, в строке запроса указывается соответствующее значение `sortOrder`.

Для формирования гиперссылок в заголовках столбцов страница Razor использует `NameSort` и `DateSort` с соответствующими значениями строки запроса:

[!code-csharp[](intro/samples/cu21/Pages/Students/Index.cshtml.cs?name=snippet_SortOnly&highlight=3-4)]

Следующий код содержит условный [оператор ?:](/dotnet/csharp/language-reference/operators/conditional-operator) C#:

[!code-csharp[](intro/samples/cu21/Pages/Students/Index.cshtml.cs?name=snippet_Ternary)]

Первая строка указывает, что когда `sortOrder` равен null или пуст, `NameSort` имеет значение "name_desc". Если `sortOrder`**не является** равным null или пустым, для `NameSort` задается пустая строка.

`?: operator` также называется тернарным оператором.

Следующие два оператора устанавливают гиперссылки в заголовках столбцов на странице следующим образом:

| Текущий порядок сортировки | Гиперссылка "Last Name" (Фамилия) | Гиперссылка "Date" (Дата) |
|:--------------------:|:-------------------:|:--------------:|
| "Last Name" (Фамилия) по возрастанию | descending        | ascending      |
| "Last Name" (Фамилия) по убыванию | ascending           | ascending      |
| "Date" (Дата) по возрастанию       | ascending           | descending     |
| "Date" (Дата) по убыванию      | ascending           | ascending      |

Для указания столбца, по которому выполняется сортировка, этот метод использует LINQ to Entities. Код инициализирует `IQueryable<Student>` до оператора switch и изменяет его в этом операторе:

[!code-csharp[](intro/samples/cu21/Pages/Students/Index.cshtml.cs?name=snippet_SortOnly&highlight=6-999)]

 При создании или изменении `IQueryable` запрос в базу данных не отправляется. Запрос не выполнится, пока объект `IQueryable` не будет преобразован в коллекцию. `IQueryable` преобразуются в коллекцию путем вызова метода, такого как `ToListAsync`. Таким образом, код `IQueryable` создает одиночный запрос, который не выполняется до следующего оператора:

[!code-csharp[](intro/samples/cu21/Pages/Students/Index.cshtml.cs?name=snippet_SortOnlyRtn)]

`OnGetAsync` можно расширить на случай большого числа сортируемых столбцов.

### <a name="add-column-heading-hyperlinks-to-the-student-index-page"></a>Добавление гиперссылок для заголовков столбцов на странице индексов учащихся

Замените код в файле *Students/Index.cshtml* на следующий выделенный код:

[!code-cshtml[](intro/samples/cu21/Pages/Students/Index2.cshtml?highlight=17-19,25-27)]

Предыдущий код:

* Добавляет гиперссылки в заголовки столбцов `LastName` и `EnrollmentDate`.
* Использует эти сведения в `NameSort` и `DateSort` для настройки гиперссылок с использованием текущих значений порядка сортировки.

Чтобы проверить работу сортировки, сделайте следующее:

* Запустите приложение и откройте вкладку **Students** (Учащиеся).
* Щелкните **Last Name** (Фамилия).
* Щелкните **Enrollment Date** (Дата зачисления).

Чтобы лучше понять код:

* В *Student/Index.cshtml.cs* задайте точку останова в `switch (sortOrder)`.
* Добавьте контрольное значение для `NameSort` и `DateSort`.
* В *Student/Index.cshtml* задайте точку останова в `@Html.DisplayNameFor(model => model.Student[0].LastName)`.

Осуществите пошаговое выполнение в отладчике.

## <a name="add-a-search-box-to-the-students-index-page"></a>Добавление поля поиска на страницу указателя учащихся

Для добавления фильтрации на страницу индекса учащихся:

* На страницу Razor добавляется текстовое поле и кнопка отправки. Текстовое поле предоставляет строку поиска для имени или фамилии.
* Страничная модель обновляется для использования значения из текстового поля.

### <a name="add-filtering-functionality-to-the-index-method"></a>Добавление функций фильтрации в метод Index

Измените файл *Students/Index.cshtml.cs* `OnGetAsync`, используя следующий код:

[!code-csharp[](intro/samples/cu21/Pages/Students/Index.cshtml.cs?name=snippet_SortFilter&highlight=1,5,9-13)]

Предыдущий код:

* Добавляет параметр `searchString` в метод `OnGetAsync`. Значение строки поиска получается из текстового поля, добавляемого в следующем разделе.
* Добавил в оператор LINQ предложение `Where`. Это предложение `Where` отбирает только учащихся, чье имя или фамилия содержат строку поиска. Оператор LINQ выполняется, только если задано значение для поиска.

Примечание. Предыдущий код вызывает метод `Where` объекта `IQueryable`, при этом фильтр обрабатывается на сервере. В некоторых случаях приложение может вызывать метод `Where` как метод расширения для коллекции в памяти. Предположим, например, что `_context.Students` меняется с EF Core `DbSet` на метод репозитория, возвращающий коллекцию `IEnumerable`. Обычно результат остается прежним, но в некоторых случаях он может отличаться.

Например, реализация `Contains` в .NET Framework по умолчанию выполняет сравнение с учетом регистра. В SQL Server `Contains` учет регистра определяется параметрами сортировки у экземпляра SQL Server. По умолчанию SQL Server не учитывает регистр. Можно вызвать `ToUpper`, чтобы явно велеть тесту не учитывать регистр.

`Where(s => s.LastName.ToUpper().Contains(searchString.ToUpper())`

Предыдущий код обеспечивает, что результаты не учитывают регистр, если код изменяется для использования `IEnumerable`. Когда `Contains` вызывается для коллекции `IEnumerable`, используется реализация .NET Core. Когда `Contains` вызывается для объекта `IQueryable`, используется реализация базы данных. При возвращение `IEnumerable` из репозитория производительность может значительно снижаться:

1. Все строки возвращаются с сервера базы данных.
1. Фильтр применяется ко всем возвращенным строкам в приложении.

Вызов `ToUpper` снижает производительность. Код `ToUpper` добавляет функцию в предложение WHERE TSQL-оператора SELECT. Добавленная функция не позволяет оптимизатору использовать индекс. Учитывая, что SQL устанавливается без учета регистра, рекомендуется не использовать вызов `ToUpper`, когда он не требуется.

### <a name="add-a-search-box-to-the-student-index-page"></a>Добавление поля поиска на страницу индексов учащихся

Добавьте в *Pages/Student/Index.cshtml* приведенный ниже выделенный код, чтобы создать кнопку **Search** и различные элементы хрома.

[!code-cshtml[](intro/samples/cu21/Pages/Students/Index3.cshtml?highlight=14-23&range=1-25)]

Для добавления кнопки и поля поиска предыдущий код использует `<form>` [вспомогательную функцию тегов](xref:mvc/views/tag-helpers/intro). По умолчанию вспомогательная функция тегов `<form>` отправляет данные формы с помощью POST. При этом параметры передаются в тексте сообщения HTTP, а не в URL-адресе. При использовании HTTP GET данные формы передаются в виде строк запроса в URL-адресе. Передача данных со строками запроса позволяет пользователям добавлять URL-адрес в закладки. [Руководства консорциума W3C](https://www.w3.org/2001/tag/doc/whenToUseGet.html) рекомендуют использовать GET, когда действие не приводит к обновлению.

Проверьте работу приложения:

* Выберите вкладку **Students** (Учащиеся) и введите строку поиска.
* Выберите **Search** (Поиск).

Обратите внимание, что URL-адрес содержит строку поиска.

```html
http://localhost:5000/Students?SearchString=an
```

Если страница добавлена в закладки, закладка содержит URL-адрес страницы и строку запроса `SearchString`. Формирование строки запроса обеспечивает `method="get"` в теге `form`.

Сейчас при выборе ссылки сортировки заголовка столбца теряется значение фильтра в поле **Search** (Поиск). Потерянное значение фильтра исправляется в следующем разделе.

## <a name="add-paging-functionality-to-the-students-index-page"></a>Добавление на страницу указателя учащихся разбиения на страницы

В этом разделе создается класс `PaginatedList` для поддержки разбиения на страницы. Класс `PaginatedList` использует операторы `Skip` и `Take` для фильтрации данных на сервере вместо того, чтобы извлекать все строки таблицы. На следующем рисунке показаны кнопки перелистывания.

![Страница указателя учащихся со ссылками для перелистывания](sort-filter-page/_static/paging.png)

В папке проекта создайте файл `PaginatedList.cs` со следующим кодом:

[!code-csharp[](intro/samples/cu21/PaginatedList.cs)]

В предыдущем коде метод `CreateAsync` принимает размер и номер страницы и вызывает соответствующие методы `Skip` и `Take` объекта `IQueryable`. Метод `ToListAsync` объекта `IQueryable` при вызове возвращает список, содержащий только запрошенную страницу. Для включения и отключения кнопок перелистывания страниц **Previous** (Назад) и **Next** (Далее) используются свойства `HasPreviousPage` и `HasNextPage`.

Метод `CreateAsync` используется для создания `PaginatedList<T>`. Конструктор не позволяет создать объект`PaginatedList<T>`, так как конструкторы не могут выполнять асинхронный код.

## <a name="add-paging-functionality-to-the-index-method"></a>Добавление разбиения на страницы в метод Index

В *Students/Index.cshtml.cs* измените тип `Student` с `IList<Student>` на `PaginatedList<Student>`:

[!code-csharp[](intro/samples/cu21/Pages/Students/Index.cshtml.cs?name=snippet_SortFilterPageType)]

Измените файл *Students/Index.cshtml.cs* `OnGetAsync`, используя следующий код:

[!code-csharp[](intro/samples/cu21/Pages/Students/Index.cshtml.cs?name=snippet_SortFilterPage&highlight=1-4,7-14,41-999)]

Предыдущий код добавляет страницу индекса, текущий `sortOrder` и `currentFilter` в сигнатуру метода.

[!code-csharp[](intro/samples/cu21/Pages/Students/Index.cshtml.cs?name=snippet_SortFilterPage2)]

Все параметры равны null, когда:

* Страница вызывается по ссылке **Students** (Учащиеся).
* Пользователь не открывал ссылку перелистывания или сортировки.

При выборе ссылки перелистывания переменная индекса страницы содержит номер страницы для отображения.

`CurrentSort` предоставляет странице Razor текущий порядок сортировки. Текущий порядок сортировки нужно включить в ссылки перелистывания, чтобы сохранить его при смене страницы.

`CurrentFilter` предоставляет странице Razor текущую строку фильтра. Значение `CurrentFilter`:

* Нужно включить в ссылки для перелистывания, чтобы сохранить параметры фильтра при смене страницы.
* Нужно восстановить в текстовом поле после обновления страницы.

Если строка поиска изменяется во время перелистывания, номер страницы сбрасывается в значение 1. Номер страницы должен быть сброшен на 1, так как с новым фильтром может измениться состав отображаемых данных. Если введено значение для поиска и нажата кнопка **Submit** (Отправить):

* Строка поиска изменяется.
* Значение параметра `searchString` отличается от null.

[!code-csharp[](intro/samples/cu21/Pages/Students/Index.cshtml.cs?name=snippet_SortFilterPage3)]

Метод `PaginatedList.CreateAsync` преобразует результат запроса учащихся в отдельную страницу коллекции, поддерживающую разбиение на страницы. Эта страница с учащимися передается на страницу Razor.

[!code-csharp[](intro/samples/cu21/Pages/Students/Index.cshtml.cs?name=snippet_SortFilterPage4)]

Два вопросительных знака в `PaginatedList.CreateAsync` являются [оператором объединения с null](/dotnet/csharp/language-reference/operators/null-conditional-operator). Оператор объединения с null определяет значение по умолчанию для типа, допускающего значение null. Выражение `(pageIndex ?? 1)` означает возвращение значения `pageIndex`, если он имеет значение. Если у `pageIndex` нет значения, возвращается 1.

## <a name="add-paging-links-to-the-student-no-locrazor-page"></a>Добавление ссылок на страницу Razor учащихся

Измените разметку в *Students/Index.cshtml*. Изменения выделены:

[!code-cshtml[](intro/samples/cu21/Pages/Students/Index.cshtml?highlight=28-31,37-40,68-999)]

Ссылки в заголовках столбцов передают в метод `OnGetAsync` с помощью строки запроса текущее значение строки поиска, чтобы пользователь мог сортировать отфильтрованные результаты:

[!code-cshtml[](intro/samples/cu21/Pages/Students/Index.cshtml?range=28-31)]

Кнопки перелистывания отображаются вспомогательными функциями тегов:

[!code-cshtml[](intro/samples/cu21/Pages/Students/Index.cshtml?range=72-)]

Запустите приложение и перейдите на страницу учащихся.

* Чтобы убедиться, что разбиение на страницы работает, нажимайте кнопки перелистывания при различном порядке сортировки.
* Чтобы убедиться, что разбиение на страницы работает корректно вместе с сортировкой и фильтрацией, введите строку поиска и попробуйте перелистнуть страницу.

![Страница указателя учащихся со ссылками для перелистывания](sort-filter-page/_static/paging.png)

Чтобы лучше понять код:

* В *Student/Index.cshtml.cs* задайте точку останова в `switch (sortOrder)`.
* Добавьте контрольное значение для `NameSort`, `DateSort`, `CurrentSort` и `Model.Student.PageIndex`.
* В *Student/Index.cshtml* задайте точку останова в `@Html.DisplayNameFor(model => model.Student[0].LastName)`.

Осуществите пошаговое выполнение в отладчике.

## <a name="update-the-about-page-to-show-student-statistics"></a>Изменение страницы "About" (О программе) для отображения статистики учащихся

В этом шаге изменяется страница *Pages/About.cshtml* , чтобы отобразить количество зачисленных учащихся по дням. Это изменение использует группирование и включает следующие шаги:

* Создание модели представления для данных, используемых страницей **About** (О программе).
* Обновление страницы "About" (О программе) для использования модели представления.

### <a name="create-the-view-model"></a>Создание модели представления

Создайте папку *SchoolViewModels* в папке *Models*.

Добавьте в папку *SchoolViewModels* файл *EnrollmentDateGroup.cs* со следующим кодом:

[!code-csharp[](intro/samples/cu21/Models/SchoolViewModels/EnrollmentDateGroup.cs)]

### <a name="update-the-about-page-model"></a>Обновление модели страницы "About" (О программе)

Веб-шаблоны в ASP.NET Core 2.2 не включают страницу About. Если вы используете ASP.NET Core 2.2, создайте страницу About Razor Page.

Измените файл *Pages/About.cshtml.cs* , используя следующий код:

[!code-csharp[](intro/samples/cu21/Pages/About.cshtml.cs)]

Запрос LINQ группирует записи из таблицы студентов по дате зачисления, вычисляет число записей в каждой группе и сохраняет результаты в коллекцию объектов моделей представления `EnrollmentDateGroup`.

### <a name="modify-the-about-no-locrazor-page"></a>Изменение страницы Razor About

Замените код в файле *Pages/About.cshtml* следующим кодом:

[!code-cshtml[](intro/samples/cu21/Pages/About.cshtml)]

Запустите приложение и перейдите на страницу "About" (О программе). Количество зачисленных студентов по дням отображается в таблице.

При возникновении проблем, которые вам не удается устранить, скачайте [готовое приложение для этого этапа](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/data/ef-rp/intro/samples/StageSnapShots/cu-part3-sorting).

![Страница About](sort-filter-page/_static/about.png)

## <a name="additional-resources"></a>Дополнительные ресурсы

* [Отладка источника ASP.NET Core 2.x](https://github.com/dotnet/AspNetCore.Docs/issues/4155)
* [Версия руководства на YouTube](https://www.youtube.com/watch?v=MDs7PFpoMqI)

В следующем руководстве приложение использует миграции для обновления модели данных.

> [!div class="step-by-step"]
> [Назад](xref:data/ef-rp/crud)
> [Вперед](xref:data/ef-rp/migrations)

::: moniker-end

