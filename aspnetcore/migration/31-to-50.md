---
title: Миграция с ASP.NET Core 3,1 на 5,0
author: scottaddie
description: Узнайте, как перенести проект ASP.NET Core 3,1 в ASP.NET Core 5,0.
ms.author: scaddie
ms.custom: mvc
ms.date: 12/02/2020
no-loc:
- appsettings.json
- ASP.NET Core Identity
- cookie
- Cookie
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: migration/31-to-50
ms.openlocfilehash: 1a4dcdee738eb05f62c3268d9ef579974dd99cf4
ms.sourcegitcommit: b64c44ba5e3abb4ad4d50de93b7e282bf0f251e4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "97972097"
---
# <a name="migrate-from-aspnet-core-31-to-50"></a><span data-ttu-id="7d868-103">Миграция с ASP.NET Core 3,1 на 5,0</span><span class="sxs-lookup"><span data-stu-id="7d868-103">Migrate from ASP.NET Core 3.1 to 5.0</span></span>

<span data-ttu-id="7d868-104">Автор: [Скотт Адди](https://github.com/scottaddie) (Scott Addie)</span><span class="sxs-lookup"><span data-stu-id="7d868-104">By [Scott Addie](https://github.com/scottaddie)</span></span>

<span data-ttu-id="7d868-105">В этой статье объясняется, как обновить существующий проект ASP.NET Core 3,1 до ASP.NET Core 5,0.</span><span class="sxs-lookup"><span data-stu-id="7d868-105">This article explains how to update an existing ASP.NET Core 3.1 project to ASP.NET Core 5.0.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="7d868-106">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="7d868-106">Prerequisites</span></span>

# <a name="visual-studio"></a>[<span data-ttu-id="7d868-107">Visual Studio</span><span class="sxs-lookup"><span data-stu-id="7d868-107">Visual Studio</span></span>](#tab/visual-studio)

[!INCLUDE[](~/includes/net-core-prereqs-vs-5.0.md)]

# <a name="visual-studio-code"></a>[<span data-ttu-id="7d868-108">Visual Studio Code</span><span class="sxs-lookup"><span data-stu-id="7d868-108">Visual Studio Code</span></span>](#tab/visual-studio-code)

[!INCLUDE[](~/includes/net-core-prereqs-vsc-5.0.md)]

# <a name="visual-studio-for-mac"></a>[<span data-ttu-id="7d868-109">Visual Studio для Mac</span><span class="sxs-lookup"><span data-stu-id="7d868-109">Visual Studio for Mac</span></span>](#tab/visual-studio-mac)

[!INCLUDE[](~/includes/net-core-prereqs-mac-5.0.md)]

---

## <a name="update-net-core-sdk-version-in-globaljson"></a><span data-ttu-id="7d868-110">Обновление версии пакета SDK для .NET Core в файле global.json</span><span class="sxs-lookup"><span data-stu-id="7d868-110">Update .NET Core SDK version in global.json</span></span>

<span data-ttu-id="7d868-111">Если вы полагаетесь на [global.js](/dotnet/core/tools/global-json) файла для конкретной версии пакет SDK для .NET Core, обновите `version` свойство до установленной версии пакета SDK для .NET 5,0.</span><span class="sxs-lookup"><span data-stu-id="7d868-111">If you rely upon a [global.json](/dotnet/core/tools/global-json) file to target a specific .NET Core SDK version, update the `version` property to the .NET 5.0 SDK version that's installed.</span></span> <span data-ttu-id="7d868-112">Пример:</span><span class="sxs-lookup"><span data-stu-id="7d868-112">For example:</span></span>

```diff
{
  "sdk": {
-    "version": "3.1.200"
+    "version": "5.0.100"
  }
}
```

## <a name="update-the-target-framework"></a><span data-ttu-id="7d868-113">Обновление целевой платформы</span><span class="sxs-lookup"><span data-stu-id="7d868-113">Update the target framework</span></span>

<span data-ttu-id="7d868-114">При обновлении Blazor WebAssembly проекта перейдите к разделу [Обновление Blazor WebAssembly проектов](#update-blazor-webassembly-projects) .</span><span class="sxs-lookup"><span data-stu-id="7d868-114">If updating a Blazor WebAssembly project, skip to the [Update Blazor WebAssembly projects](#update-blazor-webassembly-projects) section.</span></span> <span data-ttu-id="7d868-115">Для любого другого типа проекта ASP.NET Core обновите [моникер целевой платформы файла проекта (TFM)](/dotnet/standard/frameworks) `net5.0` следующим образом:</span><span class="sxs-lookup"><span data-stu-id="7d868-115">For any other ASP.NET Core project type, update the project file's [Target Framework Moniker (TFM)](/dotnet/standard/frameworks) to `net5.0`:</span></span>

```diff
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
-    <TargetFramework>netcoreapp3.1</TargetFramework>
+    <TargetFramework>net5.0</TargetFramework>
  </PropertyGroup>

</Project>
```

## <a name="changes-to-no-locblazor-app-routing-logic-in-501"></a><span data-ttu-id="7d868-116">Изменения в Blazor логике маршрутизации приложений в 5.0.1</span><span class="sxs-lookup"><span data-stu-id="7d868-116">Changes to Blazor app routing logic in 5.0.1</span></span>

<span data-ttu-id="7d868-117">Вычисление приоритета маршрута изменилось в ASP.NET Coreном выпуске исправления 5.0.1.</span><span class="sxs-lookup"><span data-stu-id="7d868-117">The computation of route precedence changed in the ASP.NET Core 5.0.1 patch release.</span></span> <span data-ttu-id="7d868-118">Это может повлиять на вас, если вы определили перехватывать все маршруты или маршруты с необязательными параметрами.</span><span class="sxs-lookup"><span data-stu-id="7d868-118">This might affect you if you've defined catch-all routes or routes with optional parameters.</span></span>

### <a name="old-behavior"></a><span data-ttu-id="7d868-119">Старое поведение</span><span class="sxs-lookup"><span data-stu-id="7d868-119">Old behavior</span></span>

<span data-ttu-id="7d868-120">С предыдущим поведением в ASP.NET Core 5.0.0 или более ранней версии маршруты с более низким приоритетом, такие как, сопоставляются `{*slug}` перед маршрутами с более высоким приоритетом, например `/customer/{id}` .</span><span class="sxs-lookup"><span data-stu-id="7d868-120">With the prior behavior in ASP.NET Core 5.0.0 or earlier, routes with lower precedence, such as `{*slug}`, are matched before routes with higher precedence, such as `/customer/{id}`.</span></span>

### <a name="new-behavior"></a><span data-ttu-id="7d868-121">Новое поведение</span><span class="sxs-lookup"><span data-stu-id="7d868-121">New behavior</span></span>

<span data-ttu-id="7d868-122">Новое поведение в ASP.NET Core 5.0.1 или более поздней версии соответствует поведению маршрутизации, определенному в ASP.NET Core приложениях, где платформа рассчитывает и устанавливает приоритет маршрута для каждого сегмента, а также использует длину маршрута для прерывания связей в качестве вторичного критерия.</span><span class="sxs-lookup"><span data-stu-id="7d868-122">The new behavior in ASP.NET Core 5.0.1 or later more closely matches the routing behavior defined in ASP.NET Core apps, where the framework computes and establishes the route precedence for each segment first and only uses the length of the route to break ties as a secondary criteria.</span></span>

### <a name="reason-for-change"></a><span data-ttu-id="7d868-123">Причина изменения</span><span class="sxs-lookup"><span data-stu-id="7d868-123">Reason for change</span></span>

<span data-ttu-id="7d868-124">Исходное поведение считается ошибкой в реализации, поскольку наша цель заключается в том, чтобы система маршрутизации находилась так Blazor же, как и система маршрутизации ASP.NET Core для подмножества функций, поддерживаемых Blazor маршрутизацией.</span><span class="sxs-lookup"><span data-stu-id="7d868-124">The original behavior is considered a bug in the implementation because our goal is for the Blazor routing system to behave in the same way as the ASP.NET Core routing system for the subset of features supported by Blazor routing.</span></span>

### <a name="recommended-action"></a><span data-ttu-id="7d868-125">Рекомендованное действие</span><span class="sxs-lookup"><span data-stu-id="7d868-125">Recommended action</span></span>

<span data-ttu-id="7d868-126">Добавьте `PreferExactMatches` атрибут к `Router` компоненту в файле, `App.razor` чтобы принять правильное поведение:</span><span class="sxs-lookup"><span data-stu-id="7d868-126">Add the `PreferExactMatches` attribute to the `Router` component in the `App.razor` file to opt into the correct behavior:</span></span>

```razor
<Router AppAssembly="@typeof(Program).Assembly" PreferExactMatches="@true">
```

<span data-ttu-id="7d868-127">Если `PreferExactMatches` для задано значение `@true` , то сопоставление маршрутов предпочитает поиск точных совпадений по подстановочным знакам.</span><span class="sxs-lookup"><span data-stu-id="7d868-127">When `PreferExactMatches` is set to `@true`, route matching prefers exact matches over wildcards.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="7d868-128">Все приложения должны явно задать `PreferExactMatches` значение `@true` .</span><span class="sxs-lookup"><span data-stu-id="7d868-128">All apps should explicitly set `PreferExactMatches` to `@true`.</span></span>
>
> <span data-ttu-id="7d868-129">Возможность задать значение `PreferExactMatches` `@false` или оставить его неопределенным, что по умолчанию `false` имеет значение в языке C#, *только для обратной совместимости*.</span><span class="sxs-lookup"><span data-stu-id="7d868-129">The ability to set `PreferExactMatches` to `@false` or leave it unset, which defaults the option to `false` in C#, *is only provided for backward compatibility*.</span></span>
>
> <span data-ttu-id="7d868-130">При выпуске .NET 6 маршрутизатор всегда будет предпочитать точные соответствия, и параметр будет `PreferExactMatches` недоступен.</span><span class="sxs-lookup"><span data-stu-id="7d868-130">When .NET 6 is released, the router will always prefer exact matches, and the `PreferExactMatches` option won't be available.</span></span>

## <a name="update-no-locblazor-webassembly-and-no-locblazor-server-projects"></a><span data-ttu-id="7d868-131">Обновление Blazor WebAssembly и Blazor Server проекты</span><span class="sxs-lookup"><span data-stu-id="7d868-131">Update Blazor WebAssembly and Blazor Server projects</span></span>

<span data-ttu-id="7d868-132">*Рекомендации в этом разделе относятся к Blazor моделям размещения. В разделах, следующих за этим разделом, приведены дополнительные рекомендации, относящиеся к размещению моделей и типов приложений. Примените рекомендации из всех соответствующих разделов к приложению.*</span><span class="sxs-lookup"><span data-stu-id="7d868-132">*The guidance in this section applies to both Blazor hosting models. Sections following this section provide additional guidance specific to hosting models and app types. Apply the guidance from all relevant sections to your app.*</span></span>

1. <span data-ttu-id="7d868-133">В `wwwroot/index.html` Blazor WebAssembly приложении или в `Pages/_Host.cshtml` Blazor Server приложении добавьте `<link>` элемент в `<head>` элемент для стилей.</span><span class="sxs-lookup"><span data-stu-id="7d868-133">In `wwwroot/index.html` of a Blazor WebAssembly app or the `Pages/_Host.cshtml` of a Blazor Server app, add a `<link>` element to the `<head>` element for styles.</span></span> <span data-ttu-id="7d868-134">В следующих `<link>` `href` значениях атрибута element заполнителем `{ASSEMBLY NAME}` является имя сборки приложения.</span><span class="sxs-lookup"><span data-stu-id="7d868-134">In the following `<link>` element `href` attribute values, the placeholder `{ASSEMBLY NAME}` is the app's assembly name.</span></span>

    ```diff
    +<link href="{ASSEMBLY NAME}.styles.css" rel="stylesheet" />
    ```
    
    <span data-ttu-id="7d868-135">Автономный Blazor WebAssembly или Blazor Server Пример:</span><span class="sxs-lookup"><span data-stu-id="7d868-135">Standalone Blazor WebAssembly or Blazor Server example:</span></span>
    
    ```diff
    +<link href="BlazorSample.styles.css" rel="stylesheet" />
    ```

    <span data-ttu-id="7d868-136">*`Client`* Пример проекта размещенного Blazor WebAssembly решения:</span><span class="sxs-lookup"><span data-stu-id="7d868-136">*`Client`* project of a hosted Blazor WebAssembly solution example:</span></span>
    
    ```diff
    +<link href="BlazorSample.Client.styles.css" rel="stylesheet" />
    ```

1. <span data-ttu-id="7d868-137">Включите новое пространство имен в `_Imports.razor` файл приложения для [виртуализации компонентов](xref:blazor/components/virtualization) <xref:Microsoft.AspNetCore.Components.Web.Virtualization?displayProperty=fullName> .</span><span class="sxs-lookup"><span data-stu-id="7d868-137">Include a new namespace in the app's `_Imports.razor` file for [component virtualization](xref:blazor/components/virtualization), <xref:Microsoft.AspNetCore.Components.Web.Virtualization?displayProperty=fullName>.</span></span> <span data-ttu-id="7d868-138">В следующих `_Imports.razor` файлах показаны пространства имен по умолчанию в приложениях, созданных из Blazor шаблонов проектов.</span><span class="sxs-lookup"><span data-stu-id="7d868-138">The following `_Imports.razor` files show the default namespaces in apps generated from the Blazor project templates.</span></span> <span data-ttu-id="7d868-139">Заполнитель `{ASSEMBLY NAME}` — это имя сборки приложения.</span><span class="sxs-lookup"><span data-stu-id="7d868-139">The placeholder `{ASSEMBLY NAME}` is the app's assembly name.</span></span>

   <span data-ttu-id="7d868-140">Blazor WebAssembly (`_Imports.razor`):</span><span class="sxs-lookup"><span data-stu-id="7d868-140">Blazor WebAssembly (`_Imports.razor`):</span></span>
   
   ```razor
   @using System.Net.Http
   @using System.Net.Http.Json
   @using Microsoft.AspNetCore.Components.Forms
   @using Microsoft.AspNetCore.Components.Routing
   @using Microsoft.AspNetCore.Components.Web
   @using Microsoft.AspNetCore.Components.Web.Virtualization
   @using Microsoft.AspNetCore.Components.WebAssembly.Http
   @using Microsoft.JSInterop
   @using {ASSEMBLY NAME}
   @using {ASSEMBLY NAME}.Shared
   ```

   <span data-ttu-id="7d868-141">Blazor Server (`_Imports.razor`):</span><span class="sxs-lookup"><span data-stu-id="7d868-141">Blazor Server (`_Imports.razor`):</span></span>
   
   ```razor
   @using System.Net.Http
   @using Microsoft.AspNetCore.Authorization
   @using Microsoft.AspNetCore.Components.Authorization
   @using Microsoft.AspNetCore.Components.Forms
   @using Microsoft.AspNetCore.Components.Routing
   @using Microsoft.AspNetCore.Components.Web
   @using Microsoft.AspNetCore.Components.Web.Virtualization
   @using Microsoft.JSInterop
   @using {ASSEMBLY NAME}
   @using {ASSEMBLY NAME}.Shared
   ```
   
1. <span data-ttu-id="7d868-142">В `MainLayout` компоненте ( `Shared/MainLayout.razor` ) заключите разметку HTML компонента в `<div>` элемент, атрибут которого имеет `class` значение `page` :</span><span class="sxs-lookup"><span data-stu-id="7d868-142">In the `MainLayout` component (`Shared/MainLayout.razor`), surround the component's HTML markup with a `<div>` element that has a `class` attribute set to `page`:</span></span>

    ```razor
    <div class="page">
    
        ...
        
    </div>
    ```
    
1. <span data-ttu-id="7d868-143">Добавьте в папку следующие файлы `Shared` :</span><span class="sxs-lookup"><span data-stu-id="7d868-143">Add the following files to the `Shared` folder:</span></span>

    <span data-ttu-id="7d868-144">`MainLayout.razor.css`:</span><span class="sxs-lookup"><span data-stu-id="7d868-144">`MainLayout.razor.css`:</span></span>
    
    ```css
    .page {
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .main {
        flex: 1;
    }

    .sidebar {
        background-image: linear-gradient(180deg, rgb(5, 39, 103) 0%, #3a0647 70%);
    }

    .top-row {
        background-color: #f7f7f7;
        border-bottom: 1px solid #d6d5d5;
        justify-content: flex-end;
        height: 3.5rem;
        display: flex;
        align-items: center;
    }

        .top-row ::deep a, .top-row .btn-link {
            white-space: nowrap;
            margin-left: 1.5rem;
        }

        .top-row a:first-child {
            overflow: hidden;
            text-overflow: ellipsis;
        }

    @media (max-width: 767.98px) {
        .top-row:not(.auth) {
            display: none;
        }

        .top-row.auth {
            justify-content: space-between;
        }

        .top-row a, .top-row .btn-link {
            margin-left: 0;
        }
    }

    @media (min-width: 768px) {
        .page {
            flex-direction: row;
        }

        .sidebar {
            width: 250px;
            height: 100vh;
            position: sticky;
            top: 0;
        }

        .top-row {
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .main > div {
            padding-left: 2rem !important;
            padding-right: 1.5rem !important;
        }
    }
    ```
    
    <span data-ttu-id="7d868-145">`NavMenu.razor.css`:</span><span class="sxs-lookup"><span data-stu-id="7d868-145">`NavMenu.razor.css`:</span></span>
    
    ```css
    .navbar-toggler {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .top-row {
        height: 3.5rem;
        background-color: rgba(0,0,0,0.4);
    }

    .navbar-brand {
        font-size: 1.1rem;
    }

    .oi {
        width: 2rem;
        font-size: 1.1rem;
        vertical-align: text-top;
        top: -2px;
    }

    .nav-item {
        font-size: 0.9rem;
        padding-bottom: 0.5rem;
    }

        .nav-item:first-of-type {
            padding-top: 1rem;
        }

        .nav-item:last-of-type {
            padding-bottom: 1rem;
        }

        .nav-item ::deep a {
            color: #d7d7d7;
            border-radius: 4px;
            height: 3rem;
            display: flex;
            align-items: center;
            line-height: 3rem;
        }

    .nav-item ::deep a.active {
        background-color: rgba(255,255,255,0.25);
        color: white;
    }

    .nav-item ::deep a:hover {
        background-color: rgba(255,255,255,0.1);
        color: white;
    }

    @media (min-width: 768px) {
        .navbar-toggler {
            display: none;
        }

        .collapse {
            /* Never collapse the sidebar for wide screens */
            display: block;
        }
    }
    ```

1. <span data-ttu-id="7d868-146">Последний базовый `wwwroot/css/app.css` файл Blazor WebAssembly приложения или `wwwroot/css/site.css` файла Blazor Server приложения содержит следующие стили.</span><span class="sxs-lookup"><span data-stu-id="7d868-146">The latest base `wwwroot/css/app.css` file of a Blazor WebAssembly app or `wwwroot/css/site.css` file of a Blazor Server app includes the following styles.</span></span> <span data-ttu-id="7d868-147">Удалите дополнительные стили, в которых находятся следующие стили и все, что вы добавили в приложение.</span><span class="sxs-lookup"><span data-stu-id="7d868-147">Remove extra styles leaving the following styles and any that you've added to the app.</span></span>

    <span data-ttu-id="7d868-148">Следующая таблица стилей содержит только базовые стили и не **включает пользовательские** стили, добавленные разработчиком:</span><span class="sxs-lookup"><span data-stu-id="7d868-148">The following stylesheet only includes base styles and does **not** include custom styles added by the developer:</span></span>
   
    ```css
    @import url('open-iconic/font/css/open-iconic-bootstrap.min.css');

    html, body {
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    a, .btn-link {
        color: #0366d6;
    }

    .btn-primary {
        color: #fff;
        background-color: #1b6ec2;
        border-color: #1861ac;
    }

    .content {
        padding-top: 1.1rem;
    }

    .valid.modified:not([type=checkbox]) {
        outline: 1px solid #26b050;
    }

    .invalid {
        outline: 1px solid red;
    }

    .validation-message {
        color: red;
    }

    #blazor-error-ui {
        background: lightyellow;
        bottom: 0;
        box-shadow: 0 -1px 2px rgba(0, 0, 0, 0.2);
        display: none;
        left: 0;
        padding: 0.6rem 1.25rem 0.7rem 1.25rem;
        position: fixed;
        width: 100%;
        z-index: 1000;
    }

    #blazor-error-ui .dismiss {
        cursor: pointer;
        position: absolute;
        right: 0.75rem;
        top: 0.5rem;
    }
    ```

## <a name="update-no-locblazor-webassembly-projects"></a><span data-ttu-id="7d868-149">Обновление Blazor WebAssembly проектов</span><span class="sxs-lookup"><span data-stu-id="7d868-149">Update Blazor WebAssembly projects</span></span>

<span data-ttu-id="7d868-150">Следуйте указаниям в предыдущем разделе [Обновление Blazor WebAssembly и Blazor Server проекты](#update-blazor-webassembly-and-blazor-server-projects) .</span><span class="sxs-lookup"><span data-stu-id="7d868-150">Follow the guidance in the preceding [Update Blazor WebAssembly and Blazor Server projects](#update-blazor-webassembly-and-blazor-server-projects) section.</span></span>

<span data-ttu-id="7d868-151">Для Blazor WebAssembly проекта, включая *`Client`* проект размещенного Blazor решения, внесите в файл проекта следующие изменения:</span><span class="sxs-lookup"><span data-stu-id="7d868-151">For a Blazor WebAssembly project, including the *`Client`* project of a hosted Blazor solution, apply the following changes to the project file:</span></span>

1. <span data-ttu-id="7d868-152">Обновите пакет SDK с `Microsoft.NET.Sdk.Web` на `Microsoft.NET.Sdk.BlazorWebAssembly` :</span><span class="sxs-lookup"><span data-stu-id="7d868-152">Update the SDK from `Microsoft.NET.Sdk.Web` to `Microsoft.NET.Sdk.BlazorWebAssembly`:</span></span>

    ```diff
    - <Project Sdk="Microsoft.NET.Sdk.Web">
    + <Project Sdk="Microsoft.NET.Sdk.BlazorWebAssembly">
    ```
    
    > [!NOTE]
    > <span data-ttu-id="7d868-153">Это обновление применяется только к отдельным Blazor WebAssembly проектам и *`Client`* проектам размещенных Blazor решений.</span><span class="sxs-lookup"><span data-stu-id="7d868-153">This update only applies to standalone Blazor WebAssembly projects and the *`Client`* projects of hosted Blazor solutions.</span></span>

1. <span data-ttu-id="7d868-154">Обновите следующие свойства:</span><span class="sxs-lookup"><span data-stu-id="7d868-154">Update the following properties:</span></span>

    ```diff
    <Project Sdk="Microsoft.NET.Sdk.BlazorWebAssembly">
    
      <PropertyGroup>
    -     <TargetFramework>netstandard2.1</TargetFramework>
    -     <RazorLangVersion>3.0</RazorLangVersion>
    +     <TargetFramework>net5.0</TargetFramework>
      </PropertyGroup>
    ```

1. <span data-ttu-id="7d868-155">Удалите ссылку на пакет в [Microsoft. AspNetCore. Components. Assembly. Build](https://www.nuget.org/packages/Microsoft.AspNetCore.Components.WebAssembly.Build):</span><span class="sxs-lookup"><span data-stu-id="7d868-155">Remove the package reference to [Microsoft.AspNetCore.Components.WebAssembly.Build](https://www.nuget.org/packages/Microsoft.AspNetCore.Components.WebAssembly.Build):</span></span>

    ```diff
    <ItemGroup>
    -    <PackageReference Include="Microsoft.AspNetCore.Components.WebAssembly.Build" Version="3.2.1" PrivateAssets="all" />
    ```

1. <span data-ttu-id="7d868-156">Обновите другие пакеты до их последних версий.</span><span class="sxs-lookup"><span data-stu-id="7d868-156">Update other packages to their latest versions.</span></span> <span data-ttu-id="7d868-157">Последние версии можно найти по адресу [NuGet.org](https://www.nuget.org).</span><span class="sxs-lookup"><span data-stu-id="7d868-157">The latest versions can be found at [NuGet.org](https://www.nuget.org).</span></span>

1. <span data-ttu-id="7d868-158">В службах `wwwroot/index.html` измените элемент, загружающий `App` компонент, на `<div>` элемент с `id` установленным значением `app` :</span><span class="sxs-lookup"><span data-stu-id="7d868-158">In `wwwroot/index.html`, change the element that loads the `App` component to a `<div>` element with an `id` set to `app`:</span></span>
    
    ```diff
    -<app>Loading...</app>
    +<div id="app">Loading...</div>
    ```
    
1. <span data-ttu-id="7d868-159">В `Program.Main` (`Program.cs`):</span><span class="sxs-lookup"><span data-stu-id="7d868-159">In `Program.Main` (`Program.cs`):</span></span>

   * <span data-ttu-id="7d868-160">Измените ссылку на `<app>` элемент на селектор CSS, добавив в `#` него хэш.</span><span class="sxs-lookup"><span data-stu-id="7d868-160">Change the reference to the `<app>` element to a CSS selector by adding a hash `#` to it.</span></span>
   * <span data-ttu-id="7d868-161">Измените `HttpClient` регистрацию на область.</span><span class="sxs-lookup"><span data-stu-id="7d868-161">Change the `HttpClient` registration to scoped.</span></span>

    ```diff
    -builder.RootComponents.Add<App>("app");
    +builder.RootComponents.Add<App>("#app");
    
    -builder.Services.AddTransient(sp => new HttpClient 
    -    { BaseAddress = new Uri(builder.HostEnvironment.BaseAddress) });
    +builder.Services.AddScoped(sp => new HttpClient 
    +    { BaseAddress = new Uri(builder.HostEnvironment.BaseAddress) });
    ```

### <a name="standalone-no-locblazor-webassembly-app-with-microsoft-accounts"></a><span data-ttu-id="7d868-162">Автономное Blazor WebAssembly приложение с учетными записями Майкрософт</span><span class="sxs-lookup"><span data-stu-id="7d868-162">Standalone Blazor WebAssembly app with Microsoft Accounts</span></span>

<span data-ttu-id="7d868-163">Следуйте указаниям, приведенным в разделах, посвященных [обновлению Blazor WebAssembly и Blazor Server проектам](#update-blazor-webassembly-and-blazor-server-projects) , и [Обновление Blazor WebAssembly проектов](#update-blazor-webassembly-projects) .</span><span class="sxs-lookup"><span data-stu-id="7d868-163">Follow the guidance in the preceding [Update Blazor WebAssembly and Blazor Server projects](#update-blazor-webassembly-and-blazor-server-projects) and [Update Blazor WebAssembly projects](#update-blazor-webassembly-projects) sections.</span></span>

<span data-ttu-id="7d868-164">Для автономного Blazor WebAssembly приложения, зарегистрированного в портал Azure для использования Azure Active Directory (AAD) для учетных записей Майкрософт:</span><span class="sxs-lookup"><span data-stu-id="7d868-164">For a standalone Blazor WebAssembly app registered in the Azure portal to use Azure Active Directory (AAD) for Microsoft Accounts:</span></span>

* <span data-ttu-id="7d868-165">Для приложения требуются `openid` области и `offline_access` :</span><span class="sxs-lookup"><span data-stu-id="7d868-165">The app requires the `openid` and `offline_access` scopes:</span></span>

  ```csharp
  options.ProviderOptions.DefaultAccessTokenScopes.Add("openid");
  options.ProviderOptions.DefaultAccessTokenScopes.Add("offline_access");
  ```
  
* <span data-ttu-id="7d868-166">В колонке портал Azure **проверки подлинности** регистрации приложений:</span><span class="sxs-lookup"><span data-stu-id="7d868-166">In the Azure portal app registration **Authentication** blade:</span></span>

  1. <span data-ttu-id="7d868-167">Удалите конфигурацию **веб-** платформы.</span><span class="sxs-lookup"><span data-stu-id="7d868-167">Remove the **Web** platform configuration.</span></span>
  1. <span data-ttu-id="7d868-168">Добавьте конфигурацию платформы **одностраничного приложения** с URI перенаправления приложения.</span><span class="sxs-lookup"><span data-stu-id="7d868-168">Add a **Single-page application** platform configuration with the app's redirect URI.</span></span>
  1. <span data-ttu-id="7d868-169">Отключите **неявное предоставление** для **маркеров доступа** и **маркеров идентификации**.</span><span class="sxs-lookup"><span data-stu-id="7d868-169">Disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>

<span data-ttu-id="7d868-170">Для получения дополнительной информации см. <xref:blazor/security/webassembly/standalone-with-microsoft-accounts>.</span><span class="sxs-lookup"><span data-stu-id="7d868-170">For more information, see <xref:blazor/security/webassembly/standalone-with-microsoft-accounts>.</span></span>

### <a name="standalone-no-locblazor-webassembly-app-with-azure-active-directory-aad"></a><span data-ttu-id="7d868-171">Автономное Blazor WebAssembly приложение с Azure Active Directory (AAD)</span><span class="sxs-lookup"><span data-stu-id="7d868-171">Standalone Blazor WebAssembly app with Azure Active Directory (AAD)</span></span>

<span data-ttu-id="7d868-172">Следуйте указаниям, приведенным в разделах, посвященных [обновлению Blazor WebAssembly и Blazor Server проектам](#update-blazor-webassembly-and-blazor-server-projects) , и [Обновление Blazor WebAssembly проектов](#update-blazor-webassembly-projects) .</span><span class="sxs-lookup"><span data-stu-id="7d868-172">Follow the guidance in the preceding [Update Blazor WebAssembly and Blazor Server projects](#update-blazor-webassembly-and-blazor-server-projects) and [Update Blazor WebAssembly projects](#update-blazor-webassembly-projects) sections.</span></span>

<span data-ttu-id="7d868-173">Для автономного Blazor WebAssembly приложения, зарегистрированного в портал Azure для использования Azure Active Directory (AAD):</span><span class="sxs-lookup"><span data-stu-id="7d868-173">For a standalone Blazor WebAssembly app registered in the Azure portal to use Azure Active Directory (AAD):</span></span>

* <span data-ttu-id="7d868-174">Для приложения требуется `https://graph.microsoft.com/User.Read` область:</span><span class="sxs-lookup"><span data-stu-id="7d868-174">The app requires the `https://graph.microsoft.com/User.Read` scope:</span></span>

  ```csharp
  options.ProviderOptions.DefaultAccessTokenScopes
      .Add("https://graph.microsoft.com/User.Read");
  ```
  
* <span data-ttu-id="7d868-175">В колонке портал Azure **проверки подлинности** регистрации приложений:</span><span class="sxs-lookup"><span data-stu-id="7d868-175">In the Azure portal app registration **Authentication** blade:</span></span>

  1. <span data-ttu-id="7d868-176">Удалите конфигурацию **веб-** платформы.</span><span class="sxs-lookup"><span data-stu-id="7d868-176">Remove the **Web** platform configuration.</span></span>
  1. <span data-ttu-id="7d868-177">Добавьте конфигурацию платформы **одностраничного приложения** с URI перенаправления приложения.</span><span class="sxs-lookup"><span data-stu-id="7d868-177">Add a **Single-page application** platform configuration with the app's redirect URI.</span></span>
  1. <span data-ttu-id="7d868-178">Отключите **неявное предоставление** для **маркеров доступа** и **маркеров идентификации**.</span><span class="sxs-lookup"><span data-stu-id="7d868-178">Disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>
  
<span data-ttu-id="7d868-179">Для получения дополнительной информации см. <xref:blazor/security/webassembly/standalone-with-azure-active-directory>.</span><span class="sxs-lookup"><span data-stu-id="7d868-179">For more information, see <xref:blazor/security/webassembly/standalone-with-azure-active-directory>.</span></span>

### <a name="standalone-no-locblazor-webassembly-app-with-azure-active-directory-aad-b2c"></a><span data-ttu-id="7d868-180">Автономное Blazor WebAssembly приложение с Azure Active Directory (AAD) B2C</span><span class="sxs-lookup"><span data-stu-id="7d868-180">Standalone Blazor WebAssembly app with Azure Active Directory (AAD) B2C</span></span>

<span data-ttu-id="7d868-181">Следуйте указаниям, приведенным в разделах, посвященных [обновлению Blazor WebAssembly и Blazor Server проектам](#update-blazor-webassembly-and-blazor-server-projects) , и [Обновление Blazor WebAssembly проектов](#update-blazor-webassembly-projects) .</span><span class="sxs-lookup"><span data-stu-id="7d868-181">Follow the guidance in the preceding [Update Blazor WebAssembly and Blazor Server projects](#update-blazor-webassembly-and-blazor-server-projects) and [Update Blazor WebAssembly projects](#update-blazor-webassembly-projects) sections.</span></span>

<span data-ttu-id="7d868-182">Для автономного Blazor WebAssembly приложения, зарегистрированного в портал Azure для использования Azure Active Directory (AAD) B2C:</span><span class="sxs-lookup"><span data-stu-id="7d868-182">For a standalone Blazor WebAssembly app registered in the Azure portal to use Azure Active Directory (AAD) B2C:</span></span>

* <span data-ttu-id="7d868-183">Для приложения требуются `openid` области и `offline_access` :</span><span class="sxs-lookup"><span data-stu-id="7d868-183">The app requires the `openid` and `offline_access` scopes:</span></span>

  ```csharp
  options.ProviderOptions.DefaultAccessTokenScopes.Add("openid");
  options.ProviderOptions.DefaultAccessTokenScopes.Add("offline_access");
  ```
  
* <span data-ttu-id="7d868-184">В колонке портал Azure **проверки подлинности** регистрации приложений:</span><span class="sxs-lookup"><span data-stu-id="7d868-184">In the Azure portal app registration **Authentication** blade:</span></span>

  1. <span data-ttu-id="7d868-185">Удалите конфигурацию **веб-** платформы.</span><span class="sxs-lookup"><span data-stu-id="7d868-185">Remove the **Web** platform configuration.</span></span>
  1. <span data-ttu-id="7d868-186">Добавьте конфигурацию платформы **одностраничного приложения** с URI перенаправления приложения.</span><span class="sxs-lookup"><span data-stu-id="7d868-186">Add a **Single-page application** platform configuration with the app's redirect URI.</span></span>
  1. <span data-ttu-id="7d868-187">Отключите **неявное предоставление** для **маркеров доступа** и **маркеров идентификации**.</span><span class="sxs-lookup"><span data-stu-id="7d868-187">Disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>

<span data-ttu-id="7d868-188">Для получения дополнительной информации см. <xref:blazor/security/webassembly/standalone-with-azure-active-directory-b2c>.</span><span class="sxs-lookup"><span data-stu-id="7d868-188">For more information, see <xref:blazor/security/webassembly/standalone-with-azure-active-directory-b2c>.</span></span>

### <a name="hosted-no-locblazor-webassembly-app-with-azure-active-directory-aad-or-aad-b2c"></a><span data-ttu-id="7d868-189">Размещенное Blazor WebAssembly приложение с Azure Active Directory (AAD) или AAD B2C</span><span class="sxs-lookup"><span data-stu-id="7d868-189">Hosted Blazor WebAssembly app with Azure Active Directory (AAD) or AAD B2C</span></span>

<span data-ttu-id="7d868-190">Следуйте указаниям, приведенным в разделах, посвященных [обновлению Blazor WebAssembly и Blazor Server проектам](#update-blazor-webassembly-and-blazor-server-projects) , и [Обновление Blazor WebAssembly проектов](#update-blazor-webassembly-projects) .</span><span class="sxs-lookup"><span data-stu-id="7d868-190">Follow the guidance in the preceding [Update Blazor WebAssembly and Blazor Server projects](#update-blazor-webassembly-and-blazor-server-projects) and [Update Blazor WebAssembly projects](#update-blazor-webassembly-projects) sections.</span></span>

<span data-ttu-id="7d868-191">*`Client`* Регистрация приложения размещенного Blazor решения, использующего AAD или AAD B2C для проверки подлинности пользователей, должно использовать конфигурацию платформы приложений Azure с **одной страницей** .</span><span class="sxs-lookup"><span data-stu-id="7d868-191">The *`Client`* app registration of a hosted Blazor solution that uses AAD or AAD B2C for user authentication should use a **Single-page application** Azure Apps platform configuration.</span></span>

<span data-ttu-id="7d868-192">В *`Client`* колонке портал Azure **проверки подлинности** регистрации приложений:</span><span class="sxs-lookup"><span data-stu-id="7d868-192">In the Azure portal *`Client`* app registration **Authentication** blade:</span></span>

  1. <span data-ttu-id="7d868-193">Удалите конфигурацию **веб-** платформы.</span><span class="sxs-lookup"><span data-stu-id="7d868-193">Remove the **Web** platform configuration.</span></span>
  1. <span data-ttu-id="7d868-194">Добавьте конфигурацию платформы **одностраничного приложения** с URI перенаправления приложения.</span><span class="sxs-lookup"><span data-stu-id="7d868-194">Add a **Single-page application** platform configuration with the app's redirect URI.</span></span>
  1. <span data-ttu-id="7d868-195">Отключите **неявное предоставление** для **маркеров доступа** и **маркеров идентификации**.</span><span class="sxs-lookup"><span data-stu-id="7d868-195">Disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>

<span data-ttu-id="7d868-196">Дополнительные сведения см. в разделе:</span><span class="sxs-lookup"><span data-stu-id="7d868-196">For more information, see:</span></span>

* <xref:blazor/security/webassembly/hosted-with-azure-active-directory>
* <xref:blazor/security/webassembly/hosted-with-azure-active-directory-b2c>

### <a name="update-the-server-project-of-a-hosted-no-locblazor-solution"></a><span data-ttu-id="7d868-197">Обновление серверного проекта размещенного Blazor решения</span><span class="sxs-lookup"><span data-stu-id="7d868-197">Update the Server project of a hosted Blazor solution</span></span>

<span data-ttu-id="7d868-198">Следуйте указаниям в предыдущих разделах:</span><span class="sxs-lookup"><span data-stu-id="7d868-198">Follow the guidance in the preceding sections:</span></span>

* [<span data-ttu-id="7d868-199">Обновление Blazor WebAssembly и Blazor Server проекты</span><span class="sxs-lookup"><span data-stu-id="7d868-199">Update Blazor WebAssembly and Blazor Server projects</span></span>](#update-blazor-webassembly-and-blazor-server-projects)
* [<span data-ttu-id="7d868-200">Обновление Blazor WebAssembly проектов</span><span class="sxs-lookup"><span data-stu-id="7d868-200">Update Blazor WebAssembly projects</span></span>](#update-blazor-webassembly-projects)
* <span data-ttu-id="7d868-201">Раздел, который применяется к поставщику приложения с Azure Active Directory:</span><span class="sxs-lookup"><span data-stu-id="7d868-201">The section that applies to the app's provider with Azure Active Directory:</span></span>
  * [<span data-ttu-id="7d868-202">Автономное Blazor WebAssembly приложение с учетными записями Майкрософт</span><span class="sxs-lookup"><span data-stu-id="7d868-202">Standalone Blazor WebAssembly app with Microsoft Accounts</span></span>](#standalone-blazor-webassembly-app-with-microsoft-accounts)
  * [<span data-ttu-id="7d868-203">Автономное Blazor WebAssembly приложение с Azure Active Directory (AAD)</span><span class="sxs-lookup"><span data-stu-id="7d868-203">Standalone Blazor WebAssembly app with Azure Active Directory (AAD)</span></span>](#standalone-blazor-webassembly-app-with-azure-active-directory-aad)
  * [<span data-ttu-id="7d868-204">Автономное Blazor WebAssembly приложение с Azure Active Directory (AAD) B2C</span><span class="sxs-lookup"><span data-stu-id="7d868-204">Standalone Blazor WebAssembly app with Azure Active Directory (AAD) B2C</span></span>](#standalone-blazor-webassembly-app-with-azure-active-directory-aad-b2c)

<span data-ttu-id="7d868-205">Обновите *`Server`* проект размещенного Blazor решения как приложение ASP.NET Core, следуя общим рекомендациям в этой статье.</span><span class="sxs-lookup"><span data-stu-id="7d868-205">Update the *`Server`* project of a hosted Blazor solution as an ASP.NET Core app following the general guidance in this article.</span></span>

<span data-ttu-id="7d868-206">Кроме того, *`Server`* проекты, которые выполняют проверку подлинности пользователей в клиентских Blazor WebAssembly приложениях с помощью Azure Active Directory (AAD) или B2C, должны внедрять новые Identity пакеты Microsoft v 2.0:</span><span class="sxs-lookup"><span data-stu-id="7d868-206">Additionally, *`Server`* projects that authenticate users to client Blazor WebAssembly apps with Azure Active Directory (AAD) or B2C should adopt new Microsoft Identity v2.0 packages:</span></span> 
  
<span data-ttu-id="7d868-207">Для AAD:</span><span class="sxs-lookup"><span data-stu-id="7d868-207">For AAD:</span></span>

```diff
-<PackageReference Include="Microsoft.AspNetCore.Authentication.AzureAD.UI" Version="..." />
+<PackageReference Include="Microsoft.Identity.Web" Version="{VERSION}" />
+<PackageReference Include="Microsoft.Identity.Web.UI" Version="{VERSION}" />
```

<span data-ttu-id="7d868-208">Для AAD B2C:</span><span class="sxs-lookup"><span data-stu-id="7d868-208">For AAD B2C:</span></span>

```diff
-<PackageReference Include="Microsoft.AspNetCore.Authentication.AzureADB2C.UI" Version="..." />
+<PackageReference Include="Microsoft.Identity.Web" Version="{VERSION}" />
+<PackageReference Include="Microsoft.Identity.Web.UI" Version="{VERSION}" />
```

<span data-ttu-id="7d868-209">Для предыдущих ссылок на пакеты определите версии пакета для `{VERSION}` заполнителей по адресу NuGet.org:</span><span class="sxs-lookup"><span data-stu-id="7d868-209">For the preceding package references, determine the package versions for the `{VERSION}` placeholders at NuGet.org:</span></span>

* [`Microsoft.Identity.Web`](https://www.nuget.org/packages/Microsoft.Identity.Web)
* [`Microsoft.Identity.Web.UI`](https://www.nuget.org/packages/Microsoft.Identity.Web.UI)

> [!NOTE]
> <span data-ttu-id="7d868-210">Пакет SDK *`Server`* проекта в размещенном Blazor WebAssembly решении остается `Microsoft.NET.Sdk.Web` следующим образом:</span><span class="sxs-lookup"><span data-stu-id="7d868-210">The SDK of the *`Server`* project in a hosted Blazor WebAssembly solution remains `Microsoft.NET.Sdk.Web`:</span></span>
>
> ```xml
> <Project Sdk="Microsoft.NET.Sdk.Web">
> ```

<span data-ttu-id="7d868-211">Дополнительные сведения см. в разделе:</span><span class="sxs-lookup"><span data-stu-id="7d868-211">For more information, see:</span></span>

* <xref:blazor/security/webassembly/hosted-with-azure-active-directory>
* <xref:blazor/security/webassembly/hosted-with-azure-active-directory-b2c>

### <a name="clean-and-rebuild-the-solution"></a><span data-ttu-id="7d868-212">Очистка и перестроение решения</span><span class="sxs-lookup"><span data-stu-id="7d868-212">Clean and rebuild the solution</span></span>

<span data-ttu-id="7d868-213">После переноса приложения или решения в .NET 5 выполните очистку и перестроение приложения или решения.</span><span class="sxs-lookup"><span data-stu-id="7d868-213">After migrating the app or solution to .NET 5, clean and rebuild the app or solution.</span></span> <span data-ttu-id="7d868-214">Если между новыми ссылками на пакеты и кэшированными пакетами существуют несовместимости пакетов:</span><span class="sxs-lookup"><span data-stu-id="7d868-214">If package incompatibilities exist between new package references and cached packages:</span></span>

1. <span data-ttu-id="7d868-215">Очистите кэши пакетов NuGet, выполнив следующую [`dotnet nuget locals`](/dotnet/core/tools/dotnet-nuget-locals) команду в командной оболочке:</span><span class="sxs-lookup"><span data-stu-id="7d868-215">Clear NuGet package caches by executing the following [`dotnet nuget locals`](/dotnet/core/tools/dotnet-nuget-locals) command in a command shell:</span></span>

   ```dotnetcli
   dotnet nuget locals --clear all
   ```
   
1. <span data-ttu-id="7d868-216">Очистите и перестройте приложение или решение.</span><span class="sxs-lookup"><span data-stu-id="7d868-216">Clean and rebuild the app or solution.</span></span>

### <a name="troubleshoot"></a><span data-ttu-id="7d868-217">Диагностика</span><span class="sxs-lookup"><span data-stu-id="7d868-217">Troubleshoot</span></span>

<span data-ttu-id="7d868-218">Следуйте указаниям по *устранению неполадок* в конце Blazor WebAssembly раздела безопасности, относящегося к вашему приложению:</span><span class="sxs-lookup"><span data-stu-id="7d868-218">Follow the *Troubleshoot* guidance at the end of the Blazor WebAssembly security topic that applies to your app:</span></span>

<span data-ttu-id="7d868-219">Автономные приложения Blazor WebAssembly:</span><span class="sxs-lookup"><span data-stu-id="7d868-219">Standalone Blazor WebAssembly apps:</span></span>

* [<span data-ttu-id="7d868-220">Общие рекомендации по использованию поставщиков OIDC и библиотеки проверки подлинности WebAssembly</span><span class="sxs-lookup"><span data-stu-id="7d868-220">General guidance for OIDC providers and the WebAssembly Authentication Library</span></span>](xref:blazor/security/webassembly/standalone-with-authentication-library)
* [<span data-ttu-id="7d868-221">Учетные записи Майкрософт</span><span class="sxs-lookup"><span data-stu-id="7d868-221">Microsoft Accounts</span></span>](xref:blazor/security/webassembly/standalone-with-microsoft-accounts)
* [<span data-ttu-id="7d868-222">Azure Active Directory (AAD)</span><span class="sxs-lookup"><span data-stu-id="7d868-222">Azure Active Directory (AAD)</span></span>](xref:blazor/security/webassembly/standalone-with-azure-active-directory)
* [<span data-ttu-id="7d868-223">Azure Active Directory (AAD) B2C</span><span class="sxs-lookup"><span data-stu-id="7d868-223">Azure Active Directory (AAD) B2C</span></span>](xref:blazor/security/webassembly/standalone-with-azure-active-directory-b2c)

<span data-ttu-id="7d868-224">Размещенные приложения Blazor WebAssembly:</span><span class="sxs-lookup"><span data-stu-id="7d868-224">Hosted Blazor WebAssembly apps:</span></span>

* [<span data-ttu-id="7d868-225">Azure Active Directory (AAD)</span><span class="sxs-lookup"><span data-stu-id="7d868-225">Azure Active Directory (AAD)</span></span>](xref:blazor/security/webassembly/hosted-with-azure-active-directory)
* [<span data-ttu-id="7d868-226">Azure Active Directory (AAD) B2C</span><span class="sxs-lookup"><span data-stu-id="7d868-226">Azure Active Directory (AAD) B2C</span></span>](xref:blazor/security/webassembly/hosted-with-azure-active-directory-b2c)
* [<span data-ttu-id="7d868-227">Сервер Identity</span><span class="sxs-lookup"><span data-stu-id="7d868-227">Identity Server</span></span>](xref:blazor/security/webassembly/hosted-with-identity-server)

### <a name="unauthorized-client-for-azure-active-directory-aad"></a><span data-ttu-id="7d868-228">Неавторизованный клиент для Azure Active Directory (AAD)</span><span class="sxs-lookup"><span data-stu-id="7d868-228">Unauthorized client for Azure Active Directory (AAD)</span></span>

<span data-ttu-id="7d868-229">После обновления Blazor WebAssembly приложения, использующего AAD для проверки подлинности, может появиться следующая ошибка при обратном вызове входа в приложение после того, как пользователь войдет с помощью AAD:</span><span class="sxs-lookup"><span data-stu-id="7d868-229">After upgrading a Blazor WebAssembly app that uses AAD for authentication, you may receive the following error on the login callback to the app after the user signs in with AAD:</span></span>

> <span data-ttu-id="7d868-230">Сведения: Не удалось выполнить авторизацию Microsoft.AspNetCore.Authorization.DefaultAuthorizationService[2].</span><span class="sxs-lookup"><span data-stu-id="7d868-230">info: Microsoft.AspNetCore.Authorization.DefaultAuthorizationService[2] Authorization failed.</span></span> <span data-ttu-id="7d868-231">Не выполнены такие требования: DenyAnonymousAuthorizationRequirement. Требуется пользователь, прошедший проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="7d868-231">These requirements were not met: DenyAnonymousAuthorizationRequirement: Requires an authenticated user.</span></span>

<span data-ttu-id="7d868-232">Ошибка обратного вызова входа от AAD:</span><span class="sxs-lookup"><span data-stu-id="7d868-232">Login callback error from AAD:</span></span>

* <span data-ttu-id="7d868-233">Ошибка `unauthorized_client` (У вызывающей стороны нет прав на запись для ресурса: [subscriptions/])</span><span class="sxs-lookup"><span data-stu-id="7d868-233">Error: `unauthorized_client`</span></span>
* <span data-ttu-id="7d868-234">Описание: `AADB2C90058: The provided application is not configured to allow public clients.`</span><span class="sxs-lookup"><span data-stu-id="7d868-234">Description: `AADB2C90058: The provided application is not configured to allow public clients.`</span></span>

<span data-ttu-id="7d868-235">Чтобы устранить эту ошибку, сделайте следующее:</span><span class="sxs-lookup"><span data-stu-id="7d868-235">To resolve the error:</span></span>

1. <span data-ttu-id="7d868-236">На портале Azure перейдите к [манифесту приложения](/azure/active-directory/develop/reference-app-manifest).</span><span class="sxs-lookup"><span data-stu-id="7d868-236">In the Azure portal, access the [app's manifest](/azure/active-directory/develop/reference-app-manifest).</span></span>
1. <span data-ttu-id="7d868-237">Задайте для атрибута [`allowPublicClient`](/azure/active-directory/develop/reference-app-manifest#allowpublicclient-attribute) значение `null` или `true`.</span><span class="sxs-lookup"><span data-stu-id="7d868-237">Set the [`allowPublicClient`](/azure/active-directory/develop/reference-app-manifest#allowpublicclient-attribute) attribute to `null` or `true`.</span></span>

## <a name="update-a-no-locblazor-progressive-web-application-pwa"></a><span data-ttu-id="7d868-238">Обновление Blazor последовательного веб-приложения (PWA)</span><span class="sxs-lookup"><span data-stu-id="7d868-238">Update a Blazor Progressive Web Application (PWA)</span></span>

<span data-ttu-id="7d868-239">Добавьте следующий элемент в файл проекта приложения PWA:</span><span class="sxs-lookup"><span data-stu-id="7d868-239">Add the following item to the PWA app's project file:</span></span>

```xml
<ItemGroup>
  <ServiceWorker Include="wwwroot\service-worker.js" 
    PublishedContent="wwwroot\service-worker.published.js" />
</ItemGroup>
```

## <a name="update-no-locrazor-class-libraries-rcls"></a><span data-ttu-id="7d868-240">Обновление Razor библиотек классов (рклс)</span><span class="sxs-lookup"><span data-stu-id="7d868-240">Update Razor class libraries (RCLs)</span></span>

<span data-ttu-id="7d868-241">Перенесите Razor библиотеки классов (рклс), чтобы воспользоваться преимуществами новых API-интерфейсов или функций, представленных в составе ASP.NET Core 5,0.</span><span class="sxs-lookup"><span data-stu-id="7d868-241">Migrate Razor class libraries (RCLs) to take advantage of new APIs or features that are introduced as part of ASP.NET Core 5.0.</span></span> 

<span data-ttu-id="7d868-242">Обновление РКЛ, предназначенного для компонентов:</span><span class="sxs-lookup"><span data-stu-id="7d868-242">To update a RCL that targets components:</span></span>

1. <span data-ttu-id="7d868-243">Обновите следующие свойства в файле проекта:</span><span class="sxs-lookup"><span data-stu-id="7d868-243">Update the following properties in the project file:</span></span>

   ```diff
   <Project Sdk="Microsoft.NET.Sdk.Razor">
    
     <PropertyGroup>
   -     <TargetFramework>netstandard2.0</TargetFramework>
   -     <RazorLangVersion>3.0</RazorLangVersion>
   +     <TargetFramework>net5.0</TargetFramework>
     </PropertyGroup>
   ```

1. <span data-ttu-id="7d868-244">Обновите другие пакеты до их последних версий.</span><span class="sxs-lookup"><span data-stu-id="7d868-244">Update other packages to their latest versions.</span></span> <span data-ttu-id="7d868-245">Последние версии можно найти по адресу [NuGet.org](https://www.nuget.org).</span><span class="sxs-lookup"><span data-stu-id="7d868-245">The latest versions can be found at [NuGet.org](https://www.nuget.org).</span></span>

<span data-ttu-id="7d868-246">Чтобы обновить РКЛ, предназначенный для MVC, обновите следующие свойства в файле проекта:</span><span class="sxs-lookup"><span data-stu-id="7d868-246">To update an RCL targeting MVC, update the following properties in the project file:</span></span>

```diff
<Project Sdk="Microsoft.NET.Sdk.Razor">

  <PropertyGroup>
-    <TargetFramework>netcoreapp3.1</TargetFramework>
+    <TargetFramework>net5.0</TargetFramework>
    <AddRazorSupportForMvc>true</AddRazorSupportForMvc>
  </PropertyGroup>
```

## <a name="update-package-references"></a><span data-ttu-id="7d868-247">Обновление ссылок на пакеты</span><span class="sxs-lookup"><span data-stu-id="7d868-247">Update package references</span></span>

<span data-ttu-id="7d868-248">В файле проекта обновите все файлы [Microsoft. AspNetCore. \*](https://www.nuget.org/packages?q=Microsoft.AspNetCore.*), [Microsoft. EntityFrameworkCore. \*](https://www.nuget.org/packages?q=Microsoft.EntityFrameworkCore.*), [Microsoft. extensions. \*](https://www.nuget.org/packages?q=Microsoft.Extensions.*)и [System.Net.Http.Jsв](https://www.nuget.org/packages/System.Net.Http.Json) атрибуте ссылки на пакет `Version` значение 5.0.0 или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="7d868-248">In the project file, update each [Microsoft.AspNetCore.\*](https://www.nuget.org/packages?q=Microsoft.AspNetCore.*), [Microsoft.EntityFrameworkCore.\*](https://www.nuget.org/packages?q=Microsoft.EntityFrameworkCore.*), [Microsoft.Extensions.\*](https://www.nuget.org/packages?q=Microsoft.Extensions.*), and [System.Net.Http.Json](https://www.nuget.org/packages/System.Net.Http.Json) package reference's `Version` attribute to 5.0.0 or later.</span></span> <span data-ttu-id="7d868-249">Пример:</span><span class="sxs-lookup"><span data-stu-id="7d868-249">For example:</span></span>

```diff
<ItemGroup>
-    <PackageReference Include="Microsoft.AspNetCore.JsonPatch" Version="3.1.6" />
-    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="3.1.6">
-    <PackageReference Include="Microsoft.Extensions.Caching.Abstractions" Version="3.1.6" />
-    <PackageReference Include="System.Net.Http.Json" Version="3.2.1" />
+    <PackageReference Include="Microsoft.AspNetCore.JsonPatch" Version="5.0.0" />
+    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="5.0.0">
+    <PackageReference Include="Microsoft.Extensions.Caching.Abstractions" Version="5.0.0" />
+    <PackageReference Include="System.Net.Http.Json" Version="5.0.0" />
</ItemGroup>
```

## <a name="update-docker-images"></a><span data-ttu-id="7d868-250">Обновление образов DOCKER</span><span class="sxs-lookup"><span data-stu-id="7d868-250">Update Docker images</span></span>

<span data-ttu-id="7d868-251">Для приложений, использующих DOCKER,  обновите `FROM` инструкции и скрипты Dockerfile.</span><span class="sxs-lookup"><span data-stu-id="7d868-251">For apps using Docker, update your *Dockerfile* `FROM` statements and scripts.</span></span> <span data-ttu-id="7d868-252">Используйте базовый образ, включающий среду выполнения ASP.NET Core 5,0.</span><span class="sxs-lookup"><span data-stu-id="7d868-252">Use a base image that includes the ASP.NET Core 5.0 runtime.</span></span> <span data-ttu-id="7d868-253">Рассмотрим следующую `docker pull` команду в различиях между ASP.NET Core 3,1 и 5,0:</span><span class="sxs-lookup"><span data-stu-id="7d868-253">Consider the following `docker pull` command difference between ASP.NET Core 3.1 and 5.0:</span></span>

```diff
- docker pull mcr.microsoft.com/dotnet/core/aspnet:3.1
+ docker pull mcr.microsoft.com/dotnet/aspnet:5.0
```

<span data-ttu-id="7d868-254">В рамках перехода на .NET в качестве названия продукта образы DOCKER перемещаются из `mcr.microsoft.com/dotnet/core` репозиториев в `mcr.microsoft.com/dotnet` .</span><span class="sxs-lookup"><span data-stu-id="7d868-254">As part of the move to ".NET" as the product name, the Docker images moved from the `mcr.microsoft.com/dotnet/core` repositories to `mcr.microsoft.com/dotnet`.</span></span> <span data-ttu-id="7d868-255">Дополнительные сведения см. в разделе [DotNet/DotNet-DOCKER # 1939](https://github.com/dotnet/dotnet-docker/issues/1939).</span><span class="sxs-lookup"><span data-stu-id="7d868-255">For more information, see [dotnet/dotnet-docker#1939](https://github.com/dotnet/dotnet-docker/issues/1939).</span></span>

## <a name="model-binding-changes-in-aspnet-core-mvc-and-no-locrazor-pages"></a><span data-ttu-id="7d868-256">Изменение привязки модели в ASP.NET Core MVC и Razor страницах</span><span class="sxs-lookup"><span data-stu-id="7d868-256">Model binding changes in ASP.NET Core MVC and Razor Pages</span></span>

### <a name="datetime-values-are-model-bound-as-utc-times"></a><span data-ttu-id="7d868-257">Значения даты и времени привязаны к модели в формате UTC</span><span class="sxs-lookup"><span data-stu-id="7d868-257">DateTime values are model bound as UTC times</span></span>

<span data-ttu-id="7d868-258">В ASP.NET Core 3,1 и более ранних версиях `DateTime` значения были привязаны к модели как местное время, где часовой пояс был определен сервером.</span><span class="sxs-lookup"><span data-stu-id="7d868-258">In ASP.NET Core 3.1 and earlier, `DateTime` values were model-bound as local time, where the timezone was determined by the server.</span></span> <span data-ttu-id="7d868-259">`DateTime` значения, связанные с форматированием входных данных (JSON) и `DateTimeOffset` значениями, были привязаны как часовые пояса в формате UTC.</span><span class="sxs-lookup"><span data-stu-id="7d868-259">`DateTime` values bound from input formatting (JSON) and `DateTimeOffset` values were bound as UTC timezones.</span></span>

<span data-ttu-id="7d868-260">В ASP.NET Core 5,0 и более поздних версиях привязка модели согласованно привязывает `DateTime` значения к часовому поясу UTC.</span><span class="sxs-lookup"><span data-stu-id="7d868-260">In ASP.NET Core 5.0 and later, model binding consistently binds `DateTime` values with the UTC timezone.</span></span>

<span data-ttu-id="7d868-261">Чтобы удержать предыдущее поведение, удалите `DateTimeModelBinderProvider` в `Startup.ConfigureServices` :</span><span class="sxs-lookup"><span data-stu-id="7d868-261">To retain the previous behavior, remove the `DateTimeModelBinderProvider` in `Startup.ConfigureServices`:</span></span>

```csharp
services.AddControllersWithViews(options => 
    options.ModelBinderProviders.RemoveType<DateTimeModelBinderProvider>());
```

### <a name="complexobjectmodelbinderprovider--complexobjectmodelbinder-replace-complextypemodelbinderprovider--complextypemodelbinder"></a><span data-ttu-id="7d868-262">Комплексобжектмоделбиндерпровидер \ Комплексобжектмоделбиндер заменить Комплекстипемоделбиндерпровидер \ ComplexTypeModelBinder</span><span class="sxs-lookup"><span data-stu-id="7d868-262">ComplexObjectModelBinderProvider \ ComplexObjectModelBinder replace ComplexTypeModelBinderProvider \ ComplexTypeModelBinder</span></span>

<span data-ttu-id="7d868-263">Чтобы добавить поддержку для [типов записей привязки модели C# 9](/dotnet/csharp/whats-new/csharp-9#record-types), <xref:Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ComplexTypeModelBinderProvider> используется:</span><span class="sxs-lookup"><span data-stu-id="7d868-263">To add support for model binding [C# 9 record types](/dotnet/csharp/whats-new/csharp-9#record-types), the <xref:Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ComplexTypeModelBinderProvider> is:</span></span>

* <span data-ttu-id="7d868-264">Помечены как устаревшие.</span><span class="sxs-lookup"><span data-stu-id="7d868-264">Annotated as obsolete.</span></span>
* <span data-ttu-id="7d868-265">Больше не регистрируется по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="7d868-265">No longer registered by default.</span></span>

<span data-ttu-id="7d868-266">Приложения, зависящие от наличия `ComplexTypeModelBinderProvider` в `ModelBinderProviders` коллекции, должны ссылаться на новый поставщик подшивки:</span><span class="sxs-lookup"><span data-stu-id="7d868-266">Apps that rely on the presence of the `ComplexTypeModelBinderProvider` in the `ModelBinderProviders` collection need to reference the new binder provider:</span></span>

```diff
- var complexModelBinderProvider = options.ModelBinderProviders.OfType<ComplexTypeModelBinderProvider>();
+ var complexModelBinderProvider = options.ModelBinderProviders.OfType<ComplexObjectModelBinderProvider>();
```

## <a name="usedatabaseerrorpage-obsolete"></a><span data-ttu-id="7d868-267">Уседатабасиррорпаже устарел</span><span class="sxs-lookup"><span data-stu-id="7d868-267">UseDatabaseErrorPage obsolete</span></span>

<span data-ttu-id="7d868-268">Шаблоны ASP.NET Core 3,1, которые включают параметр для отдельных учетных записей пользователей, формируют вызов <xref:Microsoft.AspNetCore.Builder.DatabaseErrorPageExtensions.UseDatabaseErrorPage%2A> .</span><span class="sxs-lookup"><span data-stu-id="7d868-268">The ASP.NET Core 3.1 templates that include an option for individual user accounts generate a call to <xref:Microsoft.AspNetCore.Builder.DatabaseErrorPageExtensions.UseDatabaseErrorPage%2A>.</span></span> <span data-ttu-id="7d868-269">`UseDatabaseErrorPage` теперь является устаревшим и должен быть заменен сочетанием `AddDatabaseDeveloperPageExceptionFilter` и `UseMigrationsEndPoint` , как показано в следующем коде:</span><span class="sxs-lookup"><span data-stu-id="7d868-269">`UseDatabaseErrorPage` is now obsolete and should be replaced with a combination of `AddDatabaseDeveloperPageExceptionFilter` and `UseMigrationsEndPoint`, as shown in the following code:</span></span>

```diff
public void ConfigureServices(IServiceCollection services)
{
    services.AddDbContext<ApplicationDbContext>(options =>
        options.UseSqlServer(
            Configuration.GetConnectionString("DefaultConnection")));
+   services.AddDatabaseDeveloperPageExceptionFilter();
    services.AddDefaultIdentity<IdentityUser>(options => options.SignIn.RequireConfirmedAccount = true)
        .AddEntityFrameworkStores<ApplicationDbContext>();
    services.AddRazorPages();
}

public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    if (env.IsDevelopment())
    {
        app.UseDeveloperExceptionPage();
+       app.UseMigrationsEndPoint();
-       app.UseDatabaseErrorPage();
    }
    else
    {
        app.UseExceptionHandler("/Error");
        app.UseHsts();
    }
```

<span data-ttu-id="7d868-270">Дополнительные сведения см. в [этой статье об ошибке на GitHub](https://github.com/dotnet/aspnetcore/issues/24987).</span><span class="sxs-lookup"><span data-stu-id="7d868-270">For more information, see [this GitHub issue](https://github.com/dotnet/aspnetcore/issues/24987).</span></span>

## <a name="review-breaking-changes"></a><span data-ttu-id="7d868-271">Проверка критических изменений</span><span class="sxs-lookup"><span data-stu-id="7d868-271">Review breaking changes</span></span>

<span data-ttu-id="7d868-272">Критические изменения с .NET Core 3,1 на .NET 5,0 см. в разделе [критические изменения для миграции с версии 3,1 на 5,0](/dotnet/core/compatibility/3.1-5.0).</span><span class="sxs-lookup"><span data-stu-id="7d868-272">For breaking changes from .NET Core 3.1 to .NET 5.0, see [Breaking changes for migration from version 3.1 to 5.0](/dotnet/core/compatibility/3.1-5.0).</span></span> <span data-ttu-id="7d868-273">ASP.NET Core и Entity Framework Core также включены в список.</span><span class="sxs-lookup"><span data-stu-id="7d868-273">ASP.NET Core and Entity Framework Core are also included in the list.</span></span>
