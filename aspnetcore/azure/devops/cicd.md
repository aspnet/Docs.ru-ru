---
title: Непрерывная интеграция и развертывание — DevOps с ASP.NET Core и Azure
author: CamSoper
description: Непрерывная интеграция и развертывание в DevOps с ASP.NET Core и Azure
ms.author: scaddie
ms.date: 10/24/2018
ms.custom: devx-track-csharp, mvc, seodec18
no-loc:
- appsettings.json
- ASP.NET Core Identity
- cookie
- Cookie
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: azure/devops/cicd
ms.openlocfilehash: eddd7034bf1860fb35cf00eefb7a11a408869700
ms.sourcegitcommit: ca34c1ac578e7d3daa0febf1810ba5fc74f60bbf
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2020
ms.locfileid: "93052647"
---
# <a name="continuous-integration-and-deployment"></a>Непрерывная интеграция и развертывание

В предыдущей главе вы создали локальный репозиторий GIT для приложения Simple Feed Reader. В этой главе вы опубликуете код в репозитории GitHub и создадите конвейер Azure DevOps Services с помощью Azure Pipelines. Конвейер обеспечивает непрерывную сборку и развертывание приложения. Любая фиксация в репозитории GitHub активирует сборку и развертывание в промежуточном слоте веб-приложения Azure.

В этом разделе вам предстоит выполнить следующие задачи:

* опубликовать код приложения в GitHub;
* отключить локальное развертывание в GIT;
* создать организацию Azure DevOps;
* создать командный проект в Azure DevOps Services;
* Создание определения построения
* Создание конвейера выпуска
* Фиксация изменений в GitHub и автоматическое развертывание в Azure
* изучить конвейер Azure Pipelines.

## <a name="publish-the-apps-code-to-github"></a>Публикация кода приложения в GitHub

1. Откройте окно браузера и перейдите по адресу `https://github.com`.
1. Щелкните стрелку раскрывающегося списка  **+** в заголовке и выберите пункт **New repository** (Новый репозиторий).

    ![Пункт New Repository в GitHub](media/cicd/github-new-repo.png)

1. В раскрывающемся списке **Owner** (Владелец) выберите свою учетную запись, а затем в текстовом поле **Repository name** (Имя репозитория) введите *simple-feed-reader*.
1. Нажмите кнопку **Create repository** (Создать репозиторий).
1. Откройте командную оболочку на локальном компьютере. Перейдите в каталог, в котором хранится репозиторий GIT *simple-feed-reader*.
1. Переименуйте существующий удаленный репозиторий *origin* в *upstream*. Выполните следующую команду:

    ```console
    git remote rename origin upstream
    ```

1. Добавьте новый удаленный репозиторий *origin* , связанный с вашей копией репозитория в GitHub. Выполните следующую команду:

    ```console
    git remote add origin https://github.com/<GitHub_username>/simple-feed-reader/
    ```

1. Опубликуйте локальный репозиторий GIT в только что созданном репозитории GitHub. Выполните следующую команду:

    ```console
    git push -u origin master
    ```

1. Откройте окно браузера и перейдите по адресу `https://github.com/<GitHub_username>/simple-feed-reader/`. Проверьте, имеется ли ваш код в репозитории GitHub.

## <a name="disconnect-local-git-deployment"></a>Отключение локального развертывания в GIT

Удалите локальное развертывание GIT, выполнив указанные ниже действия. Azure Pipelines (служба Azure DevOps) заменяет его и дополняет его функциональные возможности.

1. На [портале Azure](https://portal.azure.com/) перейдите к *промежуточному веб-приложению (mywebapp\<unique_number\>/staging)* . Его можно быстро найти, введя в поле поиска на портале запрос *промежуточное*.

    ![Поиск промежуточного веб-приложения](media/cicd/portal-search-box.png)

1. Щелкните **Центр развертывания**. Появится новая панель. Щелкните **Отключить** , чтобы удалить локальную конфигурацию управления исходным кодом GIT, добавленную в предыдущей главе. Подтвердите удаление, нажав кнопку **Да**.
1. Перейдите к службе приложений *mywebapp<уникальный_номер>* . Напомним, что ее можно легко найти с помощью поля поиска на портале.
1. Щелкните **Центр развертывания**. Появится новая панель. Щелкните **Отключить** , чтобы удалить локальную конфигурацию управления исходным кодом GIT, добавленную в предыдущей главе. Подтвердите удаление, нажав кнопку **Да**.

## <a name="create-an-azure-devops-organization"></a>Создание организации Azure DevOps

1. Откройте браузер и перейдите на [страницу создания организации Azure DevOps](https://go.microsoft.com/fwlink/?LinkId=307137).
1. В текстовом поле **Выберите запоминающееся имя** введите уникальное имя, чтобы сформировать URL-адрес для доступа к организации Azure DevOps.
1. Установите переключатель в положение **Git** , так как код размещается в репозитории GitHub.
1. Нажмите кнопку **Continue** (Продолжить). После короткого ожидания будут созданы учетная запись и командный проект с именем *MyFirstProject*.

    ![Страница создания организации Azure DevOps](media/cicd/vsts-account-creation.png)

1. Откройте сообщение электронной почты с подтверждением того, что организация и проект Azure DevOps готовы к использованию. Нажмите кнопку **Запустить проект**.

    ![Кнопка "Запустить проект"](media/cicd/vsts-start-project.png)

1. В браузере откроется страница с адресом *\<account_name\>.visualstudio.com*. Щелкните ссылку *MyFirstProject* , чтобы начать настройку конвейера DevOps проекта.

## <a name="configure-the-azure-pipelines-pipeline"></a>Настройка конвейера Azure Pipelines

Процесс состоит из трех отдельных шагов. Выполнив действия, описанные в следующих трех разделах, вы получите работающий конвейер DevOps.

### <a name="grant-azure-devops-access-to-the-github-repository"></a>Предоставление Azure DevOps доступа к репозиторию GitHub

1. Разверните меню-гармошку **или выполнить сборку кода из внешнего репозитория**. Нажмите кнопку **Настроить сборку**.

    ![Кнопка "Настроить сборку"](media/cicd/vsts-setup-build.png)

1. В разделе **Выбор источника** выберите пункт **GitHub**.

    ![Выбор источника — GitHub](media/cicd/vsts-select-source.png)

1. Чтобы Azure DevOps мог получить доступ к репозиторию GitHub, необходима авторизация. В текстовом поле **Имя подключения** введите *Подключение к GitHub <имя_пользователя_GitHub>* . Пример:

    ![Имя подключения к GitHub](media/cicd/vsts-repo-authz.png)

1. Если в учетной записи GitHub включена двухфакторная проверка подлинности, необходим личный маркер доступа. В этом случае щелкните ссылку **Авторизовать с личным маркером доступа GitHub**. За помощью обратитесь к [инструкциям по созданию личного маркера доступа GitHub](https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/). Требуется только область разрешений *репозиторий*. В противном случае нажмите кнопку **Авторизовать с помощью OAuth**.
1. При появлении запроса выполните вход в учетную запись GitHub. Затем выберите "Авторизовать", чтобы предоставить доступ к вашей организации Azure DevOps. В случае успеха будет создана новая конечная точка службы.
1. Нажмите кнопку с многоточием рядом с кнопкой **Репозиторий**. Выберите в списке репозиторий *<имя_пользователя_GitHub>/simple-feed-reader*. Нажмите кнопку **Выбрать**.
1. В раскрывающемся списке **Ветвь по умолчанию для сборок вручную и по расписанию** выберите *главную* ветвь. Нажмите кнопку **Continue** (Продолжить). Откроется страница выбора шаблона.

### <a name="create-the-build-definition"></a>Создание определения сборки

1. На странице выбора шаблона в поле поиска введите *ASP.NET Core*.

    ![Поиск ASP.NET Core на странице выбора шаблона](media/cicd/vsts-template-selection.png)

1. Появятся результаты поиска шаблона. Наведите указатель на шаблон **ASP.NET Core** и нажмите кнопку **Применить**.
1. Появится вкладка **Задачи** определения сборки. Перейдите на вкладку **Триггеры** .
1. Установите флажок **Включить непрерывную интеграцию**. В разделе **Фильтры ветвей** убедитесь в том, что в раскрывающемся списке **Тип** выбран пункт *Включить*. В раскрывающемся списке **Спецификация ветви** выберите пункт *главная*.

    ![Параметры включения непрерывной интеграции](media/cicd/vsts-enable-ci.png)

    В результате установки этих параметров сборка будет происходить при отправке любого изменения в *главную* ветвь репозитория GitHub. Тестирование непрерывной интеграции производится в разделе [Фиксация изменений в GitHub и автоматическое развертывание в Azure](#commit-changes-to-github-and-automatically-deploy-to-azure).

1. Нажмите кнопку **Сохранить и поместить в очередь** и выберите пункт **Сохранить**.

    ![Кнопка "Сохранить"](media/cicd/vsts-save-build.png)

1. Появится следующее модальное диалоговое окно:

    ![Сохранение определения сборки — модальное диалоговое окно](media/cicd/vsts-save-modal.png)

    Используйте папку по умолчанию *\\* и нажмите кнопку **Сохранить**.

### <a name="create-the-release-pipeline"></a>Создание конвейера выпуска

1. Перейдите на вкладку **Выпуски** командного проекта. Нажмите кнопку **Новый конвейер**.

    ![Вкладка "Выпуски" — кнопка "Новый конвейер"](media/cicd/vsts-new-release-definition.png)

    Появится область выбора шаблона.

1. На странице выбора шаблона в поле поиска введите *Служба приложений*.

    ![Поле для поиска шаблона конвейера выпуска](media/cicd/vsts-release-template-search.png)

1. Появятся результаты поиска шаблона. Наведите указатель на шаблон **Развертывание службы приложений Azure с помощью слота** и нажмите кнопку **Применить**. Откроется вкладка **Конвейер** конвейера выпуска.

    ![Вкладка "Конвейер" конвейера выпуска](media/cicd/vsts-release-definition-pipeline.png)

1. В поле **Артефакты** нажмите кнопку **Добавить**. Появится панель **Добавление артефакта**.

    ![Конвейер выпуска — панель "Добавление артефакта"](media/cicd/vsts-release-add-artifact.png)

1. В разделе **Тип источника** выберите плитку **Сборка**. Этот тип позволяет связать конвейер выпуска с определением сборки.
1. В раскрывающемся списке **Проект** выберите пункт *MyFirstProject*.
1. В раскрывающемся списке **Источник (определение сборки)** выберите имя определения сборки *MyFirstProject-ASP.NET Core-CI*.
1. В раскрывающемся списке **Версия по умолчанию** выберите пункт *Последняя*. В результате будет выполнена сборка артефактов, полученных при последнем запуске определения сборки.
1. Замените текст в поле **Псевдоним источника** на *Сброс*.
1. Нажмите кнопку **Добавить**. Содержимое в разделе **Артефакты** обновится в соответствии с изменениями.
1. Чтобы включить непрерывное развертывание, щелкните значок молнии.

    ![Артефакты конвейера выпуска — значок молнии](media/cicd/vsts-artifacts-lightning-bolt.png)

    При включении этого параметра развертывание происходит каждый раз, когда становится доступна новая сборка.
1. Справа появится панель **Триггер непрерывного развертывания**. Щелкните выключатель, чтобы включить эту функцию. Включать **триггер запроса на вытягивание** необязательно.
1. В разделе **Фильтры ветви сборки** откройте раскрывающийся список **Добавить**. Выберите пункт **Ветвь по умолчанию в определении сборки**. При применении этого фильтра выпуск активируется только для сборки из *главной* ветви репозитория GitHub.
1. Нажмите кнопку **Сохранить**. В появившемся модальном диалоговом окне **Сохранить** нажмите кнопку **ОК**.
1. Щелкните поле **Среда 1**. Справа появится панель **Среда**. Измените текст *Среда 1* в текстовом поле **Имя среды** на *Рабочая*.

   ![Конвейер выпуска — текстовое поле "Имя среды"](media/cicd/vsts-environment-name-textbox.png)

1. Щелкните ссылку **1 этап, 2 задачи** в поле **Рабочая**.

    ![Конвейер выпуска — ссылка на рабочую среду](media/cicd/vsts-production-link.png)

    Появится вкладка **Задачи** среды.
1. Выберите задачу **Развертывание службы приложений Azure в слоте**. Ее параметры появятся на панели справа.
1. В раскрывающемся списке **Подписка Azure** выберите подписку Azure, связанную со службой приложений. После этого нажмите кнопку **Авторизовать**.
1. В раскрывающемся списке **Тип приложения** выберите пункт *Веб-приложение*.
1. В раскрывающемся списке **Имя службы приложений** выберите пункт *mywebapp/<уникальный_номер/>* .
1. В раскрывающемся списке **Группа ресурсов** выберите пункт *AzureTutorial*.
1. В раскрывающемся списке **Слот** выберите пункт *Промежуточный*.
1. Нажмите кнопку **Сохранить**.
1. Наведите указатель на имя конвейера выпуска по умолчанию. Щелкните значок карандаша, чтобы изменить его. Используйте имя *MyFirstProject-ASP.NET Core-CD*.

    ![Имя конвейера выпуска](media/cicd/vsts-release-definition-name.png)

1. Нажмите кнопку **Сохранить**.

## <a name="commit-changes-to-github-and-automatically-deploy-to-azure"></a>Фиксация изменений в GitHub и автоматическое развертывание в Azure

1. Откройте файл *SimpleFeedReader.sln* в Visual Studio.
1. В обозревателе решений откройте файл *Pages\Index.cshtml*. Измените `<h2>Simple Feed Reader - V3</h2>` на `<h2>Simple Feed Reader - V4</h2>`.
1. Нажмите сочетание клавиш **CTRL**+**SHIFT**+**B** для сборки приложения.
1. Зафиксируйте файл в репозитории GitHub. Используйте страницу **Изменения** на вкладке *Team Explorer* в Visual Studio или выполните следующую команду в командной оболочке локального компьютера:

    ```console
    git commit -a -m "upgraded to V4"
    ```

1. Отправьте изменение в *главную* ветвь удаленного репозитория *origin* в GitHub:

    ```console
    git push origin master
    ```

    Фиксация появится в *главной* ветви репозитория GitHub.

    ![Фиксация в главной ветви GitHub](media/cicd/github-commit.png)

    Запустится сборка, так как на вкладке **Триггеры** определения сборки включена непрерывная интеграция.

    ![включение непрерывной интеграции](media/cicd/enable-ci.png)

1. Перейдите на вкладку **В очереди** страницы **Azure Pipelines** > **Сборки** в Azure DevOps Services. Для сборки в очереди показаны ветвь и фиксация, активировавшая сборку.

    ![сборка в очереди](media/cicd/build-queued.png)

1. После успешной сборки производится развертывание в Azure. Перейдите к приложению в браузере. Обратите внимание, что в заголовке имеется текст "V4".

    ![обновленное приложение](media/cicd/updated-app-v4.png)

## <a name="examine-the-azure-pipelines-pipeline"></a>Изучение конвейера Azure Pipelines

### <a name="build-definition"></a>Определение сборки

Определение сборки было создано с именем *MyFirstProject-ASP.NET Core-CI*. После завершения сборки создается файл *ZIP* , содержащий ресурсы для публикации. Конвейер выпуска развертывает эти ресурсы в Azure.

На вкладке **Задачи** определения сборки перечислены выполняемые шаги. Имеется пять задач сборки.

![задачи определения сборки](media/cicd/build-definition-tasks.png)

1. **Восстановление**  &mdash; выполняет команду `dotnet restore` для восстановления пакетов NuGet приложения. По умолчанию используется веб-канал пакетов nuget.org.
1. **Сборка**  &mdash; выполняет команду `dotnet build --configuration release` для компиляции кода приложения. Параметр `--configuration` служит для создания оптимизированной версии кода, которая подходит для развертывания в рабочей среде. Измените переменную *BuildConfiguration* на вкладке **Переменные** определения сборки, если, например, требуется конфигурация отладки.
1. **Тестирование**  &mdash; выполняет команду `dotnet test --configuration release --logger trx --results-directory <local_path_on_build_agent>` для выполнения модульных тестов приложения. Модульные тесты выполняются в любом проекте C#, соответствующем стандартной маске `**/*Tests/*.csproj`. Результаты тестов сохраняются в файле *TRX* в расположении, указанном с помощью параметра `--results-directory`. Если какие-либо тесты завершаются неудачно, сборка завершается сбоем и не развертывается.

    > [!NOTE]
    > Чтобы проверить работу модульных тестов, внесите в файл *SimpleFeedReader.Tests\Services\NewsServiceTests.cs* изменение, нарушающее выполнение одного из них. Например, измените `Assert.True(result.Count > 0);` на `Assert.False(result.Count > 0);` в методе `Returns_News_Stories_Given_Valid_Uri`. Зафиксируйте изменение и отправьте его в GitHub. Сборка запустится и завершится сбоем. Состояние конвейера сборки изменится на **сбой**. Отмените изменение и снова выполните фиксацию и отправку. Сборка завершится успешно.

1. **Публикация**  &mdash; выполняет команду `dotnet publish --configuration release --output <local_path_on_build_agent>` для создания файла *ZIP* с развертываемыми артефактами. Параметр `--output` указывает расположение публикации файла *ZIP*. Это расположение задается путем передачи [предварительно определенной переменной](/azure/devops/pipelines/build/variables) с именем `$(build.artifactstagingdirectory)`. Эта переменная развертывается в локальный путь, например *c:\agent\_work\1\a* , в агенте сборки.
1. **Публикация артефакта**  &mdash; публикует файл *ZIP* , созданный в результате выполнения задачи **Публикация**. В качестве параметра принимается расположение файла *ZIP* в виде предварительно определенной переменной `$(build.artifactstagingdirectory)`. Файл *ZIP* публикуется в виде папки *drop*.

Щелкните ссылку **Сводка** для определения сборки, чтобы просмотреть журнал сборок с этим определением.

![Снимок экрана: журнал определения сборки](media/cicd/build-definition-summary.png)

На открывшейся странице щелкните ссылку, соответствующую уникальному номеру сборки.

![Снимок экрана: страница сводки по определению сборки](media/cicd/build-definition-completed.png)

Отобразится сводка по данной сборке. Перейдите на вкладку **Артефакты** и обратите внимание на наличие в списке папки *drop* , созданной в результате сборки.

![Снимок экрана: папка drop в списке артефактов определения сборки](media/cicd/build-definition-artifacts.png)

Чтобы просмотреть опубликованные артефакты, воспользуйтесь ссылками **Скачать** и **Обзор**.

### <a name="release-pipeline"></a>Конвейер выпуска

Конвейер сборки был создан с именем *MyFirstProject-ASP.NET Core-CD*.

![Снимок экрана: обзор конвейера выпуска](media/cicd/release-definition-overview.png)

Два основных компонента конвейера выпуска — это **артефакты** и **среды**. Если щелкнуть поле в разделе **Артефакты** , появится следующая панель:

![Снимок экрана: артефакты конвейера выпуска](media/cicd/release-definition-artifacts.png)

В поле **Источник (определение сборки)** указано определение сборки, с которым связан этот конвейер выпуска. Файл *ZIP* , созданный в результате успешного выполнения определения сборки, передается в *рабочую* среду для развертывания в Azure. Щелкните ссылку *1 этап, 2 задачи* в поле *Рабочая* , чтобы просмотреть задачи конвейера выпуска.

![Снимок экрана: задачи конвейера выпуска](media/cicd/release-definition-tasks.png)

Конвейер выпуска состоит из двух задач: *Развертывание службы приложений Azure в слоте* и *Управление Службой приложений Azure — переключение слотов*. Если щелкнуть первую задачу, появится следующая конфигурация:

![Снимок экрана: задача развертывания конвейера выпуска](media/cicd/release-definition-task1.png)

В задаче развертывания определены подписка Azure, тип службы, имя веб-приложения, группа ресурсов и слот развертывания. В текстовом поле **Пакет или папка** указывается путь к файлу *ZIP* , который следует извлечь и развернуть в *промежуточном* слоте веб-приложения *mywebapp\<unique_number\>* .

Если щелкнуть задачу переключения слотов, появится следующая конфигурация:

![Снимок экрана: задача переключения слотов конвейера выпуска](media/cicd/release-definition-task2.png)

Приводятся сведения о подписке, группе ресурсов, типе службы, имени веб-приложения и слоте развертывания. Флажок **Переключить на рабочий слот** установлен. Соответственно код, развернутый в *промежуточном* слоте, переносится в рабочую среду.

## <a name="additional-reading"></a>Дополнительные материалы для чтения

* [Создание первого конвейера с помощью Azure Pipelines](/azure/devops/pipelines/get-started-yaml)
* [Сборка проекта .NET Core](/azure/devops/pipelines/languages/dotnet-core)
* [Развертывание веб-приложения с помощью Azure Pipelines](/azure/devops/pipelines/targets/webapp)
